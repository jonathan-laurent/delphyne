
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
      <link rel="icon" href="../../None">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.17">
    
    
      
        <title>Testing MkDocs - Delphyne</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="https://unpkg.com/katex@0/dist/katex.min.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#testing-mkdocs" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Delphyne" class="md-header__button md-logo" aria-label="Delphyne" data-md-component="logo">
      
  <img src="../../assets/logos/white/mini.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Delphyne
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Testing MkDocs
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Delphyne" class="md-nav__button md-logo" aria-label="Delphyne" data-md-component="logo">
      
  <img src="../../assets/logos/white/mini.png" alt="logo">

    </a>
    Delphyne
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Manual
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Manual
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/strategies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Strategies and Trees
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/policies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Policies
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/demos/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Demonstrations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/extension/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    VSCode Extension
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to-guides/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    How-To Guides
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" >
        
          
          <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Strategies
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            Strategies
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/strategies/trees/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Trees
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/strategies/queries/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Queries
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/strategies/traces/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Traces
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/strategies/misc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Misc
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Policies
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            Policies
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/policies/definitions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Definitions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/policies/streams/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Search Streams
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/policies/envs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Environments
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3" >
        
          
          <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Demonstrations
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            Demonstrations
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/demos/definitions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Definitions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/demos/interpreter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Interpreter
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_4" >
        
          
          <label class="md-nav__link" for="__nav_4_4" id="__nav_4_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Standard Library
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_4">
            <span class="md-nav__icon md-icon"></span>
            Standard Library
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/stdlib/basic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Basic
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/stdlib/queries/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Queries
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/stdlib/streams/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Streams
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/stdlib/effects/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Effects
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/stdlib/algorithms/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Algorithms
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/stdlib/commands/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Commands
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/stdlib/experiments/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Experiments
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#resources-on-writing-good-docstrings" class="md-nav__link">
    <span class="md-ellipsis">
      Resources on Writing Good Docstrings
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tricks" class="md-nav__link">
    <span class="md-ellipsis">
      Tricks
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#api-documentation-for-query" class="md-nav__link">
    <span class="md-ellipsis">
      API Documentation for Query
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#documenting-type-aliases" class="md-nav__link">
    <span class="md-ellipsis">
      Documenting Type Aliases
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Documenting Type Aliases">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.Stream" class="md-nav__link">
    <span class="md-ellipsis">
      Stream
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Stream">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.Stream.all" class="md-nav__link">
    <span class="md-ellipsis">
      all
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Stream.bind" class="md-nav__link">
    <span class="md-ellipsis">
      bind
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Stream.collect" class="md-nav__link">
    <span class="md-ellipsis">
      collect
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Stream.first" class="md-nav__link">
    <span class="md-ellipsis">
      first
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Stream.loop" class="md-nav__link">
    <span class="md-ellipsis">
      loop
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Stream.next" class="md-nav__link">
    <span class="md-ellipsis">
      next
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Stream.or_else" class="md-nav__link">
    <span class="md-ellipsis">
      or_else
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Stream.parallel" class="md-nav__link">
    <span class="md-ellipsis">
      parallel
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Stream.sequence" class="md-nav__link">
    <span class="md-ellipsis">
      sequence
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Stream.take" class="md-nav__link">
    <span class="md-ellipsis">
      take
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Stream.with_budget" class="md-nav__link">
    <span class="md-ellipsis">
      with_budget
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.AnswerPrefix" class="md-nav__link">
    <span class="md-ellipsis">
      AnswerPrefix
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Tag" class="md-nav__link">
    <span class="md-ellipsis">
      Tag
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.IPDict" class="md-nav__link">
    <span class="md-ellipsis">
      IPDict
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#documenting-a-class" class="md-nav__link">
    <span class="md-ellipsis">
      Documenting a Class
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Documenting a Class">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.Query" class="md-nav__link">
    <span class="md-ellipsis">
      Query
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Query">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.Query--customizing-prompts" class="md-nav__link">
    <span class="md-ellipsis">
      Customizing Prompts
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query--answer-modes-and-configurations" class="md-nav__link">
    <span class="md-ellipsis">
      Answer Modes and Configurations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query--allowing-multi-message-exchanges-and-tool-calls" class="md-nav__link">
    <span class="md-ellipsis">
      Allowing Multi-Message Exchanges and Tool Calls
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query--answer-prefixes" class="md-nav__link">
    <span class="md-ellipsis">
      Answer Prefixes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query--the-response-type" class="md-nav__link">
    <span class="md-ellipsis">
      The Response Type
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query--manually-overriding-the-parse-method" class="md-nav__link">
    <span class="md-ellipsis">
      Manually Overriding the parse Method
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query.globals" class="md-nav__link">
    <span class="md-ellipsis">
      globals
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query.parse" class="md-nav__link">
    <span class="md-ellipsis">
      parse
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query.query_config" class="md-nav__link">
    <span class="md-ellipsis">
      query_config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query.query_prefix" class="md-nav__link">
    <span class="md-ellipsis">
      query_prefix
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query.query_settings" class="md-nav__link">
    <span class="md-ellipsis">
      query_settings
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query.run_toplevel" class="md-nav__link">
    <span class="md-ellipsis">
      run_toplevel
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query.using" class="md-nav__link">
    <span class="md-ellipsis">
      using
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#documenting-a-class-without-members" class="md-nav__link">
    <span class="md-ellipsis">
      Documenting a Class without Members
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Documenting a Class without Members">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.Query" class="md-nav__link">
    <span class="md-ellipsis">
      Query
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Query">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.Query--customizing-prompts" class="md-nav__link">
    <span class="md-ellipsis">
      Customizing Prompts
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query--answer-modes-and-configurations" class="md-nav__link">
    <span class="md-ellipsis">
      Answer Modes and Configurations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query--allowing-multi-message-exchanges-and-tool-calls" class="md-nav__link">
    <span class="md-ellipsis">
      Allowing Multi-Message Exchanges and Tool Calls
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query--answer-prefixes" class="md-nav__link">
    <span class="md-ellipsis">
      Answer Prefixes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query--the-response-type" class="md-nav__link">
    <span class="md-ellipsis">
      The Response Type
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query--manually-overriding-the-parse-method" class="md-nav__link">
    <span class="md-ellipsis">
      Manually Overriding the parse Method
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#documenting-a-class-with-selected-members" class="md-nav__link">
    <span class="md-ellipsis">
      Documenting a Class With Selected Members
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Documenting a Class With Selected Members">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.Query" class="md-nav__link">
    <span class="md-ellipsis">
      Query
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Query">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.Query--customizing-prompts" class="md-nav__link">
    <span class="md-ellipsis">
      Customizing Prompts
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query--answer-modes-and-configurations" class="md-nav__link">
    <span class="md-ellipsis">
      Answer Modes and Configurations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query--allowing-multi-message-exchanges-and-tool-calls" class="md-nav__link">
    <span class="md-ellipsis">
      Allowing Multi-Message Exchanges and Tool Calls
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query--answer-prefixes" class="md-nav__link">
    <span class="md-ellipsis">
      Answer Prefixes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query--the-response-type" class="md-nav__link">
    <span class="md-ellipsis">
      The Response Type
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query--manually-overriding-the-parse-method" class="md-nav__link">
    <span class="md-ellipsis">
      Manually Overriding the parse Method
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query.parse_answer" class="md-nav__link">
    <span class="md-ellipsis">
      parse_answer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query.query_config" class="md-nav__link">
    <span class="md-ellipsis">
      query_config
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#documenting-a-dataclass" class="md-nav__link">
    <span class="md-ellipsis">
      Documenting a Dataclass
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Documenting a Dataclass">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.core.AttachedQuery" class="md-nav__link">
    <span class="md-ellipsis">
      AttachedQuery
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#documenting-a-function" class="md-nav__link">
    <span class="md-ellipsis">
      Documenting a Function
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Documenting a Function">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.few_shot" class="md-nav__link">
    <span class="md-ellipsis">
      few_shot
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#documenting-a-whole-module" class="md-nav__link">
    <span class="md-ellipsis">
      Documenting a whole module
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Documenting a whole module">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries" class="md-nav__link">
    <span class="md-ellipsis">
      queries
    </span>
  </a>
  
    <nav class="md-nav" aria-label="queries">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.ASSISTANT_PRIMING_STR" class="md-nav__link">
    <span class="md-ellipsis">
      ASSISTANT_PRIMING_STR
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.DEFAULT_FEEDBACK_PROMPT" class="md-nav__link">
    <span class="md-ellipsis">
      DEFAULT_FEEDBACK_PROMPT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.DEFAULT_INSTANCE_PROMPT" class="md-nav__link">
    <span class="md-ellipsis">
      DEFAULT_INSTANCE_PROMPT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.DEFAULT_INSTANCE_PROMPT_WITH_PREFIX" class="md-nav__link">
    <span class="md-ellipsis">
      DEFAULT_INSTANCE_PROMPT_WITH_PREFIX
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.ExampleSelector" class="md-nav__link">
    <span class="md-ellipsis">
      ExampleSelector
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.ParserSpec" class="md-nav__link">
    <span class="md-ellipsis">
      ParserSpec
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.ParserSpecDict" class="md-nav__link">
    <span class="md-ellipsis">
      ParserSpecDict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.QueryConfigDict" class="md-nav__link">
    <span class="md-ellipsis">
      QueryConfigDict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.REPAIR_PROMPT" class="md-nav__link">
    <span class="md-ellipsis">
      REPAIR_PROMPT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.REQUEST_OTHER_PROMPT" class="md-nav__link">
    <span class="md-ellipsis">
      REQUEST_OTHER_PROMPT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.FinalAnswer" class="md-nav__link">
    <span class="md-ellipsis">
      FinalAnswer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.GenericTextParser" class="md-nav__link">
    <span class="md-ellipsis">
      GenericTextParser
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.ProbInfo" class="md-nav__link">
    <span class="md-ellipsis">
      ProbInfo
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.Query" class="md-nav__link">
    <span class="md-ellipsis">
      Query
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Query">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.Query--customizing-prompts" class="md-nav__link">
    <span class="md-ellipsis">
      Customizing Prompts
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.Query--answer-modes-and-configurations" class="md-nav__link">
    <span class="md-ellipsis">
      Answer Modes and Configurations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.Query--allowing-multi-message-exchanges-and-tool-calls" class="md-nav__link">
    <span class="md-ellipsis">
      Allowing Multi-Message Exchanges and Tool Calls
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.Query--answer-prefixes" class="md-nav__link">
    <span class="md-ellipsis">
      Answer Prefixes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.Query--the-response-type" class="md-nav__link">
    <span class="md-ellipsis">
      The Response Type
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.Query--manually-overriding-the-parse-method" class="md-nav__link">
    <span class="md-ellipsis">
      Manually Overriding the parse Method
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.Query.globals" class="md-nav__link">
    <span class="md-ellipsis">
      globals
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.Query.parse" class="md-nav__link">
    <span class="md-ellipsis">
      parse
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.Query.query_config" class="md-nav__link">
    <span class="md-ellipsis">
      query_config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.Query.query_prefix" class="md-nav__link">
    <span class="md-ellipsis">
      query_prefix
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.Query.query_settings" class="md-nav__link">
    <span class="md-ellipsis">
      query_settings
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.Query.run_toplevel" class="md-nav__link">
    <span class="md-ellipsis">
      run_toplevel
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.Query.using" class="md-nav__link">
    <span class="md-ellipsis">
      using
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.QueryConfig" class="md-nav__link">
    <span class="md-ellipsis">
      QueryConfig
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.Response" class="md-nav__link">
    <span class="md-ellipsis">
      Response
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.TextParser" class="md-nav__link">
    <span class="md-ellipsis">
      TextParser
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.ToolRequests" class="md-nav__link">
    <span class="md-ellipsis">
      ToolRequests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.WrappedParseError" class="md-nav__link">
    <span class="md-ellipsis">
      WrappedParseError
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.answer_with" class="md-nav__link">
    <span class="md-ellipsis">
      answer_with
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.classify" class="md-nav__link">
    <span class="md-ellipsis">
      classify
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.few_shot" class="md-nav__link">
    <span class="md-ellipsis">
      few_shot
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.first_word" class="md-nav__link">
    <span class="md-ellipsis">
      first_word
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.raw_string" class="md-nav__link">
    <span class="md-ellipsis">
      raw_string
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.raw_yaml" class="md-nav__link">
    <span class="md-ellipsis">
      raw_yaml
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.select_all_examples" class="md-nav__link">
    <span class="md-ellipsis">
      select_all_examples
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.select_random_examples" class="md-nav__link">
    <span class="md-ellipsis">
      select_random_examples
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.select_with_either_tags" class="md-nav__link">
    <span class="md-ellipsis">
      select_with_either_tags
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.string_from_last_block" class="md-nav__link">
    <span class="md-ellipsis">
      string_from_last_block
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.trimmed_raw_string" class="md-nav__link">
    <span class="md-ellipsis">
      trimmed_raw_string
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.trimmed_string_from_last_block" class="md-nav__link">
    <span class="md-ellipsis">
      trimmed_string_from_last_block
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.yaml_from_last_block" class="md-nav__link">
    <span class="md-ellipsis">
      yaml_from_last_block
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="testing-mkdocs">Testing MkDocs</h1>
<!-- Takeaway: do not forget `options:` -->

<h2 id="resources-on-writing-good-docstrings">Resources on Writing Good Docstrings</h2>
<ul>
<li><a href="https://github.com/pydantic/pydantic/blob/b0175de473823f6f6927b9ecdc8998059727a086/pydantic/type_adapter.py#L68">Pydantic Example</a></li>
</ul>
<h2 id="tricks">Tricks</h2>
<ul>
<li>In docstrings, both <code>[`AttachedQuery`][delphyne.core.AttachedQuery]</code> and <code>[delphyne.core.AttachedQuery][]</code> will work but the former is better style.</li>
<li>The <code>"rewrap.autoWrap.enabled": true</code> option is pretty good for what I want to do. Also, always select before rewrapping and we should be good.</li>
<li>Start documenting each field in uppercase.</li>
</ul>
<h2 id="api-documentation-for-query">API Documentation for Query</h2>
<p>The <a class="autorefs autorefs-internal" title="Query" href="#delphyne.Query"><code>Query</code></a> class is the base class for all queries in Delphyne, providing convenient features and automatic type inference. Does it work to have partial paths (<a class="autorefs autorefs-internal" title="Query" href="#delphyne.Query"><code>Query</code></a>)?</p>
<h2 id="documenting-type-aliases">Documenting Type Aliases</h2>


<div class="doc doc-object doc-class">



<h3 id="delphyne.Stream" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">Stream</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="delphyne.core.AbstractStream">AbstractStream</span>[<span title="delphyne.stdlib.streams.Stream[T]">Stream[T]</span>]</code></p>


        <p>A search stream produced by a search policy or prompting policy.</p>
<p>This class inherits [<code>AbstractStream</code>][delphyne.AbstractStream] and supports various methods
and combinators for assembling streams, while guaranteeing adherence
to the <a href="delphyne.core.streams">search stream protocol</a>.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.Stream._generate">_generate</span></code></td>
            <td>
                  <code><span title="collections.abc.Callable">Callable</span>[[], <span title="delphyne.core.StreamGen">StreamGen</span>[<span title="delphyne.stdlib.streams.Stream[T]">Stream[T]</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A zeroary function that produces a stream generator.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/streams.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Stream</span><span class="p">[</span><span class="n">T</span><span class="p">](</span><span class="n">dp</span><span class="o">.</span><span class="n">AbstractStream</span><span class="p">[</span><span class="n">T</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A search stream produced by a search policy or prompting policy.</span>

<span class="sd">    This class inherits `AbstractStream` and supports various methods</span>
<span class="sd">    and combinators for assembling streams, while guaranteeing adherence</span>
<span class="sd">    to the [search stream protocol](delphyne.core.streams).</span>

<span class="sd">    Attributes:</span>
<span class="sd">        _generate: A zeroary function that produces a stream generator.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_generate</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">dp</span><span class="o">.</span><span class="n">StreamGen</span><span class="p">[</span><span class="n">T</span><span class="p">]]</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">gen</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">StreamGen</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate</span><span class="p">()</span>

    <span class="c1">## Collecting all elements</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">collect</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">budget</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">BudgetLimit</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">num_generated</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">Solution</span><span class="p">[</span><span class="n">T</span><span class="p">]],</span> <span class="n">dp</span><span class="o">.</span><span class="n">Budget</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Exhaust a stream and collect all generated solutions.</span>

<span class="sd">        Attributes:</span>
<span class="sd">            budget (optional): Budget limit (see `with_budget` method).</span>
<span class="sd">            num_generated (optional): Number of solutions to generate</span>
<span class="sd">                (see `take` method).</span>

<span class="sd">        Returns:</span>
<span class="sd">            A sequence of solutions along with the total spent budget.</span>

<span class="sd">        !!! warning</span>
<span class="sd">            This function must only be used at top-level and *not*</span>
<span class="sd">            within the definition of a search stream generator (in which</span>
<span class="sd">            case the consumed resources won&#39;t be accounted for in the</span>
<span class="sd">            parent stream). See `Stream.all`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">budget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_budget</span><span class="p">(</span><span class="n">budget</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_generated</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">num_generated</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stream_collect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="p">())</span>

    <span class="c1">## Transforming the stream</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_budget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">budget</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">BudgetLimit</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an identical stream that denies all spending requests</span>
<span class="sd">        once a given amount of budget is spent.</span>

<span class="sd">        **Guarantees**: if all budget spending over-estimates passed to</span>
<span class="sd">        `spend_on` are accurate, the given budget limit is rigorously</span>
<span class="sd">        respected. If not, the spent amount may exceed the budget by an</span>
<span class="sd">        amount of `Delta * N`, where `Delta` is the maximum estimation</span>
<span class="sd">        error and `N` is the concurrency level of the stream (1 if</span>
<span class="sd">        `Stream.parallel` is never used).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Stream</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">stream_with_budget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="p">(),</span> <span class="n">budget</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">take</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_generated</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">strict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an identical stream that terminates once a given number</span>
<span class="sd">        of solution is generated. If `strict` is set to `False`, more</span>
<span class="sd">        solutions can be returned, provided that no additional budget</span>
<span class="sd">        must be spent for generating them.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Stream</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">stream_take</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="p">(),</span> <span class="n">num_generated</span><span class="p">,</span> <span class="n">strict</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">loop</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">stop_on_reject</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Stream[T]&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Repeatedly execute a stream.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            n (optional): Number of times to repeat the stream. By</span>
<span class="sd">                default, the stream is repeated indefinitely.</span>
<span class="sd">            stop_on_reject: If set to `True` (default), the resulting</span>
<span class="sd">                stream stops after the first iteration during which no</span>
<span class="sd">                spending request was granted. This guarantees</span>
<span class="sd">                termination, even if `n` is `None`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">it</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Stream</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="n">stream_sequence</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gen</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">it</span><span class="p">),</span> <span class="n">stop_on_reject</span><span class="o">=</span><span class="n">stop_on_reject</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">bind</span><span class="p">[</span><span class="n">U</span><span class="p">](</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">dp</span><span class="o">.</span><span class="n">Solution</span><span class="p">[</span><span class="n">T</span><span class="p">]],</span> <span class="n">dp</span><span class="o">.</span><span class="n">StreamGen</span><span class="p">[</span><span class="n">U</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Stream[U]&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply a function to all generated solutions of a stream and</span>
<span class="sd">        concatenate the resulting streams.</span>

<span class="sd">        This is analogous to the `concat_map` funtion on lists:</span>

<span class="sd">            def concat_map(f, xs):</span>
<span class="sd">                return [y for x in xs for y in f(x)]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Stream</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">stream_bind</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="p">(),</span> <span class="n">f</span><span class="p">))</span>

    <span class="c1">## Monadic Methods</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">first</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">StreamContext</span><span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">Solution</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Obtain the first solution from a stream, or return `None` if the</span>
<span class="sd">        stream terminates without yielding any solution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">stream_first</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">all</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">StreamContext</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">Solution</span><span class="p">[</span><span class="n">T</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Obtain all solutions from a stream.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">stream_all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">next</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">StreamContext</span><span class="p">[</span>
        <span class="s2">&quot;tuple[Sequence[dp.Solution[T]], dp.Budget, Stream[T] | None]&quot;</span>
    <span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make an atomic attempt to obtain a solution from the stream,</span>
<span class="sd">        stopping right before a second spending request is made.</span>

<span class="sd">        Return a sequence of generated solutions, the total spent</span>
<span class="sd">        budget, and the remaining stream, if any.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gen</span><span class="p">,</span> <span class="n">budg</span><span class="p">,</span> <span class="n">rest</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">stream_next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="p">())</span>
        <span class="n">new_rest</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">rest</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">Stream</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">rest</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gen</span><span class="p">,</span> <span class="n">budg</span><span class="p">,</span> <span class="n">new_rest</span>

    <span class="c1">## Static Methods</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">sequence</span><span class="p">[</span><span class="n">U</span><span class="p">](</span>
        <span class="n">streams</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="s2">&quot;Stream[U]&quot;</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">stop_on_reject</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Stream[U]&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Concatenate all streams from a possibly infinite collection.</span>

<span class="sd">        If `stop_on_reject` is set to `True` (default), then the</span>
<span class="sd">        resulting stream is stopped as soon as one stream in the</span>
<span class="sd">        collection terminates without a single spending request being</span>
<span class="sd">        granted. This allows guaranteeing termination, even if an</span>
<span class="sd">        infinite collection of streams is passed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Stream</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="n">stream_sequence</span><span class="p">(</span>
                <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">gen</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">streams</span><span class="p">),</span> <span class="n">stop_on_reject</span><span class="o">=</span><span class="n">stop_on_reject</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">parallel</span><span class="p">[</span><span class="n">U</span><span class="p">](</span><span class="n">streams</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="s2">&quot;Stream[U]&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Stream[U]&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run all streams of a sequence in separate threads, possibly</span>
<span class="sd">        interleaving the resulting solutions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Stream</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">stream_parallel</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">gen</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">streams</span><span class="p">]))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">or_else</span><span class="p">[</span><span class="n">U</span><span class="p">](</span><span class="n">main</span><span class="p">:</span> <span class="s2">&quot;Stream[U]&quot;</span><span class="p">,</span> <span class="n">fallback</span><span class="p">:</span> <span class="s2">&quot;Stream[U]&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Stream[U]&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the `main` stream and, if it does not yield any solution,</span>
<span class="sd">        run the `fallback` stream.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Stream</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">stream_or_else</span><span class="p">(</span><span class="n">main</span><span class="o">.</span><span class="n">gen</span><span class="p">,</span> <span class="n">fallback</span><span class="o">.</span><span class="n">gen</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="delphyne.Stream.all" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">all</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">all</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n"><span title="delphyne.core.StreamContext">StreamContext</span></span><span class="p">[</span><span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><span title="delphyne.core.Solution">Solution</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.streams.Stream[T]">Stream[T]</span></span><span class="p">]]]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Obtain all solutions from a stream.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/streams.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">all</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">StreamContext</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">Solution</span><span class="p">[</span><span class="n">T</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Obtain all solutions from a stream.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">stream_all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.Stream.bind" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">bind</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">bind</span><span class="p">(</span><span class="n">f</span><span class="p">:</span> <span class="n"><span title="collections.abc.Callable">Callable</span></span><span class="p">[[</span><span class="n"><span title="delphyne.core.Solution">Solution</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.streams.Stream[T]">Stream[T]</span></span><span class="p">]],</span> <span class="n"><span title="delphyne.core.StreamGen">StreamGen</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.streams.Stream.bind[U]">bind[U]</span></span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Stream


  
      dataclass
   (delphyne.stdlib.streams.Stream)" href="#delphyne.Stream">Stream</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.streams.Stream.bind[U]">bind[U]</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Apply a function to all generated solutions of a stream and
concatenate the resulting streams.</p>
<p>This is analogous to the <code>concat_map</code> funtion on lists:</p>
<pre><code>def concat_map(f, xs):
    return [y for x in xs for y in f(x)]
</code></pre>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/streams.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">bind</span><span class="p">[</span><span class="n">U</span><span class="p">](</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">dp</span><span class="o">.</span><span class="n">Solution</span><span class="p">[</span><span class="n">T</span><span class="p">]],</span> <span class="n">dp</span><span class="o">.</span><span class="n">StreamGen</span><span class="p">[</span><span class="n">U</span><span class="p">]]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Stream[U]&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply a function to all generated solutions of a stream and</span>
<span class="sd">    concatenate the resulting streams.</span>

<span class="sd">    This is analogous to the `concat_map` funtion on lists:</span>

<span class="sd">        def concat_map(f, xs):</span>
<span class="sd">            return [y for x in xs for y in f(x)]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Stream</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">stream_bind</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="p">(),</span> <span class="n">f</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.Stream.collect" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">collect</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">collect</span><span class="p">(</span><span class="n">budget</span><span class="p">:</span> <span class="n"><span title="delphyne.core.BudgetLimit">BudgetLimit</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">num_generated</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="tuple">tuple</span></span><span class="p">[</span><span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><span title="delphyne.core.Solution">Solution</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.streams.Stream[T]">Stream[T]</span></span><span class="p">]],</span> <span class="n"><span title="delphyne.core.Budget">Budget</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Exhaust a stream and collect all generated solutions.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.Stream.collect.budget">budget</span></code></td>
            <td>
                  <code><span title="optional">optional</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Budget limit (see [<code>with_budget</code>][delphyne.with_budget] method).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.Stream.collect.num_generated">num_generated</span></code></td>
            <td>
                  <code><span title="optional">optional</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of solutions to generate
(see [<code>take</code>][delphyne.take] method).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="tuple">tuple</span>[<span title="collections.abc.Sequence">Sequence</span>[<span title="delphyne.core.Solution">Solution</span>[<span title="delphyne.stdlib.streams.Stream[T]">Stream[T]</span>]], <span title="delphyne.core.Budget">Budget</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A sequence of solutions along with the total spent budget.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
        <div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This function must only be used at top-level and <em>not</em>
within the definition of a search stream generator (in which
case the consumed resources won't be accounted for in the
parent stream). See <code>Stream.all</code>.</p>
</div>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/streams.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">collect</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">budget</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">BudgetLimit</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">num_generated</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">Solution</span><span class="p">[</span><span class="n">T</span><span class="p">]],</span> <span class="n">dp</span><span class="o">.</span><span class="n">Budget</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exhaust a stream and collect all generated solutions.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        budget (optional): Budget limit (see `with_budget` method).</span>
<span class="sd">        num_generated (optional): Number of solutions to generate</span>
<span class="sd">            (see `take` method).</span>

<span class="sd">    Returns:</span>
<span class="sd">        A sequence of solutions along with the total spent budget.</span>

<span class="sd">    !!! warning</span>
<span class="sd">        This function must only be used at top-level and *not*</span>
<span class="sd">        within the definition of a search stream generator (in which</span>
<span class="sd">        case the consumed resources won&#39;t be accounted for in the</span>
<span class="sd">        parent stream). See `Stream.all`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">budget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_budget</span><span class="p">(</span><span class="n">budget</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_generated</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">num_generated</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">stream_collect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.Stream.first" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">first</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">first</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n"><span title="delphyne.core.StreamContext">StreamContext</span></span><span class="p">[</span><span class="n"><span title="delphyne.core.Solution">Solution</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.streams.Stream[T]">Stream[T]</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Obtain the first solution from a stream, or return <code>None</code> if the
stream terminates without yielding any solution.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/streams.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">first</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">StreamContext</span><span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">Solution</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Obtain the first solution from a stream, or return `None` if the</span>
<span class="sd">    stream terminates without yielding any solution.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">stream_first</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.Stream.loop" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">loop</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">loop</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">stop_on_reject</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Stream


  
      dataclass
   (delphyne.stdlib.streams.Stream)" href="#delphyne.Stream">Stream</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.streams.Stream[T]">Stream[T]</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Repeatedly execute a stream.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>n</code>
            </td>
            <td>
                  <code><span title="optional">optional</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of times to repeat the stream. By
default, the stream is repeated indefinitely.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>stop_on_reject</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If set to <code>True</code> (default), the resulting
stream stops after the first iteration during which no
spending request was granted. This guarantees
termination, even if <code>n</code> is <code>None</code>.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/streams.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">loop</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">stop_on_reject</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Stream[T]&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Repeatedly execute a stream.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        n (optional): Number of times to repeat the stream. By</span>
<span class="sd">            default, the stream is repeated indefinitely.</span>
<span class="sd">        stop_on_reject: If set to `True` (default), the resulting</span>
<span class="sd">            stream stops after the first iteration during which no</span>
<span class="sd">            spending request was granted. This guarantees</span>
<span class="sd">            termination, even if `n` is `None`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">it</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Stream</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="n">stream_sequence</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gen</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">it</span><span class="p">),</span> <span class="n">stop_on_reject</span><span class="o">=</span><span class="n">stop_on_reject</span>
        <span class="p">)</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.Stream.next" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">next</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">next</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n"><span title="delphyne.core.StreamContext">StreamContext</span></span><span class="p">[</span><span class="n"><span title="tuple">tuple</span></span><span class="p">[</span><span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><span title="delphyne.core.Solution">Solution</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.streams.Stream[T]">Stream[T]</span></span><span class="p">]],</span> <span class="n"><span title="delphyne.core.Budget">Budget</span></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-internal" title="Stream


  
      dataclass
   (delphyne.stdlib.streams.Stream)" href="#delphyne.Stream">Stream</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.streams.Stream[T]">Stream[T]</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Make an atomic attempt to obtain a solution from the stream,
stopping right before a second spending request is made.</p>
<p>Return a sequence of generated solutions, the total spent
budget, and the remaining stream, if any.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/streams.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">next</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">StreamContext</span><span class="p">[</span>
    <span class="s2">&quot;tuple[Sequence[dp.Solution[T]], dp.Budget, Stream[T] | None]&quot;</span>
<span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make an atomic attempt to obtain a solution from the stream,</span>
<span class="sd">    stopping right before a second spending request is made.</span>

<span class="sd">    Return a sequence of generated solutions, the total spent</span>
<span class="sd">    budget, and the remaining stream, if any.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gen</span><span class="p">,</span> <span class="n">budg</span><span class="p">,</span> <span class="n">rest</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">stream_next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="p">())</span>
    <span class="n">new_rest</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">rest</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">Stream</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">rest</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">gen</span><span class="p">,</span> <span class="n">budg</span><span class="p">,</span> <span class="n">new_rest</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.Stream.or_else" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">or_else</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">or_else</span><span class="p">(</span><span class="n">main</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="Stream


  
      dataclass
   (delphyne.stdlib.streams.Stream)" href="#delphyne.Stream">Stream</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.streams.Stream.or_else[U]">or_else[U]</span></span><span class="p">],</span> <span class="n">fallback</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="Stream


  
      dataclass
   (delphyne.stdlib.streams.Stream)" href="#delphyne.Stream">Stream</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.streams.Stream.or_else[U]">or_else[U]</span></span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Stream


  
      dataclass
   (delphyne.stdlib.streams.Stream)" href="#delphyne.Stream">Stream</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.streams.Stream.or_else[U]">or_else[U]</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Run the <code>main</code> stream and, if it does not yield any solution,
run the <code>fallback</code> stream.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/streams.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">or_else</span><span class="p">[</span><span class="n">U</span><span class="p">](</span><span class="n">main</span><span class="p">:</span> <span class="s2">&quot;Stream[U]&quot;</span><span class="p">,</span> <span class="n">fallback</span><span class="p">:</span> <span class="s2">&quot;Stream[U]&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Stream[U]&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run the `main` stream and, if it does not yield any solution,</span>
<span class="sd">    run the `fallback` stream.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Stream</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">stream_or_else</span><span class="p">(</span><span class="n">main</span><span class="o">.</span><span class="n">gen</span><span class="p">,</span> <span class="n">fallback</span><span class="o">.</span><span class="n">gen</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.Stream.parallel" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">parallel</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">parallel</span><span class="p">(</span><span class="n">streams</span><span class="p">:</span> <span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="Stream


  
      dataclass
   (delphyne.stdlib.streams.Stream)" href="#delphyne.Stream">Stream</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.streams.Stream.parallel[U]">parallel[U]</span></span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Stream


  
      dataclass
   (delphyne.stdlib.streams.Stream)" href="#delphyne.Stream">Stream</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.streams.Stream.parallel[U]">parallel[U]</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Run all streams of a sequence in separate threads, possibly
interleaving the resulting solutions.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/streams.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">parallel</span><span class="p">[</span><span class="n">U</span><span class="p">](</span><span class="n">streams</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="s2">&quot;Stream[U]&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Stream[U]&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run all streams of a sequence in separate threads, possibly</span>
<span class="sd">    interleaving the resulting solutions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Stream</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">stream_parallel</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">gen</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">streams</span><span class="p">]))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.Stream.sequence" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">sequence</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">sequence</span><span class="p">(</span><span class="n">streams</span><span class="p">:</span> <span class="n"><span title="collections.abc.Iterable">Iterable</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="Stream


  
      dataclass
   (delphyne.stdlib.streams.Stream)" href="#delphyne.Stream">Stream</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.streams.Stream.sequence[U]">sequence[U]</span></span><span class="p">]],</span> <span class="o">*</span><span class="p">,</span> <span class="n">stop_on_reject</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Stream


  
      dataclass
   (delphyne.stdlib.streams.Stream)" href="#delphyne.Stream">Stream</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.streams.Stream.sequence[U]">sequence[U]</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Concatenate all streams from a possibly infinite collection.</p>
<p>If <code>stop_on_reject</code> is set to <code>True</code> (default), then the
resulting stream is stopped as soon as one stream in the
collection terminates without a single spending request being
granted. This allows guaranteeing termination, even if an
infinite collection of streams is passed.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/streams.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">sequence</span><span class="p">[</span><span class="n">U</span><span class="p">](</span>
    <span class="n">streams</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="s2">&quot;Stream[U]&quot;</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">stop_on_reject</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Stream[U]&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Concatenate all streams from a possibly infinite collection.</span>

<span class="sd">    If `stop_on_reject` is set to `True` (default), then the</span>
<span class="sd">    resulting stream is stopped as soon as one stream in the</span>
<span class="sd">    collection terminates without a single spending request being</span>
<span class="sd">    granted. This allows guaranteeing termination, even if an</span>
<span class="sd">    infinite collection of streams is passed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Stream</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="n">stream_sequence</span><span class="p">(</span>
            <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">gen</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">streams</span><span class="p">),</span> <span class="n">stop_on_reject</span><span class="o">=</span><span class="n">stop_on_reject</span>
        <span class="p">)</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.Stream.take" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">take</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">take</span><span class="p">(</span><span class="n">num_generated</span><span class="p">:</span> <span class="n"><span title="int">int</span></span><span class="p">,</span> <span class="n">strict</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Return an identical stream that terminates once a given number
of solution is generated. If <code>strict</code> is set to <code>False</code>, more
solutions can be returned, provided that no additional budget
must be spent for generating them.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/streams.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">take</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_generated</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">strict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return an identical stream that terminates once a given number</span>
<span class="sd">    of solution is generated. If `strict` is set to `False`, more</span>
<span class="sd">    solutions can be returned, provided that no additional budget</span>
<span class="sd">    must be spent for generating them.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Stream</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">stream_take</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="p">(),</span> <span class="n">num_generated</span><span class="p">,</span> <span class="n">strict</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.Stream.with_budget" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">with_budget</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">with_budget</span><span class="p">(</span><span class="n">budget</span><span class="p">:</span> <span class="n"><span title="delphyne.core.BudgetLimit">BudgetLimit</span></span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Return an identical stream that denies all spending requests
once a given amount of budget is spent.</p>
<p><strong>Guarantees</strong>: if all budget spending over-estimates passed to
[<code>spend_on</code>][delphyne.spend_on] are accurate, the given budget limit is rigorously
respected. If not, the spent amount may exceed the budget by an
amount of <code>Delta * N</code>, where <code>Delta</code> is the maximum estimation
error and <code>N</code> is the concurrency level of the stream (1 if
<code>Stream.parallel</code> is never used).</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/streams.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">with_budget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">budget</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">BudgetLimit</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return an identical stream that denies all spending requests</span>
<span class="sd">    once a given amount of budget is spent.</span>

<span class="sd">    **Guarantees**: if all budget spending over-estimates passed to</span>
<span class="sd">    `spend_on` are accurate, the given budget limit is rigorously</span>
<span class="sd">    respected. If not, the spent amount may exceed the budget by an</span>
<span class="sd">    amount of `Delta * N`, where `Delta` is the maximum estimation</span>
<span class="sd">    error and `N` is the concurrency level of the stream (1 if</span>
<span class="sd">    `Stream.parallel` is never used).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Stream</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">stream_with_budget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="p">(),</span> <span class="n">budget</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="delphyne.AnswerPrefix" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">AnswerPrefix</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">AnswerPrefix</span><span class="p">:</span> <span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><span title="delphyne.core.chats.AnswerPrefixElement">AnswerPrefixElement</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>An LLM chat history, to be passed to a query as an answer prefix (see
<code>Query.query_prefix</code>).</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="delphyne.Tag" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">Tag</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">Tag</span><span class="p">:</span> <span class="n"><span title="str">str</span></span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>String tags for nodes and spaces.</p>
<p>Nodes and spaces can be assigned string identifiers, which may be
referenced in demonstration tests or when defining inner policies
(e.g., <a class="autorefs autorefs-internal" title="IPDict" href="#delphyne.IPDict"><code>IPDict</code></a>). Tags should contain only alphanumeric characters,
underscores, dots, and dashes.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="delphyne.IPDict" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">IPDict</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">IPDict</span><span class="p">:</span> <span class="n"><span title="collections.abc.Mapping">Mapping</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.policies.Policy">Policy</span></span><span class="p">[</span><span class="n"><span title="typing.Any">Any</span></span><span class="p">,</span> <span class="n"><span title="typing.Any">Any</span></span><span class="p">]</span> <span class="o">|</span> <span class="n"><span title="delphyne.stdlib.policies.PromptingPolicy">PromptingPolicy</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Type of an Inner-Policy Dictionary.</p>
<p>Inner-Policy dictionaries allow to define strategies in a more concise
way in exchange for less static type safety.</p>
<p>Normally, an <em>inner policy type</em> must be defined for every strategy, and
opaque spaces are created from queries or strategy by passing the
<code>using</code> method a mapping from the ambient inner policy to a proper
sub-policy, often in the form of an anonymous function:</p>
<pre><code>@dataclass class MyInnerPolicy:
    foo: PromptingPolicy # etc

def my_strategy() -&gt; Strategy[Branch, MyInnerPolicy, str]:
    x = yield from branch(Foo().using(lambda p: p.foo)) # etc
</code></pre>
<p>As an alternative, one can have a strategy use an inner policy
dictionary, by passing ellipses (<code>...</code>) to the <code>using</code> method:</p>
<pre><code>def my_strategy() -&gt; Strategy[Branch, IPDict, str]:
    x = yield from branch(Foo().using(...)) # etc
</code></pre>
<p>When doing so, a simple Python dictionary can be used as an inner
policy, whose keys are space tags (the same tags can be referenced in
demonstration tests). In the example above, and since a spaces induced
by a query inherits its name as a tag by default, one can define an
inner policy for <code>my_strategy</code> as:</p>
<pre><code>{"Foo": foo_prompting_policy, ...}
</code></pre>
<p>A conjunction of tags can also be specified, separated by <code>&amp;</code> (without
spaces). For example, <code>{"tag1&amp;tag2": pp, ...}</code> associates prompting
policies <code>pp</code> to spaces with both tags <code>tag1</code> and <code>tag2</code>. New tags can
be added to a space builder using the <code>SpaceBuilder.tagged</code> method.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>If several entries of the inner policy dictionary apply for a given
instance of <code>.using(...)</code>, a runtime error is raised.</p>
</div>
<p>See <code>tests/example_strategies:generate_number</code> for another example.</p>

    </div>

</div><h2 id="documenting-a-class">Documenting a Class</h2>


<div class="doc doc-object doc-class">



<h3 id="delphyne.Query" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">Query</span>


</h3>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="delphyne.core.AbstractQuery">AbstractQuery</span>[<span title="delphyne.stdlib.queries.Query[T]">Query[T]</span>]</code></p>


        <p>Base class for queries.</p>
<p>This class adds standard convenience features on top of
[<code>AbstractQuery</code>][delphyne.AbstractQuery], using reflection to allow queries to be defined
concisely. Here is a simple example of a query type definition:</p>
<pre><code>@dataclass class MakeSum(Query[list[int]]):
    ''' Given a list of allowed numbers and a target number, you
    must find a sub-list whose elements sum up to the target.
    Just answer with a list of numbers as a JSON object and
    nothing else. '''

    allowed: list[int] target: int
</code></pre>
<p>In general, a query type is a dataclass that inherits <code>Query[T]</code>,
where <code>T</code> is the query's answer type. In the example above, no
parser is specified and so oracles are requested to provide
structured answers as JSON objects, which are automatically parsed
into the answer type (<code>list[int]</code>) using pydantic. Assuming that no
Jinja prompt file is provided, the docstring is used as a system
prompt and instance prompts are generated by simply serializing
<code>MakeSum</code> instances into YAML.</p>
<h6 id="delphyne.Query--customizing-prompts">Customizing Prompts</h6>
<p>System and instance prompts can be specified via Jinja templates.
The templates manager ([<code>TemplatesManager</code>][delphyne.TemplatesManager]) looks for templates named
"<QueryName>.<instance|system>.jinja". Templates can also be
provided by defining the <code>__system_prompt__</code> and/or <code>__instance_prompt__</code>
class attributes. If none of these are provided, the query's
docstring is used as a system prompt and <code>DEFAULT_INSTANCE_PROMPT</code>
is used as an instance prompt template.</p>
<p>The following arguments are usually made available to templates
(although specific prompting policies can add more):</p>
<ul>
<li><code>query</code>: the query instance.</li>
<li><code>mode</code>: the requested answer mode.</li>
<li><code>params</code>: the query hyperparameters (e.g., as passed to <a class="autorefs autorefs-internal" href="#delphyne.few_shot"><code>few_shot</code></a>)</li>
</ul>
<h6 id="delphyne.Query--answer-modes-and-configurations">Answer Modes and Configurations</h6>
<p>A query can define several answer modes ([<code>AnswerMode</code>][delphyne.AnswerMode]), each of
which can be associated with a different parser and set of settings.
By default, the only answer mode is <code>None</code>. More answer modes can be
defined by setting class variable <code>__modes__</code>.</p>
<p>The <code>query_config</code> method maps modes to configurations (i.e., a set
of settings, including a parser specification). Its default behavior
works by inspecting the <code>__parser__</code> and <code>__config__</code> class
attributes and does not typically require overriding.</p>
<h6 id="delphyne.Query--allowing-multi-message-exchanges-and-tool-calls">Allowing Multi-Message Exchanges and Tool Calls</h6>
<p>A common pattern for interacting with LLMs is to have multi-message
exchanges where the full conversation history is resent repeatedly.
LLMs are also often allowed to request tool call. This interaction
pattern is implemented in the [<code>interact</code>][delphyne.interact] standard strategy. It is
enabled by several features on the <a class="autorefs autorefs-internal" title="Query" href="#delphyne.Query"><code>Query</code></a> side.</p>
<h6 id="delphyne.Query--answer-prefixes">Answer Prefixes</h6>
<p>If a query type has a prefix attribute with type <a class="autorefs autorefs-internal" title="AnswerPrefix" href="#delphyne.AnswerPrefix"><code>AnswerPrefix</code></a>,
this attribute can be used to provide a chat history, to be added to
the query's prompt.</p>
<h6 id="delphyne.Query--the-response-type">The <a class="autorefs autorefs-internal" title="Response


  
      dataclass
  " href="#delphyne.stdlib.queries.Response"><code>Response</code></a> Type</h6>
<p>If the query answer type is <a class="autorefs autorefs-internal" title="Response


  
      dataclass
  " href="#delphyne.stdlib.queries.Response"><code>Response</code></a>, the query does not only
return a parsed answer, but also the LLM raw answer (which can be
appended to a chat history), and possibly a sequence of tool calls.</p>
<h6 id="delphyne.Query--manually-overriding-the-parse-method">Manually Overriding the [<code>parse</code>][delphyne.parse] Method</h6>
<p>For advanced use cases, it is possible to directly override the
[<code>parse</code>][delphyne.parse] method that turns an answer into an object of type <code>T</code>. When
this is done, the <code>__config__</code> and <code>__parser__</code> class attributes
must not be set. Also, the <code>query_settings</code> method always returns
the default settings instead of relying on <code>query_config</code> and must
be overriden if another behavior is desired.</p>







              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Query</span><span class="p">[</span><span class="n">T</span><span class="p">](</span><span class="n">dp</span><span class="o">.</span><span class="n">AbstractQuery</span><span class="p">[</span><span class="n">T</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for queries.</span>

<span class="sd">    This class adds standard convenience features on top of</span>
<span class="sd">    `AbstractQuery`, using reflection to allow queries to be defined</span>
<span class="sd">    concisely. Here is a simple example of a query type definition:</span>

<span class="sd">        @dataclass class MakeSum(Query[list[int]]):</span>
<span class="sd">            &#39;&#39;&#39; Given a list of allowed numbers and a target number, you</span>
<span class="sd">            must find a sub-list whose elements sum up to the target.</span>
<span class="sd">            Just answer with a list of numbers as a JSON object and</span>
<span class="sd">            nothing else. &#39;&#39;&#39;</span>

<span class="sd">            allowed: list[int] target: int</span>

<span class="sd">    In general, a query type is a dataclass that inherits `Query[T]`,</span>
<span class="sd">    where `T` is the query&#39;s answer type. In the example above, no</span>
<span class="sd">    parser is specified and so oracles are requested to provide</span>
<span class="sd">    structured answers as JSON objects, which are automatically parsed</span>
<span class="sd">    into the answer type (`list[int]`) using pydantic. Assuming that no</span>
<span class="sd">    Jinja prompt file is provided, the docstring is used as a system</span>
<span class="sd">    prompt and instance prompts are generated by simply serializing</span>
<span class="sd">    `MakeSum` instances into YAML.</span>

<span class="sd">    ### Customizing Prompts</span>

<span class="sd">    System and instance prompts can be specified via Jinja templates.</span>
<span class="sd">    The templates manager (`TemplatesManager`) looks for templates named</span>
<span class="sd">    &quot;&lt;QueryName&gt;.&lt;instance|system&gt;.jinja&quot;. Templates can also be</span>
<span class="sd">    provided by defining the `__system_prompt__` and/or `__instance_prompt__`</span>
<span class="sd">    class attributes. If none of these are provided, the query&#39;s</span>
<span class="sd">    docstring is used as a system prompt and `DEFAULT_INSTANCE_PROMPT`</span>
<span class="sd">    is used as an instance prompt template.</span>

<span class="sd">    The following arguments are usually made available to templates</span>
<span class="sd">    (although specific prompting policies can add more):</span>

<span class="sd">    - `query`: the query instance.</span>
<span class="sd">    - `mode`: the requested answer mode.</span>
<span class="sd">    - `params`: the query hyperparameters (e.g., as passed to `few_shot`)</span>

<span class="sd">    ### Answer Modes and Configurations</span>

<span class="sd">    A query can define several answer modes (`AnswerMode`), each of</span>
<span class="sd">    which can be associated with a different parser and set of settings.</span>
<span class="sd">    By default, the only answer mode is `None`. More answer modes can be</span>
<span class="sd">    defined by setting class variable `__modes__`.</span>

<span class="sd">    The `query_config` method maps modes to configurations (i.e., a set</span>
<span class="sd">    of settings, including a parser specification). Its default behavior</span>
<span class="sd">    works by inspecting the `__parser__` and `__config__` class</span>
<span class="sd">    attributes and does not typically require overriding.</span>

<span class="sd">    ### Allowing Multi-Message Exchanges and Tool Calls</span>

<span class="sd">    A common pattern for interacting with LLMs is to have multi-message</span>
<span class="sd">    exchanges where the full conversation history is resent repeatedly.</span>
<span class="sd">    LLMs are also often allowed to request tool call. This interaction</span>
<span class="sd">    pattern is implemented in the `interact` standard strategy. It is</span>
<span class="sd">    enabled by several features on the `Query` side.</span>

<span class="sd">    #### Answer Prefixes</span>

<span class="sd">    If a query type has a prefix attribute with type `AnswerPrefix`,</span>
<span class="sd">    this attribute can be used to provide a chat history, to be added to</span>
<span class="sd">    the query&#39;s prompt.</span>

<span class="sd">    #### The `Response` Type</span>

<span class="sd">    If the query answer type is `Response`, the query does not only</span>
<span class="sd">    return a parsed answer, but also the LLM raw answer (which can be</span>
<span class="sd">    appended to a chat history), and possibly a sequence of tool calls.</span>

<span class="sd">    ### Manually Overriding the `parse` Method</span>

<span class="sd">    For advanced use cases, it is possible to directly override the</span>
<span class="sd">    `parse` method that turns an answer into an object of type `T`. When</span>
<span class="sd">    this is done, the `__config__` and `__parser__` class attributes</span>
<span class="sd">    must not be set. Also, the `query_settings` method always returns</span>
<span class="sd">    the default settings instead of relying on `query_config` and must</span>
<span class="sd">    be overriden if another behavior is desired.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__modes__</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">AnswerMode</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">__parser__</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">ParserSpec</span> <span class="o">|</span> <span class="n">ParserSpecDict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">__config__</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">QueryConfig</span> <span class="o">|</span> <span class="n">QueryConfigDict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">### Inspection methods</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">query_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">AnswerMode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QueryConfig</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Map modes to configurations.</span>

<span class="sd">        This method inspects the `__config__` and `__parser__` class</span>
<span class="sd">        attributes (none or either can be set but not both).</span>

<span class="sd">        - If no attribute is set, the default configuration is used for</span>
<span class="sd">              all modes, which uses the `&quot;structured&quot;` parser.</span>
<span class="sd">        - If `__config__` is set to a `QueryConfig`, this configuration</span>
<span class="sd">              is used for all modes.</span>
<span class="sd">        - Alternatively, `__config__` can be set to a dictionary mapping</span>
<span class="sd">              modes to configurations.</span>
<span class="sd">        - If `__parser__` is set to a parser specification, the default</span>
<span class="sd">              configuration is used for all modes, *except* that the</span>
<span class="sd">              provided parser is used instead of the default one.</span>
<span class="sd">        - Alternatively, `__parser__` can also be set to a dictionary.</span>

<span class="sd">        In the special case where the `parse` method is overriden and</span>
<span class="sd">        only in this case, return `None` after ensuring that</span>
<span class="sd">        `__config__` and `__parser__` are not set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">parse_overriden</span> <span class="o">=</span> <span class="n">dpi</span><span class="o">.</span><span class="n">is_method_overridden</span><span class="p">(</span><span class="n">Query</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;parse&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parse_overriden</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__config__</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">assert</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__parser__</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__config__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parser__</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="p">(</span>
                <span class="s2">&quot;Cannot have both __config__ and __parser__ attributes.&quot;</span>
            <span class="p">)</span>
            <span class="n">config_attr</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__config__</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config_attr</span><span class="p">,</span> <span class="n">QueryConfig</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">config_attr</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config_attr</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">config_attr</span><span class="p">)[</span><span class="n">mode</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__parser__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parser_attr</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__parser__</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parser_attr</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
                <span class="n">parser</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">parser_attr</span><span class="p">)[</span><span class="n">mode</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parser</span> <span class="o">=</span> <span class="n">parser_attr</span>
            <span class="n">_check_valid_parser_spec</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">QueryConfig</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">QueryConfig</span><span class="p">(</span><span class="s2">&quot;structured&quot;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_decomposed_answer_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_DecomposedAnswerType</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_DecomposedAnswerType</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_answer_type</span><span class="p">())</span>

    <span class="c1">### Parsing Answers</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">parse_answer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">answer</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">Answer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span> <span class="o">|</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">answer</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_modes</span><span class="p">(),</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unknown mode: </span><span class="si">{</span><span class="n">answer</span><span class="o">.</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">e</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">answer</span><span class="p">:</span> <span class="n">Answer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A more convenient method to override instead of `parse_answer`.</span>

<span class="sd">        Raises `ParseError`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Decompose the specified answer type</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_config</span><span class="p">(</span><span class="n">answer</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">parser</span>
        <span class="n">ans_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decomposed_answer_type</span><span class="p">()</span>

        <span class="c1"># Compute base parsing function `parser`</span>
        <span class="n">parser</span><span class="p">:</span> <span class="n">_ParsingFunction</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="s2">&quot;structured&quot;</span><span class="p">:</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">_from_structured</span><span class="p">(</span><span class="n">ans_type</span><span class="o">.</span><span class="n">to_parse</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">attr</span> <span class="o">==</span> <span class="s2">&quot;final_tool_call&quot;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ans_type</span><span class="o">.</span><span class="n">to_parse</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">_from_final_tool_call</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="nb">type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">ans_type</span><span class="o">.</span><span class="n">to_parse</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">callable</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">attr</span><span class="p">)</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="n">nargs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">nargs</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">nargs</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="n">nargs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">parser</span> <span class="o">=</span> <span class="n">_from_text_parser</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parser</span> <span class="o">=</span> <span class="n">_from_generic_text_parser</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">ans_type</span><span class="o">.</span><span class="n">to_parse</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ans_type</span><span class="o">.</span><span class="n">wrap_parse_errors</span><span class="p">():</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">_wrap_parse_errors</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>

        <span class="c1"># If the answer type has form `Response[..., ...]`</span>
        <span class="k">if</span> <span class="n">ans_type</span><span class="o">.</span><span class="n">resp</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_has_final_tool_call</span><span class="p">(</span><span class="n">ans_type</span><span class="p">,</span> <span class="n">answer</span><span class="p">):</span>
                <span class="n">tcs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tcs</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">_parse_tool_call</span><span class="p">(</span><span class="n">ans_type</span><span class="o">.</span><span class="n">resp</span><span class="o">.</span><span class="n">tools</span><span class="p">,</span> <span class="n">tc</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">answer</span><span class="o">.</span><span class="n">tool_calls</span>
                <span class="p">]</span>
            <span class="k">if</span> <span class="n">tcs</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">Response</span><span class="p">(</span><span class="n">answer</span><span class="p">,</span> <span class="n">ToolRequests</span><span class="p">(</span><span class="n">tcs</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">Response</span><span class="p">(</span><span class="n">answer</span><span class="p">,</span> <span class="n">FinalAnswer</span><span class="p">(</span><span class="n">parser</span><span class="p">(</span><span class="n">answer</span><span class="p">))))</span>

        <span class="k">return</span> <span class="n">parser</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>

    <span class="c1">### Query Settings</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">query_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">AnswerMode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">QuerySettings</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the settings associated with the query.</span>

<span class="sd">        By default, this method uses the result of `query_config` to</span>
<span class="sd">        determine settings if `parse` is not overriden, and the default</span>
<span class="sd">        set of settings otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_config</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># `parse` is overriden</span>
            <span class="k">return</span> <span class="n">dp</span><span class="o">.</span><span class="n">QuerySettings</span><span class="p">(</span><span class="n">structured_output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">structured_output</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">parser</span> <span class="o">==</span> <span class="s2">&quot;structured&quot;</span><span class="p">:</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decomposed_answer_type</span><span class="p">()</span><span class="o">.</span><span class="n">final</span>
            <span class="n">structured_output</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">StructuredOutputSettings</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">tool_types</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_tools</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">parser</span><span class="p">):</span>
            <span class="n">tools</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">ToolSettings</span><span class="p">(</span>
                <span class="n">tool_types</span><span class="p">,</span> <span class="n">force_tool_call</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">parser</span> <span class="o">==</span> <span class="s2">&quot;final_tool_call&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">dp</span><span class="o">.</span><span class="n">QuerySettings</span><span class="p">(</span>
            <span class="n">structured_output</span><span class="o">=</span><span class="n">structured_output</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_structured_output_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypeAnnot</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="n">ty</span><span class="o">.</span><span class="n">NoTypeInfo</span><span class="p">:</span>
        <span class="n">decomposed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decomposed_answer_type</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">decomposed</span><span class="o">.</span><span class="n">final</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_query_tools</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">:</span> <span class="n">ParserSpec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
        <span class="n">ans_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decomposed_answer_type</span><span class="p">()</span>
        <span class="n">tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">ans_type</span><span class="o">.</span><span class="n">resp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tools</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">ans_type</span><span class="o">.</span><span class="n">resp</span><span class="o">.</span><span class="n">tools</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">parser</span> <span class="o">==</span> <span class="s2">&quot;final_tool_call&quot;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ans_type</span><span class="o">.</span><span class="n">final</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span>
            <span class="n">tools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ans_type</span><span class="o">.</span><span class="n">final</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tools</span>

    <span class="c1">### Query Prefixes</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_has_special_prefix_attr</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">annots</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">get_type_hints</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;prefix&quot;</span> <span class="ow">in</span> <span class="n">annots</span> <span class="ow">and</span> <span class="n">annots</span><span class="p">[</span><span class="s2">&quot;prefix&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="n">ct</span><span class="o">.</span><span class="n">AnswerPrefix</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">query_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ct</span><span class="o">.</span><span class="n">AnswerPrefix</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the value of the `prefix` attribute if it has type</span>
<span class="sd">        annotation `AnswerPrefix` or return `None`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_special_prefix_attr</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;prefix&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1">### Producing Prompts</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_prompt</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">kind</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;instance&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">AnswerMode</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">],</span>
        <span class="n">extra_args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">env</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">TemplatesManager</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">env</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">_no_prompt_manager_error</span><span class="p">()</span>
        <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="p">,</span>
            <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="n">mode</span><span class="p">,</span>
            <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">params</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">extra_args</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extra_args</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">glob</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">globals</span><span class="p">())</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s2">&quot;globals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">glob</span>
        <span class="k">return</span> <span class="n">env</span><span class="o">.</span><span class="n">prompt</span><span class="p">(</span>
            <span class="n">query_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">query_name</span><span class="p">(),</span>
            <span class="n">prompt_kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span>
            <span class="n">template_args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
            <span class="n">default_template</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_default_prompt</span><span class="p">(</span><span class="n">kind</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_default_prompt</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">kind</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;instance&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">attr_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;__</span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="s2">_prompt__&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;instance&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_has_special_prefix_attr</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">DEFAULT_INSTANCE_PROMPT_WITH_PREFIX</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">DEFAULT_INSTANCE_PROMPT</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;system&quot;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">doc</span> <span class="o">:=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="bp">cls</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">doc</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;feedback&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DEFAULT_FEEDBACK_PROMPT</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">globals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return global objects accessible in prompts via the `globals`</span>
<span class="sd">        attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1">### Other Simple Overrides</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">serialize_args</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">],</span> <span class="n">ty</span><span class="o">.</span><span class="n">pydantic_dump</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_answer_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypeAnnot</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">dpi</span><span class="o">.</span><span class="n">first_parameter_of_base_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">answer_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypeAnnot</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_answer_type</span><span class="p">()</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">finite_answer_set</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">Answer</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># We handle the special case where the return type is a literal</span>
        <span class="c1"># type that is a subtype of str.</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_type</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">:=</span> <span class="n">_match_string_literal_type</span><span class="p">(</span><span class="n">ans</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">Answer</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">res</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">query_modes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">AnswerMode</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__modes__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__modes__</span>
        <span class="k">return</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>

    <span class="c1">### Generating Opaque Spaces</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">using</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_policy</span><span class="p">:</span> <span class="n">EllipsisType</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Opaque</span><span class="p">[</span><span class="n">IPDict</span><span class="p">,</span> <span class="n">T</span><span class="p">]:</span> <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">using</span><span class="p">[</span><span class="n">P</span><span class="p">](</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">get_policy</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">P</span><span class="p">],</span> <span class="n">pol</span><span class="o">.</span><span class="n">PromptingPolicy</span><span class="p">]</span> <span class="o">|</span> <span class="n">EllipsisType</span><span class="p">,</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="n">inner_policy_type</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">P</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Opaque</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">]:</span> <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">using</span><span class="p">[</span><span class="n">P</span><span class="p">](</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">get_policy</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">P</span><span class="p">],</span> <span class="n">pol</span><span class="o">.</span><span class="n">PromptingPolicy</span><span class="p">]</span> <span class="o">|</span> <span class="n">EllipsisType</span><span class="p">,</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="n">inner_policy_type</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">P</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Opaque</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Turn a query into an opaque space by providing a mapping from</span>
<span class="sd">        the ambient inner policy to a prompting policy.</span>

<span class="sd">        Attributes:</span>
<span class="sd">            get_policy: A function that maps the ambient inner policy to</span>
<span class="sd">                a prompting policy to use for answering the query.</span>
<span class="sd">                Alternatively, if the ellipsis value `...` is passed, the</span>
<span class="sd">                inner policy type is assumed to be `IPDict`, and</span>
<span class="sd">                prompting policies are automatically selected using tags</span>
<span class="sd">                (see `IPDict` documentation).</span>
<span class="sd">            inner_policy_type: Ambient inner policy type. This information</span>
<span class="sd">                is not used at runtime but it can be provided to help type</span>
<span class="sd">                inference when necessary.</span>

<span class="sd">        The optional `inner_policy_type` argument is ignored at runtime</span>
<span class="sd">        and can be used to help type checkers infer the type of the</span>
<span class="sd">        ambient inner policy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">get_policy</span><span class="p">,</span> <span class="n">EllipsisType</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">OpaqueSpace</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">]</span><span class="o">.</span><span class="n">from_query</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">cast</span><span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">pol</span><span class="o">.</span><span class="n">dict_subpolicy</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">OpaqueSpace</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">]</span><span class="o">.</span><span class="n">from_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">get_policy</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_toplevel</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">env</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">PolicyEnv</span><span class="p">,</span>
        <span class="n">policy</span><span class="p">:</span> <span class="n">pol</span><span class="o">.</span><span class="n">PromptingPolicy</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Stream</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Obtain a search stream of query answers, given a prompting</span>
<span class="sd">        policy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">attached</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">spawn_standalone_query</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">policy</span><span class="p">(</span><span class="n">attached</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="delphyne.Query.globals" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">globals</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">globals</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n"><span title="dict">dict</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="object">object</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Return global objects accessible in prompts via the [<code>globals</code>][delphyne.globals]
attribute.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">globals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return global objects accessible in prompts via the `globals`</span>
<span class="sd">    attribute.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.Query.parse" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">parse</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">parse</span><span class="p">(</span><span class="n">answer</span><span class="p">:</span> <span class="n"><span title="delphyne.core.refs.Answer">Answer</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="delphyne.stdlib.queries.Query[T]">Query[T]</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>A more convenient method to override instead of <code>parse_answer</code>.</p>
<p>Raises [<code>ParseError</code>][delphyne.ParseError].</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">answer</span><span class="p">:</span> <span class="n">Answer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A more convenient method to override instead of `parse_answer`.</span>

<span class="sd">    Raises `ParseError`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Decompose the specified answer type</span>
    <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_config</span><span class="p">(</span><span class="n">answer</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="n">attr</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">parser</span>
    <span class="n">ans_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decomposed_answer_type</span><span class="p">()</span>

    <span class="c1"># Compute base parsing function `parser`</span>
    <span class="n">parser</span><span class="p">:</span> <span class="n">_ParsingFunction</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="s2">&quot;structured&quot;</span><span class="p">:</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">_from_structured</span><span class="p">(</span><span class="n">ans_type</span><span class="o">.</span><span class="n">to_parse</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">attr</span> <span class="o">==</span> <span class="s2">&quot;final_tool_call&quot;</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ans_type</span><span class="o">.</span><span class="n">to_parse</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">_from_final_tool_call</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="nb">type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">ans_type</span><span class="o">.</span><span class="n">to_parse</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">callable</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">attr</span><span class="p">)</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="n">nargs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">nargs</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">nargs</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">nargs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">_from_text_parser</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">_from_generic_text_parser</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">ans_type</span><span class="o">.</span><span class="n">to_parse</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ans_type</span><span class="o">.</span><span class="n">wrap_parse_errors</span><span class="p">():</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">_wrap_parse_errors</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>

    <span class="c1"># If the answer type has form `Response[..., ...]`</span>
    <span class="k">if</span> <span class="n">ans_type</span><span class="o">.</span><span class="n">resp</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_has_final_tool_call</span><span class="p">(</span><span class="n">ans_type</span><span class="p">,</span> <span class="n">answer</span><span class="p">):</span>
            <span class="n">tcs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tcs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">_parse_tool_call</span><span class="p">(</span><span class="n">ans_type</span><span class="o">.</span><span class="n">resp</span><span class="o">.</span><span class="n">tools</span><span class="p">,</span> <span class="n">tc</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">answer</span><span class="o">.</span><span class="n">tool_calls</span>
            <span class="p">]</span>
        <span class="k">if</span> <span class="n">tcs</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">Response</span><span class="p">(</span><span class="n">answer</span><span class="p">,</span> <span class="n">ToolRequests</span><span class="p">(</span><span class="n">tcs</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">Response</span><span class="p">(</span><span class="n">answer</span><span class="p">,</span> <span class="n">FinalAnswer</span><span class="p">(</span><span class="n">parser</span><span class="p">(</span><span class="n">answer</span><span class="p">))))</span>

    <span class="k">return</span> <span class="n">parser</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.Query.query_config" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">query_config</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">query_config</span><span class="p">(</span><span class="n">mode</span><span class="p">:</span> <span class="n"><span title="delphyne.core.AnswerMode">AnswerMode</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="QueryConfig


  
      dataclass
   (delphyne.stdlib.queries.QueryConfig)" href="#delphyne.stdlib.queries.QueryConfig">QueryConfig</a></span> <span class="o">|</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Map modes to configurations.</p>
<p>This method inspects the <code>__config__</code> and <code>__parser__</code> class
attributes (none or either can be set but not both).</p>
<ul>
<li>If no attribute is set, the default configuration is used for
      all modes, which uses the <code>"structured"</code> parser.</li>
<li>If <code>__config__</code> is set to a <code>QueryConfig</code>, this configuration
      is used for all modes.</li>
<li>Alternatively, <code>__config__</code> can be set to a dictionary mapping
      modes to configurations.</li>
<li>If <code>__parser__</code> is set to a parser specification, the default
      configuration is used for all modes, <em>except</em> that the
      provided parser is used instead of the default one.</li>
<li>Alternatively, <code>__parser__</code> can also be set to a dictionary.</li>
</ul>
<p>In the special case where the [<code>parse</code>][delphyne.parse] method is overriden and
only in this case, return <code>None</code> after ensuring that
<code>__config__</code> and <code>__parser__</code> are not set.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">query_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">AnswerMode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QueryConfig</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Map modes to configurations.</span>

<span class="sd">    This method inspects the `__config__` and `__parser__` class</span>
<span class="sd">    attributes (none or either can be set but not both).</span>

<span class="sd">    - If no attribute is set, the default configuration is used for</span>
<span class="sd">          all modes, which uses the `&quot;structured&quot;` parser.</span>
<span class="sd">    - If `__config__` is set to a `QueryConfig`, this configuration</span>
<span class="sd">          is used for all modes.</span>
<span class="sd">    - Alternatively, `__config__` can be set to a dictionary mapping</span>
<span class="sd">          modes to configurations.</span>
<span class="sd">    - If `__parser__` is set to a parser specification, the default</span>
<span class="sd">          configuration is used for all modes, *except* that the</span>
<span class="sd">          provided parser is used instead of the default one.</span>
<span class="sd">    - Alternatively, `__parser__` can also be set to a dictionary.</span>

<span class="sd">    In the special case where the `parse` method is overriden and</span>
<span class="sd">    only in this case, return `None` after ensuring that</span>
<span class="sd">    `__config__` and `__parser__` are not set.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">parse_overriden</span> <span class="o">=</span> <span class="n">dpi</span><span class="o">.</span><span class="n">is_method_overridden</span><span class="p">(</span><span class="n">Query</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;parse&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">parse_overriden</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__config__</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__parser__</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__config__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parser__</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="p">(</span>
            <span class="s2">&quot;Cannot have both __config__ and __parser__ attributes.&quot;</span>
        <span class="p">)</span>
        <span class="n">config_attr</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__config__</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config_attr</span><span class="p">,</span> <span class="n">QueryConfig</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">config_attr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config_attr</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">config_attr</span><span class="p">)[</span><span class="n">mode</span><span class="p">]</span>
    <span class="k">elif</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__parser__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">parser_attr</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__parser__</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parser_attr</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">parser_attr</span><span class="p">)[</span><span class="n">mode</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">parser_attr</span>
        <span class="n">_check_valid_parser_spec</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">QueryConfig</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">QueryConfig</span><span class="p">(</span><span class="s2">&quot;structured&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.Query.query_prefix" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">query_prefix</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">query_prefix</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="AnswerPrefix (delphyne.core.chats.AnswerPrefix)" href="#delphyne.AnswerPrefix">AnswerPrefix</a></span> <span class="o">|</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Return the value of the <code>prefix</code> attribute if it has type
annotation <a class="autorefs autorefs-internal" title="AnswerPrefix" href="#delphyne.AnswerPrefix"><code>AnswerPrefix</code></a> or return <code>None</code>.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@override</span>
<span class="k">def</span><span class="w"> </span><span class="nf">query_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ct</span><span class="o">.</span><span class="n">AnswerPrefix</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the value of the `prefix` attribute if it has type</span>
<span class="sd">    annotation `AnswerPrefix` or return `None`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_special_prefix_attr</span><span class="p">():</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;prefix&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.Query.query_settings" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">query_settings</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">query_settings</span><span class="p">(</span><span class="n">mode</span><span class="p">:</span> <span class="n"><span title="delphyne.core.AnswerMode">AnswerMode</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="delphyne.core.QuerySettings">QuerySettings</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Return the settings associated with the query.</p>
<p>By default, this method uses the result of <code>query_config</code> to
determine settings if [<code>parse</code>][delphyne.parse] is not overriden, and the default
set of settings otherwise.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@override</span>
<span class="k">def</span><span class="w"> </span><span class="nf">query_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">AnswerMode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">QuerySettings</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the settings associated with the query.</span>

<span class="sd">    By default, this method uses the result of `query_config` to</span>
<span class="sd">    determine settings if `parse` is not overriden, and the default</span>
<span class="sd">    set of settings otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_config</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># `parse` is overriden</span>
        <span class="k">return</span> <span class="n">dp</span><span class="o">.</span><span class="n">QuerySettings</span><span class="p">(</span><span class="n">structured_output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">structured_output</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">parser</span> <span class="o">==</span> <span class="s2">&quot;structured&quot;</span><span class="p">:</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decomposed_answer_type</span><span class="p">()</span><span class="o">.</span><span class="n">final</span>
        <span class="n">structured_output</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">StructuredOutputSettings</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">tool_types</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_tools</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">parser</span><span class="p">):</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">ToolSettings</span><span class="p">(</span>
            <span class="n">tool_types</span><span class="p">,</span> <span class="n">force_tool_call</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">parser</span> <span class="o">==</span> <span class="s2">&quot;final_tool_call&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">dp</span><span class="o">.</span><span class="n">QuerySettings</span><span class="p">(</span>
        <span class="n">structured_output</span><span class="o">=</span><span class="n">structured_output</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.Query.run_toplevel" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">run_toplevel</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">run_toplevel</span><span class="p">(</span><span class="n">env</span><span class="p">:</span> <span class="n"><span title="delphyne.core.PolicyEnv">PolicyEnv</span></span><span class="p">,</span> <span class="n">policy</span><span class="p">:</span> <span class="n"><span title="delphyne.stdlib.policies.PromptingPolicy">PromptingPolicy</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Stream


  
      dataclass
   (delphyne.stdlib.streams.Stream)" href="#delphyne.Stream">Stream</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.Query[T]">Query[T]</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Obtain a search stream of query answers, given a prompting
policy.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">run_toplevel</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">PolicyEnv</span><span class="p">,</span>
    <span class="n">policy</span><span class="p">:</span> <span class="n">pol</span><span class="o">.</span><span class="n">PromptingPolicy</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Stream</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Obtain a search stream of query answers, given a prompting</span>
<span class="sd">    policy.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">attached</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">spawn_standalone_query</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">policy</span><span class="p">(</span><span class="n">attached</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.Query.using" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">using</span>


</h4>
          <div class="doc-overloads">
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">using</span><span class="p">(</span><span class="n">get_policy</span><span class="p">:</span> <span class="n"><span title="types.EllipsisType">EllipsisType</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="delphyne.stdlib.opaque.Opaque">Opaque</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="IPDict (delphyne.stdlib.policies.IPDict)" href="#delphyne.IPDict">IPDict</a></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.queries.Query[T]">Query[T]</span></span><span class="p">]</span>
</code></pre></div><div class="doc-signature highlight"><pre><span></span><code><span class="nf">using</span><span class="p">(</span><span class="n">get_policy</span><span class="p">:</span> <span class="n"><span title="collections.abc.Callable">Callable</span></span><span class="p">[[</span><span class="n"><span title="delphyne.stdlib.queries.Query.using[P]">using[P]</span></span><span class="p">],</span> <span class="n"><span title="delphyne.stdlib.policies.PromptingPolicy">PromptingPolicy</span></span><span class="p">]</span> <span class="o">|</span> <span class="n"><span title="types.EllipsisType">EllipsisType</span></span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="n">inner_policy_type</span><span class="p">:</span> <span class="n"><span title="type">type</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.Query.using[P]">using[P]</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="delphyne.stdlib.opaque.Opaque">Opaque</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.Query.using[P]">using[P]</span></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.queries.Query[T]">Query[T]</span></span><span class="p">]</span>
</code></pre></div>          </div>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">using</span><span class="p">(</span><span class="n">get_policy</span><span class="p">:</span> <span class="n"><span title="collections.abc.Callable">Callable</span></span><span class="p">[[</span><span class="n"><span title="delphyne.stdlib.queries.Query.using[P]">using[P]</span></span><span class="p">],</span> <span class="n"><span title="delphyne.stdlib.policies.PromptingPolicy">PromptingPolicy</span></span><span class="p">]</span> <span class="o">|</span> <span class="n"><span title="types.EllipsisType">EllipsisType</span></span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="n">inner_policy_type</span><span class="p">:</span> <span class="n"><span title="type">type</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.Query.using[P]">using[P]</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="delphyne.stdlib.opaque.Opaque">Opaque</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.Query.using[P]">using[P]</span></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.queries.Query[T]">Query[T]</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Turn a query into an opaque space by providing a mapping from
the ambient inner policy to a prompting policy.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.Query.using.get_policy">get_policy</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A function that maps the ambient inner policy to
a prompting policy to use for answering the query.
Alternatively, if the ellipsis value <code>...</code> is passed, the
inner policy type is assumed to be <a class="autorefs autorefs-internal" title="IPDict" href="#delphyne.IPDict"><code>IPDict</code></a>, and
prompting policies are automatically selected using tags
(see <a class="autorefs autorefs-internal" title="IPDict" href="#delphyne.IPDict"><code>IPDict</code></a> documentation).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.Query.using.inner_policy_type">inner_policy_type</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Ambient inner policy type. This information
is not used at runtime but it can be provided to help type
inference when necessary.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
        <p>The optional <code>inner_policy_type</code> argument is ignored at runtime
and can be used to help type checkers infer the type of the
ambient inner policy.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">using</span><span class="p">[</span><span class="n">P</span><span class="p">](</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">get_policy</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">P</span><span class="p">],</span> <span class="n">pol</span><span class="o">.</span><span class="n">PromptingPolicy</span><span class="p">]</span> <span class="o">|</span> <span class="n">EllipsisType</span><span class="p">,</span>
    <span class="o">/</span><span class="p">,</span>
    <span class="n">inner_policy_type</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">P</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Opaque</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Turn a query into an opaque space by providing a mapping from</span>
<span class="sd">    the ambient inner policy to a prompting policy.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        get_policy: A function that maps the ambient inner policy to</span>
<span class="sd">            a prompting policy to use for answering the query.</span>
<span class="sd">            Alternatively, if the ellipsis value `...` is passed, the</span>
<span class="sd">            inner policy type is assumed to be `IPDict`, and</span>
<span class="sd">            prompting policies are automatically selected using tags</span>
<span class="sd">            (see `IPDict` documentation).</span>
<span class="sd">        inner_policy_type: Ambient inner policy type. This information</span>
<span class="sd">            is not used at runtime but it can be provided to help type</span>
<span class="sd">            inference when necessary.</span>

<span class="sd">    The optional `inner_policy_type` argument is ignored at runtime</span>
<span class="sd">    and can be used to help type checkers infer the type of the</span>
<span class="sd">    ambient inner policy.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">get_policy</span><span class="p">,</span> <span class="n">EllipsisType</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">OpaqueSpace</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">]</span><span class="o">.</span><span class="n">from_query</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cast</span><span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">pol</span><span class="o">.</span><span class="n">dict_subpolicy</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">OpaqueSpace</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">]</span><span class="o">.</span><span class="n">from_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">get_policy</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h2 id="documenting-a-class-without-members">Documenting a Class without Members</h2>


<div class="doc doc-object doc-class">



<h3 id="delphyne.Query" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">Query</span>


</h3>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="delphyne.core.AbstractQuery">AbstractQuery</span>[<span title="delphyne.stdlib.queries.Query[T]">Query[T]</span>]</code></p>


        <p>Base class for queries.</p>
<p>This class adds standard convenience features on top of
[<code>AbstractQuery</code>][delphyne.AbstractQuery], using reflection to allow queries to be defined
concisely. Here is a simple example of a query type definition:</p>
<pre><code>@dataclass class MakeSum(Query[list[int]]):
    ''' Given a list of allowed numbers and a target number, you
    must find a sub-list whose elements sum up to the target.
    Just answer with a list of numbers as a JSON object and
    nothing else. '''

    allowed: list[int] target: int
</code></pre>
<p>In general, a query type is a dataclass that inherits <code>Query[T]</code>,
where <code>T</code> is the query's answer type. In the example above, no
parser is specified and so oracles are requested to provide
structured answers as JSON objects, which are automatically parsed
into the answer type (<code>list[int]</code>) using pydantic. Assuming that no
Jinja prompt file is provided, the docstring is used as a system
prompt and instance prompts are generated by simply serializing
<code>MakeSum</code> instances into YAML.</p>
<h6 id="delphyne.Query--customizing-prompts">Customizing Prompts</h6>
<p>System and instance prompts can be specified via Jinja templates.
The templates manager ([<code>TemplatesManager</code>][delphyne.TemplatesManager]) looks for templates named
"<QueryName>.<instance|system>.jinja". Templates can also be
provided by defining the <code>__system_prompt__</code> and/or <code>__instance_prompt__</code>
class attributes. If none of these are provided, the query's
docstring is used as a system prompt and <code>DEFAULT_INSTANCE_PROMPT</code>
is used as an instance prompt template.</p>
<p>The following arguments are usually made available to templates
(although specific prompting policies can add more):</p>
<ul>
<li><code>query</code>: the query instance.</li>
<li><code>mode</code>: the requested answer mode.</li>
<li><code>params</code>: the query hyperparameters (e.g., as passed to <a class="autorefs autorefs-internal" href="#delphyne.few_shot"><code>few_shot</code></a>)</li>
</ul>
<h6 id="delphyne.Query--answer-modes-and-configurations">Answer Modes and Configurations</h6>
<p>A query can define several answer modes ([<code>AnswerMode</code>][delphyne.AnswerMode]), each of
which can be associated with a different parser and set of settings.
By default, the only answer mode is <code>None</code>. More answer modes can be
defined by setting class variable <code>__modes__</code>.</p>
<p>The <code>query_config</code> method maps modes to configurations (i.e., a set
of settings, including a parser specification). Its default behavior
works by inspecting the <code>__parser__</code> and <code>__config__</code> class
attributes and does not typically require overriding.</p>
<h6 id="delphyne.Query--allowing-multi-message-exchanges-and-tool-calls">Allowing Multi-Message Exchanges and Tool Calls</h6>
<p>A common pattern for interacting with LLMs is to have multi-message
exchanges where the full conversation history is resent repeatedly.
LLMs are also often allowed to request tool call. This interaction
pattern is implemented in the [<code>interact</code>][delphyne.interact] standard strategy. It is
enabled by several features on the <a class="autorefs autorefs-internal" title="Query" href="#delphyne.Query"><code>Query</code></a> side.</p>
<h6 id="delphyne.Query--answer-prefixes">Answer Prefixes</h6>
<p>If a query type has a prefix attribute with type <a class="autorefs autorefs-internal" title="AnswerPrefix" href="#delphyne.AnswerPrefix"><code>AnswerPrefix</code></a>,
this attribute can be used to provide a chat history, to be added to
the query's prompt.</p>
<h6 id="delphyne.Query--the-response-type">The <a class="autorefs autorefs-internal" title="Response


  
      dataclass
  " href="#delphyne.stdlib.queries.Response"><code>Response</code></a> Type</h6>
<p>If the query answer type is <a class="autorefs autorefs-internal" title="Response


  
      dataclass
  " href="#delphyne.stdlib.queries.Response"><code>Response</code></a>, the query does not only
return a parsed answer, but also the LLM raw answer (which can be
appended to a chat history), and possibly a sequence of tool calls.</p>
<h6 id="delphyne.Query--manually-overriding-the-parse-method">Manually Overriding the [<code>parse</code>][delphyne.parse] Method</h6>
<p>For advanced use cases, it is possible to directly override the
[<code>parse</code>][delphyne.parse] method that turns an answer into an object of type <code>T</code>. When
this is done, the <code>__config__</code> and <code>__parser__</code> class attributes
must not be set. Also, the <code>query_settings</code> method always returns
the default settings instead of relying on <code>query_config</code> and must
be overriden if another behavior is desired.</p>







              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Query</span><span class="p">[</span><span class="n">T</span><span class="p">](</span><span class="n">dp</span><span class="o">.</span><span class="n">AbstractQuery</span><span class="p">[</span><span class="n">T</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for queries.</span>

<span class="sd">    This class adds standard convenience features on top of</span>
<span class="sd">    `AbstractQuery`, using reflection to allow queries to be defined</span>
<span class="sd">    concisely. Here is a simple example of a query type definition:</span>

<span class="sd">        @dataclass class MakeSum(Query[list[int]]):</span>
<span class="sd">            &#39;&#39;&#39; Given a list of allowed numbers and a target number, you</span>
<span class="sd">            must find a sub-list whose elements sum up to the target.</span>
<span class="sd">            Just answer with a list of numbers as a JSON object and</span>
<span class="sd">            nothing else. &#39;&#39;&#39;</span>

<span class="sd">            allowed: list[int] target: int</span>

<span class="sd">    In general, a query type is a dataclass that inherits `Query[T]`,</span>
<span class="sd">    where `T` is the query&#39;s answer type. In the example above, no</span>
<span class="sd">    parser is specified and so oracles are requested to provide</span>
<span class="sd">    structured answers as JSON objects, which are automatically parsed</span>
<span class="sd">    into the answer type (`list[int]`) using pydantic. Assuming that no</span>
<span class="sd">    Jinja prompt file is provided, the docstring is used as a system</span>
<span class="sd">    prompt and instance prompts are generated by simply serializing</span>
<span class="sd">    `MakeSum` instances into YAML.</span>

<span class="sd">    ### Customizing Prompts</span>

<span class="sd">    System and instance prompts can be specified via Jinja templates.</span>
<span class="sd">    The templates manager (`TemplatesManager`) looks for templates named</span>
<span class="sd">    &quot;&lt;QueryName&gt;.&lt;instance|system&gt;.jinja&quot;. Templates can also be</span>
<span class="sd">    provided by defining the `__system_prompt__` and/or `__instance_prompt__`</span>
<span class="sd">    class attributes. If none of these are provided, the query&#39;s</span>
<span class="sd">    docstring is used as a system prompt and `DEFAULT_INSTANCE_PROMPT`</span>
<span class="sd">    is used as an instance prompt template.</span>

<span class="sd">    The following arguments are usually made available to templates</span>
<span class="sd">    (although specific prompting policies can add more):</span>

<span class="sd">    - `query`: the query instance.</span>
<span class="sd">    - `mode`: the requested answer mode.</span>
<span class="sd">    - `params`: the query hyperparameters (e.g., as passed to `few_shot`)</span>

<span class="sd">    ### Answer Modes and Configurations</span>

<span class="sd">    A query can define several answer modes (`AnswerMode`), each of</span>
<span class="sd">    which can be associated with a different parser and set of settings.</span>
<span class="sd">    By default, the only answer mode is `None`. More answer modes can be</span>
<span class="sd">    defined by setting class variable `__modes__`.</span>

<span class="sd">    The `query_config` method maps modes to configurations (i.e., a set</span>
<span class="sd">    of settings, including a parser specification). Its default behavior</span>
<span class="sd">    works by inspecting the `__parser__` and `__config__` class</span>
<span class="sd">    attributes and does not typically require overriding.</span>

<span class="sd">    ### Allowing Multi-Message Exchanges and Tool Calls</span>

<span class="sd">    A common pattern for interacting with LLMs is to have multi-message</span>
<span class="sd">    exchanges where the full conversation history is resent repeatedly.</span>
<span class="sd">    LLMs are also often allowed to request tool call. This interaction</span>
<span class="sd">    pattern is implemented in the `interact` standard strategy. It is</span>
<span class="sd">    enabled by several features on the `Query` side.</span>

<span class="sd">    #### Answer Prefixes</span>

<span class="sd">    If a query type has a prefix attribute with type `AnswerPrefix`,</span>
<span class="sd">    this attribute can be used to provide a chat history, to be added to</span>
<span class="sd">    the query&#39;s prompt.</span>

<span class="sd">    #### The `Response` Type</span>

<span class="sd">    If the query answer type is `Response`, the query does not only</span>
<span class="sd">    return a parsed answer, but also the LLM raw answer (which can be</span>
<span class="sd">    appended to a chat history), and possibly a sequence of tool calls.</span>

<span class="sd">    ### Manually Overriding the `parse` Method</span>

<span class="sd">    For advanced use cases, it is possible to directly override the</span>
<span class="sd">    `parse` method that turns an answer into an object of type `T`. When</span>
<span class="sd">    this is done, the `__config__` and `__parser__` class attributes</span>
<span class="sd">    must not be set. Also, the `query_settings` method always returns</span>
<span class="sd">    the default settings instead of relying on `query_config` and must</span>
<span class="sd">    be overriden if another behavior is desired.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__modes__</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">AnswerMode</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">__parser__</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">ParserSpec</span> <span class="o">|</span> <span class="n">ParserSpecDict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">__config__</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">QueryConfig</span> <span class="o">|</span> <span class="n">QueryConfigDict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">### Inspection methods</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">query_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">AnswerMode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QueryConfig</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Map modes to configurations.</span>

<span class="sd">        This method inspects the `__config__` and `__parser__` class</span>
<span class="sd">        attributes (none or either can be set but not both).</span>

<span class="sd">        - If no attribute is set, the default configuration is used for</span>
<span class="sd">              all modes, which uses the `&quot;structured&quot;` parser.</span>
<span class="sd">        - If `__config__` is set to a `QueryConfig`, this configuration</span>
<span class="sd">              is used for all modes.</span>
<span class="sd">        - Alternatively, `__config__` can be set to a dictionary mapping</span>
<span class="sd">              modes to configurations.</span>
<span class="sd">        - If `__parser__` is set to a parser specification, the default</span>
<span class="sd">              configuration is used for all modes, *except* that the</span>
<span class="sd">              provided parser is used instead of the default one.</span>
<span class="sd">        - Alternatively, `__parser__` can also be set to a dictionary.</span>

<span class="sd">        In the special case where the `parse` method is overriden and</span>
<span class="sd">        only in this case, return `None` after ensuring that</span>
<span class="sd">        `__config__` and `__parser__` are not set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">parse_overriden</span> <span class="o">=</span> <span class="n">dpi</span><span class="o">.</span><span class="n">is_method_overridden</span><span class="p">(</span><span class="n">Query</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;parse&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parse_overriden</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__config__</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">assert</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__parser__</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__config__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parser__</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="p">(</span>
                <span class="s2">&quot;Cannot have both __config__ and __parser__ attributes.&quot;</span>
            <span class="p">)</span>
            <span class="n">config_attr</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__config__</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config_attr</span><span class="p">,</span> <span class="n">QueryConfig</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">config_attr</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config_attr</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">config_attr</span><span class="p">)[</span><span class="n">mode</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__parser__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parser_attr</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__parser__</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parser_attr</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
                <span class="n">parser</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">parser_attr</span><span class="p">)[</span><span class="n">mode</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parser</span> <span class="o">=</span> <span class="n">parser_attr</span>
            <span class="n">_check_valid_parser_spec</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">QueryConfig</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">QueryConfig</span><span class="p">(</span><span class="s2">&quot;structured&quot;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_decomposed_answer_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_DecomposedAnswerType</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_DecomposedAnswerType</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_answer_type</span><span class="p">())</span>

    <span class="c1">### Parsing Answers</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">parse_answer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">answer</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">Answer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span> <span class="o">|</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">answer</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_modes</span><span class="p">(),</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unknown mode: </span><span class="si">{</span><span class="n">answer</span><span class="o">.</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">e</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">answer</span><span class="p">:</span> <span class="n">Answer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A more convenient method to override instead of `parse_answer`.</span>

<span class="sd">        Raises `ParseError`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Decompose the specified answer type</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_config</span><span class="p">(</span><span class="n">answer</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">parser</span>
        <span class="n">ans_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decomposed_answer_type</span><span class="p">()</span>

        <span class="c1"># Compute base parsing function `parser`</span>
        <span class="n">parser</span><span class="p">:</span> <span class="n">_ParsingFunction</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="s2">&quot;structured&quot;</span><span class="p">:</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">_from_structured</span><span class="p">(</span><span class="n">ans_type</span><span class="o">.</span><span class="n">to_parse</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">attr</span> <span class="o">==</span> <span class="s2">&quot;final_tool_call&quot;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ans_type</span><span class="o">.</span><span class="n">to_parse</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">_from_final_tool_call</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="nb">type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">ans_type</span><span class="o">.</span><span class="n">to_parse</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">callable</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">attr</span><span class="p">)</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="n">nargs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">nargs</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">nargs</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="n">nargs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">parser</span> <span class="o">=</span> <span class="n">_from_text_parser</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parser</span> <span class="o">=</span> <span class="n">_from_generic_text_parser</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">ans_type</span><span class="o">.</span><span class="n">to_parse</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ans_type</span><span class="o">.</span><span class="n">wrap_parse_errors</span><span class="p">():</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">_wrap_parse_errors</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>

        <span class="c1"># If the answer type has form `Response[..., ...]`</span>
        <span class="k">if</span> <span class="n">ans_type</span><span class="o">.</span><span class="n">resp</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_has_final_tool_call</span><span class="p">(</span><span class="n">ans_type</span><span class="p">,</span> <span class="n">answer</span><span class="p">):</span>
                <span class="n">tcs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tcs</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">_parse_tool_call</span><span class="p">(</span><span class="n">ans_type</span><span class="o">.</span><span class="n">resp</span><span class="o">.</span><span class="n">tools</span><span class="p">,</span> <span class="n">tc</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">answer</span><span class="o">.</span><span class="n">tool_calls</span>
                <span class="p">]</span>
            <span class="k">if</span> <span class="n">tcs</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">Response</span><span class="p">(</span><span class="n">answer</span><span class="p">,</span> <span class="n">ToolRequests</span><span class="p">(</span><span class="n">tcs</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">Response</span><span class="p">(</span><span class="n">answer</span><span class="p">,</span> <span class="n">FinalAnswer</span><span class="p">(</span><span class="n">parser</span><span class="p">(</span><span class="n">answer</span><span class="p">))))</span>

        <span class="k">return</span> <span class="n">parser</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>

    <span class="c1">### Query Settings</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">query_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">AnswerMode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">QuerySettings</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the settings associated with the query.</span>

<span class="sd">        By default, this method uses the result of `query_config` to</span>
<span class="sd">        determine settings if `parse` is not overriden, and the default</span>
<span class="sd">        set of settings otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_config</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># `parse` is overriden</span>
            <span class="k">return</span> <span class="n">dp</span><span class="o">.</span><span class="n">QuerySettings</span><span class="p">(</span><span class="n">structured_output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">structured_output</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">parser</span> <span class="o">==</span> <span class="s2">&quot;structured&quot;</span><span class="p">:</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decomposed_answer_type</span><span class="p">()</span><span class="o">.</span><span class="n">final</span>
            <span class="n">structured_output</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">StructuredOutputSettings</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">tool_types</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_tools</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">parser</span><span class="p">):</span>
            <span class="n">tools</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">ToolSettings</span><span class="p">(</span>
                <span class="n">tool_types</span><span class="p">,</span> <span class="n">force_tool_call</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">parser</span> <span class="o">==</span> <span class="s2">&quot;final_tool_call&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">dp</span><span class="o">.</span><span class="n">QuerySettings</span><span class="p">(</span>
            <span class="n">structured_output</span><span class="o">=</span><span class="n">structured_output</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_structured_output_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypeAnnot</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="n">ty</span><span class="o">.</span><span class="n">NoTypeInfo</span><span class="p">:</span>
        <span class="n">decomposed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decomposed_answer_type</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">decomposed</span><span class="o">.</span><span class="n">final</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_query_tools</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">:</span> <span class="n">ParserSpec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
        <span class="n">ans_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decomposed_answer_type</span><span class="p">()</span>
        <span class="n">tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">ans_type</span><span class="o">.</span><span class="n">resp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tools</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">ans_type</span><span class="o">.</span><span class="n">resp</span><span class="o">.</span><span class="n">tools</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">parser</span> <span class="o">==</span> <span class="s2">&quot;final_tool_call&quot;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ans_type</span><span class="o">.</span><span class="n">final</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span>
            <span class="n">tools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ans_type</span><span class="o">.</span><span class="n">final</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tools</span>

    <span class="c1">### Query Prefixes</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_has_special_prefix_attr</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">annots</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">get_type_hints</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;prefix&quot;</span> <span class="ow">in</span> <span class="n">annots</span> <span class="ow">and</span> <span class="n">annots</span><span class="p">[</span><span class="s2">&quot;prefix&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="n">ct</span><span class="o">.</span><span class="n">AnswerPrefix</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">query_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ct</span><span class="o">.</span><span class="n">AnswerPrefix</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the value of the `prefix` attribute if it has type</span>
<span class="sd">        annotation `AnswerPrefix` or return `None`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_special_prefix_attr</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;prefix&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1">### Producing Prompts</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_prompt</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">kind</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;instance&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">AnswerMode</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">],</span>
        <span class="n">extra_args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">env</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">TemplatesManager</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">env</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">_no_prompt_manager_error</span><span class="p">()</span>
        <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="p">,</span>
            <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="n">mode</span><span class="p">,</span>
            <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">params</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">extra_args</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extra_args</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">glob</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">globals</span><span class="p">())</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s2">&quot;globals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">glob</span>
        <span class="k">return</span> <span class="n">env</span><span class="o">.</span><span class="n">prompt</span><span class="p">(</span>
            <span class="n">query_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">query_name</span><span class="p">(),</span>
            <span class="n">prompt_kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span>
            <span class="n">template_args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
            <span class="n">default_template</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_default_prompt</span><span class="p">(</span><span class="n">kind</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_default_prompt</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">kind</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;instance&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">attr_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;__</span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="s2">_prompt__&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;instance&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_has_special_prefix_attr</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">DEFAULT_INSTANCE_PROMPT_WITH_PREFIX</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">DEFAULT_INSTANCE_PROMPT</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;system&quot;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">doc</span> <span class="o">:=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="bp">cls</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">doc</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;feedback&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DEFAULT_FEEDBACK_PROMPT</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">globals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return global objects accessible in prompts via the `globals`</span>
<span class="sd">        attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1">### Other Simple Overrides</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">serialize_args</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">],</span> <span class="n">ty</span><span class="o">.</span><span class="n">pydantic_dump</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_answer_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypeAnnot</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">dpi</span><span class="o">.</span><span class="n">first_parameter_of_base_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">answer_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypeAnnot</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_answer_type</span><span class="p">()</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">finite_answer_set</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">Answer</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># We handle the special case where the return type is a literal</span>
        <span class="c1"># type that is a subtype of str.</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_type</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">:=</span> <span class="n">_match_string_literal_type</span><span class="p">(</span><span class="n">ans</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">Answer</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">res</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">query_modes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">AnswerMode</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__modes__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__modes__</span>
        <span class="k">return</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>

    <span class="c1">### Generating Opaque Spaces</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">using</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_policy</span><span class="p">:</span> <span class="n">EllipsisType</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Opaque</span><span class="p">[</span><span class="n">IPDict</span><span class="p">,</span> <span class="n">T</span><span class="p">]:</span> <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">using</span><span class="p">[</span><span class="n">P</span><span class="p">](</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">get_policy</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">P</span><span class="p">],</span> <span class="n">pol</span><span class="o">.</span><span class="n">PromptingPolicy</span><span class="p">]</span> <span class="o">|</span> <span class="n">EllipsisType</span><span class="p">,</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="n">inner_policy_type</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">P</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Opaque</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">]:</span> <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">using</span><span class="p">[</span><span class="n">P</span><span class="p">](</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">get_policy</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">P</span><span class="p">],</span> <span class="n">pol</span><span class="o">.</span><span class="n">PromptingPolicy</span><span class="p">]</span> <span class="o">|</span> <span class="n">EllipsisType</span><span class="p">,</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="n">inner_policy_type</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">P</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Opaque</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Turn a query into an opaque space by providing a mapping from</span>
<span class="sd">        the ambient inner policy to a prompting policy.</span>

<span class="sd">        Attributes:</span>
<span class="sd">            get_policy: A function that maps the ambient inner policy to</span>
<span class="sd">                a prompting policy to use for answering the query.</span>
<span class="sd">                Alternatively, if the ellipsis value `...` is passed, the</span>
<span class="sd">                inner policy type is assumed to be `IPDict`, and</span>
<span class="sd">                prompting policies are automatically selected using tags</span>
<span class="sd">                (see `IPDict` documentation).</span>
<span class="sd">            inner_policy_type: Ambient inner policy type. This information</span>
<span class="sd">                is not used at runtime but it can be provided to help type</span>
<span class="sd">                inference when necessary.</span>

<span class="sd">        The optional `inner_policy_type` argument is ignored at runtime</span>
<span class="sd">        and can be used to help type checkers infer the type of the</span>
<span class="sd">        ambient inner policy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">get_policy</span><span class="p">,</span> <span class="n">EllipsisType</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">OpaqueSpace</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">]</span><span class="o">.</span><span class="n">from_query</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">cast</span><span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">pol</span><span class="o">.</span><span class="n">dict_subpolicy</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">OpaqueSpace</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">]</span><span class="o">.</span><span class="n">from_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">get_policy</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_toplevel</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">env</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">PolicyEnv</span><span class="p">,</span>
        <span class="n">policy</span><span class="p">:</span> <span class="n">pol</span><span class="o">.</span><span class="n">PromptingPolicy</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Stream</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Obtain a search stream of query answers, given a prompting</span>
<span class="sd">        policy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">attached</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">spawn_standalone_query</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">policy</span><span class="p">(</span><span class="n">attached</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div><h2 id="documenting-a-class-with-selected-members">Documenting a Class With Selected Members</h2>


<div class="doc doc-object doc-class">



<h3 id="delphyne.Query" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">Query</span>


</h3>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="delphyne.core.AbstractQuery">AbstractQuery</span>[<span title="delphyne.stdlib.queries.Query[T]">Query[T]</span>]</code></p>


        <p>Base class for queries.</p>
<p>This class adds standard convenience features on top of
[<code>AbstractQuery</code>][delphyne.AbstractQuery], using reflection to allow queries to be defined
concisely. Here is a simple example of a query type definition:</p>
<pre><code>@dataclass class MakeSum(Query[list[int]]):
    ''' Given a list of allowed numbers and a target number, you
    must find a sub-list whose elements sum up to the target.
    Just answer with a list of numbers as a JSON object and
    nothing else. '''

    allowed: list[int] target: int
</code></pre>
<p>In general, a query type is a dataclass that inherits <code>Query[T]</code>,
where <code>T</code> is the query's answer type. In the example above, no
parser is specified and so oracles are requested to provide
structured answers as JSON objects, which are automatically parsed
into the answer type (<code>list[int]</code>) using pydantic. Assuming that no
Jinja prompt file is provided, the docstring is used as a system
prompt and instance prompts are generated by simply serializing
<code>MakeSum</code> instances into YAML.</p>
<h6 id="delphyne.Query--customizing-prompts">Customizing Prompts</h6>
<p>System and instance prompts can be specified via Jinja templates.
The templates manager ([<code>TemplatesManager</code>][delphyne.TemplatesManager]) looks for templates named
"<QueryName>.<instance|system>.jinja". Templates can also be
provided by defining the <code>__system_prompt__</code> and/or <code>__instance_prompt__</code>
class attributes. If none of these are provided, the query's
docstring is used as a system prompt and <code>DEFAULT_INSTANCE_PROMPT</code>
is used as an instance prompt template.</p>
<p>The following arguments are usually made available to templates
(although specific prompting policies can add more):</p>
<ul>
<li><code>query</code>: the query instance.</li>
<li><code>mode</code>: the requested answer mode.</li>
<li><code>params</code>: the query hyperparameters (e.g., as passed to <a class="autorefs autorefs-internal" href="#delphyne.few_shot"><code>few_shot</code></a>)</li>
</ul>
<h6 id="delphyne.Query--answer-modes-and-configurations">Answer Modes and Configurations</h6>
<p>A query can define several answer modes ([<code>AnswerMode</code>][delphyne.AnswerMode]), each of
which can be associated with a different parser and set of settings.
By default, the only answer mode is <code>None</code>. More answer modes can be
defined by setting class variable <code>__modes__</code>.</p>
<p>The <code>query_config</code> method maps modes to configurations (i.e., a set
of settings, including a parser specification). Its default behavior
works by inspecting the <code>__parser__</code> and <code>__config__</code> class
attributes and does not typically require overriding.</p>
<h6 id="delphyne.Query--allowing-multi-message-exchanges-and-tool-calls">Allowing Multi-Message Exchanges and Tool Calls</h6>
<p>A common pattern for interacting with LLMs is to have multi-message
exchanges where the full conversation history is resent repeatedly.
LLMs are also often allowed to request tool call. This interaction
pattern is implemented in the [<code>interact</code>][delphyne.interact] standard strategy. It is
enabled by several features on the <a class="autorefs autorefs-internal" title="Query" href="#delphyne.Query"><code>Query</code></a> side.</p>
<h6 id="delphyne.Query--answer-prefixes">Answer Prefixes</h6>
<p>If a query type has a prefix attribute with type <a class="autorefs autorefs-internal" title="AnswerPrefix" href="#delphyne.AnswerPrefix"><code>AnswerPrefix</code></a>,
this attribute can be used to provide a chat history, to be added to
the query's prompt.</p>
<h6 id="delphyne.Query--the-response-type">The <a class="autorefs autorefs-internal" title="Response


  
      dataclass
  " href="#delphyne.stdlib.queries.Response"><code>Response</code></a> Type</h6>
<p>If the query answer type is <a class="autorefs autorefs-internal" title="Response


  
      dataclass
  " href="#delphyne.stdlib.queries.Response"><code>Response</code></a>, the query does not only
return a parsed answer, but also the LLM raw answer (which can be
appended to a chat history), and possibly a sequence of tool calls.</p>
<h6 id="delphyne.Query--manually-overriding-the-parse-method">Manually Overriding the [<code>parse</code>][delphyne.parse] Method</h6>
<p>For advanced use cases, it is possible to directly override the
[<code>parse</code>][delphyne.parse] method that turns an answer into an object of type <code>T</code>. When
this is done, the <code>__config__</code> and <code>__parser__</code> class attributes
must not be set. Also, the <code>query_settings</code> method always returns
the default settings instead of relying on <code>query_config</code> and must
be overriden if another behavior is desired.</p>










<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="parse_answer (delphyne.Query.parse_answer)" href="#delphyne.Query.parse_answer">parse_answer</a></code></td>
              <td>
                <div class="doc-md-description">
                  
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="query_config (delphyne.Query.query_config)" href="#delphyne.Query.query_config">query_config</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Map modes to configurations.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>



              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Query</span><span class="p">[</span><span class="n">T</span><span class="p">](</span><span class="n">dp</span><span class="o">.</span><span class="n">AbstractQuery</span><span class="p">[</span><span class="n">T</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for queries.</span>

<span class="sd">    This class adds standard convenience features on top of</span>
<span class="sd">    `AbstractQuery`, using reflection to allow queries to be defined</span>
<span class="sd">    concisely. Here is a simple example of a query type definition:</span>

<span class="sd">        @dataclass class MakeSum(Query[list[int]]):</span>
<span class="sd">            &#39;&#39;&#39; Given a list of allowed numbers and a target number, you</span>
<span class="sd">            must find a sub-list whose elements sum up to the target.</span>
<span class="sd">            Just answer with a list of numbers as a JSON object and</span>
<span class="sd">            nothing else. &#39;&#39;&#39;</span>

<span class="sd">            allowed: list[int] target: int</span>

<span class="sd">    In general, a query type is a dataclass that inherits `Query[T]`,</span>
<span class="sd">    where `T` is the query&#39;s answer type. In the example above, no</span>
<span class="sd">    parser is specified and so oracles are requested to provide</span>
<span class="sd">    structured answers as JSON objects, which are automatically parsed</span>
<span class="sd">    into the answer type (`list[int]`) using pydantic. Assuming that no</span>
<span class="sd">    Jinja prompt file is provided, the docstring is used as a system</span>
<span class="sd">    prompt and instance prompts are generated by simply serializing</span>
<span class="sd">    `MakeSum` instances into YAML.</span>

<span class="sd">    ### Customizing Prompts</span>

<span class="sd">    System and instance prompts can be specified via Jinja templates.</span>
<span class="sd">    The templates manager (`TemplatesManager`) looks for templates named</span>
<span class="sd">    &quot;&lt;QueryName&gt;.&lt;instance|system&gt;.jinja&quot;. Templates can also be</span>
<span class="sd">    provided by defining the `__system_prompt__` and/or `__instance_prompt__`</span>
<span class="sd">    class attributes. If none of these are provided, the query&#39;s</span>
<span class="sd">    docstring is used as a system prompt and `DEFAULT_INSTANCE_PROMPT`</span>
<span class="sd">    is used as an instance prompt template.</span>

<span class="sd">    The following arguments are usually made available to templates</span>
<span class="sd">    (although specific prompting policies can add more):</span>

<span class="sd">    - `query`: the query instance.</span>
<span class="sd">    - `mode`: the requested answer mode.</span>
<span class="sd">    - `params`: the query hyperparameters (e.g., as passed to `few_shot`)</span>

<span class="sd">    ### Answer Modes and Configurations</span>

<span class="sd">    A query can define several answer modes (`AnswerMode`), each of</span>
<span class="sd">    which can be associated with a different parser and set of settings.</span>
<span class="sd">    By default, the only answer mode is `None`. More answer modes can be</span>
<span class="sd">    defined by setting class variable `__modes__`.</span>

<span class="sd">    The `query_config` method maps modes to configurations (i.e., a set</span>
<span class="sd">    of settings, including a parser specification). Its default behavior</span>
<span class="sd">    works by inspecting the `__parser__` and `__config__` class</span>
<span class="sd">    attributes and does not typically require overriding.</span>

<span class="sd">    ### Allowing Multi-Message Exchanges and Tool Calls</span>

<span class="sd">    A common pattern for interacting with LLMs is to have multi-message</span>
<span class="sd">    exchanges where the full conversation history is resent repeatedly.</span>
<span class="sd">    LLMs are also often allowed to request tool call. This interaction</span>
<span class="sd">    pattern is implemented in the `interact` standard strategy. It is</span>
<span class="sd">    enabled by several features on the `Query` side.</span>

<span class="sd">    #### Answer Prefixes</span>

<span class="sd">    If a query type has a prefix attribute with type `AnswerPrefix`,</span>
<span class="sd">    this attribute can be used to provide a chat history, to be added to</span>
<span class="sd">    the query&#39;s prompt.</span>

<span class="sd">    #### The `Response` Type</span>

<span class="sd">    If the query answer type is `Response`, the query does not only</span>
<span class="sd">    return a parsed answer, but also the LLM raw answer (which can be</span>
<span class="sd">    appended to a chat history), and possibly a sequence of tool calls.</span>

<span class="sd">    ### Manually Overriding the `parse` Method</span>

<span class="sd">    For advanced use cases, it is possible to directly override the</span>
<span class="sd">    `parse` method that turns an answer into an object of type `T`. When</span>
<span class="sd">    this is done, the `__config__` and `__parser__` class attributes</span>
<span class="sd">    must not be set. Also, the `query_settings` method always returns</span>
<span class="sd">    the default settings instead of relying on `query_config` and must</span>
<span class="sd">    be overriden if another behavior is desired.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__modes__</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">AnswerMode</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">__parser__</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">ParserSpec</span> <span class="o">|</span> <span class="n">ParserSpecDict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">__config__</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">QueryConfig</span> <span class="o">|</span> <span class="n">QueryConfigDict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">### Inspection methods</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">query_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">AnswerMode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QueryConfig</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Map modes to configurations.</span>

<span class="sd">        This method inspects the `__config__` and `__parser__` class</span>
<span class="sd">        attributes (none or either can be set but not both).</span>

<span class="sd">        - If no attribute is set, the default configuration is used for</span>
<span class="sd">              all modes, which uses the `&quot;structured&quot;` parser.</span>
<span class="sd">        - If `__config__` is set to a `QueryConfig`, this configuration</span>
<span class="sd">              is used for all modes.</span>
<span class="sd">        - Alternatively, `__config__` can be set to a dictionary mapping</span>
<span class="sd">              modes to configurations.</span>
<span class="sd">        - If `__parser__` is set to a parser specification, the default</span>
<span class="sd">              configuration is used for all modes, *except* that the</span>
<span class="sd">              provided parser is used instead of the default one.</span>
<span class="sd">        - Alternatively, `__parser__` can also be set to a dictionary.</span>

<span class="sd">        In the special case where the `parse` method is overriden and</span>
<span class="sd">        only in this case, return `None` after ensuring that</span>
<span class="sd">        `__config__` and `__parser__` are not set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">parse_overriden</span> <span class="o">=</span> <span class="n">dpi</span><span class="o">.</span><span class="n">is_method_overridden</span><span class="p">(</span><span class="n">Query</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;parse&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parse_overriden</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__config__</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">assert</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__parser__</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__config__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parser__</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="p">(</span>
                <span class="s2">&quot;Cannot have both __config__ and __parser__ attributes.&quot;</span>
            <span class="p">)</span>
            <span class="n">config_attr</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__config__</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config_attr</span><span class="p">,</span> <span class="n">QueryConfig</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">config_attr</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config_attr</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">config_attr</span><span class="p">)[</span><span class="n">mode</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__parser__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parser_attr</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__parser__</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parser_attr</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
                <span class="n">parser</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">parser_attr</span><span class="p">)[</span><span class="n">mode</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parser</span> <span class="o">=</span> <span class="n">parser_attr</span>
            <span class="n">_check_valid_parser_spec</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">QueryConfig</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">QueryConfig</span><span class="p">(</span><span class="s2">&quot;structured&quot;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_decomposed_answer_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_DecomposedAnswerType</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_DecomposedAnswerType</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_answer_type</span><span class="p">())</span>

    <span class="c1">### Parsing Answers</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">parse_answer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">answer</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">Answer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span> <span class="o">|</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">answer</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_modes</span><span class="p">(),</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unknown mode: </span><span class="si">{</span><span class="n">answer</span><span class="o">.</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">e</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">answer</span><span class="p">:</span> <span class="n">Answer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A more convenient method to override instead of `parse_answer`.</span>

<span class="sd">        Raises `ParseError`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Decompose the specified answer type</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_config</span><span class="p">(</span><span class="n">answer</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">parser</span>
        <span class="n">ans_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decomposed_answer_type</span><span class="p">()</span>

        <span class="c1"># Compute base parsing function `parser`</span>
        <span class="n">parser</span><span class="p">:</span> <span class="n">_ParsingFunction</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="s2">&quot;structured&quot;</span><span class="p">:</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">_from_structured</span><span class="p">(</span><span class="n">ans_type</span><span class="o">.</span><span class="n">to_parse</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">attr</span> <span class="o">==</span> <span class="s2">&quot;final_tool_call&quot;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ans_type</span><span class="o">.</span><span class="n">to_parse</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">_from_final_tool_call</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="nb">type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">ans_type</span><span class="o">.</span><span class="n">to_parse</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">callable</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">attr</span><span class="p">)</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="n">nargs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">nargs</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">nargs</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="n">nargs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">parser</span> <span class="o">=</span> <span class="n">_from_text_parser</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parser</span> <span class="o">=</span> <span class="n">_from_generic_text_parser</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">ans_type</span><span class="o">.</span><span class="n">to_parse</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ans_type</span><span class="o">.</span><span class="n">wrap_parse_errors</span><span class="p">():</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">_wrap_parse_errors</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>

        <span class="c1"># If the answer type has form `Response[..., ...]`</span>
        <span class="k">if</span> <span class="n">ans_type</span><span class="o">.</span><span class="n">resp</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_has_final_tool_call</span><span class="p">(</span><span class="n">ans_type</span><span class="p">,</span> <span class="n">answer</span><span class="p">):</span>
                <span class="n">tcs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tcs</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">_parse_tool_call</span><span class="p">(</span><span class="n">ans_type</span><span class="o">.</span><span class="n">resp</span><span class="o">.</span><span class="n">tools</span><span class="p">,</span> <span class="n">tc</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">answer</span><span class="o">.</span><span class="n">tool_calls</span>
                <span class="p">]</span>
            <span class="k">if</span> <span class="n">tcs</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">Response</span><span class="p">(</span><span class="n">answer</span><span class="p">,</span> <span class="n">ToolRequests</span><span class="p">(</span><span class="n">tcs</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">Response</span><span class="p">(</span><span class="n">answer</span><span class="p">,</span> <span class="n">FinalAnswer</span><span class="p">(</span><span class="n">parser</span><span class="p">(</span><span class="n">answer</span><span class="p">))))</span>

        <span class="k">return</span> <span class="n">parser</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>

    <span class="c1">### Query Settings</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">query_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">AnswerMode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">QuerySettings</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the settings associated with the query.</span>

<span class="sd">        By default, this method uses the result of `query_config` to</span>
<span class="sd">        determine settings if `parse` is not overriden, and the default</span>
<span class="sd">        set of settings otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_config</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># `parse` is overriden</span>
            <span class="k">return</span> <span class="n">dp</span><span class="o">.</span><span class="n">QuerySettings</span><span class="p">(</span><span class="n">structured_output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">structured_output</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">parser</span> <span class="o">==</span> <span class="s2">&quot;structured&quot;</span><span class="p">:</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decomposed_answer_type</span><span class="p">()</span><span class="o">.</span><span class="n">final</span>
            <span class="n">structured_output</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">StructuredOutputSettings</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">tool_types</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_tools</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">parser</span><span class="p">):</span>
            <span class="n">tools</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">ToolSettings</span><span class="p">(</span>
                <span class="n">tool_types</span><span class="p">,</span> <span class="n">force_tool_call</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">parser</span> <span class="o">==</span> <span class="s2">&quot;final_tool_call&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">dp</span><span class="o">.</span><span class="n">QuerySettings</span><span class="p">(</span>
            <span class="n">structured_output</span><span class="o">=</span><span class="n">structured_output</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_structured_output_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypeAnnot</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="n">ty</span><span class="o">.</span><span class="n">NoTypeInfo</span><span class="p">:</span>
        <span class="n">decomposed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decomposed_answer_type</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">decomposed</span><span class="o">.</span><span class="n">final</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_query_tools</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">:</span> <span class="n">ParserSpec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
        <span class="n">ans_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decomposed_answer_type</span><span class="p">()</span>
        <span class="n">tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">ans_type</span><span class="o">.</span><span class="n">resp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tools</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">ans_type</span><span class="o">.</span><span class="n">resp</span><span class="o">.</span><span class="n">tools</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">parser</span> <span class="o">==</span> <span class="s2">&quot;final_tool_call&quot;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ans_type</span><span class="o">.</span><span class="n">final</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span>
            <span class="n">tools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ans_type</span><span class="o">.</span><span class="n">final</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tools</span>

    <span class="c1">### Query Prefixes</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_has_special_prefix_attr</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">annots</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">get_type_hints</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;prefix&quot;</span> <span class="ow">in</span> <span class="n">annots</span> <span class="ow">and</span> <span class="n">annots</span><span class="p">[</span><span class="s2">&quot;prefix&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="n">ct</span><span class="o">.</span><span class="n">AnswerPrefix</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">query_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ct</span><span class="o">.</span><span class="n">AnswerPrefix</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the value of the `prefix` attribute if it has type</span>
<span class="sd">        annotation `AnswerPrefix` or return `None`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_special_prefix_attr</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;prefix&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1">### Producing Prompts</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_prompt</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">kind</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;instance&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">AnswerMode</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">],</span>
        <span class="n">extra_args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">env</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">TemplatesManager</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">env</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">_no_prompt_manager_error</span><span class="p">()</span>
        <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="p">,</span>
            <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="n">mode</span><span class="p">,</span>
            <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">params</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">extra_args</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extra_args</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">glob</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">globals</span><span class="p">())</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s2">&quot;globals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">glob</span>
        <span class="k">return</span> <span class="n">env</span><span class="o">.</span><span class="n">prompt</span><span class="p">(</span>
            <span class="n">query_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">query_name</span><span class="p">(),</span>
            <span class="n">prompt_kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span>
            <span class="n">template_args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
            <span class="n">default_template</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_default_prompt</span><span class="p">(</span><span class="n">kind</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_default_prompt</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">kind</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;instance&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">attr_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;__</span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="s2">_prompt__&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;instance&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_has_special_prefix_attr</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">DEFAULT_INSTANCE_PROMPT_WITH_PREFIX</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">DEFAULT_INSTANCE_PROMPT</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;system&quot;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">doc</span> <span class="o">:=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="bp">cls</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">doc</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;feedback&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DEFAULT_FEEDBACK_PROMPT</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">globals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return global objects accessible in prompts via the `globals`</span>
<span class="sd">        attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1">### Other Simple Overrides</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">serialize_args</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">],</span> <span class="n">ty</span><span class="o">.</span><span class="n">pydantic_dump</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_answer_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypeAnnot</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">dpi</span><span class="o">.</span><span class="n">first_parameter_of_base_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">answer_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypeAnnot</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_answer_type</span><span class="p">()</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">finite_answer_set</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">Answer</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># We handle the special case where the return type is a literal</span>
        <span class="c1"># type that is a subtype of str.</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_type</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">:=</span> <span class="n">_match_string_literal_type</span><span class="p">(</span><span class="n">ans</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">Answer</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">res</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">query_modes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">AnswerMode</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__modes__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__modes__</span>
        <span class="k">return</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>

    <span class="c1">### Generating Opaque Spaces</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">using</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_policy</span><span class="p">:</span> <span class="n">EllipsisType</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Opaque</span><span class="p">[</span><span class="n">IPDict</span><span class="p">,</span> <span class="n">T</span><span class="p">]:</span> <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">using</span><span class="p">[</span><span class="n">P</span><span class="p">](</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">get_policy</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">P</span><span class="p">],</span> <span class="n">pol</span><span class="o">.</span><span class="n">PromptingPolicy</span><span class="p">]</span> <span class="o">|</span> <span class="n">EllipsisType</span><span class="p">,</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="n">inner_policy_type</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">P</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Opaque</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">]:</span> <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">using</span><span class="p">[</span><span class="n">P</span><span class="p">](</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">get_policy</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">P</span><span class="p">],</span> <span class="n">pol</span><span class="o">.</span><span class="n">PromptingPolicy</span><span class="p">]</span> <span class="o">|</span> <span class="n">EllipsisType</span><span class="p">,</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="n">inner_policy_type</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">P</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Opaque</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Turn a query into an opaque space by providing a mapping from</span>
<span class="sd">        the ambient inner policy to a prompting policy.</span>

<span class="sd">        Attributes:</span>
<span class="sd">            get_policy: A function that maps the ambient inner policy to</span>
<span class="sd">                a prompting policy to use for answering the query.</span>
<span class="sd">                Alternatively, if the ellipsis value `...` is passed, the</span>
<span class="sd">                inner policy type is assumed to be `IPDict`, and</span>
<span class="sd">                prompting policies are automatically selected using tags</span>
<span class="sd">                (see `IPDict` documentation).</span>
<span class="sd">            inner_policy_type: Ambient inner policy type. This information</span>
<span class="sd">                is not used at runtime but it can be provided to help type</span>
<span class="sd">                inference when necessary.</span>

<span class="sd">        The optional `inner_policy_type` argument is ignored at runtime</span>
<span class="sd">        and can be used to help type checkers infer the type of the</span>
<span class="sd">        ambient inner policy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">get_policy</span><span class="p">,</span> <span class="n">EllipsisType</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">OpaqueSpace</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">]</span><span class="o">.</span><span class="n">from_query</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">cast</span><span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">pol</span><span class="o">.</span><span class="n">dict_subpolicy</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">OpaqueSpace</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">]</span><span class="o">.</span><span class="n">from_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">get_policy</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_toplevel</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">env</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">PolicyEnv</span><span class="p">,</span>
        <span class="n">policy</span><span class="p">:</span> <span class="n">pol</span><span class="o">.</span><span class="n">PromptingPolicy</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Stream</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Obtain a search stream of query answers, given a prompting</span>
<span class="sd">        policy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">attached</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">spawn_standalone_query</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">policy</span><span class="p">(</span><span class="n">attached</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="delphyne.Query.parse_answer" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">parse_answer</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">parse_answer</span><span class="p">(</span><span class="n">answer</span><span class="p">:</span> <span class="n"><span title="delphyne.core.Answer">Answer</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="delphyne.stdlib.queries.Query[T]">Query[T]</span></span> <span class="o">|</span> <span class="n"><span title="delphyne.core.ParseError">ParseError</span></span>
</code></pre></div>

    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@override</span>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_answer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">answer</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">Answer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span> <span class="o">|</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">answer</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_modes</span><span class="p">(),</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Unknown mode: </span><span class="si">{</span><span class="n">answer</span><span class="o">.</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">e</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.Query.query_config" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">query_config</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">query_config</span><span class="p">(</span><span class="n">mode</span><span class="p">:</span> <span class="n"><span title="delphyne.core.AnswerMode">AnswerMode</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="QueryConfig


  
      dataclass
   (delphyne.stdlib.queries.QueryConfig)" href="#delphyne.stdlib.queries.QueryConfig">QueryConfig</a></span> <span class="o">|</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Map modes to configurations.</p>
<p>This method inspects the <code>__config__</code> and <code>__parser__</code> class
attributes (none or either can be set but not both).</p>
<ul>
<li>If no attribute is set, the default configuration is used for
      all modes, which uses the <code>"structured"</code> parser.</li>
<li>If <code>__config__</code> is set to a <code>QueryConfig</code>, this configuration
      is used for all modes.</li>
<li>Alternatively, <code>__config__</code> can be set to a dictionary mapping
      modes to configurations.</li>
<li>If <code>__parser__</code> is set to a parser specification, the default
      configuration is used for all modes, <em>except</em> that the
      provided parser is used instead of the default one.</li>
<li>Alternatively, <code>__parser__</code> can also be set to a dictionary.</li>
</ul>
<p>In the special case where the [<code>parse</code>][delphyne.parse] method is overriden and
only in this case, return <code>None</code> after ensuring that
<code>__config__</code> and <code>__parser__</code> are not set.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">query_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">AnswerMode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QueryConfig</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Map modes to configurations.</span>

<span class="sd">    This method inspects the `__config__` and `__parser__` class</span>
<span class="sd">    attributes (none or either can be set but not both).</span>

<span class="sd">    - If no attribute is set, the default configuration is used for</span>
<span class="sd">          all modes, which uses the `&quot;structured&quot;` parser.</span>
<span class="sd">    - If `__config__` is set to a `QueryConfig`, this configuration</span>
<span class="sd">          is used for all modes.</span>
<span class="sd">    - Alternatively, `__config__` can be set to a dictionary mapping</span>
<span class="sd">          modes to configurations.</span>
<span class="sd">    - If `__parser__` is set to a parser specification, the default</span>
<span class="sd">          configuration is used for all modes, *except* that the</span>
<span class="sd">          provided parser is used instead of the default one.</span>
<span class="sd">    - Alternatively, `__parser__` can also be set to a dictionary.</span>

<span class="sd">    In the special case where the `parse` method is overriden and</span>
<span class="sd">    only in this case, return `None` after ensuring that</span>
<span class="sd">    `__config__` and `__parser__` are not set.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">parse_overriden</span> <span class="o">=</span> <span class="n">dpi</span><span class="o">.</span><span class="n">is_method_overridden</span><span class="p">(</span><span class="n">Query</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;parse&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">parse_overriden</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__config__</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__parser__</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__config__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parser__</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="p">(</span>
            <span class="s2">&quot;Cannot have both __config__ and __parser__ attributes.&quot;</span>
        <span class="p">)</span>
        <span class="n">config_attr</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__config__</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config_attr</span><span class="p">,</span> <span class="n">QueryConfig</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">config_attr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config_attr</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">config_attr</span><span class="p">)[</span><span class="n">mode</span><span class="p">]</span>
    <span class="k">elif</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__parser__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">parser_attr</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__parser__</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parser_attr</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">parser_attr</span><span class="p">)[</span><span class="n">mode</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">parser_attr</span>
        <span class="n">_check_valid_parser_spec</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">QueryConfig</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">QueryConfig</span><span class="p">(</span><span class="s2">&quot;structured&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h2 id="documenting-a-dataclass">Documenting a Dataclass</h2>


<div class="doc doc-object doc-class">



<h3 id="delphyne.core.AttachedQuery" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">AttachedQuery</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">


        <p>Wrapper for a query attached to a specific space.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.core.AttachedQuery.query">query</span></code></td>
            <td>
                  <code><span title="delphyne.core.queries.AbstractQuery">AbstractQuery</span>[<span title="delphyne.core.trees.AttachedQuery[T]">AttachedQuery[T]</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The wrapped query.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.core.AttachedQuery.ref">ref</span></code></td>
            <td>
                  <code><span title="delphyne.core.refs.GlobalSpacePath">GlobalSpacePath</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A global reference to the space to which the query is
attached.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.core.AttachedQuery.parse_answer">parse_answer</span></code></td>
            <td>
                  <code><span title="collections.abc.Callable">Callable</span>[[<span title="delphyne.core.refs.Answer">Answer</span>], <span title="delphyne.core.refs.Tracked">Tracked</span>[<span title="delphyne.core.trees.AttachedQuery[T]">AttachedQuery[T]</span>] | <span title="delphyne.core.queries.ParseError">ParseError</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A wrapper around <code>self.query.parse_answer</code>,
which attaches proper tracking information to answers.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>src/delphyne/core/trees.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">AttachedQuery</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper for a query attached to a specific space.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        query: The wrapped query.</span>
<span class="sd">        ref: A global reference to the space to which the query is</span>
<span class="sd">            attached.</span>
<span class="sd">        parse_answer: A wrapper around `self.query.parse_answer`,</span>
<span class="sd">            which attaches proper tracking information to answers.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">query</span><span class="p">:</span> <span class="n">AbstractQuery</span><span class="p">[</span><span class="n">T</span><span class="p">]</span>
    <span class="n">ref</span><span class="p">:</span> <span class="n">refs</span><span class="o">.</span><span class="n">GlobalSpacePath</span>
    <span class="n">parse_answer</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">refs</span><span class="o">.</span><span class="n">Answer</span><span class="p">],</span> <span class="n">Tracked</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">|</span> <span class="n">ParseError</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div><h2 id="documenting-a-function">Documenting a Function</h2>


<div class="doc doc-object doc-function">



<a id="delphyne.few_shot"></a>
    <div class="doc doc-contents first">

        <p>The standard few-shot prompting policy.</p>
<p>A prompt is formed by concatenating a system prompt, a series of
examples (each of which consists in an instance prompt followed by
an answer), and a final answer prompt. Then, answers are repeatedly
sampled and parsed, until a spending request is declined.</p>
<p>Arguments:</p>
<pre><code>query: The query to answer. env: The policy environment. model:
The LLM to use for answering the query. params: Prompt
hyperparameters, which are passed to prompt
    templates as a `params` dictionary.
select_examples: A series of filters for selecting examples, to
    be applied in sequence. By default, no filter is used and so
    all available examples are fetched.
mode: The answer mode to use for parsing the query answer.
enable_logging: Whether to log raw oracle responses.
temperature: The temperature parameter to use with the LLM, as a
    number from 0 to 2.
num_concurrent: The number of completions to request for each
    LLM call. Note that most LLM providers only bill input
    tokens once, regardless of the number of completions.
max_requests: The maximum number of LLM requests to perform
    before the resulting seach stream terminates, if any.
no_wrap_parse_errors: If set to `True`, then parser results of
    type [`WrappedParseError`][delphyne.WrappedParseError] are unwrapped and treated as normal
    parse errors.
iterative_mode: If set to `False` (default), answers are
    repeatedly and independently sampled. If set to `True`, a
    single chat conversation occurs instead: Whenever a parse
    error occurs, a message is issued by rendering the
    `&lt;QueryName&gt;.repair.jinja` template, asking for a new
    attempt to be made (the [`ParseError`][delphyne.ParseError] object is available as
    an `error` template variable). After an answer is
    successfully generated and parsed, a message is issued by
    rendering the `&lt;QueryName&gt;.more.jinja` template, asking for
    another different answer to be generated.

    This special mode allows creating simple conversational
    agents with very little effort, by only defining a single
    query. However, it does not support tool calls, and the
    demonstration language cannot be used to illustrate how
    `repair` and `more` messages should be handled. For
    implementing more advanced conversational agents, see
    the standard [`interact`][delphyne.interact] strategy.
</code></pre>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@prompting_policy</span>
<span class="k">def</span><span class="w"> </span><span class="nf">few_shot</span><span class="p">[</span><span class="n">T</span><span class="p">](</span>
    <span class="n">query</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">AttachedQuery</span><span class="p">[</span><span class="n">T</span><span class="p">],</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">PolicyEnv</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">md</span><span class="o">.</span><span class="n">LLM</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">select_examples</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ExampleSelector</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
    <span class="n">mode</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">AnswerMode</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">enable_logging</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">num_concurrent</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">max_requests</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">no_wrap_parse_errors</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">iterative_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">StreamGen</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The standard few-shot prompting policy.</span>

<span class="sd">    A prompt is formed by concatenating a system prompt, a series of</span>
<span class="sd">    examples (each of which consists in an instance prompt followed by</span>
<span class="sd">    an answer), and a final answer prompt. Then, answers are repeatedly</span>
<span class="sd">    sampled and parsed, until a spending request is declined.</span>

<span class="sd">    Arguments:</span>

<span class="sd">        query: The query to answer. env: The policy environment. model:</span>
<span class="sd">        The LLM to use for answering the query. params: Prompt</span>
<span class="sd">        hyperparameters, which are passed to prompt</span>
<span class="sd">            templates as a `params` dictionary.</span>
<span class="sd">        select_examples: A series of filters for selecting examples, to</span>
<span class="sd">            be applied in sequence. By default, no filter is used and so</span>
<span class="sd">            all available examples are fetched.</span>
<span class="sd">        mode: The answer mode to use for parsing the query answer.</span>
<span class="sd">        enable_logging: Whether to log raw oracle responses.</span>
<span class="sd">        temperature: The temperature parameter to use with the LLM, as a</span>
<span class="sd">            number from 0 to 2.</span>
<span class="sd">        num_concurrent: The number of completions to request for each</span>
<span class="sd">            LLM call. Note that most LLM providers only bill input</span>
<span class="sd">            tokens once, regardless of the number of completions.</span>
<span class="sd">        max_requests: The maximum number of LLM requests to perform</span>
<span class="sd">            before the resulting seach stream terminates, if any.</span>
<span class="sd">        no_wrap_parse_errors: If set to `True`, then parser results of</span>
<span class="sd">            type `WrappedParseError` are unwrapped and treated as normal</span>
<span class="sd">            parse errors.</span>
<span class="sd">        iterative_mode: If set to `False` (default), answers are</span>
<span class="sd">            repeatedly and independently sampled. If set to `True`, a</span>
<span class="sd">            single chat conversation occurs instead: Whenever a parse</span>
<span class="sd">            error occurs, a message is issued by rendering the</span>
<span class="sd">            `&lt;QueryName&gt;.repair.jinja` template, asking for a new</span>
<span class="sd">            attempt to be made (the `ParseError` object is available as</span>
<span class="sd">            an `error` template variable). After an answer is</span>
<span class="sd">            successfully generated and parsed, a message is issued by</span>
<span class="sd">            rendering the `&lt;QueryName&gt;.more.jinja` template, asking for</span>
<span class="sd">            another different answer to be generated.</span>

<span class="sd">            This special mode allows creating simple conversational</span>
<span class="sd">            agents with very little effort, by only defining a single</span>
<span class="sd">            query. However, it does not support tool calls, and the</span>
<span class="sd">            demonstration language cannot be used to illustrate how</span>
<span class="sd">            `repair` and `more` messages should be handled. For</span>
<span class="sd">            implementing more advanced conversational agents, see</span>
<span class="sd">            the standard `interact` strategy.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">iterative_mode</span> <span class="ow">or</span> <span class="n">num_concurrent</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">max_requests</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">max_requests</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">env</span><span class="o">.</span><span class="n">tracer</span><span class="o">.</span><span class="n">trace_query</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">ref</span><span class="p">)</span>
    <span class="n">examples</span> <span class="o">=</span> <span class="n">fetch_examples</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">examples</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">query</span><span class="p">,</span> <span class="n">select_examples</span><span class="p">)</span>
    <span class="n">mngr</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">templates</span>
    <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">prompt</span> <span class="o">=</span> <span class="n">create_prompt</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">query</span><span class="p">,</span> <span class="n">examples</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">mngr</span><span class="p">)</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">query_settings</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
    <span class="n">options</span><span class="p">:</span> <span class="n">md</span><span class="o">.</span><span class="n">RequestOptions</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">temperature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">options</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temperature</span>
    <span class="n">structured_output</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">structured_output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out_type</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">structured_output</span><span class="o">.</span><span class="n">type</span>
        <span class="n">structured_output</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">Schema</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">out_type</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">tools</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">force_tool_call</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="s2">&quot;tool_choice&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;required&quot;</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="p">[</span><span class="n">md</span><span class="o">.</span><span class="n">Schema</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">tool_types</span><span class="p">]</span>
    <span class="n">num_reqs</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">max_requests</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">num_reqs</span> <span class="o">&lt;</span> <span class="n">max_requests</span><span class="p">:</span>
        <span class="n">num_reqs</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">LLMRequest</span><span class="p">(</span>
            <span class="n">prompt</span><span class="p">,</span>
            <span class="n">num_completions</span><span class="o">=</span><span class="n">num_concurrent</span><span class="p">,</span>
            <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">structured_output</span><span class="o">=</span><span class="n">structured_output</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">_send_request</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="n">SpendingDeclined</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="n">log_oracle_response</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">resp</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">enable_logging</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s2">&quot;llm_no_output&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">elements</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">Tracked</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">|</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">answers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">Answer</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">resp</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
            <span class="n">answer</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">Answer</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">output</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">))</span>
            <span class="n">answers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>
            <span class="n">element</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">parse_answer</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">no_wrap_parse_errors</span><span class="p">:</span>
                <span class="n">element</span> <span class="o">=</span> <span class="n">_unwrap_parse_error</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
            <span class="n">env</span><span class="o">.</span><span class="n">tracer</span><span class="o">.</span><span class="n">trace_answer</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">ref</span><span class="p">,</span> <span class="n">answer</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span><span class="p">):</span>
                <span class="n">log</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s2">&quot;parse_error&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">element</span><span class="p">},</span> <span class="n">loc</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>
            <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">dp</span><span class="o">.</span><span class="n">Solution</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="c1"># In iterative mode, we want to keep the conversation going</span>
        <span class="k">if</span> <span class="n">iterative_mode</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">answers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="n">element</span> <span class="o">=</span> <span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">repair</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">generate_prompt</span><span class="p">(</span>
                        <span class="n">kind</span><span class="o">=</span><span class="n">REPAIR_PROMPT</span><span class="p">,</span>
                        <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
                        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">params</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">element</span><span class="p">},</span>
                        <span class="n">env</span><span class="o">=</span><span class="n">mngr</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="n">dp</span><span class="o">.</span><span class="n">TemplateFileMissing</span><span class="p">:</span>
                    <span class="n">repair</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;Invalid answer. Please consider the following&quot;</span>
                        <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; feedback and try again:</span><span class="se">\n\n</span><span class="si">{</span><span class="n">element</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="n">new_message</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">UserMessage</span><span class="p">(</span><span class="n">repair</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">gen_new</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">generate_prompt</span><span class="p">(</span>
                        <span class="n">kind</span><span class="o">=</span><span class="n">REQUEST_OTHER_PROMPT</span><span class="p">,</span>
                        <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
                        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">params</span><span class="p">},</span>
                        <span class="n">env</span><span class="o">=</span><span class="n">mngr</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="n">dp</span><span class="o">.</span><span class="n">TemplateFileMissing</span><span class="p">:</span>
                    <span class="n">gen_new</span> <span class="o">=</span> <span class="s2">&quot;Good! Can you generate a different answer now?&quot;</span>
                <span class="n">new_message</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">UserMessage</span><span class="p">(</span><span class="n">gen_new</span><span class="p">)</span>

            <span class="n">prompt</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">prompt</span><span class="p">,</span> <span class="n">md</span><span class="o">.</span><span class="n">AssistantMessage</span><span class="p">(</span><span class="n">answers</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">new_message</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h2 id="documenting-a-whole-module">Documenting a whole module</h2>


<div class="doc doc-object doc-module">



<h3 id="delphyne.stdlib.queries" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">queries</span>


</h3>

    <div class="doc doc-contents first">

        <p>Standard queries and building blocks for prompting policies.</p>









  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h4 id="delphyne.stdlib.queries.ASSISTANT_PRIMING_STR" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">ASSISTANT_PRIMING_STR</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">ASSISTANT_PRIMING_STR</span> <span class="o">=</span> <span class="s1">&#39;!&lt;assistant&gt;&#39;</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Single-line separator between the user and assistant messages in a
prompt that uses assistant priming.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="delphyne.stdlib.queries.DEFAULT_FEEDBACK_PROMPT" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">DEFAULT_FEEDBACK_PROMPT</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">DEFAULT_FEEDBACK_PROMPT</span> <span class="o">=</span> <span class="n"><span title="str.lstrip">lstrip</span></span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Default template for feedback prompts.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="delphyne.stdlib.queries.DEFAULT_INSTANCE_PROMPT" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">DEFAULT_INSTANCE_PROMPT</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">DEFAULT_INSTANCE_PROMPT</span> <span class="o">=</span> <span class="s1">&#39;{{query | yaml | trim}}&#39;</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Default instance prompt template.</p>
<p>See <code>DEFAULT_INSTANCE_PROMPT_WITH_PREFIX</code> for the special case where
queries have a special <code>prefix</code> attribute.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="delphyne.stdlib.queries.DEFAULT_INSTANCE_PROMPT_WITH_PREFIX" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">DEFAULT_INSTANCE_PROMPT_WITH_PREFIX</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">DEFAULT_INSTANCE_PROMPT_WITH_PREFIX</span> <span class="o">=</span> <span class="s2">&quot;{{query | yaml(exclude_fields=[&#39;prefix&#39;]) | trim}}&quot;</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Default instance prompt template in the presence of a special <code>prefix</code>
attribute.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="delphyne.stdlib.queries.ExampleSelector" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">ExampleSelector</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">ExampleSelector</span><span class="p">:</span> <span class="n"><span title="collections.abc.Callable">Callable</span></span><span class="p">[[</span><span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><span title="delphyne.core.Example">Example</span></span><span class="p">]],</span> <span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><span title="delphyne.core.Example">Example</span></span><span class="p">]]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>A function for selecting a subset of examples from a given sequence.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="delphyne.stdlib.queries.ParserSpec" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">ParserSpec</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">ParserSpec</span><span class="p">:</span> <span class="n"><span title="delphyne.stdlib.queries._StandardParserName">_StandardParserName</span></span> <span class="o">|</span> <span class="n"><a class="autorefs autorefs-internal" title="GenericTextParser (delphyne.stdlib.queries.GenericTextParser)" href="#delphyne.stdlib.queries.GenericTextParser">GenericTextParser</a></span> <span class="o">|</span> <span class="n"><a class="autorefs autorefs-internal" title="TextParser (delphyne.stdlib.queries.TextParser)" href="#delphyne.stdlib.queries.TextParser">TextParser</a></span><span class="p">[</span><span class="n"><span title="typing.Any">Any</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>A parser specification, which can be either:</p>
<ul>
<li><strong>"structured"</strong>: Oracles must answer with structured output, and the
      resulting JSON object is parsed using Pydantic.</li>
<li><strong>"final_tool_call"</strong>: The query answer type is presented to oracles
      as a tool, which must be called to produce the final answer. This
      provides an alternative to "structured", which additionally allows
      a chain of thoughts to precede the final answer.</li>
<li><strong>A generic text parser</strong>: See <code>GenericTextParser</code>. Oracles are then
      expected to produce a string answer, which is parsed using the
      provided function.</li>
<li><strong>A text parser</strong>: See <code>TextParser</code>. Oracles are then
      expected to produce a string answer, which is parsed using the
      provided function.</li>
</ul>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="delphyne.stdlib.queries.ParserSpecDict" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">ParserSpecDict</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">ParserSpecDict</span><span class="p">:</span> <span class="n"><span title="collections.abc.Mapping">Mapping</span></span><span class="p">[</span><span class="n"><span title="delphyne.core.AnswerMode">AnswerMode</span></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-internal" title="ParserSpec (delphyne.stdlib.queries.ParserSpec)" href="#delphyne.stdlib.queries.ParserSpec">ParserSpec</a></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>A dictionary mapping answer modes to parser specifications.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="delphyne.stdlib.queries.QueryConfigDict" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">QueryConfigDict</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">QueryConfigDict</span><span class="p">:</span> <span class="n"><span title="collections.abc.Mapping">Mapping</span></span><span class="p">[</span><span class="n"><span title="delphyne.core.AnswerMode">AnswerMode</span></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-internal" title="QueryConfig


  
      dataclass
   (delphyne.stdlib.queries.QueryConfig)" href="#delphyne.stdlib.queries.QueryConfig">QueryConfig</a></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>A dictionary mapping answer modes to query configurations.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="delphyne.stdlib.queries.REPAIR_PROMPT" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">REPAIR_PROMPT</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">REPAIR_PROMPT</span> <span class="o">=</span> <span class="s1">&#39;repair&#39;</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Template name suffix for repair prompts.
See <code>interactive</code> argument of <a class="autorefs autorefs-internal" href="#delphyne.few_shot"><code>few_shot</code></a>.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="delphyne.stdlib.queries.REQUEST_OTHER_PROMPT" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">REQUEST_OTHER_PROMPT</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">REQUEST_OTHER_PROMPT</span> <span class="o">=</span> <span class="s1">&#39;more&#39;</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Template name suffix for a requesting different solution
See <code>interactive</code> argument of <a class="autorefs autorefs-internal" href="#delphyne.few_shot"><code>few_shot</code></a>.</p>

    </div>

</div>


<div class="doc doc-object doc-class">



<h4 id="delphyne.stdlib.queries.FinalAnswer" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">FinalAnswer</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">


        <p>See <a class="autorefs autorefs-internal" title="Response


  
      dataclass
  " href="#delphyne.stdlib.queries.Response"><code>Response</code></a>.</p>










  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="delphyne.stdlib.queries.GenericTextParser" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">GenericTextParser</span>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="typing.Protocol">Protocol</span></code></p>


        <p>A function that takes a type annotation along with a string as
arguments and either returns a parsed object of the specified
type or raises [<code>ParseError</code>][delphyne.ParseError].</p>
<p>Example: <a class="autorefs autorefs-internal" title="yaml_from_last_block" href="#delphyne.stdlib.queries.yaml_from_last_block"><code>yaml_from_last_block</code></a>.</p>










  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="delphyne.stdlib.queries.ProbInfo" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">ProbInfo</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="delphyne.core.SearchMeta">SearchMeta</span></code></p>


        <p>Distribution probability, guaranteed to be nonempty and to sum to 1.</p>










  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="delphyne.stdlib.queries.Query" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">Query</span>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="delphyne.core.AbstractQuery">AbstractQuery</span>[<span title="delphyne.stdlib.queries.Query[T]">Query[T]</span>]</code></p>


        <p>Base class for queries.</p>
<p>This class adds standard convenience features on top of
[<code>AbstractQuery</code>][delphyne.AbstractQuery], using reflection to allow queries to be defined
concisely. Here is a simple example of a query type definition:</p>
<pre><code>@dataclass class MakeSum(Query[list[int]]):
    ''' Given a list of allowed numbers and a target number, you
    must find a sub-list whose elements sum up to the target.
    Just answer with a list of numbers as a JSON object and
    nothing else. '''

    allowed: list[int] target: int
</code></pre>
<p>In general, a query type is a dataclass that inherits <code>Query[T]</code>,
where <code>T</code> is the query's answer type. In the example above, no
parser is specified and so oracles are requested to provide
structured answers as JSON objects, which are automatically parsed
into the answer type (<code>list[int]</code>) using pydantic. Assuming that no
Jinja prompt file is provided, the docstring is used as a system
prompt and instance prompts are generated by simply serializing
<code>MakeSum</code> instances into YAML.</p>
<h6 id="delphyne.stdlib.queries.Query--customizing-prompts">Customizing Prompts</h6>
<p>System and instance prompts can be specified via Jinja templates.
The templates manager ([<code>TemplatesManager</code>][delphyne.TemplatesManager]) looks for templates named
"<QueryName>.<instance|system>.jinja". Templates can also be
provided by defining the <code>__system_prompt__</code> and/or <code>__instance_prompt__</code>
class attributes. If none of these are provided, the query's
docstring is used as a system prompt and <code>DEFAULT_INSTANCE_PROMPT</code>
is used as an instance prompt template.</p>
<p>The following arguments are usually made available to templates
(although specific prompting policies can add more):</p>
<ul>
<li><code>query</code>: the query instance.</li>
<li><code>mode</code>: the requested answer mode.</li>
<li><code>params</code>: the query hyperparameters (e.g., as passed to <a class="autorefs autorefs-internal" href="#delphyne.few_shot"><code>few_shot</code></a>)</li>
</ul>
<h6 id="delphyne.stdlib.queries.Query--answer-modes-and-configurations">Answer Modes and Configurations</h6>
<p>A query can define several answer modes ([<code>AnswerMode</code>][delphyne.AnswerMode]), each of
which can be associated with a different parser and set of settings.
By default, the only answer mode is <code>None</code>. More answer modes can be
defined by setting class variable <code>__modes__</code>.</p>
<p>The <code>query_config</code> method maps modes to configurations (i.e., a set
of settings, including a parser specification). Its default behavior
works by inspecting the <code>__parser__</code> and <code>__config__</code> class
attributes and does not typically require overriding.</p>
<h6 id="delphyne.stdlib.queries.Query--allowing-multi-message-exchanges-and-tool-calls">Allowing Multi-Message Exchanges and Tool Calls</h6>
<p>A common pattern for interacting with LLMs is to have multi-message
exchanges where the full conversation history is resent repeatedly.
LLMs are also often allowed to request tool call. This interaction
pattern is implemented in the [<code>interact</code>][delphyne.interact] standard strategy. It is
enabled by several features on the <a class="autorefs autorefs-internal" title="Query" href="#delphyne.Query"><code>Query</code></a> side.</p>
<h6 id="delphyne.stdlib.queries.Query--answer-prefixes">Answer Prefixes</h6>
<p>If a query type has a prefix attribute with type <a class="autorefs autorefs-internal" title="AnswerPrefix" href="#delphyne.AnswerPrefix"><code>AnswerPrefix</code></a>,
this attribute can be used to provide a chat history, to be added to
the query's prompt.</p>
<h6 id="delphyne.stdlib.queries.Query--the-response-type">The <a class="autorefs autorefs-internal" title="Response


  
      dataclass
  " href="#delphyne.stdlib.queries.Response"><code>Response</code></a> Type</h6>
<p>If the query answer type is <a class="autorefs autorefs-internal" title="Response


  
      dataclass
  " href="#delphyne.stdlib.queries.Response"><code>Response</code></a>, the query does not only
return a parsed answer, but also the LLM raw answer (which can be
appended to a chat history), and possibly a sequence of tool calls.</p>
<h6 id="delphyne.stdlib.queries.Query--manually-overriding-the-parse-method">Manually Overriding the [<code>parse</code>][delphyne.parse] Method</h6>
<p>For advanced use cases, it is possible to directly override the
[<code>parse</code>][delphyne.parse] method that turns an answer into an object of type <code>T</code>. When
this is done, the <code>__config__</code> and <code>__parser__</code> class attributes
must not be set. Also, the <code>query_settings</code> method always returns
the default settings instead of relying on <code>query_config</code> and must
be overriden if another behavior is desired.</p>










  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h5 id="delphyne.stdlib.queries.Query.globals" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">globals</span>


</h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">globals</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n"><span title="dict">dict</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="object">object</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Return global objects accessible in prompts via the [<code>globals</code>][delphyne.globals]
attribute.</p>


    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="delphyne.stdlib.queries.Query.parse" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">parse</span>


</h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">parse</span><span class="p">(</span><span class="n">answer</span><span class="p">:</span> <span class="n"><span title="delphyne.core.refs.Answer">Answer</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="delphyne.stdlib.queries.Query[T]">Query[T]</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>A more convenient method to override instead of <code>parse_answer</code>.</p>
<p>Raises [<code>ParseError</code>][delphyne.ParseError].</p>


    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="delphyne.stdlib.queries.Query.query_config" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">query_config</span>


</h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">query_config</span><span class="p">(</span><span class="n">mode</span><span class="p">:</span> <span class="n"><span title="delphyne.core.AnswerMode">AnswerMode</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="QueryConfig


  
      dataclass
   (delphyne.stdlib.queries.QueryConfig)" href="#delphyne.stdlib.queries.QueryConfig">QueryConfig</a></span> <span class="o">|</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Map modes to configurations.</p>
<p>This method inspects the <code>__config__</code> and <code>__parser__</code> class
attributes (none or either can be set but not both).</p>
<ul>
<li>If no attribute is set, the default configuration is used for
      all modes, which uses the <code>"structured"</code> parser.</li>
<li>If <code>__config__</code> is set to a <code>QueryConfig</code>, this configuration
      is used for all modes.</li>
<li>Alternatively, <code>__config__</code> can be set to a dictionary mapping
      modes to configurations.</li>
<li>If <code>__parser__</code> is set to a parser specification, the default
      configuration is used for all modes, <em>except</em> that the
      provided parser is used instead of the default one.</li>
<li>Alternatively, <code>__parser__</code> can also be set to a dictionary.</li>
</ul>
<p>In the special case where the [<code>parse</code>][delphyne.parse] method is overriden and
only in this case, return <code>None</code> after ensuring that
<code>__config__</code> and <code>__parser__</code> are not set.</p>


    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="delphyne.stdlib.queries.Query.query_prefix" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">query_prefix</span>


</h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">query_prefix</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="AnswerPrefix (delphyne.core.chats.AnswerPrefix)" href="#delphyne.AnswerPrefix">AnswerPrefix</a></span> <span class="o">|</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Return the value of the <code>prefix</code> attribute if it has type
annotation <a class="autorefs autorefs-internal" title="AnswerPrefix" href="#delphyne.AnswerPrefix"><code>AnswerPrefix</code></a> or return <code>None</code>.</p>


    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="delphyne.stdlib.queries.Query.query_settings" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">query_settings</span>


</h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">query_settings</span><span class="p">(</span><span class="n">mode</span><span class="p">:</span> <span class="n"><span title="delphyne.core.AnswerMode">AnswerMode</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="delphyne.core.QuerySettings">QuerySettings</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Return the settings associated with the query.</p>
<p>By default, this method uses the result of <code>query_config</code> to
determine settings if [<code>parse</code>][delphyne.parse] is not overriden, and the default
set of settings otherwise.</p>


    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="delphyne.stdlib.queries.Query.run_toplevel" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">run_toplevel</span>


</h5>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">run_toplevel</span><span class="p">(</span><span class="n">env</span><span class="p">:</span> <span class="n"><span title="delphyne.core.PolicyEnv">PolicyEnv</span></span><span class="p">,</span> <span class="n">policy</span><span class="p">:</span> <span class="n"><span title="delphyne.stdlib.policies.PromptingPolicy">PromptingPolicy</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Stream


  
      dataclass
   (delphyne.stdlib.streams.Stream)" href="#delphyne.Stream">Stream</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.Query[T]">Query[T]</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Obtain a search stream of query answers, given a prompting
policy.</p>


    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="delphyne.stdlib.queries.Query.using" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">using</span>


</h5>
          <div class="doc-overloads">
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">using</span><span class="p">(</span><span class="n">get_policy</span><span class="p">:</span> <span class="n"><span title="types.EllipsisType">EllipsisType</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="delphyne.stdlib.opaque.Opaque">Opaque</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="IPDict (delphyne.stdlib.policies.IPDict)" href="#delphyne.IPDict">IPDict</a></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.queries.Query[T]">Query[T]</span></span><span class="p">]</span>
</code></pre></div><div class="doc-signature highlight"><pre><span></span><code><span class="nf">using</span><span class="p">(</span><span class="n">get_policy</span><span class="p">:</span> <span class="n"><span title="collections.abc.Callable">Callable</span></span><span class="p">[[</span><span class="n"><span title="delphyne.stdlib.queries.Query.using[P]">using[P]</span></span><span class="p">],</span> <span class="n"><span title="delphyne.stdlib.policies.PromptingPolicy">PromptingPolicy</span></span><span class="p">]</span> <span class="o">|</span> <span class="n"><span title="types.EllipsisType">EllipsisType</span></span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="n">inner_policy_type</span><span class="p">:</span> <span class="n"><span title="type">type</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.Query.using[P]">using[P]</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="delphyne.stdlib.opaque.Opaque">Opaque</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.Query.using[P]">using[P]</span></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.queries.Query[T]">Query[T]</span></span><span class="p">]</span>
</code></pre></div>          </div>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">using</span><span class="p">(</span><span class="n">get_policy</span><span class="p">:</span> <span class="n"><span title="collections.abc.Callable">Callable</span></span><span class="p">[[</span><span class="n"><span title="delphyne.stdlib.queries.Query.using[P]">using[P]</span></span><span class="p">],</span> <span class="n"><span title="delphyne.stdlib.policies.PromptingPolicy">PromptingPolicy</span></span><span class="p">]</span> <span class="o">|</span> <span class="n"><span title="types.EllipsisType">EllipsisType</span></span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="n">inner_policy_type</span><span class="p">:</span> <span class="n"><span title="type">type</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.Query.using[P]">using[P]</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="delphyne.stdlib.opaque.Opaque">Opaque</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.Query.using[P]">using[P]</span></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.queries.Query[T]">Query[T]</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Turn a query into an opaque space by providing a mapping from
the ambient inner policy to a prompting policy.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.queries.Query.using.get_policy">get_policy</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A function that maps the ambient inner policy to
a prompting policy to use for answering the query.
Alternatively, if the ellipsis value <code>...</code> is passed, the
inner policy type is assumed to be <a class="autorefs autorefs-internal" title="IPDict" href="#delphyne.IPDict"><code>IPDict</code></a>, and
prompting policies are automatically selected using tags
(see <a class="autorefs autorefs-internal" title="IPDict" href="#delphyne.IPDict"><code>IPDict</code></a> documentation).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.queries.Query.using.inner_policy_type">inner_policy_type</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Ambient inner policy type. This information
is not used at runtime but it can be provided to help type
inference when necessary.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
        <p>The optional <code>inner_policy_type</code> argument is ignored at runtime
and can be used to help type checkers infer the type of the
ambient inner policy.</p>


    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="delphyne.stdlib.queries.QueryConfig" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">QueryConfig</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">


        <p>Mode-specific query settings.</p>
<p>More settings could be added in the future.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.queries.QueryConfig.parser">parser</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="ParserSpec (delphyne.stdlib.queries.ParserSpec)" href="#delphyne.stdlib.queries.ParserSpec">ParserSpec</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A parser specification.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>










  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="delphyne.stdlib.queries.Response" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">Response</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">


        <p>Answer type for queries that allow follow-ups.</p>
<p><a class="autorefs autorefs-internal" title="Response


  
      dataclass
  " href="#delphyne.stdlib.queries.Response"><code>Response</code></a> values give access to both the raw LLM response (to be
passed pass in <a class="autorefs autorefs-internal" title="AnswerPrefix" href="#delphyne.AnswerPrefix"><code>AnswerPrefix</code></a>) and to eventual tool calls.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.queries.Response.answer">answer</span></code></td>
            <td>
                  <code><span title="delphyne.core.Answer">Answer</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The raw, unparsed LLM answer.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.queries.Response.parsed">parsed</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="FinalAnswer


  
      dataclass
   (delphyne.stdlib.queries.FinalAnswer)" href="#delphyne.stdlib.queries.FinalAnswer">FinalAnswer</a>[<span title="delphyne.stdlib.queries.Response[F]">Response[F]</span>] | <a class="autorefs autorefs-internal" title="ToolRequests


  
      dataclass
   (delphyne.stdlib.queries.ToolRequests)" href="#delphyne.stdlib.queries.ToolRequests">ToolRequests</a>[<span title="delphyne.stdlib.queries.Response[T]">Response[T]</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Either the parsed answer wrapped in <a class="autorefs autorefs-internal" title="FinalAnswer


  
      dataclass
  " href="#delphyne.stdlib.queries.FinalAnswer"><code>FinalAnswer</code></a> or
some tool call requests wrapped in <a class="autorefs autorefs-internal" title="ToolRequests


  
      dataclass
  " href="#delphyne.stdlib.queries.ToolRequests"><code>ToolRequests</code></a>.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>










  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="delphyne.stdlib.queries.TextParser" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">TextParser</span>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="typing.Protocol">Protocol</span></code></p>


        <p>A function that takes a string as an argument and either returns
a parsed object or raises [<code>ParseError</code>][delphyne.ParseError].</p>










  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="delphyne.stdlib.queries.ToolRequests" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">ToolRequests</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">


        <p>See <a class="autorefs autorefs-internal" title="Response


  
      dataclass
  " href="#delphyne.stdlib.queries.Response"><code>Response</code></a>.</p>










  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="delphyne.stdlib.queries.WrappedParseError" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">WrappedParseError</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">


        <p>A wrapped parse error that is returned to a strategy instead of
causing a failure.</p>
<p>For queries that declare a return type of the form <code>Response[... |
WrappedParseError, ...]</code>, parse errors do not result in failures but
are instead wrapped and returned, to be handled explicitly by the
surrounding strategy. For example, when building conversational
agents with [<code>interact</code>][delphyne.interact], having the query include <a class="autorefs autorefs-internal" title="WrappedParseError


  
      dataclass
  " href="#delphyne.stdlib.queries.WrappedParseError"><code>WrappedParseError</code></a>
in its return type allows explicitly asking the agent to fix parse
errors instead of failing (or having the policy retry an identical
prompt).</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.queries.WrappedParseError.error">error</span></code></td>
            <td>
                  <code><span title="delphyne.core.ParseError">ParseError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The wrapped parse error.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>










  <div class="doc doc-children">











  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h4 id="delphyne.stdlib.queries.answer_with" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">answer_with</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">answer_with</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="AttachedQuery


  
      dataclass
   (delphyne.core.AttachedQuery)" href="#delphyne.core.AttachedQuery">AttachedQuery</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.answer_with[T]">answer_with[T]</span></span><span class="p">],</span> <span class="n">env</span><span class="p">:</span> <span class="n"><span title="delphyne.core.PolicyEnv">PolicyEnv</span></span><span class="p">,</span> <span class="n">answers</span><span class="p">:</span> <span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">],</span> <span class="n">probs</span><span class="p">:</span> <span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><span title="float">float</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n"><span title="delphyne.core.AnswerMode">AnswerMode</span></span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="delphyne.core.StreamGen">StreamGen</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.answer_with[T]">answer_with[T]</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>A prompting policy that returns a hardcoded set of answers without
looking at the query. If <code>probs</code> is not provided, then all elements
are yielded in sequence. If it is, the top element is yielded once,
with a <a class="autorefs autorefs-internal" title="ProbInfo


  
      dataclass
  " href="#delphyne.stdlib.queries.ProbInfo"><code>ProbInfo</code></a> annotation featuring the provided distribution.</p>


    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.stdlib.queries.classify" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">classify</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">classify</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="AttachedQuery


  
      dataclass
   (delphyne.core.AttachedQuery)" href="#delphyne.core.AttachedQuery">AttachedQuery</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.classify[T]">classify[T]</span></span><span class="p">],</span> <span class="n">env</span><span class="p">:</span> <span class="n"><span title="delphyne.core.PolicyEnv">PolicyEnv</span></span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n"><span title="delphyne.stdlib.models.LLM">LLM</span></span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n"><span title="dict">dict</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="object">object</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">select_examples</span><span class="p">:</span> <span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="ExampleSelector (delphyne.stdlib.queries.ExampleSelector)" href="#delphyne.stdlib.queries.ExampleSelector">ExampleSelector</a></span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span> <span class="n">mode</span><span class="p">:</span> <span class="n"><span title="delphyne.core.AnswerMode">AnswerMode</span></span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">enable_logging</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">top_logprobs</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">temperature</span><span class="p">:</span> <span class="n"><span title="float">float</span></span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">bias</span><span class="p">:</span> <span class="n"><span title="tuple">tuple</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="float">float</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="delphyne.core.StreamGen">StreamGen</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.classify[T]">classify[T]</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Execute a classification query, attaching a probability distribution
to the attached answer.</p>
<p>Attributes:</p>
<pre><code>query: The query to answer.
env: The global policy environment.
model: The LLM to use for answering the query.
params: Prompt hyperparameters.
select_examples: Example selector.
mode: The answer mode to use for parsing the query answer.
enable_logging: Whether to log raw oracle responses.
top_logprobs: The number of top logprobs to request from the
    LLM, putting an upper bound on the support size of the
    classifier's output distributions.
temperature: A temperature to apply to the classifier's output
    distribution (a temperature of 0 means that only top
    elements are assigned a nonzero probability).
bias: When `bias=(e, p)` is provided, the final classifier
    distribution `D` is transformed into `(1-p)*D + p*dirac(e)`
</code></pre>
<p>See <a class="autorefs autorefs-internal" href="#delphyne.few_shot"><code>few_shot</code></a> for details on some of the arguments above.</p>


    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.stdlib.queries.few_shot" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">few_shot</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">few_shot</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="AttachedQuery


  
      dataclass
   (delphyne.core.AttachedQuery)" href="#delphyne.core.AttachedQuery">AttachedQuery</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.few_shot[T]">few_shot[T]</span></span><span class="p">],</span> <span class="n">env</span><span class="p">:</span> <span class="n"><span title="delphyne.core.PolicyEnv">PolicyEnv</span></span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n"><span title="delphyne.stdlib.models.LLM">LLM</span></span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n"><span title="dict">dict</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="object">object</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">select_examples</span><span class="p">:</span> <span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="ExampleSelector (delphyne.stdlib.queries.ExampleSelector)" href="#delphyne.stdlib.queries.ExampleSelector">ExampleSelector</a></span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span> <span class="n">mode</span><span class="p">:</span> <span class="n"><span title="delphyne.core.AnswerMode">AnswerMode</span></span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">enable_logging</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">temperature</span><span class="p">:</span> <span class="n"><span title="float">float</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">num_concurrent</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max_requests</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">no_wrap_parse_errors</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">iterative_mode</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="delphyne.core.StreamGen">StreamGen</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.few_shot[T]">few_shot[T]</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>The standard few-shot prompting policy.</p>
<p>A prompt is formed by concatenating a system prompt, a series of
examples (each of which consists in an instance prompt followed by
an answer), and a final answer prompt. Then, answers are repeatedly
sampled and parsed, until a spending request is declined.</p>
<p>Arguments:</p>
<pre><code>query: The query to answer. env: The policy environment. model:
The LLM to use for answering the query. params: Prompt
hyperparameters, which are passed to prompt
    templates as a `params` dictionary.
select_examples: A series of filters for selecting examples, to
    be applied in sequence. By default, no filter is used and so
    all available examples are fetched.
mode: The answer mode to use for parsing the query answer.
enable_logging: Whether to log raw oracle responses.
temperature: The temperature parameter to use with the LLM, as a
    number from 0 to 2.
num_concurrent: The number of completions to request for each
    LLM call. Note that most LLM providers only bill input
    tokens once, regardless of the number of completions.
max_requests: The maximum number of LLM requests to perform
    before the resulting seach stream terminates, if any.
no_wrap_parse_errors: If set to `True`, then parser results of
    type [`WrappedParseError`][delphyne.WrappedParseError] are unwrapped and treated as normal
    parse errors.
iterative_mode: If set to `False` (default), answers are
    repeatedly and independently sampled. If set to `True`, a
    single chat conversation occurs instead: Whenever a parse
    error occurs, a message is issued by rendering the
    `&lt;QueryName&gt;.repair.jinja` template, asking for a new
    attempt to be made (the [`ParseError`][delphyne.ParseError] object is available as
    an `error` template variable). After an answer is
    successfully generated and parsed, a message is issued by
    rendering the `&lt;QueryName&gt;.more.jinja` template, asking for
    another different answer to be generated.

    This special mode allows creating simple conversational
    agents with very little effort, by only defining a single
    query. However, it does not support tool calls, and the
    demonstration language cannot be used to illustrate how
    `repair` and `more` messages should be handled. For
    implementing more advanced conversational agents, see
    the standard [`interact`][delphyne.interact] strategy.
</code></pre>


    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.stdlib.queries.first_word" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">first_word</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">first_word</span><span class="p">(</span><span class="nb">type</span><span class="p">:</span> <span class="n"><span title="delphyne.utils.typing.TypeAnnot">TypeAnnot</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.first_word[T]">first_word[T]</span></span><span class="p">],</span> <span class="n">res</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="delphyne.stdlib.queries.first_word[T]">first_word[T]</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Parse the first word of the answer and turn it into an object of
type T=Literal[s1,...,sn].</p>


    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.stdlib.queries.raw_string" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">raw_string</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">raw_string</span><span class="p">(</span><span class="n">type_annot</span><span class="p">:</span> <span class="n"><span title="delphyne.utils.typing.TypeAnnot">TypeAnnot</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.raw_string[T]">raw_string[T]</span></span><span class="p">],</span> <span class="n">res</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="delphyne.stdlib.queries.raw_string[T]">raw_string[T]</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Do not perform any parsing and return the answer as a raw string.</p>


    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.stdlib.queries.raw_yaml" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">raw_yaml</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">raw_yaml</span><span class="p">(</span><span class="nb">type</span><span class="p">:</span> <span class="n"><span title="delphyne.utils.typing.TypeAnnot">TypeAnnot</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.raw_yaml[T]">raw_yaml[T]</span></span><span class="p">],</span> <span class="n">res</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="delphyne.stdlib.queries.raw_yaml[T]">raw_yaml[T]</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Parse a text answer that consists in a single YAML object and
nothing else.</p>


    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.stdlib.queries.select_all_examples" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">select_all_examples</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">select_all_examples</span><span class="p">(</span><span class="n">examples</span><span class="p">:</span> <span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><span title="delphyne.core.Example">Example</span></span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><span title="delphyne.core.Example">Example</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Example selector that returns all available examples.</p>


    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.stdlib.queries.select_random_examples" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">select_random_examples</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">select_random_examples</span><span class="p">(</span><span class="n">num_examples</span><span class="p">:</span> <span class="n"><span title="int">int</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="ExampleSelector (delphyne.stdlib.queries.ExampleSelector)" href="#delphyne.stdlib.queries.ExampleSelector">ExampleSelector</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Example selector that randomly selects a given number of examples.</p>
<p>All examples are selected if less examples are available than
requested.</p>


    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.stdlib.queries.select_with_either_tags" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">select_with_either_tags</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">select_with_either_tags</span><span class="p">(</span><span class="n">tags</span><span class="p">:</span> <span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">])</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Select examples that are annotated with at least one of a provided
set of tags.</p>


    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.stdlib.queries.string_from_last_block" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">string_from_last_block</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">string_from_last_block</span><span class="p">(</span><span class="nb">type</span><span class="p">:</span> <span class="n"><span title="delphyne.utils.typing.TypeAnnot">TypeAnnot</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.string_from_last_block[T]">string_from_last_block[T]</span></span><span class="p">],</span> <span class="n">res</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="delphyne.stdlib.queries.string_from_last_block[T]">string_from_last_block[T]</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Extract the string content of the last code block from the answer
(surrounded by triple back quotes).</p>


    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.stdlib.queries.trimmed_raw_string" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">trimmed_raw_string</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">trimmed_raw_string</span><span class="p">(</span><span class="nb">type</span><span class="p">:</span> <span class="n"><span title="delphyne.utils.typing.TypeAnnot">TypeAnnot</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.trimmed_raw_string[T]">trimmed_raw_string[T]</span></span><span class="p">],</span> <span class="n">res</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="delphyne.stdlib.queries.trimmed_raw_string[T]">trimmed_raw_string[T]</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Do not perform any parsing and return the answer as a raw string,
after trimming leading and trailing whitespace.</p>


    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.stdlib.queries.trimmed_string_from_last_block" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">trimmed_string_from_last_block</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">trimmed_string_from_last_block</span><span class="p">(</span><span class="nb">type</span><span class="p">:</span> <span class="n"><span title="delphyne.utils.typing.TypeAnnot">TypeAnnot</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.trimmed_string_from_last_block[T]">trimmed_string_from_last_block[T]</span></span><span class="p">],</span> <span class="n">res</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="delphyne.stdlib.queries.trimmed_string_from_last_block[T]">trimmed_string_from_last_block[T]</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Extract the string content of the last code block from the answer
(surrounded by triple back quotes) and trim leading and trailing
whitespace.</p>


    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.stdlib.queries.yaml_from_last_block" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">yaml_from_last_block</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">yaml_from_last_block</span><span class="p">(</span><span class="nb">type</span><span class="p">:</span> <span class="n"><span title="delphyne.utils.typing.TypeAnnot">TypeAnnot</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.yaml_from_last_block[T]">yaml_from_last_block[T]</span></span><span class="p">],</span> <span class="n">res</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="delphyne.stdlib.queries.yaml_from_last_block[T]">yaml_from_last_block[T]</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Parse the YAML object defined in the last code block of a text
answer (between triple back quotes). In particular, this parser
allows chain of thoughts.</p>


    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.annotate", "content.code.copy", "content.tabs.link", "navigation.indexes"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.92b07e13.min.js"></script>
      
        <script src="../../javascript/katex.js"></script>
      
        <script src="https://unpkg.com/katex@0/dist/katex.min.js"></script>
      
        <script src="https://unpkg.com/katex@0/dist/contrib/auto-render.min.js"></script>
      
    
  </body>
</html>