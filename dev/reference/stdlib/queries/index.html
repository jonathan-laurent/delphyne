
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../basic/">
      
      
        <link rel="next" href="../streams/">
      
      
      <link rel="icon" href="../../../None">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.18">
    
    
      
        <title>Queries - Delphyne</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="https://unpkg.com/katex@0/dist/katex.min.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#queries-and-prompting-policies" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Delphyne" class="md-header__button md-logo" aria-label="Delphyne" data-md-component="logo">
      
  <img src="../../../assets/logos/white/mini.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Delphyne
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Queries
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Delphyne" class="md-nav__button md-logo" aria-label="Delphyne" data-md-component="logo">
      
  <img src="../../../assets/logos/white/mini.png" alt="logo">

    </a>
    Delphyne
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Manual
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Manual
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../manual/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../manual/strategies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Strategy Language
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../manual/policies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Policy Language
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../manual/demos/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Demonstration Language
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../manual/extension/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    VSCode Extension
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../how-to-guides/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    How-To Guides
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" >
        
          
          <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Strategy Language
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            Strategy Language
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../strategies/trees/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Trees and Spaces
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../strategies/strategies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Strategies and Reification
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../strategies/queries/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Queries and Chats
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../strategies/traces/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    References and Traces
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../strategies/misc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Miscellaneous
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Policy Language
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            Policy Language
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../policies/definitions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Definitions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../policies/streams/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Search Streams
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3" >
        
          
          <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Demonstration Language
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            Demonstration Language
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../demos/definitions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Definitions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../demos/interpreter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Interpreter
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4_4" id="__nav_4_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Standard Library
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4_4">
            <span class="md-nav__icon md-icon"></span>
            Standard Library
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../basic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Basic
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Queries
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Queries
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#queries" class="md-nav__link">
    <span class="md-ellipsis">
      Queries
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Queries">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.Query" class="md-nav__link">
    <span class="md-ellipsis">
      Query
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Query">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.Query--customizing-prompts" class="md-nav__link">
    <span class="md-ellipsis">
      Customizing Prompts
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query--answer-modes-and-configurations" class="md-nav__link">
    <span class="md-ellipsis">
      Answer Modes and Configurations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query--allowing-multi-message-exchanges-and-tool-calls" class="md-nav__link">
    <span class="md-ellipsis">
      Allowing Multi-Message Exchanges and Tool Calls
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Allowing Multi-Message Exchanges and Tool Calls">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.Query--answer-prefixes" class="md-nav__link">
    <span class="md-ellipsis">
      Answer Prefixes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query--the-response-type" class="md-nav__link">
    <span class="md-ellipsis">
      The Response Type
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query.parser" class="md-nav__link">
    <span class="md-ellipsis">
      parser
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query.parser_for" class="md-nav__link">
    <span class="md-ellipsis">
      parser_for
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query.query_prefix" class="md-nav__link">
    <span class="md-ellipsis">
      query_prefix
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query.globals" class="md-nav__link">
    <span class="md-ellipsis">
      globals
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query.using" class="md-nav__link">
    <span class="md-ellipsis">
      using
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query.run_toplevel" class="md-nav__link">
    <span class="md-ellipsis">
      run_toplevel
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Parser" class="md-nav__link">
    <span class="md-ellipsis">
      Parser
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Parser">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.Parser.wrap_errors" class="md-nav__link">
    <span class="md-ellipsis">
      wrap_errors
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Parser.response" class="md-nav__link">
    <span class="md-ellipsis">
      response
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Parser.trim" class="md-nav__link">
    <span class="md-ellipsis">
      trim
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Parser.json" class="md-nav__link">
    <span class="md-ellipsis">
      json
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Parser.yaml" class="md-nav__link">
    <span class="md-ellipsis">
      yaml
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Parser.map" class="md-nav__link">
    <span class="md-ellipsis">
      map
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Parser.validate" class="md-nav__link">
    <span class="md-ellipsis">
      validate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Parser.response_with" class="md-nav__link">
    <span class="md-ellipsis">
      response_with
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Parser.json_as" class="md-nav__link">
    <span class="md-ellipsis">
      json_as
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Parser.yaml_as" class="md-nav__link">
    <span class="md-ellipsis">
      yaml_as
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.GenericParser" class="md-nav__link">
    <span class="md-ellipsis">
      GenericParser
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GenericParser">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.GenericParser.wrap_errors" class="md-nav__link">
    <span class="md-ellipsis">
      wrap_errors
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.GenericParser.response" class="md-nav__link">
    <span class="md-ellipsis">
      response
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries._GenericParserFn" class="md-nav__link">
    <span class="md-ellipsis">
      _GenericParserFn
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.ParserDict" class="md-nav__link">
    <span class="md-ellipsis">
      ParserDict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Response" class="md-nav__link">
    <span class="md-ellipsis">
      Response
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.FinalAnswer" class="md-nav__link">
    <span class="md-ellipsis">
      FinalAnswer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.ToolRequests" class="md-nav__link">
    <span class="md-ellipsis">
      ToolRequests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.WrappedParseError" class="md-nav__link">
    <span class="md-ellipsis">
      WrappedParseError
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.QueryTemplateArgs" class="md-nav__link">
    <span class="md-ellipsis">
      QueryTemplateArgs
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#standard-parsers" class="md-nav__link">
    <span class="md-ellipsis">
      Standard Parsers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Standard Parsers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.structured_as" class="md-nav__link">
    <span class="md-ellipsis">
      structured_as
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.final_tool_call_as" class="md-nav__link">
    <span class="md-ellipsis">
      final_tool_call_as
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.structured" class="md-nav__link">
    <span class="md-ellipsis">
      structured
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.final_tool_call" class="md-nav__link">
    <span class="md-ellipsis">
      final_tool_call
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.last_code_block" class="md-nav__link">
    <span class="md-ellipsis">
      last_code_block
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.get_text" class="md-nav__link">
    <span class="md-ellipsis">
      get_text
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prompting-policies" class="md-nav__link">
    <span class="md-ellipsis">
      Prompting Policies
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Prompting Policies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.few_shot" class="md-nav__link">
    <span class="md-ellipsis">
      few_shot
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.classify" class="md-nav__link">
    <span class="md-ellipsis">
      classify
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.ProbInfo" class="md-nav__link">
    <span class="md-ellipsis">
      ProbInfo
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#models" class="md-nav__link">
    <span class="md-ellipsis">
      Models
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Models">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLM" class="md-nav__link">
    <span class="md-ellipsis">
      LLM
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LLM">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLM.estimate_budget" class="md-nav__link">
    <span class="md-ellipsis">
      estimate_budget
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLM.add_model_defaults" class="md-nav__link">
    <span class="md-ellipsis">
      add_model_defaults
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLM.stream_request" class="md-nav__link">
    <span class="md-ellipsis">
      stream_request
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLM.send_request" class="md-nav__link">
    <span class="md-ellipsis">
      send_request
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLMRequest" class="md-nav__link">
    <span class="md-ellipsis">
      LLMRequest
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLMResponse" class="md-nav__link">
    <span class="md-ellipsis">
      LLMResponse
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.AbstractTool" class="md-nav__link">
    <span class="md-ellipsis">
      AbstractTool
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.Chat" class="md-nav__link">
    <span class="md-ellipsis">
      Chat
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.ChatMessage" class="md-nav__link">
    <span class="md-ellipsis">
      ChatMessage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.SystemMessage" class="md-nav__link">
    <span class="md-ellipsis">
      SystemMessage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.UserMessage" class="md-nav__link">
    <span class="md-ellipsis">
      UserMessage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.AssistantMessage" class="md-nav__link">
    <span class="md-ellipsis">
      AssistantMessage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.ToolMessage" class="md-nav__link">
    <span class="md-ellipsis">
      ToolMessage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.RequestOptions" class="md-nav__link">
    <span class="md-ellipsis">
      RequestOptions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.Schema" class="md-nav__link">
    <span class="md-ellipsis">
      Schema
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Schema">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.Schema.make" class="md-nav__link">
    <span class="md-ellipsis">
      make
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLMOutput" class="md-nav__link">
    <span class="md-ellipsis">
      LLMOutput
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.FinishReason" class="md-nav__link">
    <span class="md-ellipsis">
      FinishReason
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.DummyModel" class="md-nav__link">
    <span class="md-ellipsis">
      DummyModel
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.WithRetry" class="md-nav__link">
    <span class="md-ellipsis">
      WithRetry
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.CachedModel" class="md-nav__link">
    <span class="md-ellipsis">
      CachedModel
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLMCache" class="md-nav__link">
    <span class="md-ellipsis">
      LLMCache
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.Token" class="md-nav__link">
    <span class="md-ellipsis">
      Token
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.TokenInfo" class="md-nav__link">
    <span class="md-ellipsis">
      TokenInfo
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.ModelPricing" class="md-nav__link">
    <span class="md-ellipsis">
      ModelPricing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLMResponseLogItem" class="md-nav__link">
    <span class="md-ellipsis">
      LLMResponseLogItem
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLMBusyException" class="md-nav__link">
    <span class="md-ellipsis">
      LLMBusyException
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.BudgetCategory" class="md-nav__link">
    <span class="md-ellipsis">
      BudgetCategory
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.budget_entry" class="md-nav__link">
    <span class="md-ellipsis">
      budget_entry
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.NUM_REQUESTS" class="md-nav__link">
    <span class="md-ellipsis">
      NUM_REQUESTS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.NUM_COMPLETIONS" class="md-nav__link">
    <span class="md-ellipsis">
      NUM_COMPLETIONS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.NUM_INPUT_TOKENS" class="md-nav__link">
    <span class="md-ellipsis">
      NUM_INPUT_TOKENS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.NUM_CACHED_INPUT_TOKENS" class="md-nav__link">
    <span class="md-ellipsis">
      NUM_CACHED_INPUT_TOKENS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.NUM_OUTPUT_TOKENS" class="md-nav__link">
    <span class="md-ellipsis">
      NUM_OUTPUT_TOKENS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.DOLLAR_PRICE" class="md-nav__link">
    <span class="md-ellipsis">
      DOLLAR_PRICE
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../streams/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Streams
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../environments/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Environments
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../effects/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Effects
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../algorithms/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Algorithms
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../commands/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Commands
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../experiments/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Experiments
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Delphyne CLI
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#queries" class="md-nav__link">
    <span class="md-ellipsis">
      Queries
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Queries">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.Query" class="md-nav__link">
    <span class="md-ellipsis">
      Query
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Query">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.Query--customizing-prompts" class="md-nav__link">
    <span class="md-ellipsis">
      Customizing Prompts
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query--answer-modes-and-configurations" class="md-nav__link">
    <span class="md-ellipsis">
      Answer Modes and Configurations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query--allowing-multi-message-exchanges-and-tool-calls" class="md-nav__link">
    <span class="md-ellipsis">
      Allowing Multi-Message Exchanges and Tool Calls
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Allowing Multi-Message Exchanges and Tool Calls">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.Query--answer-prefixes" class="md-nav__link">
    <span class="md-ellipsis">
      Answer Prefixes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query--the-response-type" class="md-nav__link">
    <span class="md-ellipsis">
      The Response Type
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query.parser" class="md-nav__link">
    <span class="md-ellipsis">
      parser
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query.parser_for" class="md-nav__link">
    <span class="md-ellipsis">
      parser_for
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query.query_prefix" class="md-nav__link">
    <span class="md-ellipsis">
      query_prefix
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query.globals" class="md-nav__link">
    <span class="md-ellipsis">
      globals
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query.using" class="md-nav__link">
    <span class="md-ellipsis">
      using
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query.run_toplevel" class="md-nav__link">
    <span class="md-ellipsis">
      run_toplevel
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Parser" class="md-nav__link">
    <span class="md-ellipsis">
      Parser
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Parser">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.Parser.wrap_errors" class="md-nav__link">
    <span class="md-ellipsis">
      wrap_errors
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Parser.response" class="md-nav__link">
    <span class="md-ellipsis">
      response
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Parser.trim" class="md-nav__link">
    <span class="md-ellipsis">
      trim
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Parser.json" class="md-nav__link">
    <span class="md-ellipsis">
      json
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Parser.yaml" class="md-nav__link">
    <span class="md-ellipsis">
      yaml
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Parser.map" class="md-nav__link">
    <span class="md-ellipsis">
      map
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Parser.validate" class="md-nav__link">
    <span class="md-ellipsis">
      validate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Parser.response_with" class="md-nav__link">
    <span class="md-ellipsis">
      response_with
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Parser.json_as" class="md-nav__link">
    <span class="md-ellipsis">
      json_as
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Parser.yaml_as" class="md-nav__link">
    <span class="md-ellipsis">
      yaml_as
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.GenericParser" class="md-nav__link">
    <span class="md-ellipsis">
      GenericParser
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GenericParser">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.GenericParser.wrap_errors" class="md-nav__link">
    <span class="md-ellipsis">
      wrap_errors
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.GenericParser.response" class="md-nav__link">
    <span class="md-ellipsis">
      response
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries._GenericParserFn" class="md-nav__link">
    <span class="md-ellipsis">
      _GenericParserFn
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.ParserDict" class="md-nav__link">
    <span class="md-ellipsis">
      ParserDict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Response" class="md-nav__link">
    <span class="md-ellipsis">
      Response
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.FinalAnswer" class="md-nav__link">
    <span class="md-ellipsis">
      FinalAnswer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.ToolRequests" class="md-nav__link">
    <span class="md-ellipsis">
      ToolRequests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.WrappedParseError" class="md-nav__link">
    <span class="md-ellipsis">
      WrappedParseError
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.QueryTemplateArgs" class="md-nav__link">
    <span class="md-ellipsis">
      QueryTemplateArgs
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#standard-parsers" class="md-nav__link">
    <span class="md-ellipsis">
      Standard Parsers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Standard Parsers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.structured_as" class="md-nav__link">
    <span class="md-ellipsis">
      structured_as
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.final_tool_call_as" class="md-nav__link">
    <span class="md-ellipsis">
      final_tool_call_as
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.structured" class="md-nav__link">
    <span class="md-ellipsis">
      structured
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.final_tool_call" class="md-nav__link">
    <span class="md-ellipsis">
      final_tool_call
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.last_code_block" class="md-nav__link">
    <span class="md-ellipsis">
      last_code_block
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.get_text" class="md-nav__link">
    <span class="md-ellipsis">
      get_text
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prompting-policies" class="md-nav__link">
    <span class="md-ellipsis">
      Prompting Policies
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Prompting Policies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.few_shot" class="md-nav__link">
    <span class="md-ellipsis">
      few_shot
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.classify" class="md-nav__link">
    <span class="md-ellipsis">
      classify
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.ProbInfo" class="md-nav__link">
    <span class="md-ellipsis">
      ProbInfo
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#models" class="md-nav__link">
    <span class="md-ellipsis">
      Models
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Models">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLM" class="md-nav__link">
    <span class="md-ellipsis">
      LLM
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LLM">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLM.estimate_budget" class="md-nav__link">
    <span class="md-ellipsis">
      estimate_budget
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLM.add_model_defaults" class="md-nav__link">
    <span class="md-ellipsis">
      add_model_defaults
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLM.stream_request" class="md-nav__link">
    <span class="md-ellipsis">
      stream_request
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLM.send_request" class="md-nav__link">
    <span class="md-ellipsis">
      send_request
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLMRequest" class="md-nav__link">
    <span class="md-ellipsis">
      LLMRequest
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLMResponse" class="md-nav__link">
    <span class="md-ellipsis">
      LLMResponse
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.AbstractTool" class="md-nav__link">
    <span class="md-ellipsis">
      AbstractTool
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.Chat" class="md-nav__link">
    <span class="md-ellipsis">
      Chat
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.ChatMessage" class="md-nav__link">
    <span class="md-ellipsis">
      ChatMessage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.SystemMessage" class="md-nav__link">
    <span class="md-ellipsis">
      SystemMessage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.UserMessage" class="md-nav__link">
    <span class="md-ellipsis">
      UserMessage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.AssistantMessage" class="md-nav__link">
    <span class="md-ellipsis">
      AssistantMessage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.ToolMessage" class="md-nav__link">
    <span class="md-ellipsis">
      ToolMessage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.RequestOptions" class="md-nav__link">
    <span class="md-ellipsis">
      RequestOptions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.Schema" class="md-nav__link">
    <span class="md-ellipsis">
      Schema
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Schema">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.Schema.make" class="md-nav__link">
    <span class="md-ellipsis">
      make
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLMOutput" class="md-nav__link">
    <span class="md-ellipsis">
      LLMOutput
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.FinishReason" class="md-nav__link">
    <span class="md-ellipsis">
      FinishReason
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.DummyModel" class="md-nav__link">
    <span class="md-ellipsis">
      DummyModel
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.WithRetry" class="md-nav__link">
    <span class="md-ellipsis">
      WithRetry
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.CachedModel" class="md-nav__link">
    <span class="md-ellipsis">
      CachedModel
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLMCache" class="md-nav__link">
    <span class="md-ellipsis">
      LLMCache
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.Token" class="md-nav__link">
    <span class="md-ellipsis">
      Token
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.TokenInfo" class="md-nav__link">
    <span class="md-ellipsis">
      TokenInfo
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.ModelPricing" class="md-nav__link">
    <span class="md-ellipsis">
      ModelPricing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLMResponseLogItem" class="md-nav__link">
    <span class="md-ellipsis">
      LLMResponseLogItem
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLMBusyException" class="md-nav__link">
    <span class="md-ellipsis">
      LLMBusyException
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.BudgetCategory" class="md-nav__link">
    <span class="md-ellipsis">
      BudgetCategory
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.budget_entry" class="md-nav__link">
    <span class="md-ellipsis">
      budget_entry
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.NUM_REQUESTS" class="md-nav__link">
    <span class="md-ellipsis">
      NUM_REQUESTS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.NUM_COMPLETIONS" class="md-nav__link">
    <span class="md-ellipsis">
      NUM_COMPLETIONS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.NUM_INPUT_TOKENS" class="md-nav__link">
    <span class="md-ellipsis">
      NUM_INPUT_TOKENS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.NUM_CACHED_INPUT_TOKENS" class="md-nav__link">
    <span class="md-ellipsis">
      NUM_CACHED_INPUT_TOKENS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.NUM_OUTPUT_TOKENS" class="md-nav__link">
    <span class="md-ellipsis">
      NUM_OUTPUT_TOKENS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.DOLLAR_PRICE" class="md-nav__link">
    <span class="md-ellipsis">
      DOLLAR_PRICE
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="queries-and-prompting-policies">Queries and Prompting Policies</h1>
<h2 id="queries">Queries</h2>


<div class="doc doc-object doc-class">



<h3 id="delphyne.Query" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">Query</span>


</h3>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="AbstractQuery (delphyne.core.AbstractQuery)" href="../../strategies/queries/#delphyne.AbstractQuery">AbstractQuery</a>[<span title="delphyne.stdlib.queries.Query[T]">T</span>]</code></p>


        <p>Base class for queries.</p>
<p>This class adds standard convenience features on top of
<a class="autorefs autorefs-internal" title="AbstractQuery" href="../../strategies/queries/#delphyne.AbstractQuery"><code>AbstractQuery</code></a>, using reflection to allow queries to be defined
concisely. Here is a simple example of a query type definition:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@dataclass</span> <span class="k">class</span><span class="w"> </span><span class="nc">MakeSum</span><span class="p">(</span><span class="n">Query</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]]):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Given a list of allowed numbers and a target number, you</span>
<span class="sd">    must find a sub-list whose elements sum up to the target.</span>
<span class="sd">    Just answer with a list of numbers as a JSON object and</span>
<span class="sd">    nothing else.&#39;&#39;&#39;</span>

    <span class="n">allowed</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="n">target</span><span class="p">:</span> <span class="nb">int</span>
</code></pre></div>
<p>In general, a query type is a dataclass that inherits <code>Query[T]</code>,
where <code>T</code> is the query's answer type. In the example above, no
parser is specified and so oracles are requested to provide
structured answers as JSON objects, which are automatically parsed
into the answer type (<code>list[int]</code>) using pydantic. Assuming that no
Jinja prompt file is provided, the docstring is used as a system
prompt and instance prompts are generated by simply serializing
<code>MakeSum</code> instances into YAML.</p>
<p>All attributes of a query must be serializable by pydantic. They can
be builtin types (int, list, dict...), custom dataclasses...</p>
<h5 id="delphyne.Query--customizing-prompts">Customizing Prompts</h5>
<p>System and instance prompts can be specified via Jinja templates.
The templates manager (<a class="autorefs autorefs-internal" title="TemplatesManager" href="../environments/#delphyne.TemplatesManager"><code>TemplatesManager</code></a>) looks for templates named
"<QueryName>.<instance|system>.jinja". Templates can also be
provided by defining the <code>__system_prompt__</code> and/or
<code>__instance_prompt__</code> class attributes. If none of these are
provided, the query's docstring is used as a system prompt and
<code>DEFAULT_INSTANCE_PROMPT</code> is used as an instance prompt template.
All attributes from <code>QueryTemplateArgs</code> are made available to
templates, with possibly extra ones.</p>
<h5 id="delphyne.Query--answer-modes-and-configurations">Answer Modes and Configurations</h5>
<p>A query can define several answer modes (<a class="autorefs autorefs-internal" title="AnswerMode" href="../../strategies/traces/#delphyne.AnswerMode"><code>AnswerMode</code></a>), each of
which can be associated with a different parser and set of settings.
By default, the only answer mode is <code>None</code>. More answer modes can be
defined by setting class variable <code>__modes__</code>.</p>
<p>The <code>parser_for</code> method maps modes to parser specifications. Its
default implementation first checks whether the <code>parser</code> method is
overriden, in which case it is used. Otherwise, the <code>__parser__</code>
attribute is checked. If none of these conditions hold, <a class="autorefs autorefs-internal" title="structured


  
      module-attribute
  " href="#delphyne.structured"><code>structured</code></a>
is used as a default parser.</p>
<h5 id="delphyne.Query--allowing-multi-message-exchanges-and-tool-calls">Allowing Multi-Message Exchanges and Tool Calls</h5>
<p>A common pattern for interacting with LLMs is to have multi-message
exchanges where the full conversation history is resent repeatedly.
LLMs are also often allowed to request tool calls. This interaction
pattern is implemented in the <a class="autorefs autorefs-internal" title="interact" href="../algorithms/#delphyne.interact"><code>interact</code></a> standard strategy. It is
enabled by several features on the <a class="autorefs autorefs-internal" title="Query" href="#delphyne.Query"><code>Query</code></a> side.</p>
<h6 id="delphyne.Query--answer-prefixes">Answer Prefixes</h6>
<p>If a query type has a prefix attribute with type <a class="autorefs autorefs-internal" title="AnswerPrefix" href="../../strategies/queries/#delphyne.AnswerPrefix"><code>AnswerPrefix</code></a>,
this attribute can be used to provide a chat history, to be added to
the query's prompt.</p>
<h6 id="delphyne.Query--the-response-type">The <a class="autorefs autorefs-internal" title="Response


  
      dataclass
  " href="#delphyne.Response"><code>Response</code></a> Type</h6>
<p>If the query answer type is <a class="autorefs autorefs-internal" title="Response


  
      dataclass
  " href="#delphyne.Response"><code>Response</code></a>, the query does not only
return a parsed answer, but also the LLM raw answer (which can be
appended to a chat history), and possibly a sequence of tool calls.</p>








              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Query</span><span class="p">[</span><span class="n">T</span><span class="p">](</span><span class="n">dp</span><span class="o">.</span><span class="n">AbstractQuery</span><span class="p">[</span><span class="n">T</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for queries.</span>

<span class="sd">    This class adds standard convenience features on top of</span>
<span class="sd">    `AbstractQuery`, using reflection to allow queries to be defined</span>
<span class="sd">    concisely. Here is a simple example of a query type definition:</span>

<span class="sd">    ```python</span>
<span class="sd">    @dataclass class MakeSum(Query[list[int]]):</span>
<span class="sd">        &#39;&#39;&#39;Given a list of allowed numbers and a target number, you</span>
<span class="sd">        must find a sub-list whose elements sum up to the target.</span>
<span class="sd">        Just answer with a list of numbers as a JSON object and</span>
<span class="sd">        nothing else.&#39;&#39;&#39;</span>

<span class="sd">        allowed: list[int] target: int</span>
<span class="sd">    ```</span>

<span class="sd">    In general, a query type is a dataclass that inherits `Query[T]`,</span>
<span class="sd">    where `T` is the query&#39;s answer type. In the example above, no</span>
<span class="sd">    parser is specified and so oracles are requested to provide</span>
<span class="sd">    structured answers as JSON objects, which are automatically parsed</span>
<span class="sd">    into the answer type (`list[int]`) using pydantic. Assuming that no</span>
<span class="sd">    Jinja prompt file is provided, the docstring is used as a system</span>
<span class="sd">    prompt and instance prompts are generated by simply serializing</span>
<span class="sd">    `MakeSum` instances into YAML.</span>

<span class="sd">    All attributes of a query must be serializable by pydantic. They can</span>
<span class="sd">    be builtin types (int, list, dict...), custom dataclasses...</span>

<span class="sd">    ## Customizing Prompts</span>

<span class="sd">    System and instance prompts can be specified via Jinja templates.</span>
<span class="sd">    The templates manager (`TemplatesManager`) looks for templates named</span>
<span class="sd">    &quot;&lt;QueryName&gt;.&lt;instance|system&gt;.jinja&quot;. Templates can also be</span>
<span class="sd">    provided by defining the `__system_prompt__` and/or</span>
<span class="sd">    `__instance_prompt__` class attributes. If none of these are</span>
<span class="sd">    provided, the query&#39;s docstring is used as a system prompt and</span>
<span class="sd">    `DEFAULT_INSTANCE_PROMPT` is used as an instance prompt template.</span>
<span class="sd">    All attributes from `QueryTemplateArgs` are made available to</span>
<span class="sd">    templates, with possibly extra ones.</span>

<span class="sd">    ## Answer Modes and Configurations</span>

<span class="sd">    A query can define several answer modes (`AnswerMode`), each of</span>
<span class="sd">    which can be associated with a different parser and set of settings.</span>
<span class="sd">    By default, the only answer mode is `None`. More answer modes can be</span>
<span class="sd">    defined by setting class variable `__modes__`.</span>

<span class="sd">    The `parser_for` method maps modes to parser specifications. Its</span>
<span class="sd">    default implementation first checks whether the `parser` method is</span>
<span class="sd">    overriden, in which case it is used. Otherwise, the `__parser__`</span>
<span class="sd">    attribute is checked. If none of these conditions hold, `structured`</span>
<span class="sd">    is used as a default parser.</span>

<span class="sd">    ## Allowing Multi-Message Exchanges and Tool Calls</span>

<span class="sd">    A common pattern for interacting with LLMs is to have multi-message</span>
<span class="sd">    exchanges where the full conversation history is resent repeatedly.</span>
<span class="sd">    LLMs are also often allowed to request tool calls. This interaction</span>
<span class="sd">    pattern is implemented in the `interact` standard strategy. It is</span>
<span class="sd">    enabled by several features on the `Query` side.</span>

<span class="sd">    ### Answer Prefixes</span>

<span class="sd">    If a query type has a prefix attribute with type `AnswerPrefix`,</span>
<span class="sd">    this attribute can be used to provide a chat history, to be added to</span>
<span class="sd">    the query&#39;s prompt.</span>

<span class="sd">    ### The `Response` Type</span>

<span class="sd">    If the query answer type is `Response`, the query does not only</span>
<span class="sd">    return a parsed answer, but also the LLM raw answer (which can be</span>
<span class="sd">    appended to a chat history), and possibly a sequence of tool calls.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__modes__</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">AnswerMode</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">__parser__</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">Parser</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="n">GenericParser</span> <span class="o">|</span> <span class="n">ParserDict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="kc">None</span>
    <span class="p">)</span>

    <span class="c1">### Parsing Answers</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">parser</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Parser</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">|</span> <span class="n">GenericParser</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to override to provide a parser specification common to</span>
<span class="sd">        all modes. Alternatively, the `__parser__` class attribute can</span>
<span class="sd">        be set. The first method allows more flexibility since parser</span>
<span class="sd">        specifications can then depend on query attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="p">(</span>
            <span class="s2">&quot;Please provide `__parser__`, `parser` or &quot;</span>
            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;`parser_for` for query type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">parser_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">AnswerMode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Parser</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">|</span> <span class="n">GenericParser</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Obtain a parser speficiation for a given answer mode.</span>

<span class="sd">        This method can be overriden. By default, it does the following:</span>

<span class="sd">        1. If the `parser` method is overriden, it uses it.</span>
<span class="sd">        2. If `__parser__` is set as a parser, it is used.</span>
<span class="sd">        2. If `__parser__` is set as a dictionary, the mode is used as a</span>
<span class="sd">           key to obtain a parser.</span>
<span class="sd">        3. Otherwise, `structured` is used as a default parser.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dpi</span><span class="o">.</span><span class="n">is_method_overridden</span><span class="p">(</span><span class="n">Query</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="s2">&quot;parser&quot;</span><span class="p">):</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parser__</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Both `__parser__` and `parser` are provided for </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parser__</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">structured</span>  <span class="c1"># default parser</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">dpi</span><span class="o">.</span><span class="n">is_method_overridden</span><span class="p">(</span>
                <span class="n">Query</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="s2">&quot;parser_for&quot;</span>
            <span class="p">),</span> <span class="p">(</span>
                <span class="s2">&quot;Both `__parser__` and `parser_for` are &quot;</span>
                <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;provided for </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
            <span class="n">parser_attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parser__</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parser_attr</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">parser</span> <span class="o">=</span> <span class="n">parser_attr</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parser</span> <span class="o">=</span> <span class="n">parser_attr</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="p">(</span><span class="n">Parser</span><span class="p">,</span> <span class="n">GenericParser</span><span class="p">)),</span> <span class="p">(</span>
                <span class="s2">&quot;Expected parser type, got: &quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">parser</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_instantiated_parser_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">AnswerMode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Parser</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser_for</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">GenericParser</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">for_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_answer_type</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">parser</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">parse_answer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">answer</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">Answer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span> <span class="o">|</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">answer</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_modes</span><span class="p">(),</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unknown mode: </span><span class="si">{</span><span class="n">answer</span><span class="o">.</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instantiated_parser_for</span><span class="p">(</span><span class="n">answer</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">e</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">query_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">AnswerMode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">QuerySettings</span><span class="p">:</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instantiated_parser_for</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">settings</span>

    <span class="c1">### Query Prefixes</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_has_special_prefix_attr</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">annots</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">get_type_hints</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;prefix&quot;</span> <span class="ow">in</span> <span class="n">annots</span> <span class="ow">and</span> <span class="n">annots</span><span class="p">[</span><span class="s2">&quot;prefix&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="n">ct</span><span class="o">.</span><span class="n">AnswerPrefix</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">query_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ct</span><span class="o">.</span><span class="n">AnswerPrefix</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the value of the `prefix` attribute if it has type</span>
<span class="sd">        annotation `AnswerPrefix` or return `None`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_special_prefix_attr</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;prefix&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1">### Producing Prompts</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_prompt</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">kind</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;instance&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">AnswerMode</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">],</span>
        <span class="n">extra_args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">env</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">AbstractTemplatesManager</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">env</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">_no_prompt_manager_error</span><span class="p">()</span>
        <span class="n">args_min</span><span class="p">:</span> <span class="n">QueryTemplateArgs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="p">,</span>
            <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="n">mode</span><span class="p">,</span>
            <span class="s2">&quot;available_modes&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_modes</span><span class="p">(),</span>
            <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">params</span><span class="p">,</span>
            <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instantiated_parser_for</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span><span class="o">.</span><span class="n">formatting</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">args_min</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">extra_args</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extra_args</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">glob</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">globals</span><span class="p">())</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s2">&quot;globals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">glob</span>
        <span class="k">return</span> <span class="n">env</span><span class="o">.</span><span class="n">prompt</span><span class="p">(</span>
            <span class="n">query_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">query_name</span><span class="p">(),</span>
            <span class="n">prompt_kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span>
            <span class="n">template_args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
            <span class="n">default_template</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_default_prompt</span><span class="p">(</span><span class="n">kind</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_default_prompt</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">kind</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;instance&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">attr_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;__</span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="s2">_prompt__&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;instance&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_has_special_prefix_attr</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">DEFAULT_INSTANCE_PROMPT_WITH_PREFIX</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">DEFAULT_INSTANCE_PROMPT</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;system&quot;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">doc</span> <span class="o">:=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="bp">cls</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">doc</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;feedback&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DEFAULT_FEEDBACK_PROMPT</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">globals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return global objects accessible in prompts via the `globals`</span>
<span class="sd">        attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1">### Other Simple Overrides</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">serialize_args</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">],</span> <span class="n">ty</span><span class="o">.</span><span class="n">pydantic_dump</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_answer_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypeAnnot</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">dpi</span><span class="o">.</span><span class="n">first_parameter_of_base_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">answer_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypeAnnot</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_answer_type</span><span class="p">()</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">finite_answer_set</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">Answer</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># We handle the special case where the return type is a literal</span>
        <span class="c1"># type that is a subtype of str.</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_type</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">:=</span> <span class="n">_match_string_literal_type</span><span class="p">(</span><span class="n">ans</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">Answer</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">res</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">query_modes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">AnswerMode</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__modes__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__modes__</span>
        <span class="k">return</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>

    <span class="c1">### Generating Opaque Spaces</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">using</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_policy</span><span class="p">:</span> <span class="n">EllipsisType</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Opaque</span><span class="p">[</span><span class="n">IPDict</span><span class="p">,</span> <span class="n">T</span><span class="p">]:</span> <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">using</span><span class="p">[</span><span class="n">P</span><span class="p">](</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">get_policy</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">P</span><span class="p">],</span> <span class="n">pol</span><span class="o">.</span><span class="n">PromptingPolicy</span><span class="p">]</span> <span class="o">|</span> <span class="n">EllipsisType</span><span class="p">,</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="n">inner_policy_type</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">P</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Opaque</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">]:</span> <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">using</span><span class="p">[</span><span class="n">P</span><span class="p">](</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">get_policy</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">P</span><span class="p">],</span> <span class="n">pol</span><span class="o">.</span><span class="n">PromptingPolicy</span><span class="p">]</span> <span class="o">|</span> <span class="n">EllipsisType</span><span class="p">,</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="n">inner_policy_type</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">P</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Opaque</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Turn a query into an opaque space by providing a mapping from</span>
<span class="sd">        the ambient inner policy to a prompting policy.</span>

<span class="sd">        Attributes:</span>
<span class="sd">            get_policy: A function that maps the ambient inner policy to</span>
<span class="sd">                a prompting policy to use for answering the query.</span>
<span class="sd">                Alternatively, if the ellipsis value `...` is passed, the</span>
<span class="sd">                inner policy type is assumed to be `IPDict`, and</span>
<span class="sd">                prompting policies are automatically selected using tags</span>
<span class="sd">                (see `IPDict` documentation).</span>
<span class="sd">            inner_policy_type: Ambient inner policy type. This information</span>
<span class="sd">                is not used at runtime but it can be provided to help type</span>
<span class="sd">                inference when necessary.</span>

<span class="sd">        The optional `inner_policy_type` argument is ignored at runtime</span>
<span class="sd">        and can be used to help type checkers infer the type of the</span>
<span class="sd">        ambient inner policy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">get_policy</span><span class="p">,</span> <span class="n">EllipsisType</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">OpaqueSpace</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">]</span><span class="o">.</span><span class="n">from_query</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">cast</span><span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">pol</span><span class="o">.</span><span class="n">dict_subpolicy</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">OpaqueSpace</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">]</span><span class="o">.</span><span class="n">from_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">get_policy</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_toplevel</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">env</span><span class="p">:</span> <span class="n">PolicyEnv</span><span class="p">,</span>
        <span class="n">policy</span><span class="p">:</span> <span class="n">pol</span><span class="o">.</span><span class="n">PromptingPolicy</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Stream</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Obtain a search stream of query answers, given a prompting</span>
<span class="sd">        policy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">attached</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">spawn_standalone_query</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">policy</span><span class="p">(</span><span class="n">attached</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="delphyne.Query.parser" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">parser</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">parser</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Parser


  
      dataclass
   (delphyne.stdlib.queries.Parser)" href="#delphyne.Parser">Parser</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.Query[T]">T</span></span><span class="p">]</span> <span class="o">|</span> <span class="n"><a class="autorefs autorefs-internal" title="GenericParser


  
      dataclass
   (delphyne.stdlib.queries.GenericParser)" href="#delphyne.GenericParser">GenericParser</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Method to override to provide a parser specification common to
all modes. Alternatively, the <code>__parser__</code> class attribute can
be set. The first method allows more flexibility since parser
specifications can then depend on query attributes.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">parser</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Parser</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">|</span> <span class="n">GenericParser</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method to override to provide a parser specification common to</span>
<span class="sd">    all modes. Alternatively, the `__parser__` class attribute can</span>
<span class="sd">    be set. The first method allows more flexibility since parser</span>
<span class="sd">    specifications can then depend on query attributes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="p">(</span>
        <span class="s2">&quot;Please provide `__parser__`, `parser` or &quot;</span>
        <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;`parser_for` for query type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.Query.parser_for" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">parser_for</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">parser_for</span><span class="p">(</span><span class="n">mode</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="AnswerMode (delphyne.core.AnswerMode)" href="../../strategies/traces/#delphyne.AnswerMode">AnswerMode</a></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Parser


  
      dataclass
   (delphyne.stdlib.queries.Parser)" href="#delphyne.Parser">Parser</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.Query[T]">T</span></span><span class="p">]</span> <span class="o">|</span> <span class="n"><a class="autorefs autorefs-internal" title="GenericParser


  
      dataclass
   (delphyne.stdlib.queries.GenericParser)" href="#delphyne.GenericParser">GenericParser</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Obtain a parser speficiation for a given answer mode.</p>
<p>This method can be overriden. By default, it does the following:</p>
<ol>
<li>If the <code>parser</code> method is overriden, it uses it.</li>
<li>If <code>__parser__</code> is set as a parser, it is used.</li>
<li>If <code>__parser__</code> is set as a dictionary, the mode is used as a
   key to obtain a parser.</li>
<li>Otherwise, <a class="autorefs autorefs-internal" title="structured


  
      module-attribute
  " href="#delphyne.structured"><code>structured</code></a> is used as a default parser.</li>
</ol>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">parser_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">AnswerMode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Parser</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">|</span> <span class="n">GenericParser</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Obtain a parser speficiation for a given answer mode.</span>

<span class="sd">    This method can be overriden. By default, it does the following:</span>

<span class="sd">    1. If the `parser` method is overriden, it uses it.</span>
<span class="sd">    2. If `__parser__` is set as a parser, it is used.</span>
<span class="sd">    2. If `__parser__` is set as a dictionary, the mode is used as a</span>
<span class="sd">       key to obtain a parser.</span>
<span class="sd">    3. Otherwise, `structured` is used as a default parser.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dpi</span><span class="o">.</span><span class="n">is_method_overridden</span><span class="p">(</span><span class="n">Query</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="s2">&quot;parser&quot;</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parser__</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Both `__parser__` and `parser` are provided for </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="p">()</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parser__</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">structured</span>  <span class="c1"># default parser</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">dpi</span><span class="o">.</span><span class="n">is_method_overridden</span><span class="p">(</span>
            <span class="n">Query</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="s2">&quot;parser_for&quot;</span>
        <span class="p">),</span> <span class="p">(</span>
            <span class="s2">&quot;Both `__parser__` and `parser_for` are &quot;</span>
            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;provided for </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>
        <span class="n">parser_attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parser__</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parser_attr</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">parser_attr</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">parser_attr</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="p">(</span><span class="n">Parser</span><span class="p">,</span> <span class="n">GenericParser</span><span class="p">)),</span> <span class="p">(</span>
            <span class="s2">&quot;Expected parser type, got: &quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">parser</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.Query.query_prefix" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">query_prefix</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">query_prefix</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="AnswerPrefix (delphyne.core.chats.AnswerPrefix)" href="../../strategies/queries/#delphyne.AnswerPrefix">AnswerPrefix</a></span> <span class="o">|</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Return the value of the <code>prefix</code> attribute if it has type
annotation <a class="autorefs autorefs-internal" title="AnswerPrefix" href="../../strategies/queries/#delphyne.AnswerPrefix"><code>AnswerPrefix</code></a> or return <code>None</code>.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@override</span>
<span class="k">def</span><span class="w"> </span><span class="nf">query_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ct</span><span class="o">.</span><span class="n">AnswerPrefix</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the value of the `prefix` attribute if it has type</span>
<span class="sd">    annotation `AnswerPrefix` or return `None`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_special_prefix_attr</span><span class="p">():</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;prefix&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.Query.globals" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">globals</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">globals</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n"><span title="dict">dict</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="object">object</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Return global objects accessible in prompts via the <code>globals</code>
attribute.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">globals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return global objects accessible in prompts via the `globals`</span>
<span class="sd">    attribute.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.Query.using" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">using</span>


</h4>
          <div class="doc-overloads">
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">using</span><span class="p">(</span><span class="n">get_policy</span><span class="p">:</span> <span class="n"><span title="types.EllipsisType">EllipsisType</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Opaque (delphyne.stdlib.opaque.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="IPDict (delphyne.stdlib.policies.IPDict)" href="../basic/#delphyne.IPDict">IPDict</a></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.queries.Query[T]">T</span></span><span class="p">]</span>
</code></pre></div><div class="doc-signature highlight"><pre><span></span><code><span class="nf">using</span><span class="p">(</span>
    <span class="n">get_policy</span><span class="p">:</span> <span class="n"><span title="collections.abc.Callable">Callable</span></span><span class="p">[[</span><span class="n"><span title="delphyne.stdlib.queries.Query.using[P]">P</span></span><span class="p">],</span> <span class="n"><a class="autorefs autorefs-internal" title="PromptingPolicy


  
      dataclass
   (delphyne.stdlib.policies.PromptingPolicy)" href="../basic/#delphyne.PromptingPolicy">PromptingPolicy</a></span><span class="p">]</span> <span class="o">|</span> <span class="n"><span title="types.EllipsisType">EllipsisType</span></span><span class="p">,</span>
    <span class="o">/</span><span class="p">,</span>
    <span class="n">inner_policy_type</span><span class="p">:</span> <span class="n"><span title="type">type</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.Query.using[P]">P</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Opaque (delphyne.stdlib.opaque.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.Query.using[P]">P</span></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.queries.Query[T]">T</span></span><span class="p">]</span>
</code></pre></div>          </div>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">using</span><span class="p">(</span>
    <span class="n">get_policy</span><span class="p">:</span> <span class="n"><span title="collections.abc.Callable">Callable</span></span><span class="p">[[</span><span class="n"><span title="delphyne.stdlib.queries.Query.using[P]">P</span></span><span class="p">],</span> <span class="n"><a class="autorefs autorefs-internal" title="PromptingPolicy


  
      dataclass
   (delphyne.stdlib.policies.PromptingPolicy)" href="../basic/#delphyne.PromptingPolicy">PromptingPolicy</a></span><span class="p">]</span> <span class="o">|</span> <span class="n"><span title="types.EllipsisType">EllipsisType</span></span><span class="p">,</span>
    <span class="o">/</span><span class="p">,</span>
    <span class="n">inner_policy_type</span><span class="p">:</span> <span class="n"><span title="type">type</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.Query.using[P]">P</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Opaque (delphyne.stdlib.opaque.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.Query.using[P]">P</span></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.queries.Query[T]">T</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Turn a query into an opaque space by providing a mapping from
the ambient inner policy to a prompting policy.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.Query.using.get_policy">get_policy</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A function that maps the ambient inner policy to
a prompting policy to use for answering the query.
Alternatively, if the ellipsis value <code>...</code> is passed, the
inner policy type is assumed to be <a class="autorefs autorefs-internal" title="IPDict" href="../basic/#delphyne.IPDict"><code>IPDict</code></a>, and
prompting policies are automatically selected using tags
(see <a class="autorefs autorefs-internal" title="IPDict" href="../basic/#delphyne.IPDict"><code>IPDict</code></a> documentation).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.Query.using.inner_policy_type">inner_policy_type</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Ambient inner policy type. This information
is not used at runtime but it can be provided to help type
inference when necessary.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
        <p>The optional <code>inner_policy_type</code> argument is ignored at runtime
and can be used to help type checkers infer the type of the
ambient inner policy.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">using</span><span class="p">[</span><span class="n">P</span><span class="p">](</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">get_policy</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">P</span><span class="p">],</span> <span class="n">pol</span><span class="o">.</span><span class="n">PromptingPolicy</span><span class="p">]</span> <span class="o">|</span> <span class="n">EllipsisType</span><span class="p">,</span>
    <span class="o">/</span><span class="p">,</span>
    <span class="n">inner_policy_type</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">P</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Opaque</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Turn a query into an opaque space by providing a mapping from</span>
<span class="sd">    the ambient inner policy to a prompting policy.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        get_policy: A function that maps the ambient inner policy to</span>
<span class="sd">            a prompting policy to use for answering the query.</span>
<span class="sd">            Alternatively, if the ellipsis value `...` is passed, the</span>
<span class="sd">            inner policy type is assumed to be `IPDict`, and</span>
<span class="sd">            prompting policies are automatically selected using tags</span>
<span class="sd">            (see `IPDict` documentation).</span>
<span class="sd">        inner_policy_type: Ambient inner policy type. This information</span>
<span class="sd">            is not used at runtime but it can be provided to help type</span>
<span class="sd">            inference when necessary.</span>

<span class="sd">    The optional `inner_policy_type` argument is ignored at runtime</span>
<span class="sd">    and can be used to help type checkers infer the type of the</span>
<span class="sd">    ambient inner policy.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">get_policy</span><span class="p">,</span> <span class="n">EllipsisType</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">OpaqueSpace</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">]</span><span class="o">.</span><span class="n">from_query</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cast</span><span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">pol</span><span class="o">.</span><span class="n">dict_subpolicy</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">OpaqueSpace</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">]</span><span class="o">.</span><span class="n">from_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">get_policy</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.Query.run_toplevel" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">run_toplevel</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">run_toplevel</span><span class="p">(</span><span class="n">env</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="PolicyEnv (delphyne.stdlib.environments.PolicyEnv)" href="../environments/#delphyne.PolicyEnv">PolicyEnv</a></span><span class="p">,</span> <span class="n">policy</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="PromptingPolicy


  
      dataclass
   (delphyne.stdlib.policies.PromptingPolicy)" href="../basic/#delphyne.PromptingPolicy">PromptingPolicy</a></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Stream


  
      dataclass
   (delphyne.stdlib.streams.Stream)" href="../streams/#delphyne.Stream">Stream</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.Query[T]">T</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Obtain a search stream of query answers, given a prompting
policy.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">run_toplevel</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">PolicyEnv</span><span class="p">,</span>
    <span class="n">policy</span><span class="p">:</span> <span class="n">pol</span><span class="o">.</span><span class="n">PromptingPolicy</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Stream</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Obtain a search stream of query answers, given a prompting</span>
<span class="sd">    policy.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">attached</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">spawn_standalone_query</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">policy</span><span class="p">(</span><span class="n">attached</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.Parser" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">Parser</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">


        <p>A parser specification.</p>
<p>In addition to a mapping from answers to answer type <code>A</code>, a parser
also specifies query settings to be passed to oracles, along with
special formatting instructions to be rendered into the prompt.
Indeed, these components are typically tied and so specifying them
together in a single place is clearer.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.Parser.settings">settings</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="QuerySettings


  
      dataclass
   (delphyne.core.QuerySettings)" href="../../strategies/queries/#delphyne.QuerySettings">QuerySettings</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The query settings associated with the parser.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.Parser.formatting">formatting</span></code></td>
            <td>
                  <code><span title="delphyne.stdlib.queries.FormattingMetadata">FormattingMetadata</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Formatting metadata.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.Parser.parse">parse</span></code></td>
            <td>
                  <code><span title="collections.abc.Callable">Callable</span>[[<a class="autorefs autorefs-internal" title="Answer


  
      dataclass
   (delphyne.core.Answer)" href="../../strategies/traces/#delphyne.Answer">Answer</a>], <span title="delphyne.stdlib.queries.Parser[A]">A</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The parsing function, which is allowed to raise
the <a class="autorefs autorefs-internal" title="ParseError


  
      dataclass
  " href="../../strategies/queries/#delphyne.ParseError"><code>ParseError</code></a> exception.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Parser</span><span class="p">[</span><span class="n">A</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A parser specification.</span>

<span class="sd">    In addition to a mapping from answers to answer type `A`, a parser</span>
<span class="sd">    also specifies query settings to be passed to oracles, along with</span>
<span class="sd">    special formatting instructions to be rendered into the prompt.</span>
<span class="sd">    Indeed, these components are typically tied and so specifying them</span>
<span class="sd">    together in a single place is clearer.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        settings: The query settings associated with the parser.</span>
<span class="sd">        formatting: Formatting metadata.</span>
<span class="sd">        parse: The parsing function, which is allowed to raise</span>
<span class="sd">            the `ParseError` exception.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">settings</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">QuerySettings</span>
    <span class="n">formatting</span><span class="p">:</span> <span class="n">FormattingMetadata</span>
    <span class="n">parse</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">dp</span><span class="o">.</span><span class="n">Answer</span><span class="p">],</span> <span class="n">A</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_formatting</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">FormattingMetadata</span><span class="p">],</span> <span class="n">FormattingMetadata</span><span class="p">],</span> <span class="o">/</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Parser[A]&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">formatting</span><span class="o">=</span><span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formatting</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">map</span><span class="p">[</span><span class="n">B</span><span class="p">](</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">f</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">A</span><span class="p">],</span> <span class="n">B</span> <span class="o">|</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span><span class="p">],</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">catch_exn</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Parser[B]&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply a function to the parser&#39;s output.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            f: The function to apply, which is allowed to raise or</span>
<span class="sd">                return `ParseError`.</span>
<span class="sd">            catch_exn: If `True`, any other exception raised by `f` is</span>
<span class="sd">                caught and wrapped into a `ParseError`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">parse</span><span class="p">(</span><span class="n">ans</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">Answer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">B</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">catch_exn</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ret</span>
            <span class="k">return</span> <span class="n">ret</span>

        <span class="k">return</span> <span class="n">Parser</span><span class="p">(</span>
            <span class="n">settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="n">formatting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">formatting</span><span class="p">,</span> <span class="n">parse</span><span class="o">=</span><span class="n">parse</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">f</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">A</span><span class="p">],</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span> <span class="o">|</span> <span class="kc">None</span><span class="p">],</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">catch_exn</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Parser[A]&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that the parser&#39;s output satisfies a given property.</span>

<span class="sd">        If the property is satisfied, function `f` must return `None`.</span>
<span class="sd">        Otherwise, it may return or raise a `ParseError`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">parse</span><span class="p">(</span><span class="n">ans</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">Answer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">A</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">opt_err</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">catch_exn</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>
            <span class="k">if</span> <span class="n">opt_err</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">opt_err</span>
            <span class="k">return</span> <span class="n">res</span>

        <span class="k">return</span> <span class="n">Parser</span><span class="p">(</span>
            <span class="n">settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="n">formatting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">formatting</span><span class="p">,</span> <span class="n">parse</span><span class="o">=</span><span class="n">parse</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">wrap_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Parser[A | WrappedParseError]&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrap parse errors into `WrappedParseError`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">parse</span><span class="p">(</span><span class="n">ans</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">Answer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">A</span> <span class="o">|</span> <span class="n">WrappedParseError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">WrappedParseError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Parser</span><span class="p">(</span>
            <span class="n">settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="n">formatting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">formatting</span><span class="p">,</span> <span class="n">parse</span><span class="o">=</span><span class="n">parse</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">response_with</span><span class="p">[</span><span class="n">T</span><span class="p">:</span> <span class="n">md</span><span class="o">.</span><span class="n">AbstractTool</span><span class="p">[</span><span class="n">Any</span><span class="p">]](</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">TypeAnnot</span><span class="p">[</span><span class="n">T</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Parser[Response[A, T]]&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrap answers into full `Response` objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">tools_raw</span> <span class="o">=</span> <span class="n">dpi</span><span class="o">.</span><span class="n">union_components</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
        <span class="n">tools_types</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">md</span><span class="o">.</span><span class="n">AbstractTool</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">tools_raw</span> <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">md</span><span class="o">.</span><span class="n">AbstractTool</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">tools_types</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">tools_raw</span><span class="p">),</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Invalid tools union: </span><span class="si">{</span><span class="n">tools</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">tools</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tools_settings</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">ToolSettings</span><span class="p">(</span>
                <span class="n">tool_types</span><span class="o">=</span><span class="n">tools_types</span><span class="p">,</span> <span class="n">force_tool_call</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tools_settings</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">ToolSettings</span><span class="p">(</span>
                <span class="n">tool_types</span><span class="o">=</span><span class="p">[</span><span class="o">*</span><span class="n">tools_types</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">tool_types</span><span class="p">],</span>
                <span class="n">force_tool_call</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">force_tool_call</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools_settings</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">parse</span><span class="p">(</span><span class="n">ans</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">Answer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">[</span><span class="n">A</span><span class="p">,</span> <span class="n">T</span><span class="p">]:</span>
            <span class="c1"># If the answer is one of the provided tool types, we</span>
            <span class="c1"># return. Otherwise, we call the parser recursively.</span>
            <span class="n">tcs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">ans</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools_types</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">tc</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">t</span><span class="o">.</span><span class="n">tool_name</span><span class="p">():</span>
                        <span class="n">tcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_parse_or_raise</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">tc</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>
                        <span class="k">break</span>
            <span class="k">if</span> <span class="n">tcs</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">[</span><span class="n">A</span><span class="p">,</span> <span class="n">T</span><span class="p">](</span><span class="n">ans</span><span class="p">,</span> <span class="n">ToolRequests</span><span class="p">(</span><span class="n">tcs</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">[</span><span class="n">A</span><span class="p">,</span> <span class="n">T</span><span class="p">](</span><span class="n">ans</span><span class="p">,</span> <span class="n">FinalAnswer</span><span class="p">(</span><span class="n">parsed</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">Parser</span><span class="p">(</span>
            <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">,</span> <span class="n">formatting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">formatting</span><span class="p">,</span> <span class="n">parse</span><span class="o">=</span><span class="n">parse</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">response</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;GenericParser&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrap answers into full `Response` objects.</span>

<span class="sd">        Return a `GenericParser` so that the list of supported tools can</span>
<span class="sd">        be extracted from the query&#39;s answer type.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">parser</span><span class="p">(</span><span class="n">annot</span><span class="p">:</span> <span class="n">TypeAnnot</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Parser</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
            <span class="k">assert</span> <span class="n">typing</span><span class="o">.</span><span class="n">get_origin</span><span class="p">(</span><span class="n">annot</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Response</span><span class="p">,</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Response type expected: </span><span class="si">{</span><span class="n">annot</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">get_args</span><span class="p">(</span><span class="n">annot</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_with</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">GenericParser</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">trim</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="s2">&quot;Parser[str]&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Parser[str]&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Trim the output of a string parser.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">strip</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">json</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="s2">&quot;Parser[str]&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;GenericParser&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse a string as a JSON object.</span>

<span class="sd">        Return a `GenericParser` so that the target type can be</span>
<span class="sd">        extracted from the query&#39;s answer type.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">GenericParser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json_as</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">yaml</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="s2">&quot;Parser[str]&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;GenericParser&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse a string as a YAML object.</span>

<span class="sd">        Return a `GenericParser` so that the target type can be</span>
<span class="sd">        extracted from the query&#39;s answer type.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">GenericParser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yaml_as</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">json_as</span><span class="p">[</span><span class="n">U</span><span class="p">](</span><span class="bp">self</span><span class="p">:</span> <span class="s2">&quot;Parser[str]&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="n">TypeAnnot</span><span class="p">[</span><span class="n">U</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Parser[U]&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse a string as a JSON object.</span>

<span class="sd">        !!! info</span>
<span class="sd">            This method currently does not work very well with type</span>
<span class="sd">            inference since its arguments do not allow inferring the</span>
<span class="sd">            type of `U`. This should work better once `TypeAnnot` can be</span>
<span class="sd">            replaced with `TypeExpr` (incoming in Python 3.14).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">_assert_not_response_type</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s2">&quot;json_as&quot;</span><span class="p">)</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">Schema</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">_parse_json_as</span><span class="p">,</span> <span class="nb">type</span><span class="p">))</span><span class="o">.</span><span class="n">update_formatting</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">replace</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">yaml_as</span><span class="p">[</span><span class="n">U</span><span class="p">](</span><span class="bp">self</span><span class="p">:</span> <span class="s2">&quot;Parser[str]&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="n">TypeAnnot</span><span class="p">[</span><span class="n">U</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Parser[U]&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse a string as a YAML object.</span>

<span class="sd">        !!! info</span>
<span class="sd">            This method currently does not work very well with type</span>
<span class="sd">            inference since its arguments do not allow inferring the</span>
<span class="sd">            type of `U`. This should work better once `TypeAnnot` can be</span>
<span class="sd">            replaced with `TypeExpr` (incoming in Python 3.14).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_assert_not_response_type</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s2">&quot;yaml_as&quot;</span><span class="p">)</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">Schema</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">_parse_yaml_as</span><span class="p">,</span> <span class="nb">type</span><span class="p">))</span><span class="o">.</span><span class="n">update_formatting</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">replace</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;yaml&quot;</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h4 id="delphyne.Parser.wrap_errors" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">wrap_errors</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">wrap_errors</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="Parser


  
      dataclass
   (delphyne.stdlib.queries.Parser)" href="#delphyne.Parser">Parser</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.Parser[A]">A</span></span> <span class="o">|</span> <span class="n"><a class="autorefs autorefs-internal" title="WrappedParseError


  
      dataclass
   (delphyne.stdlib.queries.WrappedParseError)" href="#delphyne.WrappedParseError">WrappedParseError</a></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Wrap parse errors into <a class="autorefs autorefs-internal" title="WrappedParseError


  
      dataclass
  " href="#delphyne.WrappedParseError"><code>WrappedParseError</code></a>.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="delphyne.Parser.response" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">response</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">response</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="GenericParser


  
      dataclass
   (delphyne.stdlib.queries.GenericParser)" href="#delphyne.GenericParser">GenericParser</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Wrap answers into full <a class="autorefs autorefs-internal" title="Response


  
      dataclass
  " href="#delphyne.Response"><code>Response</code></a> objects.</p>
<p>Return a <a class="autorefs autorefs-internal" title="GenericParser


  
      dataclass
  " href="#delphyne.GenericParser"><code>GenericParser</code></a> so that the list of supported tools can
be extracted from the query's answer type.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="delphyne.Parser.trim" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">trim</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">trim</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="Parser


  
      dataclass
   (delphyne.stdlib.queries.Parser)" href="#delphyne.Parser">Parser</a></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Trim the output of a string parser.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="delphyne.Parser.json" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">json</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">json</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="GenericParser


  
      dataclass
   (delphyne.stdlib.queries.GenericParser)" href="#delphyne.GenericParser">GenericParser</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Parse a string as a JSON object.</p>
<p>Return a <a class="autorefs autorefs-internal" title="GenericParser


  
      dataclass
  " href="#delphyne.GenericParser"><code>GenericParser</code></a> so that the target type can be
extracted from the query's answer type.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="delphyne.Parser.yaml" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">yaml</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">yaml</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="GenericParser


  
      dataclass
   (delphyne.stdlib.queries.GenericParser)" href="#delphyne.GenericParser">GenericParser</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Parse a string as a YAML object.</p>
<p>Return a <a class="autorefs autorefs-internal" title="GenericParser


  
      dataclass
  " href="#delphyne.GenericParser"><code>GenericParser</code></a> so that the target type can be
extracted from the query's answer type.</p>

    </div>

</div>




<div class="doc doc-object doc-function">


<h4 id="delphyne.Parser.map" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">map</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">map</span><span class="p">(</span><span class="n">f</span><span class="p">:</span> <span class="n"><span title="collections.abc.Callable">Callable</span></span><span class="p">[[</span><span class="n"><span title="delphyne.stdlib.queries.Parser[A]">A</span></span><span class="p">],</span> <span class="n"><span title="delphyne.stdlib.queries.Parser.map[B]">B</span></span> <span class="o">|</span> <span class="n"><a class="autorefs autorefs-internal" title="ParseError


  
      dataclass
   (delphyne.core.ParseError)" href="../../strategies/queries/#delphyne.ParseError">ParseError</a></span><span class="p">],</span> <span class="o">/</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">catch_exn</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Parser


  
      dataclass
   (delphyne.stdlib.queries.Parser)" href="#delphyne.Parser">Parser</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.Parser.map[B]">B</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Apply a function to the parser's output.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>f</code>
            </td>
            <td>
                  <code><span title="collections.abc.Callable">Callable</span>[[<span title="delphyne.stdlib.queries.Parser[A]">A</span>], <span title="delphyne.stdlib.queries.Parser.map[B]">B</span> | <a class="autorefs autorefs-internal" title="ParseError


  
      dataclass
   (delphyne.core.ParseError)" href="../../strategies/queries/#delphyne.ParseError">ParseError</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The function to apply, which is allowed to raise or
return <a class="autorefs autorefs-internal" title="ParseError


  
      dataclass
  " href="../../strategies/queries/#delphyne.ParseError"><code>ParseError</code></a>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>catch_exn</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If <code>True</code>, any other exception raised by <code>f</code> is
caught and wrapped into a <a class="autorefs autorefs-internal" title="ParseError


  
      dataclass
  " href="../../strategies/queries/#delphyne.ParseError"><code>ParseError</code></a>.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">map</span><span class="p">[</span><span class="n">B</span><span class="p">](</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">f</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">A</span><span class="p">],</span> <span class="n">B</span> <span class="o">|</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span><span class="p">],</span>
    <span class="o">/</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">catch_exn</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Parser[B]&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply a function to the parser&#39;s output.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        f: The function to apply, which is allowed to raise or</span>
<span class="sd">            return `ParseError`.</span>
<span class="sd">        catch_exn: If `True`, any other exception raised by `f` is</span>
<span class="sd">            caught and wrapped into a `ParseError`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">parse</span><span class="p">(</span><span class="n">ans</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">Answer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">B</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">catch_exn</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ret</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">return</span> <span class="n">Parser</span><span class="p">(</span>
        <span class="n">settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="n">formatting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">formatting</span><span class="p">,</span> <span class="n">parse</span><span class="o">=</span><span class="n">parse</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.Parser.validate" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">validate</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">validate</span><span class="p">(</span>
    <span class="n">f</span><span class="p">:</span> <span class="n"><span title="collections.abc.Callable">Callable</span></span><span class="p">[[</span><span class="n"><span title="delphyne.stdlib.queries.Parser[A]">A</span></span><span class="p">],</span> <span class="n"><a class="autorefs autorefs-internal" title="ParseError


  
      dataclass
   (delphyne.core.ParseError)" href="../../strategies/queries/#delphyne.ParseError">ParseError</a></span> <span class="o">|</span> <span class="kc">None</span><span class="p">],</span> <span class="o">/</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">catch_exn</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Parser


  
      dataclass
   (delphyne.stdlib.queries.Parser)" href="#delphyne.Parser">Parser</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.Parser[A]">A</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Check that the parser's output satisfies a given property.</p>
<p>If the property is satisfied, function <code>f</code> must return <code>None</code>.
Otherwise, it may return or raise a <a class="autorefs autorefs-internal" title="ParseError


  
      dataclass
  " href="../../strategies/queries/#delphyne.ParseError"><code>ParseError</code></a>.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">f</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">A</span><span class="p">],</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span> <span class="o">|</span> <span class="kc">None</span><span class="p">],</span>
    <span class="o">/</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">catch_exn</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Parser[A]&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check that the parser&#39;s output satisfies a given property.</span>

<span class="sd">    If the property is satisfied, function `f` must return `None`.</span>
<span class="sd">    Otherwise, it may return or raise a `ParseError`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">parse</span><span class="p">(</span><span class="n">ans</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">Answer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">A</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">opt_err</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">catch_exn</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>
        <span class="k">if</span> <span class="n">opt_err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">opt_err</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">return</span> <span class="n">Parser</span><span class="p">(</span>
        <span class="n">settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="n">formatting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">formatting</span><span class="p">,</span> <span class="n">parse</span><span class="o">=</span><span class="n">parse</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.Parser.response_with" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">response_with</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">response_with</span><span class="p">(</span><span class="n">tools</span><span class="p">:</span> <span class="n"><span title="delphyne.utils.typing.TypeAnnot">TypeAnnot</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.Parser.response_with[T]">T</span></span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Parser


  
      dataclass
   (delphyne.stdlib.queries.Parser)" href="#delphyne.Parser">Parser</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="Response


  
      dataclass
   (delphyne.stdlib.queries.Response)" href="#delphyne.Response">Response</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.Parser[A]">A</span></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.queries.Parser.response_with[T]">T</span></span><span class="p">]]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Wrap answers into full <a class="autorefs autorefs-internal" title="Response


  
      dataclass
  " href="#delphyne.Response"><code>Response</code></a> objects.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">response_with</span><span class="p">[</span><span class="n">T</span><span class="p">:</span> <span class="n">md</span><span class="o">.</span><span class="n">AbstractTool</span><span class="p">[</span><span class="n">Any</span><span class="p">]](</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">TypeAnnot</span><span class="p">[</span><span class="n">T</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Parser[Response[A, T]]&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrap answers into full `Response` objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tools_raw</span> <span class="o">=</span> <span class="n">dpi</span><span class="o">.</span><span class="n">union_components</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
    <span class="n">tools_types</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">md</span><span class="o">.</span><span class="n">AbstractTool</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">tools_raw</span> <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">md</span><span class="o">.</span><span class="n">AbstractTool</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">tools_types</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">tools_raw</span><span class="p">),</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Invalid tools union: </span><span class="si">{</span><span class="n">tools</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">tools</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tools_settings</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">ToolSettings</span><span class="p">(</span>
            <span class="n">tool_types</span><span class="o">=</span><span class="n">tools_types</span><span class="p">,</span> <span class="n">force_tool_call</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tools_settings</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">ToolSettings</span><span class="p">(</span>
            <span class="n">tool_types</span><span class="o">=</span><span class="p">[</span><span class="o">*</span><span class="n">tools_types</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">tool_types</span><span class="p">],</span>
            <span class="n">force_tool_call</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">force_tool_call</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools_settings</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">parse</span><span class="p">(</span><span class="n">ans</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">Answer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">[</span><span class="n">A</span><span class="p">,</span> <span class="n">T</span><span class="p">]:</span>
        <span class="c1"># If the answer is one of the provided tool types, we</span>
        <span class="c1"># return. Otherwise, we call the parser recursively.</span>
        <span class="n">tcs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">ans</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools_types</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tc</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">t</span><span class="o">.</span><span class="n">tool_name</span><span class="p">():</span>
                    <span class="n">tcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_parse_or_raise</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">tc</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>
                    <span class="k">break</span>
        <span class="k">if</span> <span class="n">tcs</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">[</span><span class="n">A</span><span class="p">,</span> <span class="n">T</span><span class="p">](</span><span class="n">ans</span><span class="p">,</span> <span class="n">ToolRequests</span><span class="p">(</span><span class="n">tcs</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">[</span><span class="n">A</span><span class="p">,</span> <span class="n">T</span><span class="p">](</span><span class="n">ans</span><span class="p">,</span> <span class="n">FinalAnswer</span><span class="p">(</span><span class="n">parsed</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">Parser</span><span class="p">(</span>
        <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">,</span> <span class="n">formatting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">formatting</span><span class="p">,</span> <span class="n">parse</span><span class="o">=</span><span class="n">parse</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.Parser.json_as" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">json_as</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">json_as</span><span class="p">(</span><span class="nb">type</span><span class="p">:</span> <span class="n"><span title="delphyne.utils.typing.TypeAnnot">TypeAnnot</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.Parser.json_as[U]">U</span></span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Parser


  
      dataclass
   (delphyne.stdlib.queries.Parser)" href="#delphyne.Parser">Parser</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.Parser.json_as[U]">U</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Parse a string as a JSON object.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>This method currently does not work very well with type
inference since its arguments do not allow inferring the
type of <code>U</code>. This should work better once <code>TypeAnnot</code> can be
replaced with <code>TypeExpr</code> (incoming in Python 3.14).</p>
</div>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">json_as</span><span class="p">[</span><span class="n">U</span><span class="p">](</span><span class="bp">self</span><span class="p">:</span> <span class="s2">&quot;Parser[str]&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="n">TypeAnnot</span><span class="p">[</span><span class="n">U</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Parser[U]&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse a string as a JSON object.</span>

<span class="sd">    !!! info</span>
<span class="sd">        This method currently does not work very well with type</span>
<span class="sd">        inference since its arguments do not allow inferring the</span>
<span class="sd">        type of `U`. This should work better once `TypeAnnot` can be</span>
<span class="sd">        replaced with `TypeExpr` (incoming in Python 3.14).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_assert_not_response_type</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s2">&quot;json_as&quot;</span><span class="p">)</span>
    <span class="n">schema</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">Schema</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">_parse_json_as</span><span class="p">,</span> <span class="nb">type</span><span class="p">))</span><span class="o">.</span><span class="n">update_formatting</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">replace</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.Parser.yaml_as" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">yaml_as</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">yaml_as</span><span class="p">(</span><span class="nb">type</span><span class="p">:</span> <span class="n"><span title="delphyne.utils.typing.TypeAnnot">TypeAnnot</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.Parser.yaml_as[U]">U</span></span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Parser


  
      dataclass
   (delphyne.stdlib.queries.Parser)" href="#delphyne.Parser">Parser</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.Parser.yaml_as[U]">U</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Parse a string as a YAML object.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>This method currently does not work very well with type
inference since its arguments do not allow inferring the
type of <code>U</code>. This should work better once <code>TypeAnnot</code> can be
replaced with <code>TypeExpr</code> (incoming in Python 3.14).</p>
</div>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">yaml_as</span><span class="p">[</span><span class="n">U</span><span class="p">](</span><span class="bp">self</span><span class="p">:</span> <span class="s2">&quot;Parser[str]&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="n">TypeAnnot</span><span class="p">[</span><span class="n">U</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Parser[U]&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse a string as a YAML object.</span>

<span class="sd">    !!! info</span>
<span class="sd">        This method currently does not work very well with type</span>
<span class="sd">        inference since its arguments do not allow inferring the</span>
<span class="sd">        type of `U`. This should work better once `TypeAnnot` can be</span>
<span class="sd">        replaced with `TypeExpr` (incoming in Python 3.14).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_assert_not_response_type</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s2">&quot;yaml_as&quot;</span><span class="p">)</span>
    <span class="n">schema</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">Schema</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">_parse_yaml_as</span><span class="p">,</span> <span class="nb">type</span><span class="p">))</span><span class="o">.</span><span class="n">update_formatting</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">replace</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;yaml&quot;</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.GenericParser" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">GenericParser</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">


        <p>A mapping from a query's answer type to a parser specification.</p>
<p>This is useful to avoid redundancy when specifying parsers. In
particular, it allows writing:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MyQuery</span><span class="p">(</span><span class="n">Query</span><span class="p">[</span><span class="n">Response</span><span class="p">[</span><span class="n">Out</span><span class="p">,</span> <span class="n">Tool1</span> <span class="o">|</span> <span class="n">Tool2</span><span class="p">]]):</span>
    <span class="o">...</span>
    <span class="n">__parser__</span> <span class="o">=</span> <span class="n">last_block</span><span class="o">.</span><span class="n">yaml</span><span class="o">.</span><span class="n">response</span>
</code></pre></div>
<p>instead of:</p>
<div class="highlight"><pre><span></span><code><span class="n">__parser__</span> <span class="o">=</span> <span class="n">last_block</span><span class="o">.</span><span class="n">yaml_as</span><span class="p">(</span><span class="n">Out</span><span class="p">)</span><span class="o">.</span><span class="n">response_with</span><span class="p">(</span><span class="n">Tool1</span> <span class="o">|</span> <span class="n">Tool2</span><span class="p">)</span>
</code></pre></div>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.GenericParser.for_type">for_type</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="_GenericParserFn (delphyne.stdlib.queries._GenericParserFn)" href="#delphyne.stdlib.queries._GenericParserFn">_GenericParserFn</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A function that takes a type annotation and returns a
<a class="autorefs autorefs-internal" title="Parser


  
      dataclass
  " href="#delphyne.Parser"><code>Parser</code></a> for this type.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">GenericParser</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A mapping from a query&#39;s answer type to a parser specification.</span>

<span class="sd">    This is useful to avoid redundancy when specifying parsers. In</span>
<span class="sd">    particular, it allows writing:</span>

<span class="sd">    ```python</span>
<span class="sd">    @dataclass</span>
<span class="sd">    class MyQuery(Query[Response[Out, Tool1 | Tool2]]):</span>
<span class="sd">        ...</span>
<span class="sd">        __parser__ = last_block.yaml.response</span>
<span class="sd">    ```</span>

<span class="sd">    instead of:</span>

<span class="sd">    ```python</span>
<span class="sd">    __parser__ = last_block.yaml_as(Out).response_with(Tool1 | Tool2)</span>
<span class="sd">    ```</span>

<span class="sd">    Attributes:</span>
<span class="sd">        for_type: A function that takes a type annotation and returns a</span>
<span class="sd">            `Parser` for this type.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">for_type</span><span class="p">:</span> <span class="s2">&quot;_GenericParserFn&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">wrap_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;GenericParser&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrap parse errors into `WrappedParseError`.</span>

<span class="sd">        A runtime check is performed to ensure that the answer type</span>
<span class="sd">        features `WrappedParseError`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">parser</span><span class="p">(</span><span class="n">annot</span><span class="p">:</span> <span class="n">TypeAnnot</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Parser</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
            <span class="n">comps</span> <span class="o">=</span> <span class="n">dpi</span><span class="o">.</span><span class="n">union_components</span><span class="p">(</span><span class="n">annot</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">comps</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">WrappedParseError</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">,</span> <span class="p">(</span>
                <span class="s2">&quot;Answer type does not have shape `... | WrappedParseError`: &quot;</span>
                <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">annot</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">annot</span> <span class="o">=</span> <span class="n">dpi</span><span class="o">.</span><span class="n">make_union</span><span class="p">(</span>
                <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">comps</span> <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="n">WrappedParseError</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">for_type</span><span class="p">(</span><span class="n">annot</span><span class="p">)</span><span class="o">.</span><span class="n">wrap_errors</span>

        <span class="k">return</span> <span class="n">GenericParser</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">response</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;GenericParser&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrap answers into full `Response` objects.</span>

<span class="sd">        Possible tool calls are extracted from the query&#39;s answer type</span>
<span class="sd">        and an exception is raised if this type does not have the form</span>
<span class="sd">        `Response[..., ...]`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">parser</span><span class="p">(</span><span class="n">annot</span><span class="p">:</span> <span class="n">TypeAnnot</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Parser</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
            <span class="k">assert</span> <span class="n">typing</span><span class="o">.</span><span class="n">get_origin</span><span class="p">(</span><span class="n">annot</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Response</span><span class="p">,</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Response type expected: </span><span class="si">{</span><span class="n">annot</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">get_args</span><span class="p">(</span><span class="n">annot</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">for_type</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">response_with</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">GenericParser</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h4 id="delphyne.GenericParser.wrap_errors" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">wrap_errors</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">wrap_errors</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="GenericParser


  
      dataclass
   (delphyne.stdlib.queries.GenericParser)" href="#delphyne.GenericParser">GenericParser</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Wrap parse errors into <a class="autorefs autorefs-internal" title="WrappedParseError


  
      dataclass
  " href="#delphyne.WrappedParseError"><code>WrappedParseError</code></a>.</p>
<p>A runtime check is performed to ensure that the answer type
features <a class="autorefs autorefs-internal" title="WrappedParseError


  
      dataclass
  " href="#delphyne.WrappedParseError"><code>WrappedParseError</code></a>.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="delphyne.GenericParser.response" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">response</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">response</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="GenericParser


  
      dataclass
   (delphyne.stdlib.queries.GenericParser)" href="#delphyne.GenericParser">GenericParser</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Wrap answers into full <a class="autorefs autorefs-internal" title="Response


  
      dataclass
  " href="#delphyne.Response"><code>Response</code></a> objects.</p>
<p>Possible tool calls are extracted from the query's answer type
and an exception is raised if this type does not have the form
<code>Response[..., ...]</code>.</p>

    </div>

</div>






  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.queries._GenericParserFn" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">_GenericParserFn</span>


</h3>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="typing.Protocol">Protocol</span></code></p>


        <p>Type of functions wrapped by <a class="autorefs autorefs-internal" title="GenericParser


  
      dataclass
  " href="#delphyne.GenericParser"><code>GenericParser</code></a>.</p>








              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">_GenericParserFn</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Type of functions wrapped by `GenericParser`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">[</span><span class="n">T</span><span class="p">](</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="n">TypeAnnot</span><span class="p">[</span><span class="n">T</span><span class="p">],</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Parser</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span> <span class="o">...</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-type_alias">



<h3 id="delphyne.ParserDict" class="doc doc-heading">
            <span class="doc doc-object-name doc-type_alias-name">ParserDict</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nc">ParserDict</span> <span class="o">=</span> <span class="n"><span title="dict">dict</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="AnswerMode (delphyne.core.AnswerMode)" href="../../strategies/traces/#delphyne.AnswerMode">AnswerMode</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-internal" title="Parser


  
      dataclass
   (delphyne.stdlib.queries.Parser)" href="#delphyne.Parser">Parser</a></span><span class="p">[</span><span class="n"><span title="typing.Any">Any</span></span><span class="p">]</span> <span class="o">|</span> <span class="n"><a class="autorefs autorefs-internal" title="GenericParser


  
      dataclass
   (delphyne.stdlib.queries.GenericParser)" href="#delphyne.GenericParser">GenericParser</a></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>A mapping from answer modes to parser specifications.</p>
<p>Can be used as a value for the <code>__parser__</code> class attribute of queries.</p>
    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.Response" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">Response</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">


        <p>Answer type for queries that allow follow-ups.</p>
<p><a class="autorefs autorefs-internal" title="Response


  
      dataclass
  " href="#delphyne.Response"><code>Response</code></a> values give access to both the raw LLM response (to be
passed pass in <a class="autorefs autorefs-internal" title="AnswerPrefix" href="../../strategies/queries/#delphyne.AnswerPrefix"><code>AnswerPrefix</code></a>) and to eventual tool calls. See the
<code>Parser.response</code>, <code>Parser.response_with</code>, and
<code>GenericParser.response</code> methods for creating parsers that produce
<a class="autorefs autorefs-internal" title="Response


  
      dataclass
  " href="#delphyne.Response"><code>Response</code></a> values.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.Response.answer">answer</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Answer


  
      dataclass
   (delphyne.core.Answer)" href="../../strategies/traces/#delphyne.Answer">Answer</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The raw, unparsed LLM answer.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.Response.parsed">parsed</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="FinalAnswer


  
      dataclass
   (delphyne.stdlib.queries.FinalAnswer)" href="#delphyne.FinalAnswer">FinalAnswer</a>[<span title="delphyne.stdlib.queries.Response[F]">F</span>] | <a class="autorefs autorefs-internal" title="ToolRequests


  
      dataclass
   (delphyne.stdlib.queries.ToolRequests)" href="#delphyne.ToolRequests">ToolRequests</a>[<span title="delphyne.stdlib.queries.Response[T]">T</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Either the parsed answer wrapped in <a class="autorefs autorefs-internal" title="FinalAnswer


  
      dataclass
  " href="#delphyne.FinalAnswer"><code>FinalAnswer</code></a> or
some tool call requests wrapped in <a class="autorefs autorefs-internal" title="ToolRequests


  
      dataclass
  " href="#delphyne.ToolRequests"><code>ToolRequests</code></a>.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Response</span><span class="p">[</span><span class="n">F</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="n">md</span><span class="o">.</span><span class="n">AbstractTool</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Answer type for queries that allow follow-ups.</span>

<span class="sd">    `Response` values give access to both the raw LLM response (to be</span>
<span class="sd">    passed pass in `AnswerPrefix`) and to eventual tool calls. See the</span>
<span class="sd">    `Parser.response`, `Parser.response_with`, and</span>
<span class="sd">    `GenericParser.response` methods for creating parsers that produce</span>
<span class="sd">    `Response` values.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        answer: The raw, unparsed LLM answer.</span>
<span class="sd">        parsed: Either the parsed answer wrapped in `FinalAnswer` or</span>
<span class="sd">            some tool call requests wrapped in `ToolRequests`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">answer</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">Answer</span>
    <span class="n">parsed</span><span class="p">:</span> <span class="n">FinalAnswer</span><span class="p">[</span><span class="n">F</span><span class="p">]</span> <span class="o">|</span> <span class="n">ToolRequests</span><span class="p">[</span><span class="n">T</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.FinalAnswer" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">FinalAnswer</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">


        <p>See <a class="autorefs autorefs-internal" title="Response


  
      dataclass
  " href="#delphyne.Response"><code>Response</code></a>.</p>








              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FinalAnswer</span><span class="p">[</span><span class="n">F</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    See `Response`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">final</span><span class="p">:</span> <span class="n">F</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.ToolRequests" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">ToolRequests</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">


        <p>See <a class="autorefs autorefs-internal" title="Response


  
      dataclass
  " href="#delphyne.Response"><code>Response</code></a>.</p>








              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ToolRequests</span><span class="p">[</span><span class="n">T</span><span class="p">:</span> <span class="n">md</span><span class="o">.</span><span class="n">AbstractTool</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    See `Response`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tool_calls</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">T</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.WrappedParseError" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">WrappedParseError</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">


        <p>A wrapped parse error that is returned to a strategy instead of
causing a failure.</p>
<p>For queries that declare a return type of the form <code>Response[... |
WrappedParseError, ...]</code>, parse errors do not result in failures but
are instead wrapped and returned, to be handled explicitly by the
surrounding strategy. For example, when building conversational
agents with <a class="autorefs autorefs-internal" title="interact" href="../algorithms/#delphyne.interact"><code>interact</code></a>, having the query include <a class="autorefs autorefs-internal" title="WrappedParseError


  
      dataclass
  " href="#delphyne.WrappedParseError"><code>WrappedParseError</code></a>
in its return type allows explicitly asking the agent to fix parse
errors instead of failing (or having the policy retry an identical
prompt).</p>
<p>See the <code>Parser.wrap_errors</code> and <code>GenericParser.wrap_errors</code> methods
for creating parsers that produce <a class="autorefs autorefs-internal" title="WrappedParseError


  
      dataclass
  " href="#delphyne.WrappedParseError"><code>WrappedParseError</code></a> values.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.WrappedParseError.error">error</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="ParseError


  
      dataclass
   (delphyne.core.ParseError)" href="../../strategies/queries/#delphyne.ParseError">ParseError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The wrapped parse error.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">WrappedParseError</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A wrapped parse error that is returned to a strategy instead of</span>
<span class="sd">    causing a failure.</span>

<span class="sd">    For queries that declare a return type of the form `Response[... |</span>
<span class="sd">    WrappedParseError, ...]`, parse errors do not result in failures but</span>
<span class="sd">    are instead wrapped and returned, to be handled explicitly by the</span>
<span class="sd">    surrounding strategy. For example, when building conversational</span>
<span class="sd">    agents with `interact`, having the query include `WrappedParseError`</span>
<span class="sd">    in its return type allows explicitly asking the agent to fix parse</span>
<span class="sd">    errors instead of failing (or having the policy retry an identical</span>
<span class="sd">    prompt).</span>

<span class="sd">    See the `Parser.wrap_errors` and `GenericParser.wrap_errors` methods</span>
<span class="sd">    for creating parsers that produce `WrappedParseError` values.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        error: The wrapped parse error.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">error</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.queries.QueryTemplateArgs" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">QueryTemplateArgs</span>


</h3>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="typing.TypedDict">TypedDict</span></code></p>


        <p>Template arguments passed to all query templates.</p>
<p>For particular kinds of templates, additional arguments may be
provided (e.g., <code>feedback</code> for feedback prompts).</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.queries.QueryTemplateArgs.query">query</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Query (delphyne.stdlib.queries.Query)" href="#delphyne.Query">Query</a>[<span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The query instance.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.queries.QueryTemplateArgs.mode">mode</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="AnswerMode (delphyne.core.AnswerMode)" href="../../strategies/traces/#delphyne.AnswerMode">AnswerMode</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The requested answer mode.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.queries.QueryTemplateArgs.available_modes">available_modes</span></code></td>
            <td>
                  <code><span title="collections.abc.Sequence">Sequence</span>[<a class="autorefs autorefs-internal" title="AnswerMode (delphyne.core.AnswerMode)" href="../../strategies/traces/#delphyne.AnswerMode">AnswerMode</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The sequence of all available answer modes for
the query type.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.queries.QueryTemplateArgs.params">params</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The query hyperparameters (e.g., as passed to <a class="autorefs autorefs-internal" title="few_shot" href="#delphyne.few_shot"><code>few_shot</code></a>)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.queries.QueryTemplateArgs.format">format</span></code></td>
            <td>
                  <code><span title="delphyne.stdlib.queries.FormattingMetadata">FormattingMetadata</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Formatting metadata.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">QueryTemplateArgs</span><span class="p">(</span><span class="n">typing</span><span class="o">.</span><span class="n">TypedDict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Template arguments passed to all query templates.</span>

<span class="sd">    For particular kinds of templates, additional arguments may be</span>
<span class="sd">    provided (e.g., `feedback` for feedback prompts).</span>

<span class="sd">    Attributes:</span>
<span class="sd">        query: The query instance.</span>
<span class="sd">        mode: The requested answer mode.</span>
<span class="sd">        available_modes: The sequence of all available answer modes for</span>
<span class="sd">            the query type.</span>
<span class="sd">        params: The query hyperparameters (e.g., as passed to `few_shot`)</span>
<span class="sd">        format: Formatting metadata.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># TODO: in future Python versions, use `extra_items=Any` (PEP 728)</span>

    <span class="n">query</span><span class="p">:</span> <span class="s2">&quot;Query[Any]&quot;</span>
    <span class="n">mode</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">AnswerMode</span>
    <span class="n">available_modes</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">AnswerMode</span><span class="p">]</span>
    <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="nb">format</span><span class="p">:</span> <span class="n">FormattingMetadata</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div><h2 id="standard-parsers">Standard Parsers</h2>


<div class="doc doc-object doc-function">


<h3 id="delphyne.structured_as" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">structured_as</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">structured_as</span><span class="p">(</span><span class="nb">type</span><span class="p">:</span> <span class="n"><span title="delphyne.utils.typing.TypeAnnot">TypeAnnot</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.structured_as[T]">T</span></span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Parser


  
      dataclass
   (delphyne.stdlib.queries.Parser)" href="#delphyne.Parser">Parser</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.structured_as[T]">T</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Parse an LLM structured answer into a given target type.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Only dataclass types are supported, since most LLM providers
only support structured output and tool calls for JSON objects.</p>
</div>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">structured_as</span><span class="p">[</span><span class="n">T</span><span class="p">](</span><span class="nb">type</span><span class="p">:</span> <span class="n">TypeAnnot</span><span class="p">[</span><span class="n">T</span><span class="p">],</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Parser</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse an LLM structured answer into a given target type.</span>

<span class="sd">    !!! warning</span>
<span class="sd">        Only dataclass types are supported, since most LLM providers</span>
<span class="sd">        only support structured output and tool calls for JSON objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_assert_not_response_type</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s2">&quot;structured_as&quot;</span><span class="p">)</span>
    <span class="n">_check_valid_structured_output_type</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">QuerySettings</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">StructuredOutputSettings</span><span class="p">(</span><span class="nb">type</span><span class="p">))</span>
    <span class="n">formatting</span> <span class="o">=</span> <span class="n">FormattingMetadata</span><span class="p">(</span>
        <span class="n">where</span><span class="o">=</span><span class="s2">&quot;full_answer&quot;</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">md</span><span class="o">.</span><span class="n">Schema</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">Parser</span><span class="p">(</span>
        <span class="n">settings</span><span class="p">,</span> <span class="n">formatting</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">ans</span><span class="p">:</span> <span class="n">_parse_structured_output</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">ans</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="delphyne.final_tool_call_as" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">final_tool_call_as</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">final_tool_call_as</span><span class="p">(</span><span class="n">annot</span><span class="p">:</span> <span class="n"><span title="delphyne.utils.typing.TypeAnnot">TypeAnnot</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.final_tool_call_as[T]">T</span></span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Parser


  
      dataclass
   (delphyne.stdlib.queries.Parser)" href="#delphyne.Parser">Parser</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.final_tool_call_as[T]">T</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Variant of <a class="autorefs autorefs-internal" title="structured_as" href="#delphyne.structured_as"><code>structured_as</code></a>, where the query answer type is presented
to oracles as a tool, which must be called to produce the final
answer. This provides an alternative to "structured", which
additionally allows a chain of thoughts to precede the final answer.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Only dataclass types are supported, since most LLM providers
only support structured output and tool calls for JSON objects.</p>
</div>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">final_tool_call_as</span><span class="p">[</span><span class="n">T</span><span class="p">](</span><span class="n">annot</span><span class="p">:</span> <span class="n">TypeAnnot</span><span class="p">[</span><span class="n">T</span><span class="p">],</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Parser</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Variant of `structured_as`, where the query answer type is presented</span>
<span class="sd">    to oracles as a tool, which must be called to produce the final</span>
<span class="sd">    answer. This provides an alternative to &quot;structured&quot;, which</span>
<span class="sd">    additionally allows a chain of thoughts to precede the final answer.</span>

<span class="sd">    !!! warning</span>
<span class="sd">        Only dataclass types are supported, since most LLM providers</span>
<span class="sd">        only support structured output and tool calls for JSON objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_check_valid_structured_output_type</span><span class="p">(</span><span class="n">annot</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">annot</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span>  <span class="c1"># redundant with previous check</span>
    <span class="n">tool</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">annot</span><span class="p">)</span>
    <span class="n">tool_settings</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">ToolSettings</span><span class="p">(</span><span class="n">tool_types</span><span class="o">=</span><span class="p">[</span><span class="n">tool</span><span class="p">],</span> <span class="n">force_tool_call</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">QuerySettings</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">tool_settings</span><span class="p">)</span>
    <span class="n">formatting</span> <span class="o">=</span> <span class="n">FormattingMetadata</span><span class="p">(</span>
        <span class="n">where</span><span class="o">=</span><span class="s2">&quot;tool_call&quot;</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">md</span><span class="o">.</span><span class="n">Schema</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">annot</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">parse</span><span class="p">(</span><span class="n">ans</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">Answer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ans</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Expected one final tool call, got answer: </span><span class="si">{</span><span class="n">ans</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">_parse_or_raise</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">ans</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Parser</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">formatting</span><span class="p">,</span> <span class="n">parse</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="delphyne.structured" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">structured</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">structured</span> <span class="o">=</span> <span class="n"><a class="autorefs autorefs-internal" title="GenericParser


  
      dataclass
   (delphyne.stdlib.queries.GenericParser)" href="#delphyne.GenericParser">GenericParser</a></span><span class="p">(</span><span class="n"><a class="autorefs autorefs-internal" title="structured_as (delphyne.stdlib.queries.structured_as)" href="#delphyne.structured_as">structured_as</a></span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Generic parser associated with <a class="autorefs autorefs-internal" title="structured_as" href="#delphyne.structured_as"><code>structured_as</code></a>.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="delphyne.final_tool_call" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">final_tool_call</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">final_tool_call</span> <span class="o">=</span> <span class="n"><a class="autorefs autorefs-internal" title="GenericParser


  
      dataclass
   (delphyne.stdlib.queries.GenericParser)" href="#delphyne.GenericParser">GenericParser</a></span><span class="p">(</span><span class="n"><a class="autorefs autorefs-internal" title="final_tool_call_as (delphyne.stdlib.queries.final_tool_call_as)" href="#delphyne.final_tool_call_as">final_tool_call_as</a></span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Generic parser associated with <a class="autorefs autorefs-internal" title="final_tool_call_as" href="#delphyne.final_tool_call_as"><code>final_tool_call_as</code></a>.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="delphyne.last_code_block" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">last_code_block</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">last_code_block</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="Parser


  
      dataclass
   (delphyne.stdlib.queries.Parser)" href="#delphyne.Parser">Parser</a></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">]</span> <span class="o">=</span> <span class="n"><span title="update_formatting">update_formatting</span></span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n"><span title="dataclasses.replace">replace</span></span><span class="p">(</span><span class="n"><span title="f">f</span></span><span class="p">,</span> <span class="n"><span title="dataclasses.replace(where)">where</span></span><span class="o">=</span><span class="s2">&quot;last_code_block&quot;</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Parser that extracts the last code block from a text answer.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="delphyne.get_text" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">get_text</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">get_text</span> <span class="o">=</span> <span class="n"><a class="autorefs autorefs-internal" title="Parser


  
      dataclass
   (delphyne.stdlib.queries.Parser)" href="#delphyne.Parser">Parser</a></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">](</span>
    <span class="n"><a class="autorefs autorefs-internal" title="QuerySettings


  
      dataclass
   (delphyne.core.QuerySettings)" href="../../strategies/queries/#delphyne.QuerySettings">QuerySettings</a></span><span class="p">(),</span>
    <span class="n"><span title="delphyne.stdlib.queries.FormattingMetadata">FormattingMetadata</span></span><span class="p">(</span><span class="n"><span title="delphyne.stdlib.queries.FormattingMetadata(where)">where</span></span><span class="o">=</span><span class="s2">&quot;full_answer&quot;</span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.queries.FormattingMetadata(what)">what</span></span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">),</span>
    <span class="n"><span title="delphyne.stdlib.queries._get_text_answer">_get_text_answer</span></span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Parser that extracts the text content of an answer.</p>
<p>A runtime error is raised if the answer contains structured content.</p>

    </div>

</div><h2 id="prompting-policies">Prompting Policies</h2>


<div class="doc doc-object doc-function">


<h3 id="delphyne.few_shot" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">few_shot</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">few_shot</span><span class="p">(</span>
    <span class="n">query</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="AttachedQuery


  
      dataclass
   (delphyne.core.AttachedQuery)" href="../../strategies/trees/#delphyne.AttachedQuery">AttachedQuery</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.few_shot[T]">T</span></span><span class="p">],</span>
    <span class="n">env</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="PolicyEnv (delphyne.stdlib.environments.PolicyEnv)" href="../environments/#delphyne.PolicyEnv">PolicyEnv</a></span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="LLM (delphyne.stdlib.models.LLM)" href="#delphyne.stdlib.models.LLM">LLM</a></span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">params</span><span class="p">:</span> <span class="n"><span title="dict">dict</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="object">object</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">select_examples</span><span class="p">:</span> <span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.ExampleSelector">ExampleSelector</span></span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
    <span class="n">mode</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="AnswerMode (delphyne.core.AnswerMode)" href="../../strategies/traces/#delphyne.AnswerMode">AnswerMode</a></span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">enable_logging</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">temperature</span><span class="p">:</span> <span class="n"><span title="float">float</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">num_completions</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">max_requests</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">no_wrap_parse_errors</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">iterative_mode</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="StreamGen (delphyne.core.StreamGen)" href="../../policies/streams/#delphyne.StreamGen">StreamGen</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.few_shot[T]">T</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>The standard few-shot prompting policy.</p>
<p>A prompt is formed by concatenating a system prompt, a series of
examples (each of which consists in an instance prompt followed by
an answer), and a final answer prompt. Then, answers are repeatedly
sampled and parsed, until a spending request is declined.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>query</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="AttachedQuery


  
      dataclass
   (delphyne.core.AttachedQuery)" href="../../strategies/trees/#delphyne.AttachedQuery">AttachedQuery</a>[<span title="delphyne.stdlib.queries.few_shot[T]">T</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The query to answer. env: The policy environment.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="LLM (delphyne.stdlib.models.LLM)" href="#delphyne.stdlib.models.LLM">LLM</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The LLM to use for answering the query</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>params</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="object">object</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Prompt hyperparameters, which are passed to prompt
templates as a <code>params</code> dictionary.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>select_examples</code>
            </td>
            <td>
                  <code><span title="collections.abc.Sequence">Sequence</span>[<span title="delphyne.stdlib.queries.ExampleSelector">ExampleSelector</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A series of filters for selecting examples, to
be applied in sequence. By default, no filter is used and so
all available examples are fetched.</p>
              </div>
            </td>
            <td>
                  <code>()</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mode</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="AnswerMode (delphyne.core.AnswerMode)" href="../../strategies/traces/#delphyne.AnswerMode">AnswerMode</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The answer mode to use for parsing the query answer.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>enable_logging</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to log raw oracle responses.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>temperature</code>
            </td>
            <td>
                  <code><span title="float">float</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The temperature parameter to use with the LLM, as a
number from 0 to 2.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_completions</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of completions to request for each
LLM call. Note that most LLM providers only bill input
tokens once, regardless of the number of completions.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_requests</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum number of LLM requests to perform
before the resulting seach stream terminates, if any.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>no_wrap_parse_errors</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If set to <code>True</code>, then parser results of
type <a class="autorefs autorefs-internal" title="WrappedParseError


  
      dataclass
  " href="#delphyne.WrappedParseError"><code>WrappedParseError</code></a> are unwrapped and treated as normal
parse errors.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>iterative_mode</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If set to <code>False</code> (default), answers are
repeatedly and independently sampled. If set to <code>True</code>, a
single chat conversation occurs instead: Whenever a parse
error occurs, a message is issued by rendering the
<code>&lt;QueryName&gt;.repair.jinja</code> template, asking for a new
attempt to be made (the <a class="autorefs autorefs-internal" title="ParseError


  
      dataclass
  " href="../../strategies/queries/#delphyne.ParseError"><code>ParseError</code></a> object is available as
an <code>error</code> template variable). After an answer is
successfully generated and parsed, a message is issued by
rendering the <code>&lt;QueryName&gt;.more.jinja</code> template, asking for
another different answer to be generated.</p>
<p>This special mode allows creating simple conversational
agents with very little effort, by only defining a single
query. However, it does not support tool calls, and the
demonstration language cannot be used to illustrate how
<code>repair</code> and <code>more</code> messages should be handled. For
implementing more advanced conversational agents, see
the standard <a class="autorefs autorefs-internal" title="interact" href="../algorithms/#delphyne.interact"><code>interact</code></a> strategy.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@prompting_policy</span>
<span class="k">def</span><span class="w"> </span><span class="nf">few_shot</span><span class="p">[</span><span class="n">T</span><span class="p">](</span>
    <span class="n">query</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">AttachedQuery</span><span class="p">[</span><span class="n">T</span><span class="p">],</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">PolicyEnv</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">md</span><span class="o">.</span><span class="n">LLM</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">select_examples</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ExampleSelector</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
    <span class="n">mode</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">AnswerMode</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">enable_logging</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">num_completions</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">max_requests</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">no_wrap_parse_errors</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">iterative_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">StreamGen</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The standard few-shot prompting policy.</span>

<span class="sd">    A prompt is formed by concatenating a system prompt, a series of</span>
<span class="sd">    examples (each of which consists in an instance prompt followed by</span>
<span class="sd">    an answer), and a final answer prompt. Then, answers are repeatedly</span>
<span class="sd">    sampled and parsed, until a spending request is declined.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        query: The query to answer. env: The policy environment.</span>
<span class="sd">        model: The LLM to use for answering the query</span>
<span class="sd">        params: Prompt hyperparameters, which are passed to prompt</span>
<span class="sd">            templates as a `params` dictionary.</span>
<span class="sd">        select_examples: A series of filters for selecting examples, to</span>
<span class="sd">            be applied in sequence. By default, no filter is used and so</span>
<span class="sd">            all available examples are fetched.</span>
<span class="sd">        mode: The answer mode to use for parsing the query answer.</span>
<span class="sd">        enable_logging: Whether to log raw oracle responses.</span>
<span class="sd">        temperature: The temperature parameter to use with the LLM, as a</span>
<span class="sd">            number from 0 to 2.</span>
<span class="sd">        num_completions: The number of completions to request for each</span>
<span class="sd">            LLM call. Note that most LLM providers only bill input</span>
<span class="sd">            tokens once, regardless of the number of completions.</span>
<span class="sd">        max_requests: The maximum number of LLM requests to perform</span>
<span class="sd">            before the resulting seach stream terminates, if any.</span>
<span class="sd">        no_wrap_parse_errors: If set to `True`, then parser results of</span>
<span class="sd">            type `WrappedParseError` are unwrapped and treated as normal</span>
<span class="sd">            parse errors.</span>
<span class="sd">        iterative_mode: If set to `False` (default), answers are</span>
<span class="sd">            repeatedly and independently sampled. If set to `True`, a</span>
<span class="sd">            single chat conversation occurs instead: Whenever a parse</span>
<span class="sd">            error occurs, a message is issued by rendering the</span>
<span class="sd">            `&lt;QueryName&gt;.repair.jinja` template, asking for a new</span>
<span class="sd">            attempt to be made (the `ParseError` object is available as</span>
<span class="sd">            an `error` template variable). After an answer is</span>
<span class="sd">            successfully generated and parsed, a message is issued by</span>
<span class="sd">            rendering the `&lt;QueryName&gt;.more.jinja` template, asking for</span>
<span class="sd">            another different answer to be generated.</span>

<span class="sd">            This special mode allows creating simple conversational</span>
<span class="sd">            agents with very little effort, by only defining a single</span>
<span class="sd">            query. However, it does not support tool calls, and the</span>
<span class="sd">            demonstration language cannot be used to illustrate how</span>
<span class="sd">            `repair` and `more` messages should be handled. For</span>
<span class="sd">            implementing more advanced conversational agents, see</span>
<span class="sd">            the standard `interact` strategy.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">iterative_mode</span> <span class="ow">or</span> <span class="n">num_completions</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">max_requests</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">max_requests</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">env</span><span class="o">.</span><span class="n">tracer</span><span class="o">.</span><span class="n">trace_query</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">ref</span><span class="p">)</span>
    <span class="n">examples</span> <span class="o">=</span> <span class="n">fetch_examples</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">examples</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">query</span><span class="p">,</span> <span class="n">select_examples</span><span class="p">)</span>
    <span class="n">mngr</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">templates</span>
    <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">prompt</span> <span class="o">=</span> <span class="n">create_prompt</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">query</span><span class="p">,</span> <span class="n">examples</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">mngr</span><span class="p">)</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">query_settings</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
    <span class="n">options</span><span class="p">:</span> <span class="n">md</span><span class="o">.</span><span class="n">RequestOptions</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">temperature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">options</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temperature</span>
    <span class="n">structured_output</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">structured_output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out_type</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">structured_output</span><span class="o">.</span><span class="n">type</span>
        <span class="n">structured_output</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">Schema</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">out_type</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">tools</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">force_tool_call</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="s2">&quot;tool_choice&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;required&quot;</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="p">[</span><span class="n">md</span><span class="o">.</span><span class="n">Schema</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">tool_types</span><span class="p">]</span>
    <span class="n">num_reqs</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">max_requests</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">num_reqs</span> <span class="o">&lt;</span> <span class="n">max_requests</span><span class="p">:</span>
        <span class="n">num_reqs</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">LLMRequest</span><span class="p">(</span>
            <span class="n">prompt</span><span class="p">,</span>
            <span class="n">num_completions</span><span class="o">=</span><span class="n">num_completions</span><span class="p">,</span>
            <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">structured_output</span><span class="o">=</span><span class="n">structured_output</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">_send_request</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="n">SpendingDeclined</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="n">log_oracle_response</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">resp</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">enable_logging</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s2">&quot;llm_no_output&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">elements</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">Tracked</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">|</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">answers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">Answer</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">resp</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
            <span class="n">answer</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">Answer</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">output</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">))</span>
            <span class="n">answers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>
            <span class="n">element</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">parse_answer</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">no_wrap_parse_errors</span><span class="p">:</span>
                <span class="n">element</span> <span class="o">=</span> <span class="n">_unwrap_parse_error</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
            <span class="n">env</span><span class="o">.</span><span class="n">tracer</span><span class="o">.</span><span class="n">trace_answer</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">ref</span><span class="p">,</span> <span class="n">answer</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span><span class="p">):</span>
                <span class="n">log</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s2">&quot;parse_error&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">element</span><span class="p">},</span> <span class="n">loc</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>
            <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">dp</span><span class="o">.</span><span class="n">Solution</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="c1"># In iterative mode, we want to keep the conversation going</span>
        <span class="k">if</span> <span class="n">iterative_mode</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">answers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="n">element</span> <span class="o">=</span> <span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">repair</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">generate_prompt</span><span class="p">(</span>
                        <span class="n">kind</span><span class="o">=</span><span class="n">REPAIR_PROMPT</span><span class="p">,</span>
                        <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
                        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">params</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">element</span><span class="p">},</span>
                        <span class="n">env</span><span class="o">=</span><span class="n">mngr</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="n">dp</span><span class="o">.</span><span class="n">TemplateFileMissing</span><span class="p">:</span>
                    <span class="n">repair</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;Invalid answer. Please consider the following&quot;</span>
                        <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; feedback and try again:</span><span class="se">\n\n</span><span class="si">{</span><span class="n">element</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="n">new_message</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">UserMessage</span><span class="p">(</span><span class="n">repair</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">gen_new</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">generate_prompt</span><span class="p">(</span>
                        <span class="n">kind</span><span class="o">=</span><span class="n">REQUEST_OTHER_PROMPT</span><span class="p">,</span>
                        <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
                        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">params</span><span class="p">},</span>
                        <span class="n">env</span><span class="o">=</span><span class="n">mngr</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="n">dp</span><span class="o">.</span><span class="n">TemplateFileMissing</span><span class="p">:</span>
                    <span class="n">gen_new</span> <span class="o">=</span> <span class="s2">&quot;Good! Can you generate a different answer now?&quot;</span>
                <span class="n">new_message</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">UserMessage</span><span class="p">(</span><span class="n">gen_new</span><span class="p">)</span>

            <span class="n">prompt</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">prompt</span><span class="p">,</span> <span class="n">md</span><span class="o">.</span><span class="n">AssistantMessage</span><span class="p">(</span><span class="n">answers</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">new_message</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="delphyne.classify" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">classify</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">classify</span><span class="p">(</span>
    <span class="n">query</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="AttachedQuery


  
      dataclass
   (delphyne.core.AttachedQuery)" href="../../strategies/trees/#delphyne.AttachedQuery">AttachedQuery</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.classify[T]">T</span></span><span class="p">],</span>
    <span class="n">env</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="PolicyEnv (delphyne.stdlib.environments.PolicyEnv)" href="../environments/#delphyne.PolicyEnv">PolicyEnv</a></span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="LLM (delphyne.stdlib.models.LLM)" href="#delphyne.stdlib.models.LLM">LLM</a></span><span class="p">,</span>
    <span class="n">params</span><span class="p">:</span> <span class="n"><span title="dict">dict</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="object">object</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">select_examples</span><span class="p">:</span> <span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.ExampleSelector">ExampleSelector</span></span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
    <span class="n">mode</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="AnswerMode (delphyne.core.AnswerMode)" href="../../strategies/traces/#delphyne.AnswerMode">AnswerMode</a></span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">enable_logging</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">top_logprobs</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
    <span class="n">temperature</span><span class="p">:</span> <span class="n"><span title="float">float</span></span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">bias</span><span class="p">:</span> <span class="n"><span title="tuple">tuple</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="float">float</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="StreamGen (delphyne.core.StreamGen)" href="../../policies/streams/#delphyne.StreamGen">StreamGen</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.classify[T]">T</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Execute a classification query, attaching a probability distribution
to the attached answer.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>query</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="AttachedQuery


  
      dataclass
   (delphyne.core.AttachedQuery)" href="../../strategies/trees/#delphyne.AttachedQuery">AttachedQuery</a>[<span title="delphyne.stdlib.queries.classify[T]">T</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The query to answer.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>env</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="PolicyEnv (delphyne.stdlib.environments.PolicyEnv)" href="../environments/#delphyne.PolicyEnv">PolicyEnv</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The global policy environment.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="LLM (delphyne.stdlib.models.LLM)" href="#delphyne.stdlib.models.LLM">LLM</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The LLM to use for answering the query.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>params</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="object">object</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Prompt hyperparameters.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>select_examples</code>
            </td>
            <td>
                  <code><span title="collections.abc.Sequence">Sequence</span>[<span title="delphyne.stdlib.queries.ExampleSelector">ExampleSelector</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Example selector.</p>
              </div>
            </td>
            <td>
                  <code>()</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mode</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="AnswerMode (delphyne.core.AnswerMode)" href="../../strategies/traces/#delphyne.AnswerMode">AnswerMode</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The answer mode to use for parsing the query answer.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>enable_logging</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to log raw oracle responses.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>top_logprobs</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of top logprobs to request from the
LLM, putting an upper bound on the support size of the
classifier's output distributions.</p>
              </div>
            </td>
            <td>
                  <code>20</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>temperature</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A temperature to apply to the classifier's output
distribution (a temperature of 0 means that only top
elements are assigned a nonzero probability).</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bias</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span>[<span title="str">str</span>, <span title="float">float</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>When <code>bias=(e, p)</code> is provided, the final classifier
distribution <code>D</code> is transformed into <code>(1-p)*D + p*dirac(e)</code></p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>
        <p>See <a class="autorefs autorefs-internal" title="few_shot" href="#delphyne.few_shot"><code>few_shot</code></a> for details on some of the arguments above.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@prompting_policy</span>
<span class="k">def</span><span class="w"> </span><span class="nf">classify</span><span class="p">[</span><span class="n">T</span><span class="p">](</span>
    <span class="n">query</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">AttachedQuery</span><span class="p">[</span><span class="n">T</span><span class="p">],</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">PolicyEnv</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">md</span><span class="o">.</span><span class="n">LLM</span><span class="p">,</span>
    <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">select_examples</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ExampleSelector</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
    <span class="n">mode</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">AnswerMode</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">enable_logging</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">top_logprobs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
    <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">bias</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">StreamGen</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Execute a classification query, attaching a probability distribution</span>
<span class="sd">    to the attached answer.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        query: The query to answer.</span>
<span class="sd">        env: The global policy environment.</span>
<span class="sd">        model: The LLM to use for answering the query.</span>
<span class="sd">        params: Prompt hyperparameters.</span>
<span class="sd">        select_examples: Example selector.</span>
<span class="sd">        mode: The answer mode to use for parsing the query answer.</span>
<span class="sd">        enable_logging: Whether to log raw oracle responses.</span>
<span class="sd">        top_logprobs: The number of top logprobs to request from the</span>
<span class="sd">            LLM, putting an upper bound on the support size of the</span>
<span class="sd">            classifier&#39;s output distributions.</span>
<span class="sd">        temperature: A temperature to apply to the classifier&#39;s output</span>
<span class="sd">            distribution (a temperature of 0 means that only top</span>
<span class="sd">            elements are assigned a nonzero probability).</span>
<span class="sd">        bias: When `bias=(e, p)` is provided, the final classifier</span>
<span class="sd">            distribution `D` is transformed into `(1-p)*D + p*dirac(e)`</span>

<span class="sd">    See `few_shot` for details on some of the arguments above.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">env</span><span class="o">.</span><span class="n">tracer</span><span class="o">.</span><span class="n">trace_query</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">ref</span><span class="p">)</span>
    <span class="n">examples</span> <span class="o">=</span> <span class="n">fetch_examples</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">examples</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">query</span><span class="p">,</span> <span class="n">select_examples</span><span class="p">)</span>
    <span class="n">mngr</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">templates</span>
    <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">prompt</span> <span class="o">=</span> <span class="n">create_prompt</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">query</span><span class="p">,</span> <span class="n">examples</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">mngr</span><span class="p">)</span>
    <span class="n">aset</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">finite_answer_set</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">aset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="n">vals</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">aset</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="n">vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
    <span class="n">options</span><span class="p">:</span> <span class="n">md</span><span class="o">.</span><span class="n">RequestOptions</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;logprobs&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;top_logprobs&quot;</span><span class="p">:</span> <span class="n">top_logprobs</span><span class="p">,</span>
        <span class="c1"># TODO: somehow, there seems to be a problem with this, where</span>
        <span class="c1"># one can get an empty answer with &quot;finish_reason: length&quot;:</span>
        <span class="c1"># &quot;max_completion_tokens&quot;: 1,</span>
        <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">LLMRequest</span><span class="p">(</span>
        <span class="n">prompt</span><span class="p">,</span>
        <span class="n">num_completions</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">_send_request</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="n">SpendingDeclined</span><span class="p">):</span>
        <span class="k">return</span>
    <span class="n">log_oracle_response</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">resp</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">enable_logging</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">answer</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">Answer</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">output</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
    <span class="n">env</span><span class="o">.</span><span class="n">tracer</span><span class="o">.</span><span class="n">trace_answer</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">ref</span><span class="p">,</span> <span class="n">answer</span><span class="p">)</span>
    <span class="n">parse</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">_parse_or_log_and_raise</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">element</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>
        <span class="n">lpinfo</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">logprobs</span>
        <span class="k">assert</span> <span class="n">lpinfo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">ldistr</span> <span class="o">=</span> <span class="n">_compute_value_distribution</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">lpinfo</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ldistr</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="n">ldistr</span> <span class="o">=</span> <span class="p">{</span><span class="n">output</span><span class="o">.</span><span class="n">content</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>
        <span class="n">distr</span> <span class="o">=</span> <span class="n">_apply_temperature</span><span class="p">(</span><span class="n">ldistr</span><span class="p">,</span> <span class="n">temperature</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">distr</span> <span class="o">=</span> <span class="n">_apply_bias</span><span class="p">(</span><span class="n">distr</span><span class="p">,</span> <span class="n">bias</span><span class="p">)</span>
        <span class="n">distr_tup</span> <span class="o">=</span> <span class="p">[(</span><span class="n">parse</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">Answer</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">k</span><span class="p">)),</span> <span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">distr</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">ProbInfo</span><span class="p">(</span><span class="n">distr_tup</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">dp</span><span class="o">.</span><span class="n">Solution</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">meta</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span><span class="p">:</span>
        <span class="k">return</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.ProbInfo" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">ProbInfo</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="SearchMeta (delphyne.core.SearchMeta)" href="../../policies/streams/#delphyne.SearchMeta">SearchMeta</a></code></p>


        <p>Distribution probability, guaranteed to be nonempty and to sum to 1.</p>








              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ProbInfo</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">SearchMeta</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Distribution probability, guaranteed to be nonempty and to sum to 1.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">distr</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">Tracked</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="nb">float</span><span class="p">]]</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div><h2 id="models">Models</h2>


<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.models.LLM" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">LLM</span>


</h3>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="abc.ABC">ABC</span></code></p>


        <p>Base class for an LLM.</p>








              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LLM</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for an LLM.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">estimate_budget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">LLMRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Budget</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Estimate the budget that is required to process a request.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Budget</span><span class="p">({</span><span class="n">NUM_REQUESTS</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NUM_COMPLETIONS</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">num_completions</span><span class="p">})</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_model_defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">LLMRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LLMRequest</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rewrite a request to take model-specific defaults into account.</span>

<span class="sd">        A model can carry default values for some of the request fields</span>
<span class="sd">        (e.g. the model name). Thus, requests must be processed through</span>
<span class="sd">        this function right before they are executed or cached.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_send_final_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">LLMRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LLMResponse</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Core method for processing a request.</span>

<span class="sd">        To be overriden by subclasses to implement the core</span>
<span class="sd">        functionality of `send_request`. The latter additionally handles</span>
<span class="sd">        model=specific defaults and caching.</span>

<span class="sd">        This function is allowed to raise exceptions (some</span>
<span class="sd">        provider-specific), including `LLMBusyException` for cases where</span>
<span class="sd">        retrials may be warranted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">stream_request</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">chat</span><span class="p">:</span> <span class="n">Chat</span><span class="p">,</span> <span class="n">options</span><span class="p">:</span> <span class="n">RequestOptions</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stream the text answer to a request.</span>

<span class="sd">        This is currently not used but could be leveraged by the VSCode</span>
<span class="sd">        extension in the future.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">StreamingNotImplemented</span><span class="p">()</span>

    <span class="nd">@final</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">send_request</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">LLMRequest</span><span class="p">,</span> <span class="n">cache</span><span class="p">:</span> <span class="s2">&quot;LLMCache | None&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LLMResponse</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send a request to a model and return the response.</span>

<span class="sd">        This function is allowed to raise exceptions (some</span>
<span class="sd">        provider-specific), including `LLMBusyException` for cases where</span>
<span class="sd">        retrials may be warranted.</span>

<span class="sd">        Attributes:</span>
<span class="sd">            req: The request to send.</span>
<span class="sd">            cache: An optional cache to use for the request.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span> <span class="o">=</span> <span class="n">CachedModel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache</span><span class="p">)</span>
        <span class="n">full_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_model_defaults</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_final_request</span><span class="p">(</span><span class="n">full_req</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="delphyne.stdlib.models.LLM.estimate_budget" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">estimate_budget</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">estimate_budget</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="LLMRequest


  
      dataclass
   (delphyne.stdlib.models.LLMRequest)" href="#delphyne.stdlib.models.LLMRequest">LLMRequest</a></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Budget


  
      dataclass
   (delphyne.core.streams.Budget)" href="../../policies/streams/#delphyne.Budget">Budget</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Estimate the budget that is required to process a request.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">estimate_budget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">LLMRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Budget</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Estimate the budget that is required to process a request.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Budget</span><span class="p">({</span><span class="n">NUM_REQUESTS</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NUM_COMPLETIONS</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">num_completions</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.stdlib.models.LLM.add_model_defaults" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">add_model_defaults</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">add_model_defaults</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="LLMRequest


  
      dataclass
   (delphyne.stdlib.models.LLMRequest)" href="#delphyne.stdlib.models.LLMRequest">LLMRequest</a></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="LLMRequest


  
      dataclass
   (delphyne.stdlib.models.LLMRequest)" href="#delphyne.stdlib.models.LLMRequest">LLMRequest</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Rewrite a request to take model-specific defaults into account.</p>
<p>A model can carry default values for some of the request fields
(e.g. the model name). Thus, requests must be processed through
this function right before they are executed or cached.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add_model_defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">LLMRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LLMRequest</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rewrite a request to take model-specific defaults into account.</span>

<span class="sd">    A model can carry default values for some of the request fields</span>
<span class="sd">    (e.g. the model name). Thus, requests must be processed through</span>
<span class="sd">    this function right before they are executed or cached.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.stdlib.models.LLM.stream_request" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">stream_request</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">stream_request</span><span class="p">(</span><span class="n">chat</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="Chat (delphyne.stdlib.models.Chat)" href="#delphyne.stdlib.models.Chat">Chat</a></span><span class="p">,</span> <span class="n">options</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="RequestOptions (delphyne.stdlib.models.RequestOptions)" href="#delphyne.stdlib.models.RequestOptions">RequestOptions</a></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="collections.abc.AsyncIterable">AsyncIterable</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Stream the text answer to a request.</p>
<p>This is currently not used but could be leveraged by the VSCode
extension in the future.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">stream_request</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">chat</span><span class="p">:</span> <span class="n">Chat</span><span class="p">,</span> <span class="n">options</span><span class="p">:</span> <span class="n">RequestOptions</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stream the text answer to a request.</span>

<span class="sd">    This is currently not used but could be leveraged by the VSCode</span>
<span class="sd">    extension in the future.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="n">StreamingNotImplemented</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.stdlib.models.LLM.send_request" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">send_request</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">send_request</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="LLMRequest


  
      dataclass
   (delphyne.stdlib.models.LLMRequest)" href="#delphyne.stdlib.models.LLMRequest">LLMRequest</a></span><span class="p">,</span> <span class="n">cache</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="LLMCache


  
      dataclass
   (delphyne.stdlib.models.LLMCache)" href="#delphyne.stdlib.models.LLMCache">LLMCache</a></span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="LLMResponse


  
      dataclass
   (delphyne.stdlib.models.LLMResponse)" href="#delphyne.stdlib.models.LLMResponse">LLMResponse</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Send a request to a model and return the response.</p>
<p>This function is allowed to raise exceptions (some
provider-specific), including <a class="autorefs autorefs-internal" title="LLMBusyException


  
      dataclass
  " href="#delphyne.stdlib.models.LLMBusyException"><code>LLMBusyException</code></a> for cases where
retrials may be warranted.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.LLM.send_request.req">req</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The request to send.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.LLM.send_request.cache">cache</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An optional cache to use for the request.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@final</span>
<span class="k">def</span><span class="w"> </span><span class="nf">send_request</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">LLMRequest</span><span class="p">,</span> <span class="n">cache</span><span class="p">:</span> <span class="s2">&quot;LLMCache | None&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LLMResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Send a request to a model and return the response.</span>

<span class="sd">    This function is allowed to raise exceptions (some</span>
<span class="sd">    provider-specific), including `LLMBusyException` for cases where</span>
<span class="sd">    retrials may be warranted.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        req: The request to send.</span>
<span class="sd">        cache: An optional cache to use for the request.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="n">CachedModel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache</span><span class="p">)</span>
    <span class="n">full_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_model_defaults</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_final_request</span><span class="p">(</span><span class="n">full_req</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.models.LLMRequest" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">LLMRequest</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">


        <p>An LLM chat completion request.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.LLMRequest.chat">chat</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Chat (delphyne.stdlib.models.Chat)" href="#delphyne.stdlib.models.Chat">Chat</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The chat history.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.LLMRequest.num_completions">num_completions</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of completions to generate. Note
that most LLM providers only bill input tokens once,
regardless of the number of requested completions.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.LLMRequest.options">options</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="RequestOptions (delphyne.stdlib.models.RequestOptions)" href="#delphyne.stdlib.models.RequestOptions">RequestOptions</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Request options.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.LLMRequest.tools">tools</span></code></td>
            <td>
                  <code><span title="collections.abc.Sequence">Sequence</span>[<a class="autorefs autorefs-internal" title="Schema


  
      dataclass
   (delphyne.stdlib.models.Schema)" href="#delphyne.stdlib.models.Schema">Schema</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Available tools.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.LLMRequest.structured_output">structured_output</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Schema


  
      dataclass
   (delphyne.stdlib.models.Schema)" href="#delphyne.stdlib.models.Schema">Schema</a> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Provide a schema to enable structured output,
or <code>None</code> for disabling it.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">LLMRequest</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An LLM chat completion request.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        chat: The chat history.</span>
<span class="sd">        num_completions: The number of completions to generate. Note</span>
<span class="sd">            that most LLM providers only bill input tokens once,</span>
<span class="sd">            regardless of the number of requested completions.</span>
<span class="sd">        options: Request options.</span>
<span class="sd">        tools: Available tools.</span>
<span class="sd">        structured_output: Provide a schema to enable structured output,</span>
<span class="sd">            or `None` for disabling it.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">chat</span><span class="p">:</span> <span class="n">Chat</span>
    <span class="n">num_completions</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">options</span><span class="p">:</span> <span class="n">RequestOptions</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Schema</span><span class="p">]</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">structured_output</span><span class="p">:</span> <span class="n">Schema</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="c1"># LLMRequest needs to be hashable for `CachedModel` to work.</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">repr</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">chat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_completions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)))</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.models.LLMResponse" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">LLMResponse</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">


        <p>Response to an LLM request.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.LLMResponse.outputs">outputs</span></code></td>
            <td>
                  <code><span title="collections.abc.Sequence">Sequence</span>[<a class="autorefs autorefs-internal" title="LLMOutput


  
      dataclass
   (delphyne.stdlib.models.LLMOutput)" href="#delphyne.stdlib.models.LLMOutput">LLMOutput</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Generated completions.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.LLMResponse.budget">budget</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Budget


  
      dataclass
   (delphyne.core.streams.Budget)" href="../../policies/streams/#delphyne.Budget">Budget</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Budget consumed by the request.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.LLMResponse.log_items">log_items</span></code></td>
            <td>
                  <code><span title="list">list</span>[<a class="autorefs autorefs-internal" title="LLMResponseLogItem


  
      dataclass
   (delphyne.stdlib.models.LLMResponseLogItem)" href="#delphyne.stdlib.models.LLMResponseLogItem">LLMResponseLogItem</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Log items generated while evaluating the request.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.LLMResponse.model_name">model_name</span></code></td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the model used for the request, which is
sometimes more detailed than the model name passed in
<a class="autorefs autorefs-internal" title="RequestOptions" href="#delphyne.stdlib.models.RequestOptions"><code>RequestOptions</code></a> (e.g., <code>gpt-4.1-mini-2025-04-14</code> vs
<code>gpt-4.1-mini</code>).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.LLMResponse.usage_info">usage_info</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional usage info metadata, in a
provider-specific format.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">LLMResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Response to an LLM request.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        outputs: Generated completions.</span>
<span class="sd">        budget: Budget consumed by the request.</span>
<span class="sd">        log_items: Log items generated while evaluating the request.</span>
<span class="sd">        model_name: The name of the model used for the request, which is</span>
<span class="sd">            sometimes more detailed than the model name passed in</span>
<span class="sd">            `RequestOptions` (e.g., `gpt-4.1-mini-2025-04-14` vs</span>
<span class="sd">            `gpt-4.1-mini`).</span>
<span class="sd">        usage_info: Additional usage info metadata, in a</span>
<span class="sd">            provider-specific format.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">outputs</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">LLMOutput</span><span class="p">]</span>
    <span class="n">budget</span><span class="p">:</span> <span class="n">Budget</span>
    <span class="n">log_items</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">LLMResponseLogItem</span><span class="p">]</span>
    <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">usage_info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.models.AbstractTool" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">AbstractTool</span>


</h3>


    <div class="doc doc-contents first">


        <p>Base class for an LLM tool interface.</p>
<p>A new tool interface can be added by defining a dataclass <code>S</code> that
inherits <code>AbstractTool[T]</code>, with <code>T</code> the tool output type. Instances
of <code>S</code> correspond to tool calls, and an actual tool implementation
maps values of type <code>S</code> to values of type <code>T</code>.</p>
<p>A JSON tool specification can be extracted through the
<code>tool_name</code>, <code>tool_description</code> and <code>tool_answer_type</code> class
methods. The <code>render_result</code> method describes how to render the
output of a tool implementation, in a way that can be added back as
a message in a chat history.</p>








              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AbstractTool</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for an LLM tool interface.</span>

<span class="sd">    A new tool interface can be added by defining a dataclass `S` that</span>
<span class="sd">    inherits `AbstractTool[T]`, with `T` the tool output type. Instances</span>
<span class="sd">    of `S` correspond to tool calls, and an actual tool implementation</span>
<span class="sd">    maps values of type `S` to values of type `T`.</span>

<span class="sd">    A JSON tool specification can be extracted through the</span>
<span class="sd">    `tool_name`, `tool_description` and `tool_answer_type` class</span>
<span class="sd">    methods. The `render_result` method describes how to render the</span>
<span class="sd">    output of a tool implementation, in a way that can be added back as</span>
<span class="sd">    a message in a chat history.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">tool_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tool_name_of_class_name</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">tool_description</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">tool_answer_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypeAnnot</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">dpi</span><span class="o">.</span><span class="n">first_parameter_of_base_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">render_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Structured</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">res</span>
        <span class="n">ans_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool_answer_type</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Structured</span><span class="p">(</span><span class="n">pydantic_dump</span><span class="p">(</span><span class="n">ans_type</span><span class="p">,</span> <span class="n">res</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-type_alias">



<h3 id="delphyne.stdlib.models.Chat" class="doc doc-heading">
            <span class="doc doc-object-name doc-type_alias-name">Chat</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nc">Chat</span> <span class="o">=</span> <span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="ChatMessage (delphyne.stdlib.models.ChatMessage)" href="#delphyne.stdlib.models.ChatMessage">ChatMessage</a></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents first">
    </div>

</div>

<div class="doc doc-object doc-type_alias">



<h3 id="delphyne.stdlib.models.ChatMessage" class="doc doc-heading">
            <span class="doc doc-object-name doc-type_alias-name">ChatMessage</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nc">ChatMessage</span> <span class="o">=</span> <span class="n"><a class="autorefs autorefs-internal" title="SystemMessage


  
      dataclass
   (delphyne.stdlib.models.SystemMessage)" href="#delphyne.stdlib.models.SystemMessage">SystemMessage</a></span> <span class="o">|</span> <span class="n"><a class="autorefs autorefs-internal" title="UserMessage


  
      dataclass
   (delphyne.stdlib.models.UserMessage)" href="#delphyne.stdlib.models.UserMessage">UserMessage</a></span> <span class="o">|</span> <span class="n"><a class="autorefs autorefs-internal" title="AssistantMessage


  
      dataclass
   (delphyne.stdlib.models.AssistantMessage)" href="#delphyne.stdlib.models.AssistantMessage">AssistantMessage</a></span> <span class="o">|</span> <span class="n"><a class="autorefs autorefs-internal" title="ToolMessage


  
      dataclass
   (delphyne.stdlib.models.ToolMessage)" href="#delphyne.stdlib.models.ToolMessage">ToolMessage</a></span>
</code></pre></div>

    <div class="doc doc-contents first">
    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.models.SystemMessage" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">SystemMessage</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">









              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SystemMessage</span><span class="p">:</span>
    <span class="n">role</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">]</span>  <span class="c1"># for deserialization</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># to bypass the frozen dataclass check</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;role&quot;</span><span class="p">,</span> <span class="s2">&quot;system&quot;</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.models.UserMessage" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">UserMessage</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">









              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UserMessage</span><span class="p">:</span>
    <span class="n">role</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;role&quot;</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.models.AssistantMessage" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">AssistantMessage</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">









              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">AssistantMessage</span><span class="p">:</span>
    <span class="n">role</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;assistant&quot;</span><span class="p">]</span>
    <span class="n">answer</span><span class="p">:</span> <span class="n">Answer</span>  <span class="c1"># Note: the mode does not really matter for the LLM.</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">answer</span><span class="p">:</span> <span class="n">Answer</span><span class="p">):</span>
        <span class="c1"># to bypass the frozen dataclass check</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;role&quot;</span><span class="p">,</span> <span class="s2">&quot;assistant&quot;</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;answer&quot;</span><span class="p">,</span> <span class="n">answer</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.models.ToolMessage" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">ToolMessage</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">









              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ToolMessage</span><span class="p">:</span>
    <span class="n">role</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;tool&quot;</span><span class="p">]</span>
    <span class="n">call</span><span class="p">:</span> <span class="n">ToolCall</span>
    <span class="n">result</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Structured</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">call</span><span class="p">:</span> <span class="n">ToolCall</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Structured</span><span class="p">):</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;role&quot;</span><span class="p">,</span> <span class="s2">&quot;tool&quot;</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;call&quot;</span><span class="p">,</span> <span class="n">call</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;result&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.models.RequestOptions" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">RequestOptions</span>


</h3>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="typing.TypedDict">TypedDict</span></code></p>


        <p>LLM request options, inspired from the OpenAI chat API.</p>
<p>All values are optional.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.RequestOptions.model">model</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the model to use for the request.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.RequestOptions.reasoning_effort">reasoning_effort</span></code></td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;minimal&#39;, &#39;low&#39;, &#39;medium&#39;, &#39;high&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The reasoning effort to use for the request,
when applicable (e.g., for GPT-5 or o3).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.RequestOptions.tool_choice">tool_choice</span></code></td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;auto&#39;, &#39;none&#39;, &#39;required&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How the model should select which tool (or tools)
to use when generating a response. <code>none</code> means the model
will not call any tool and instead generates a message.
<code>auto</code> means the model can pick between generating a message
or calling one or more tools. <code>required</code> means the model must
call one or more tools.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.RequestOptions.temperature">temperature</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The temperature to use for sampling, as a value
between 0 and 2.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.RequestOptions.max_completion_tokens">max_completion_tokens</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum number of tokens to generate.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.RequestOptions.logprobs">logprobs</span></code></td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to return log probabilities for the generated
tokens.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.RequestOptions.top_logprobs">top_logprobs</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of top log probabilities to return for
each generated token, as an integer between 0 and 20.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">RequestOptions</span><span class="p">(</span><span class="n">typing</span><span class="o">.</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    LLM request options, inspired from the OpenAI chat API.</span>

<span class="sd">    All values are optional.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        model: The name of the model to use for the request.</span>
<span class="sd">        reasoning_effort: The reasoning effort to use for the request,</span>
<span class="sd">            when applicable (e.g., for GPT-5 or o3).</span>
<span class="sd">        tool_choice: How the model should select which tool (or tools)</span>
<span class="sd">            to use when generating a response. `none` means the model</span>
<span class="sd">            will not call any tool and instead generates a message.</span>
<span class="sd">            `auto` means the model can pick between generating a message</span>
<span class="sd">            or calling one or more tools. `required` means the model must</span>
<span class="sd">            call one or more tools.</span>
<span class="sd">        temperature: The temperature to use for sampling, as a value</span>
<span class="sd">            between 0 and 2.</span>
<span class="sd">        max_completion_tokens: The maximum number of tokens to generate.</span>
<span class="sd">        logprobs: Whether to return log probabilities for the generated</span>
<span class="sd">            tokens.</span>
<span class="sd">        top_logprobs: The number of top log probabilities to return for</span>
<span class="sd">            each generated token, as an integer between 0 and 20.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">model</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">reasoning_effort</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;minimal&quot;</span><span class="p">,</span> <span class="s2">&quot;low&quot;</span><span class="p">,</span> <span class="s2">&quot;medium&quot;</span><span class="p">,</span> <span class="s2">&quot;high&quot;</span><span class="p">]</span>
    <span class="n">tool_choice</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;required&quot;</span><span class="p">]</span>
    <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">max_completion_tokens</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">logprobs</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">top_logprobs</span><span class="p">:</span> <span class="nb">int</span>  <span class="c1"># from 0 to 20</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.models.Schema" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">Schema</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">


        <p>The description of a schema for structured output or tool use.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.Schema.name">name</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the tool or structured output type.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.Schema.description">description</span></code></td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional description.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.Schema.schema">schema</span></code></td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The JSON schema of the tool or structured output type,
typically generated using pydantic's <code>json_schema</code> method.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Schema</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The description of a schema for structured output or tool use.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        name: Name of the tool or structured output type.</span>
<span class="sd">        description: Optional description.</span>
<span class="sd">        schema: The JSON schema of the tool or structured output type,</span>
<span class="sd">            typically generated using pydantic&#39;s `json_schema` method.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="n">schema</span><span class="p">:</span> <span class="n">Any</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">make</span><span class="p">(</span><span class="n">annot</span><span class="p">:</span> <span class="n">TypeAnnot</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Schema&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build a schema from a Python type annotation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">annot</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">annot</span><span class="p">,</span> <span class="n">AbstractTool</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">annot</span><span class="o">.</span><span class="n">tool_name</span><span class="p">()</span>
                <span class="n">description</span> <span class="o">=</span> <span class="n">annot</span><span class="o">.</span><span class="n">tool_description</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">tool_name_of_class_name</span><span class="p">(</span><span class="n">annot</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
                <span class="c1"># For a dataclass, if no docstring is provided,</span>
                <span class="c1"># `inspect.getdoc` shows its signature (name, attribute</span>
                <span class="c1"># names and types).</span>
                <span class="n">description</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">annot</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">annot</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">TypeAliasType</span><span class="p">):</span>
            <span class="c1"># TODO: we can do better here.</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">annot</span><span class="p">)</span>
            <span class="n">description</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Any other type annotation, such as a union.</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">annot</span><span class="p">)</span>
            <span class="n">description</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">adapter</span> <span class="o">=</span> <span class="n">pydantic</span><span class="o">.</span><span class="n">TypeAdapter</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">annot</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">Schema</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
            <span class="n">schema</span><span class="o">=</span><span class="n">adapter</span><span class="o">.</span><span class="n">json_schema</span><span class="p">(),</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="delphyne.stdlib.models.Schema.make" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">make</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">make</span><span class="p">(</span><span class="n">annot</span><span class="p">:</span> <span class="n"><span title="delphyne.utils.typing.TypeAnnot">TypeAnnot</span></span><span class="p">[</span><span class="n"><span title="typing.Any">Any</span></span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Schema


  
      dataclass
   (delphyne.stdlib.models.Schema)" href="#delphyne.stdlib.models.Schema">Schema</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Build a schema from a Python type annotation</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">make</span><span class="p">(</span><span class="n">annot</span><span class="p">:</span> <span class="n">TypeAnnot</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Schema&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a schema from a Python type annotation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">annot</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">annot</span><span class="p">,</span> <span class="n">AbstractTool</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">annot</span><span class="o">.</span><span class="n">tool_name</span><span class="p">()</span>
            <span class="n">description</span> <span class="o">=</span> <span class="n">annot</span><span class="o">.</span><span class="n">tool_description</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">tool_name_of_class_name</span><span class="p">(</span><span class="n">annot</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="c1"># For a dataclass, if no docstring is provided,</span>
            <span class="c1"># `inspect.getdoc` shows its signature (name, attribute</span>
            <span class="c1"># names and types).</span>
            <span class="n">description</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">annot</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">annot</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">TypeAliasType</span><span class="p">):</span>
        <span class="c1"># TODO: we can do better here.</span>
        <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">annot</span><span class="p">)</span>
        <span class="n">description</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Any other type annotation, such as a union.</span>
        <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">annot</span><span class="p">)</span>
        <span class="n">description</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">adapter</span> <span class="o">=</span> <span class="n">pydantic</span><span class="o">.</span><span class="n">TypeAdapter</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">annot</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">Schema</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
        <span class="n">schema</span><span class="o">=</span><span class="n">adapter</span><span class="o">.</span><span class="n">json_schema</span><span class="p">(),</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.models.LLMOutput" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">LLMOutput</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">


        <p>A single LLM chat completion.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.LLMOutput.content">content</span></code></td>
            <td>
                  <code><span title="str">str</span> | <a class="autorefs autorefs-internal" title="Structured


  
      dataclass
   (delphyne.core.refs.Structured)" href="../../strategies/traces/#delphyne.Structured">Structured</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The completion content, as a string or as a structured
object (if structured output was requested).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.LLMOutput.tool_calls">tool_calls</span></code></td>
            <td>
                  <code><span title="collections.abc.Sequence">Sequence</span>[<a class="autorefs autorefs-internal" title="ToolCall


  
      dataclass
   (delphyne.core.refs.ToolCall)" href="../../strategies/traces/#delphyne.ToolCall">ToolCall</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A sequence of tool calls made by the model, if any.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.LLMOutput.finish_reason">finish_reason</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="FinishReason (delphyne.stdlib.models.FinishReason)" href="#delphyne.stdlib.models.FinishReason">FinishReason</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The reason why the model stopped generating
content.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.LLMOutput.logprobs">logprobs</span></code></td>
            <td>
                  <code><span title="collections.abc.Sequence">Sequence</span>[<a class="autorefs autorefs-internal" title="TokenInfo


  
      dataclass
   (delphyne.stdlib.models.TokenInfo)" href="#delphyne.stdlib.models.TokenInfo">TokenInfo</a>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional sequence of token log probabilities, if
requested.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.LLMOutput.reasoning_content">reasoning_content</span></code></td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Reasoning chain of thoughts, if provided (the
DeepSeek API returns reasoning tokens, while the OpenAI API
generally does not).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">LLMOutput</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A single LLM chat completion.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        content: The completion content, as a string or as a structured</span>
<span class="sd">            object (if structured output was requested).</span>
<span class="sd">        tool_calls: A sequence of tool calls made by the model, if any.</span>
<span class="sd">        finish_reason: The reason why the model stopped generating</span>
<span class="sd">            content.</span>
<span class="sd">        logprobs: Optional sequence of token log probabilities, if</span>
<span class="sd">            requested.</span>
<span class="sd">        reasoning_content: Reasoning chain of thoughts, if provided (the</span>
<span class="sd">            DeepSeek API returns reasoning tokens, while the OpenAI API</span>
<span class="sd">            generally does not).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Structured</span>
    <span class="n">tool_calls</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ToolCall</span><span class="p">]</span>
    <span class="n">finish_reason</span><span class="p">:</span> <span class="n">FinishReason</span>
    <span class="n">logprobs</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">TokenInfo</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">reasoning_content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-type_alias">



<h3 id="delphyne.stdlib.models.FinishReason" class="doc doc-heading">
            <span class="doc doc-object-name doc-type_alias-name">FinishReason</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nc">FinishReason</span> <span class="o">=</span> <span class="n"><span title="typing.Literal">Literal</span></span><span class="p">[</span><span class="s1">&#39;stop&#39;</span><span class="p">,</span> <span class="s1">&#39;length&#39;</span><span class="p">,</span> <span class="s1">&#39;content_filter&#39;</span><span class="p">,</span> <span class="s1">&#39;tool_calls&#39;</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Reason why the LLM stopped generating content.</p>
    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.models.DummyModel" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">DummyModel</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="LLM (delphyne.stdlib.models.LLM)" href="#delphyne.stdlib.models.LLM">LLM</a></code></p>


        <p>A model that always fails to generate completions.</p>
<p>Used by the <code>answer_query</code> command in particular.</p>








              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DummyModel</span><span class="p">(</span><span class="n">LLM</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A model that always fails to generate completions.</span>

<span class="sd">    Used by the `answer_query` command in particular.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_model_defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">LLMRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LLMRequest</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">req</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_send_final_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">LLMRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LLMResponse</span><span class="p">:</span>
        <span class="n">budget</span> <span class="o">=</span> <span class="n">Budget</span><span class="p">({</span><span class="n">NUM_REQUESTS</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">num_completions</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">LLMResponse</span><span class="p">(</span>
            <span class="n">outputs</span><span class="o">=</span><span class="p">[],</span> <span class="n">budget</span><span class="o">=</span><span class="n">budget</span><span class="p">,</span> <span class="n">log_items</span><span class="o">=</span><span class="p">[],</span> <span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;&lt;dummy&gt;&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.models.WithRetry" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">WithRetry</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="LLM (delphyne.stdlib.models.LLM)" href="#delphyne.stdlib.models.LLM">LLM</a></code></p>


        <p>Retrying with exponential backoff.</p>








              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">WithRetry</span><span class="p">(</span><span class="n">LLM</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrying with exponential backoff.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">model</span><span class="p">:</span> <span class="n">LLM</span>
    <span class="n">num_attempts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">base_delay_seconds</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">exponential_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span>
    <span class="n">delay_noise</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mf">0.1</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_model_defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">LLMRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LLMRequest</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_model_defaults</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">estimate_budget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">LLMRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Budget</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">estimate_budget</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">retry_delays</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">random</span>

        <span class="n">acc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_delay_seconds</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_attempts</span><span class="p">):</span>
            <span class="n">delay</span> <span class="o">=</span> <span class="n">acc</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delay_noise</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">delay</span> <span class="o">+=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delay_noise</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">delay</span>
            <span class="n">acc</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exponential_factor</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_send_final_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">LLMRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LLMResponse</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">retry_delay</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">retry_delays</span><span class="p">(),</span> <span class="kc">None</span><span class="p">]):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">send_request</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">log_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">LLMResponseLogItem</span><span class="p">(</span>
                            <span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="s2">&quot;successful_retry&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;delay&quot;</span><span class="p">:</span> <span class="n">retry_delay</span><span class="p">}</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">return</span> <span class="n">ret</span>
            <span class="k">except</span> <span class="n">LLMBusyException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">retry_delay</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">retry_delay</span><span class="p">)</span>
        <span class="k">assert</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.models.CachedModel" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">CachedModel</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="LLM (delphyne.stdlib.models.LLM)" href="#delphyne.stdlib.models.LLM">LLM</a></code></p>


        <p>Wrap a model to use a given cache.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code>LLM.send_request</code> method has a <code>cache</code> argument that can be
used as a replacement for the <a class="autorefs autorefs-internal" title="CachedModel


  
      dataclass
  " href="#delphyne.stdlib.models.CachedModel"><code>CachedModel</code></a> wrapper. In
addition, all standard prompting policies use a global request
cache (see <a class="autorefs autorefs-internal" title="PolicyEnv" href="../environments/#delphyne.PolicyEnv"><code>PolicyEnv</code></a>) when available. Thus, external users
should rarely need to manually wrap models with <a class="autorefs autorefs-internal" title="CachedModel


  
      dataclass
  " href="#delphyne.stdlib.models.CachedModel"><code>CachedModel</code></a>.</p>
</div>








              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CachedModel</span><span class="p">(</span><span class="n">LLM</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrap a model to use a given cache.</span>

<span class="sd">    !!! note</span>
<span class="sd">        The `LLM.send_request` method has a `cache` argument that can be</span>
<span class="sd">        used as a replacement for the `CachedModel` wrapper. In</span>
<span class="sd">        addition, all standard prompting policies use a global request</span>
<span class="sd">        cache (see `PolicyEnv`) when available. Thus, external users</span>
<span class="sd">        should rarely need to manually wrap models with `CachedModel`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">model</span><span class="p">:</span> <span class="n">LLM</span>
    <span class="n">cache</span><span class="p">:</span> <span class="n">LLMCache</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nd">@cache</span><span class="p">(</span>
            <span class="n">cache_spec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span>
            <span class="n">hash_arg</span><span class="o">=</span><span class="n">_CachedRequest</span><span class="o">.</span><span class="n">stable_repr</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">run_request</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">_CachedRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LLMResponse</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">request</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">send_request</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">run_request</span> <span class="o">=</span> <span class="n">run_request</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_send_final_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">LLMRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LLMResponse</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">num_seen</span><span class="p">[</span><span class="n">req</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">num_seen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">num_seen</span><span class="p">[</span><span class="n">req</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_request</span><span class="p">(</span><span class="n">_CachedRequest</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">num_seen</span><span class="p">))</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">estimate_budget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">LLMRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Budget</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">estimate_budget</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_model_defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">LLMRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LLMRequest</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_model_defaults</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.models.LLMCache" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">LLMCache</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">


        <p>A cache for LLM requests.</p>
<p>More precisely, what are cached are <code>(r, i)</code> pairs where <code>r</code> is a
request and <code>i</code> is the number of times the request has been answered
since the model was instantiated. This way, caching works even when
a policy samples multiple answers for the same request.</p>
<p>Multiple models can share the same cache.</p>








              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">LLMCache</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A cache for LLM requests.</span>

<span class="sd">    More precisely, what are cached are `(r, i)` pairs where `r` is a</span>
<span class="sd">    request and `i` is the number of times the request has been answered</span>
<span class="sd">    since the model was instantiated. This way, caching works even when</span>
<span class="sd">    a policy samples multiple answers for the same request.</span>

<span class="sd">    Multiple models can share the same cache.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">spec</span><span class="p">:</span> <span class="n">CacheSpec</span>
    <span class="n">num_seen</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">LLMRequest</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">CacheSpec</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spec</span> <span class="o">=</span> <span class="n">spec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_seen</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">LLMRequest</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.models.Token" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">Token</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">


        <p>A token produced by an LLM.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.Token.token">token</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>String representation of the token.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.Token.bytes">bytes</span></code></td>
            <td>
                  <code><span title="collections.abc.Sequence">Sequence</span>[<span title="int">int</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional sequence of integers representing the token's
byte encoding.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Token</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A token produced by an LLM.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        token: String representation of the token.</span>
<span class="sd">        bytes: Optional sequence of integers representing the token&#39;s</span>
<span class="sd">            byte encoding.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">token</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">bytes</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.models.TokenInfo" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">TokenInfo</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">


        <p>Logprob information for a single token.</p>








              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TokenInfo</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Logprob information for a single token.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">token</span><span class="p">:</span> <span class="n">Token</span>
    <span class="n">logprob</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">top_logprobs</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Token</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.models.ModelPricing" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">ModelPricing</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">









              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ModelPricing</span><span class="p">:</span>
    <span class="n">dollars_per_input_token</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">dollars_per_cached_input_token</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">dollars_per_output_token</span><span class="p">:</span> <span class="nb">float</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.models.LLMResponseLogItem" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">LLMResponseLogItem</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">









              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">LLMResponseLogItem</span><span class="p">:</span>
    <span class="n">severity</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="s2">&quot;warning&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">]</span>
    <span class="n">message</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.models.LLMBusyException" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">LLMBusyException</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="Exception">Exception</span></code></p>


        <p>This exception should be raised when an LLM call failed due to a
timeout or a rate limit error that warrants a retry. In particular,
it should not be raised for ill-formed requests (those assumptions
should not be caught) or when the LLM gave a bad answer (in which
case budget was consumed and should be counted, while errors are
added into <a class="autorefs autorefs-internal" title="LLMResponse


  
      dataclass
  " href="#delphyne.stdlib.models.LLMResponse"><code>LLMResponse</code></a>).</p>
<p>See <a class="autorefs autorefs-internal" title="WithRetry


  
      dataclass
  " href="#delphyne.stdlib.models.WithRetry"><code>WithRetry</code></a> for adding retrial logic to LLMs.</p>








              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">LLMBusyException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This exception should be raised when an LLM call failed due to a</span>
<span class="sd">    timeout or a rate limit error that warrants a retry. In particular,</span>
<span class="sd">    it should not be raised for ill-formed requests (those assumptions</span>
<span class="sd">    should not be caught) or when the LLM gave a bad answer (in which</span>
<span class="sd">    case budget was consumed and should be counted, while errors are</span>
<span class="sd">    added into `LLMResponse`).</span>

<span class="sd">    See `WithRetry` for adding retrial logic to LLMs.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">exn</span><span class="p">:</span> <span class="ne">Exception</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exn</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-type_alias">



<h3 id="delphyne.stdlib.models.BudgetCategory" class="doc doc-heading">
            <span class="doc doc-object-name doc-type_alias-name">BudgetCategory</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nc">BudgetCategory</span> <span class="o">=</span> <span class="n"><span title="typing.Literal">Literal</span></span><span class="p">[</span>
    <span class="s2">&quot;num_requests&quot;</span><span class="p">,</span>
    <span class="s2">&quot;num_completions&quot;</span><span class="p">,</span>
    <span class="s2">&quot;input_tokens&quot;</span><span class="p">,</span>
    <span class="s2">&quot;cached_input_tokens&quot;</span><span class="p">,</span>
    <span class="s2">&quot;output_tokens&quot;</span><span class="p">,</span>
    <span class="s2">&quot;price&quot;</span><span class="p">,</span>
<span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Standard metrics to measure LLM inference usage.</p>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="delphyne.stdlib.models.budget_entry" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">budget_entry</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">budget_entry</span><span class="p">(</span><span class="n">category</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="BudgetCategory (delphyne.stdlib.models.BudgetCategory)" href="#delphyne.stdlib.models.BudgetCategory">BudgetCategory</a></span><span class="p">,</span> <span class="n">model_class</span><span class="p">:</span> <span class="n"><span title="str">str</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="str">str</span></span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Return a string that can be used as a key in a budget dictionary.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">budget_entry</span><span class="p">(</span>
    <span class="n">category</span><span class="p">:</span> <span class="n">BudgetCategory</span><span class="p">,</span> <span class="n">model_class</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a string that can be used as a key in a budget dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">category</span>
    <span class="k">if</span> <span class="n">model_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">res</span><span class="si">}{</span><span class="n">BUDGET_ENTRY_SEPARATOR</span><span class="si">}{</span><span class="n">model_class</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">res</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="delphyne.stdlib.models.NUM_REQUESTS" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">NUM_REQUESTS</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">NUM_REQUESTS</span> <span class="o">=</span> <span class="s1">&#39;num_requests&#39;</span>
</code></pre></div>

    <div class="doc doc-contents first">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="delphyne.stdlib.models.NUM_COMPLETIONS" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">NUM_COMPLETIONS</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">NUM_COMPLETIONS</span> <span class="o">=</span> <span class="s1">&#39;num_completions&#39;</span>
</code></pre></div>

    <div class="doc doc-contents first">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="delphyne.stdlib.models.NUM_INPUT_TOKENS" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">NUM_INPUT_TOKENS</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">NUM_INPUT_TOKENS</span> <span class="o">=</span> <span class="s1">&#39;input_tokens&#39;</span>
</code></pre></div>

    <div class="doc doc-contents first">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="delphyne.stdlib.models.NUM_CACHED_INPUT_TOKENS" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">NUM_CACHED_INPUT_TOKENS</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">NUM_CACHED_INPUT_TOKENS</span> <span class="o">=</span> <span class="s1">&#39;cached_input_tokens&#39;</span>
</code></pre></div>

    <div class="doc doc-contents first">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="delphyne.stdlib.models.NUM_OUTPUT_TOKENS" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">NUM_OUTPUT_TOKENS</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">NUM_OUTPUT_TOKENS</span> <span class="o">=</span> <span class="s1">&#39;output_tokens&#39;</span>
</code></pre></div>

    <div class="doc doc-contents first">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="delphyne.stdlib.models.DOLLAR_PRICE" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">DOLLAR_PRICE</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">DOLLAR_PRICE</span> <span class="o">=</span> <span class="s1">&#39;price&#39;</span>
</code></pre></div>

    <div class="doc doc-contents first">

    </div>

</div>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["content.code.annotate", "content.code.copy", "content.tabs.link", "navigation.indexes"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.92b07e13.min.js"></script>
      
        <script src="../../../javascript/katex.js"></script>
      
        <script src="https://unpkg.com/katex@0/dist/katex.min.js"></script>
      
        <script src="https://unpkg.com/katex@0/dist/contrib/auto-render.min.js"></script>
      
    
  </body>
</html>