
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../basic/">
      
      
        <link rel="next" href="../streams/">
      
      
      <link rel="icon" href="../../../None">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.18">
    
    
      
        <title>Queries - Delphyne</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="https://unpkg.com/katex@0/dist/katex.min.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#queries-and-prompting-policies" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Delphyne" class="md-header__button md-logo" aria-label="Delphyne" data-md-component="logo">
      
  <img src="../../../assets/logos/white/mini.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Delphyne
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Queries
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Delphyne" class="md-nav__button md-logo" aria-label="Delphyne" data-md-component="logo">
      
  <img src="../../../assets/logos/white/mini.png" alt="logo">

    </a>
    Delphyne
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Manual
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Manual
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../manual/strategies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Strategies and Trees
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../manual/policies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Policies
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../manual/demos/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Demonstrations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../manual/extension/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    VSCode Extension
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../how-to-guides/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    How-To Guides
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" >
        
          
          <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Strategy Language
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            Strategy Language
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../strategies/trees/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Trees and Spaces
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../strategies/strategies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Strategies and Reification
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../strategies/queries/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Queries and Chats
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../strategies/traces/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    References and Traces
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../strategies/misc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Miscellaneous
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Policy Language
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            Policy Language
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../policies/definitions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Definitions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../policies/streams/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Search Streams
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../policies/envs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Policy Environments
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3" >
        
          
          <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Demonstration Language
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            Demonstration Language
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../demos/definitions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Definitions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../demos/interpreter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Interpreter
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4_4" id="__nav_4_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Standard Library
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4_4">
            <span class="md-nav__icon md-icon"></span>
            Standard Library
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../basic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Basic
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Queries
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Queries
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#queries" class="md-nav__link">
    <span class="md-ellipsis">
      Queries
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Queries">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.Query" class="md-nav__link">
    <span class="md-ellipsis">
      Query
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Query">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.Query--customizing-prompts" class="md-nav__link">
    <span class="md-ellipsis">
      Customizing Prompts
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query--answer-modes-and-configurations" class="md-nav__link">
    <span class="md-ellipsis">
      Answer Modes and Configurations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query--allowing-multi-message-exchanges-and-tool-calls" class="md-nav__link">
    <span class="md-ellipsis">
      Allowing Multi-Message Exchanges and Tool Calls
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Allowing Multi-Message Exchanges and Tool Calls">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.Query--answer-prefixes" class="md-nav__link">
    <span class="md-ellipsis">
      Answer Prefixes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query--the-response-type" class="md-nav__link">
    <span class="md-ellipsis">
      The Response Type
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query--manually-overriding-the-parse-method" class="md-nav__link">
    <span class="md-ellipsis">
      Manually Overriding the parse Method
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query.query_config" class="md-nav__link">
    <span class="md-ellipsis">
      query_config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query.parse" class="md-nav__link">
    <span class="md-ellipsis">
      parse
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query.query_settings" class="md-nav__link">
    <span class="md-ellipsis">
      query_settings
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query.query_prefix" class="md-nav__link">
    <span class="md-ellipsis">
      query_prefix
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query.globals" class="md-nav__link">
    <span class="md-ellipsis">
      globals
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query.using" class="md-nav__link">
    <span class="md-ellipsis">
      using
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query.run_toplevel" class="md-nav__link">
    <span class="md-ellipsis">
      run_toplevel
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.QueryConfig" class="md-nav__link">
    <span class="md-ellipsis">
      QueryConfig
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.ParserSpec" class="md-nav__link">
    <span class="md-ellipsis">
      ParserSpec
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries._StandardParserName" class="md-nav__link">
    <span class="md-ellipsis">
      _StandardParserName
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.GenericTextParser" class="md-nav__link">
    <span class="md-ellipsis">
      GenericTextParser
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.TextParser" class="md-nav__link">
    <span class="md-ellipsis">
      TextParser
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.ParserSpecDict" class="md-nav__link">
    <span class="md-ellipsis">
      ParserSpecDict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.QueryConfigDict" class="md-nav__link">
    <span class="md-ellipsis">
      QueryConfigDict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.Response" class="md-nav__link">
    <span class="md-ellipsis">
      Response
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.FinalAnswer" class="md-nav__link">
    <span class="md-ellipsis">
      FinalAnswer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.ToolRequests" class="md-nav__link">
    <span class="md-ellipsis">
      ToolRequests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.WrappedParseError" class="md-nav__link">
    <span class="md-ellipsis">
      WrappedParseError
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#standard-parsers" class="md-nav__link">
    <span class="md-ellipsis">
      Standard Parsers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Standard Parsers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.raw_yaml" class="md-nav__link">
    <span class="md-ellipsis">
      raw_yaml
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.yaml_from_last_block" class="md-nav__link">
    <span class="md-ellipsis">
      yaml_from_last_block
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.raw_string" class="md-nav__link">
    <span class="md-ellipsis">
      raw_string
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.trimmed_raw_string" class="md-nav__link">
    <span class="md-ellipsis">
      trimmed_raw_string
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.first_word" class="md-nav__link">
    <span class="md-ellipsis">
      first_word
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.string_from_last_block" class="md-nav__link">
    <span class="md-ellipsis">
      string_from_last_block
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.trimmed_string_from_last_block" class="md-nav__link">
    <span class="md-ellipsis">
      trimmed_string_from_last_block
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prompting-policies" class="md-nav__link">
    <span class="md-ellipsis">
      Prompting Policies
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Prompting Policies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.few_shot" class="md-nav__link">
    <span class="md-ellipsis">
      few_shot
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.classify" class="md-nav__link">
    <span class="md-ellipsis">
      classify
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.ProbInfo" class="md-nav__link">
    <span class="md-ellipsis">
      ProbInfo
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#models" class="md-nav__link">
    <span class="md-ellipsis">
      Models
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Models">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLM" class="md-nav__link">
    <span class="md-ellipsis">
      LLM
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LLM">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLM.estimate_budget" class="md-nav__link">
    <span class="md-ellipsis">
      estimate_budget
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLM.add_model_defaults" class="md-nav__link">
    <span class="md-ellipsis">
      add_model_defaults
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLM.stream_request" class="md-nav__link">
    <span class="md-ellipsis">
      stream_request
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLM.send_request" class="md-nav__link">
    <span class="md-ellipsis">
      send_request
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLMRequest" class="md-nav__link">
    <span class="md-ellipsis">
      LLMRequest
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLMResponse" class="md-nav__link">
    <span class="md-ellipsis">
      LLMResponse
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.AbstractTool" class="md-nav__link">
    <span class="md-ellipsis">
      AbstractTool
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.Chat" class="md-nav__link">
    <span class="md-ellipsis">
      Chat
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.ChatMessage" class="md-nav__link">
    <span class="md-ellipsis">
      ChatMessage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.SystemMessage" class="md-nav__link">
    <span class="md-ellipsis">
      SystemMessage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.UserMessage" class="md-nav__link">
    <span class="md-ellipsis">
      UserMessage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.AssistantMessage" class="md-nav__link">
    <span class="md-ellipsis">
      AssistantMessage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.ToolMessage" class="md-nav__link">
    <span class="md-ellipsis">
      ToolMessage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.RequestOptions" class="md-nav__link">
    <span class="md-ellipsis">
      RequestOptions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.Schema" class="md-nav__link">
    <span class="md-ellipsis">
      Schema
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Schema">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.Schema.make" class="md-nav__link">
    <span class="md-ellipsis">
      make
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLMOutput" class="md-nav__link">
    <span class="md-ellipsis">
      LLMOutput
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.FinishReason" class="md-nav__link">
    <span class="md-ellipsis">
      FinishReason
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.DummyModel" class="md-nav__link">
    <span class="md-ellipsis">
      DummyModel
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.WithRetry" class="md-nav__link">
    <span class="md-ellipsis">
      WithRetry
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.CachedModel" class="md-nav__link">
    <span class="md-ellipsis">
      CachedModel
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLMCache" class="md-nav__link">
    <span class="md-ellipsis">
      LLMCache
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.Token" class="md-nav__link">
    <span class="md-ellipsis">
      Token
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.TokenInfo" class="md-nav__link">
    <span class="md-ellipsis">
      TokenInfo
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.ModelPricing" class="md-nav__link">
    <span class="md-ellipsis">
      ModelPricing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLMResponseLogItem" class="md-nav__link">
    <span class="md-ellipsis">
      LLMResponseLogItem
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLMBusyException" class="md-nav__link">
    <span class="md-ellipsis">
      LLMBusyException
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.BudgetCategory" class="md-nav__link">
    <span class="md-ellipsis">
      BudgetCategory
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.budget_entry" class="md-nav__link">
    <span class="md-ellipsis">
      budget_entry
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.NUM_REQUESTS" class="md-nav__link">
    <span class="md-ellipsis">
      NUM_REQUESTS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.NUM_COMPLETIONS" class="md-nav__link">
    <span class="md-ellipsis">
      NUM_COMPLETIONS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.NUM_INPUT_TOKENS" class="md-nav__link">
    <span class="md-ellipsis">
      NUM_INPUT_TOKENS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.NUM_CACHED_INPUT_TOKENS" class="md-nav__link">
    <span class="md-ellipsis">
      NUM_CACHED_INPUT_TOKENS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.NUM_OUTPUT_TOKENS" class="md-nav__link">
    <span class="md-ellipsis">
      NUM_OUTPUT_TOKENS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.DOLLAR_PRICE" class="md-nav__link">
    <span class="md-ellipsis">
      DOLLAR_PRICE
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../streams/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Streams
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../effects/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Effects
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../algorithms/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Algorithms
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../commands/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Commands
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../experiments/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Experiments
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Delphyne CLI
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#queries" class="md-nav__link">
    <span class="md-ellipsis">
      Queries
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Queries">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.Query" class="md-nav__link">
    <span class="md-ellipsis">
      Query
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Query">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.Query--customizing-prompts" class="md-nav__link">
    <span class="md-ellipsis">
      Customizing Prompts
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query--answer-modes-and-configurations" class="md-nav__link">
    <span class="md-ellipsis">
      Answer Modes and Configurations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query--allowing-multi-message-exchanges-and-tool-calls" class="md-nav__link">
    <span class="md-ellipsis">
      Allowing Multi-Message Exchanges and Tool Calls
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Allowing Multi-Message Exchanges and Tool Calls">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.Query--answer-prefixes" class="md-nav__link">
    <span class="md-ellipsis">
      Answer Prefixes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query--the-response-type" class="md-nav__link">
    <span class="md-ellipsis">
      The Response Type
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query--manually-overriding-the-parse-method" class="md-nav__link">
    <span class="md-ellipsis">
      Manually Overriding the parse Method
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query.query_config" class="md-nav__link">
    <span class="md-ellipsis">
      query_config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query.parse" class="md-nav__link">
    <span class="md-ellipsis">
      parse
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query.query_settings" class="md-nav__link">
    <span class="md-ellipsis">
      query_settings
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query.query_prefix" class="md-nav__link">
    <span class="md-ellipsis">
      query_prefix
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query.globals" class="md-nav__link">
    <span class="md-ellipsis">
      globals
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query.using" class="md-nav__link">
    <span class="md-ellipsis">
      using
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.Query.run_toplevel" class="md-nav__link">
    <span class="md-ellipsis">
      run_toplevel
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.QueryConfig" class="md-nav__link">
    <span class="md-ellipsis">
      QueryConfig
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.ParserSpec" class="md-nav__link">
    <span class="md-ellipsis">
      ParserSpec
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries._StandardParserName" class="md-nav__link">
    <span class="md-ellipsis">
      _StandardParserName
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.GenericTextParser" class="md-nav__link">
    <span class="md-ellipsis">
      GenericTextParser
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.TextParser" class="md-nav__link">
    <span class="md-ellipsis">
      TextParser
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.ParserSpecDict" class="md-nav__link">
    <span class="md-ellipsis">
      ParserSpecDict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.QueryConfigDict" class="md-nav__link">
    <span class="md-ellipsis">
      QueryConfigDict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.Response" class="md-nav__link">
    <span class="md-ellipsis">
      Response
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.FinalAnswer" class="md-nav__link">
    <span class="md-ellipsis">
      FinalAnswer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.ToolRequests" class="md-nav__link">
    <span class="md-ellipsis">
      ToolRequests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.queries.WrappedParseError" class="md-nav__link">
    <span class="md-ellipsis">
      WrappedParseError
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#standard-parsers" class="md-nav__link">
    <span class="md-ellipsis">
      Standard Parsers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Standard Parsers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.raw_yaml" class="md-nav__link">
    <span class="md-ellipsis">
      raw_yaml
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.yaml_from_last_block" class="md-nav__link">
    <span class="md-ellipsis">
      yaml_from_last_block
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.raw_string" class="md-nav__link">
    <span class="md-ellipsis">
      raw_string
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.trimmed_raw_string" class="md-nav__link">
    <span class="md-ellipsis">
      trimmed_raw_string
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.first_word" class="md-nav__link">
    <span class="md-ellipsis">
      first_word
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.string_from_last_block" class="md-nav__link">
    <span class="md-ellipsis">
      string_from_last_block
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.trimmed_string_from_last_block" class="md-nav__link">
    <span class="md-ellipsis">
      trimmed_string_from_last_block
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prompting-policies" class="md-nav__link">
    <span class="md-ellipsis">
      Prompting Policies
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Prompting Policies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.few_shot" class="md-nav__link">
    <span class="md-ellipsis">
      few_shot
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.classify" class="md-nav__link">
    <span class="md-ellipsis">
      classify
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.ProbInfo" class="md-nav__link">
    <span class="md-ellipsis">
      ProbInfo
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#models" class="md-nav__link">
    <span class="md-ellipsis">
      Models
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Models">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLM" class="md-nav__link">
    <span class="md-ellipsis">
      LLM
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LLM">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLM.estimate_budget" class="md-nav__link">
    <span class="md-ellipsis">
      estimate_budget
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLM.add_model_defaults" class="md-nav__link">
    <span class="md-ellipsis">
      add_model_defaults
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLM.stream_request" class="md-nav__link">
    <span class="md-ellipsis">
      stream_request
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLM.send_request" class="md-nav__link">
    <span class="md-ellipsis">
      send_request
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLMRequest" class="md-nav__link">
    <span class="md-ellipsis">
      LLMRequest
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLMResponse" class="md-nav__link">
    <span class="md-ellipsis">
      LLMResponse
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.AbstractTool" class="md-nav__link">
    <span class="md-ellipsis">
      AbstractTool
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.Chat" class="md-nav__link">
    <span class="md-ellipsis">
      Chat
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.ChatMessage" class="md-nav__link">
    <span class="md-ellipsis">
      ChatMessage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.SystemMessage" class="md-nav__link">
    <span class="md-ellipsis">
      SystemMessage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.UserMessage" class="md-nav__link">
    <span class="md-ellipsis">
      UserMessage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.AssistantMessage" class="md-nav__link">
    <span class="md-ellipsis">
      AssistantMessage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.ToolMessage" class="md-nav__link">
    <span class="md-ellipsis">
      ToolMessage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.RequestOptions" class="md-nav__link">
    <span class="md-ellipsis">
      RequestOptions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.Schema" class="md-nav__link">
    <span class="md-ellipsis">
      Schema
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Schema">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.Schema.make" class="md-nav__link">
    <span class="md-ellipsis">
      make
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLMOutput" class="md-nav__link">
    <span class="md-ellipsis">
      LLMOutput
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.FinishReason" class="md-nav__link">
    <span class="md-ellipsis">
      FinishReason
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.DummyModel" class="md-nav__link">
    <span class="md-ellipsis">
      DummyModel
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.WithRetry" class="md-nav__link">
    <span class="md-ellipsis">
      WithRetry
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.CachedModel" class="md-nav__link">
    <span class="md-ellipsis">
      CachedModel
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLMCache" class="md-nav__link">
    <span class="md-ellipsis">
      LLMCache
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.Token" class="md-nav__link">
    <span class="md-ellipsis">
      Token
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.TokenInfo" class="md-nav__link">
    <span class="md-ellipsis">
      TokenInfo
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.ModelPricing" class="md-nav__link">
    <span class="md-ellipsis">
      ModelPricing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLMResponseLogItem" class="md-nav__link">
    <span class="md-ellipsis">
      LLMResponseLogItem
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.LLMBusyException" class="md-nav__link">
    <span class="md-ellipsis">
      LLMBusyException
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.BudgetCategory" class="md-nav__link">
    <span class="md-ellipsis">
      BudgetCategory
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.budget_entry" class="md-nav__link">
    <span class="md-ellipsis">
      budget_entry
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.NUM_REQUESTS" class="md-nav__link">
    <span class="md-ellipsis">
      NUM_REQUESTS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.NUM_COMPLETIONS" class="md-nav__link">
    <span class="md-ellipsis">
      NUM_COMPLETIONS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.NUM_INPUT_TOKENS" class="md-nav__link">
    <span class="md-ellipsis">
      NUM_INPUT_TOKENS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.NUM_CACHED_INPUT_TOKENS" class="md-nav__link">
    <span class="md-ellipsis">
      NUM_CACHED_INPUT_TOKENS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.NUM_OUTPUT_TOKENS" class="md-nav__link">
    <span class="md-ellipsis">
      NUM_OUTPUT_TOKENS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.models.DOLLAR_PRICE" class="md-nav__link">
    <span class="md-ellipsis">
      DOLLAR_PRICE
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="queries-and-prompting-policies">Queries and Prompting Policies</h1>
<h2 id="queries">Queries</h2>


<div class="doc doc-object doc-class">



<h3 id="delphyne.Query" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">Query</span>


</h3>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="AbstractQuery (delphyne.core.AbstractQuery)" href="../../strategies/queries/#delphyne.AbstractQuery">AbstractQuery</a>[<span title="delphyne.stdlib.queries.Query[T]">Query[T]</span>]</code></p>


        <p>Base class for queries.</p>
<p>This class adds standard convenience features on top of
<a class="autorefs autorefs-internal" title="AbstractQuery" href="../../strategies/queries/#delphyne.AbstractQuery"><code>AbstractQuery</code></a>, using reflection to allow queries to be defined
concisely. Here is a simple example of a query type definition:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@dataclass</span> <span class="k">class</span><span class="w"> </span><span class="nc">MakeSum</span><span class="p">(</span><span class="n">Query</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]]):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Given a list of allowed numbers and a target number, you</span>
<span class="sd">    must find a sub-list whose elements sum up to the target.</span>
<span class="sd">    Just answer with a list of numbers as a JSON object and</span>
<span class="sd">    nothing else.&#39;&#39;&#39;</span>

    <span class="n">allowed</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="n">target</span><span class="p">:</span> <span class="nb">int</span>
</code></pre></div>
<p>In general, a query type is a dataclass that inherits <code>Query[T]</code>,
where <code>T</code> is the query's answer type. In the example above, no
parser is specified and so oracles are requested to provide
structured answers as JSON objects, which are automatically parsed
into the answer type (<code>list[int]</code>) using pydantic. Assuming that no
Jinja prompt file is provided, the docstring is used as a system
prompt and instance prompts are generated by simply serializing
<code>MakeSum</code> instances into YAML.</p>
<h5 id="delphyne.Query--customizing-prompts">Customizing Prompts</h5>
<p>System and instance prompts can be specified via Jinja templates.
The templates manager (<a class="autorefs autorefs-internal" title="TemplatesManager" href="../../policies/envs/#delphyne.TemplatesManager"><code>TemplatesManager</code></a>) looks for templates named
"<QueryName>.<instance|system>.jinja". Templates can also be
provided by defining the <code>__system_prompt__</code> and/or <code>__instance_prompt__</code>
class attributes. If none of these are provided, the query's
docstring is used as a system prompt and <code>DEFAULT_INSTANCE_PROMPT</code>
is used as an instance prompt template.</p>
<p>The following arguments are usually made available to templates
(although specific prompting policies can add more):</p>
<ul>
<li><code>query</code>: the query instance.</li>
<li><code>mode</code>: the requested answer mode.</li>
<li><code>params</code>: the query hyperparameters (e.g., as passed to <a class="autorefs autorefs-internal" title="few_shot" href="#delphyne.few_shot"><code>few_shot</code></a>)</li>
</ul>
<h5 id="delphyne.Query--answer-modes-and-configurations">Answer Modes and Configurations</h5>
<p>A query can define several answer modes (<a class="autorefs autorefs-internal" title="AnswerMode" href="../../strategies/traces/#delphyne.AnswerMode"><code>AnswerMode</code></a>), each of
which can be associated with a different parser and set of settings.
By default, the only answer mode is <code>None</code>. More answer modes can be
defined by setting class variable <code>__modes__</code>.</p>
<p>The <code>query_config</code> method maps modes to configurations (i.e., a set
of settings, including a parser specification). Its default behavior
works by inspecting the <code>__parser__</code> and <code>__config__</code> class
attributes and does not typically require overriding.</p>
<h5 id="delphyne.Query--allowing-multi-message-exchanges-and-tool-calls">Allowing Multi-Message Exchanges and Tool Calls</h5>
<p>A common pattern for interacting with LLMs is to have multi-message
exchanges where the full conversation history is resent repeatedly.
LLMs are also often allowed to request tool call. This interaction
pattern is implemented in the <a class="autorefs autorefs-internal" title="interact" href="../algorithms/#delphyne.interact"><code>interact</code></a> standard strategy. It is
enabled by several features on the <a class="autorefs autorefs-internal" title="Query" href="#delphyne.Query"><code>Query</code></a> side.</p>
<h6 id="delphyne.Query--answer-prefixes">Answer Prefixes</h6>
<p>If a query type has a prefix attribute with type <a class="autorefs autorefs-internal" title="AnswerPrefix" href="../../strategies/queries/#delphyne.AnswerPrefix"><code>AnswerPrefix</code></a>,
this attribute can be used to provide a chat history, to be added to
the query's prompt.</p>
<h6 id="delphyne.Query--the-response-type">The <a class="autorefs autorefs-internal" title="Response


  
      dataclass
  " href="#delphyne.stdlib.queries.Response"><code>Response</code></a> Type</h6>
<p>If the query answer type is <a class="autorefs autorefs-internal" title="Response


  
      dataclass
  " href="#delphyne.stdlib.queries.Response"><code>Response</code></a>, the query does not only
return a parsed answer, but also the LLM raw answer (which can be
appended to a chat history), and possibly a sequence of tool calls.</p>
<h5 id="delphyne.Query--manually-overriding-the-parse-method">Manually Overriding the <code>parse</code> Method</h5>
<p>For advanced use cases, it is possible to directly override the
<code>parse</code> method that turns an answer into an object of type <code>T</code>. When
this is done, the <code>__config__</code> and <code>__parser__</code> class attributes
must not be set. Also, the <code>query_settings</code> method always returns
the default settings instead of relying on <code>query_config</code> and must
be overriden if another behavior is desired.</p>







              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Query</span><span class="p">[</span><span class="n">T</span><span class="p">](</span><span class="n">dp</span><span class="o">.</span><span class="n">AbstractQuery</span><span class="p">[</span><span class="n">T</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for queries.</span>

<span class="sd">    This class adds standard convenience features on top of</span>
<span class="sd">    `AbstractQuery`, using reflection to allow queries to be defined</span>
<span class="sd">    concisely. Here is a simple example of a query type definition:</span>

<span class="sd">    ```python</span>
<span class="sd">    @dataclass class MakeSum(Query[list[int]]):</span>
<span class="sd">        &#39;&#39;&#39;Given a list of allowed numbers and a target number, you</span>
<span class="sd">        must find a sub-list whose elements sum up to the target.</span>
<span class="sd">        Just answer with a list of numbers as a JSON object and</span>
<span class="sd">        nothing else.&#39;&#39;&#39;</span>

<span class="sd">        allowed: list[int] target: int</span>
<span class="sd">    ```</span>

<span class="sd">    In general, a query type is a dataclass that inherits `Query[T]`,</span>
<span class="sd">    where `T` is the query&#39;s answer type. In the example above, no</span>
<span class="sd">    parser is specified and so oracles are requested to provide</span>
<span class="sd">    structured answers as JSON objects, which are automatically parsed</span>
<span class="sd">    into the answer type (`list[int]`) using pydantic. Assuming that no</span>
<span class="sd">    Jinja prompt file is provided, the docstring is used as a system</span>
<span class="sd">    prompt and instance prompts are generated by simply serializing</span>
<span class="sd">    `MakeSum` instances into YAML.</span>

<span class="sd">    ## Customizing Prompts</span>

<span class="sd">    System and instance prompts can be specified via Jinja templates.</span>
<span class="sd">    The templates manager (`TemplatesManager`) looks for templates named</span>
<span class="sd">    &quot;&lt;QueryName&gt;.&lt;instance|system&gt;.jinja&quot;. Templates can also be</span>
<span class="sd">    provided by defining the `__system_prompt__` and/or `__instance_prompt__`</span>
<span class="sd">    class attributes. If none of these are provided, the query&#39;s</span>
<span class="sd">    docstring is used as a system prompt and `DEFAULT_INSTANCE_PROMPT`</span>
<span class="sd">    is used as an instance prompt template.</span>

<span class="sd">    The following arguments are usually made available to templates</span>
<span class="sd">    (although specific prompting policies can add more):</span>

<span class="sd">    - `query`: the query instance.</span>
<span class="sd">    - `mode`: the requested answer mode.</span>
<span class="sd">    - `params`: the query hyperparameters (e.g., as passed to `few_shot`)</span>

<span class="sd">    ## Answer Modes and Configurations</span>

<span class="sd">    A query can define several answer modes (`AnswerMode`), each of</span>
<span class="sd">    which can be associated with a different parser and set of settings.</span>
<span class="sd">    By default, the only answer mode is `None`. More answer modes can be</span>
<span class="sd">    defined by setting class variable `__modes__`.</span>

<span class="sd">    The `query_config` method maps modes to configurations (i.e., a set</span>
<span class="sd">    of settings, including a parser specification). Its default behavior</span>
<span class="sd">    works by inspecting the `__parser__` and `__config__` class</span>
<span class="sd">    attributes and does not typically require overriding.</span>

<span class="sd">    ## Allowing Multi-Message Exchanges and Tool Calls</span>

<span class="sd">    A common pattern for interacting with LLMs is to have multi-message</span>
<span class="sd">    exchanges where the full conversation history is resent repeatedly.</span>
<span class="sd">    LLMs are also often allowed to request tool call. This interaction</span>
<span class="sd">    pattern is implemented in the `interact` standard strategy. It is</span>
<span class="sd">    enabled by several features on the `Query` side.</span>

<span class="sd">    ### Answer Prefixes</span>

<span class="sd">    If a query type has a prefix attribute with type `AnswerPrefix`,</span>
<span class="sd">    this attribute can be used to provide a chat history, to be added to</span>
<span class="sd">    the query&#39;s prompt.</span>

<span class="sd">    ### The `Response` Type</span>

<span class="sd">    If the query answer type is `Response`, the query does not only</span>
<span class="sd">    return a parsed answer, but also the LLM raw answer (which can be</span>
<span class="sd">    appended to a chat history), and possibly a sequence of tool calls.</span>

<span class="sd">    ## Manually Overriding the `parse` Method</span>

<span class="sd">    For advanced use cases, it is possible to directly override the</span>
<span class="sd">    `parse` method that turns an answer into an object of type `T`. When</span>
<span class="sd">    this is done, the `__config__` and `__parser__` class attributes</span>
<span class="sd">    must not be set. Also, the `query_settings` method always returns</span>
<span class="sd">    the default settings instead of relying on `query_config` and must</span>
<span class="sd">    be overriden if another behavior is desired.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__modes__</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">AnswerMode</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">__parser__</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">ParserSpec</span> <span class="o">|</span> <span class="n">ParserSpecDict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">__config__</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">QueryConfig</span> <span class="o">|</span> <span class="n">QueryConfigDict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">### Inspection methods</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">query_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">AnswerMode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QueryConfig</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Map modes to configurations.</span>

<span class="sd">        This method inspects the `__config__` and `__parser__` class</span>
<span class="sd">        attributes (none or either can be set but not both).</span>

<span class="sd">        - If no attribute is set, the default configuration is used for</span>
<span class="sd">              all modes, which uses the `&quot;structured&quot;` parser.</span>
<span class="sd">        - If `__config__` is set to a `QueryConfig`, this configuration</span>
<span class="sd">              is used for all modes.</span>
<span class="sd">        - Alternatively, `__config__` can be set to a dictionary mapping</span>
<span class="sd">              modes to configurations.</span>
<span class="sd">        - If `__parser__` is set to a parser specification, the default</span>
<span class="sd">              configuration is used for all modes, *except* that the</span>
<span class="sd">              provided parser is used instead of the default one.</span>
<span class="sd">        - Alternatively, `__parser__` can also be set to a dictionary.</span>

<span class="sd">        In the special case where the `parse` method is overriden and</span>
<span class="sd">        only in this case, return `None` after ensuring that</span>
<span class="sd">        `__config__` and `__parser__` are not set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">parse_overriden</span> <span class="o">=</span> <span class="n">dpi</span><span class="o">.</span><span class="n">is_method_overridden</span><span class="p">(</span><span class="n">Query</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;parse&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parse_overriden</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__config__</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">assert</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__parser__</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__config__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parser__</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="p">(</span>
                <span class="s2">&quot;Cannot have both __config__ and __parser__ attributes.&quot;</span>
            <span class="p">)</span>
            <span class="n">config_attr</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__config__</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config_attr</span><span class="p">,</span> <span class="n">QueryConfig</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">config_attr</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config_attr</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">config_attr</span><span class="p">)[</span><span class="n">mode</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__parser__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parser_attr</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__parser__</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parser_attr</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
                <span class="n">parser</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">parser_attr</span><span class="p">)[</span><span class="n">mode</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parser</span> <span class="o">=</span> <span class="n">parser_attr</span>
            <span class="n">_check_valid_parser_spec</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">QueryConfig</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">QueryConfig</span><span class="p">(</span><span class="s2">&quot;structured&quot;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_decomposed_answer_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_DecomposedAnswerType</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_DecomposedAnswerType</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_answer_type</span><span class="p">())</span>

    <span class="c1">### Parsing Answers</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">parse_answer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">answer</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">Answer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span> <span class="o">|</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">answer</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_modes</span><span class="p">(),</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unknown mode: </span><span class="si">{</span><span class="n">answer</span><span class="o">.</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">e</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">answer</span><span class="p">:</span> <span class="n">Answer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A more convenient method to override instead of `parse_answer`.</span>

<span class="sd">        Raises `ParseError`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Decompose the specified answer type</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_config</span><span class="p">(</span><span class="n">answer</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">parser</span>
        <span class="n">ans_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decomposed_answer_type</span><span class="p">()</span>

        <span class="c1"># Compute base parsing function `parser`</span>
        <span class="n">parser</span><span class="p">:</span> <span class="n">_ParsingFunction</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="s2">&quot;structured&quot;</span><span class="p">:</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">_from_structured</span><span class="p">(</span><span class="n">ans_type</span><span class="o">.</span><span class="n">to_parse</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">attr</span> <span class="o">==</span> <span class="s2">&quot;final_tool_call&quot;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ans_type</span><span class="o">.</span><span class="n">to_parse</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">_from_final_tool_call</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="nb">type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">ans_type</span><span class="o">.</span><span class="n">to_parse</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">callable</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">attr</span><span class="p">)</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="n">nargs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">nargs</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">nargs</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="n">nargs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">parser</span> <span class="o">=</span> <span class="n">_from_text_parser</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parser</span> <span class="o">=</span> <span class="n">_from_generic_text_parser</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">ans_type</span><span class="o">.</span><span class="n">to_parse</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ans_type</span><span class="o">.</span><span class="n">wrap_parse_errors</span><span class="p">():</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">_wrap_parse_errors</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>

        <span class="c1"># If the answer type has form `Response[..., ...]`</span>
        <span class="k">if</span> <span class="n">ans_type</span><span class="o">.</span><span class="n">resp</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_has_final_tool_call</span><span class="p">(</span><span class="n">ans_type</span><span class="p">,</span> <span class="n">answer</span><span class="p">):</span>
                <span class="n">tcs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tcs</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">_parse_tool_call</span><span class="p">(</span><span class="n">ans_type</span><span class="o">.</span><span class="n">resp</span><span class="o">.</span><span class="n">tools</span><span class="p">,</span> <span class="n">tc</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">answer</span><span class="o">.</span><span class="n">tool_calls</span>
                <span class="p">]</span>
            <span class="k">if</span> <span class="n">tcs</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">Response</span><span class="p">(</span><span class="n">answer</span><span class="p">,</span> <span class="n">ToolRequests</span><span class="p">(</span><span class="n">tcs</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">Response</span><span class="p">(</span><span class="n">answer</span><span class="p">,</span> <span class="n">FinalAnswer</span><span class="p">(</span><span class="n">parser</span><span class="p">(</span><span class="n">answer</span><span class="p">))))</span>

        <span class="k">return</span> <span class="n">parser</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>

    <span class="c1">### Query Settings</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">query_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">AnswerMode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">QuerySettings</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the settings associated with the query.</span>

<span class="sd">        By default, this method uses the result of `query_config` to</span>
<span class="sd">        determine settings if `parse` is not overriden, and the default</span>
<span class="sd">        set of settings otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_config</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># `parse` is overriden</span>
            <span class="k">return</span> <span class="n">dp</span><span class="o">.</span><span class="n">QuerySettings</span><span class="p">(</span><span class="n">structured_output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">structured_output</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">parser</span> <span class="o">==</span> <span class="s2">&quot;structured&quot;</span><span class="p">:</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decomposed_answer_type</span><span class="p">()</span><span class="o">.</span><span class="n">final</span>
            <span class="n">structured_output</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">StructuredOutputSettings</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">tool_types</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_tools</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">parser</span><span class="p">):</span>
            <span class="n">tools</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">ToolSettings</span><span class="p">(</span>
                <span class="n">tool_types</span><span class="p">,</span> <span class="n">force_tool_call</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">parser</span> <span class="o">==</span> <span class="s2">&quot;final_tool_call&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">dp</span><span class="o">.</span><span class="n">QuerySettings</span><span class="p">(</span>
            <span class="n">structured_output</span><span class="o">=</span><span class="n">structured_output</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_structured_output_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypeAnnot</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="n">ty</span><span class="o">.</span><span class="n">NoTypeInfo</span><span class="p">:</span>
        <span class="n">decomposed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decomposed_answer_type</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">decomposed</span><span class="o">.</span><span class="n">final</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_query_tools</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">:</span> <span class="n">ParserSpec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
        <span class="n">ans_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decomposed_answer_type</span><span class="p">()</span>
        <span class="n">tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">ans_type</span><span class="o">.</span><span class="n">resp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tools</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">ans_type</span><span class="o">.</span><span class="n">resp</span><span class="o">.</span><span class="n">tools</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">parser</span> <span class="o">==</span> <span class="s2">&quot;final_tool_call&quot;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ans_type</span><span class="o">.</span><span class="n">final</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span>
            <span class="n">tools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ans_type</span><span class="o">.</span><span class="n">final</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tools</span>

    <span class="c1">### Query Prefixes</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_has_special_prefix_attr</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">annots</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">get_type_hints</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;prefix&quot;</span> <span class="ow">in</span> <span class="n">annots</span> <span class="ow">and</span> <span class="n">annots</span><span class="p">[</span><span class="s2">&quot;prefix&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="n">ct</span><span class="o">.</span><span class="n">AnswerPrefix</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">query_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ct</span><span class="o">.</span><span class="n">AnswerPrefix</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the value of the `prefix` attribute if it has type</span>
<span class="sd">        annotation `AnswerPrefix` or return `None`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_special_prefix_attr</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;prefix&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1">### Producing Prompts</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_prompt</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">kind</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;instance&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">AnswerMode</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">],</span>
        <span class="n">extra_args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">env</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">TemplatesManager</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">env</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">_no_prompt_manager_error</span><span class="p">()</span>
        <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="p">,</span>
            <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="n">mode</span><span class="p">,</span>
            <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">params</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">extra_args</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extra_args</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">glob</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">globals</span><span class="p">())</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s2">&quot;globals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">glob</span>
        <span class="k">return</span> <span class="n">env</span><span class="o">.</span><span class="n">prompt</span><span class="p">(</span>
            <span class="n">query_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">query_name</span><span class="p">(),</span>
            <span class="n">prompt_kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span>
            <span class="n">template_args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
            <span class="n">default_template</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_default_prompt</span><span class="p">(</span><span class="n">kind</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_default_prompt</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">kind</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;instance&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">attr_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;__</span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="s2">_prompt__&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;instance&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_has_special_prefix_attr</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">DEFAULT_INSTANCE_PROMPT_WITH_PREFIX</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">DEFAULT_INSTANCE_PROMPT</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;system&quot;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">doc</span> <span class="o">:=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="bp">cls</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">doc</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;feedback&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DEFAULT_FEEDBACK_PROMPT</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">globals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return global objects accessible in prompts via the `globals`</span>
<span class="sd">        attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1">### Other Simple Overrides</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">serialize_args</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">],</span> <span class="n">ty</span><span class="o">.</span><span class="n">pydantic_dump</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_answer_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypeAnnot</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">dpi</span><span class="o">.</span><span class="n">first_parameter_of_base_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">answer_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypeAnnot</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_answer_type</span><span class="p">()</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">finite_answer_set</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">Answer</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># We handle the special case where the return type is a literal</span>
        <span class="c1"># type that is a subtype of str.</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_type</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">:=</span> <span class="n">_match_string_literal_type</span><span class="p">(</span><span class="n">ans</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">Answer</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">res</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">query_modes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">AnswerMode</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__modes__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__modes__</span>
        <span class="k">return</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>

    <span class="c1">### Generating Opaque Spaces</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">using</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_policy</span><span class="p">:</span> <span class="n">EllipsisType</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Opaque</span><span class="p">[</span><span class="n">IPDict</span><span class="p">,</span> <span class="n">T</span><span class="p">]:</span> <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">using</span><span class="p">[</span><span class="n">P</span><span class="p">](</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">get_policy</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">P</span><span class="p">],</span> <span class="n">pol</span><span class="o">.</span><span class="n">PromptingPolicy</span><span class="p">]</span> <span class="o">|</span> <span class="n">EllipsisType</span><span class="p">,</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="n">inner_policy_type</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">P</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Opaque</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">]:</span> <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">using</span><span class="p">[</span><span class="n">P</span><span class="p">](</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">get_policy</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">P</span><span class="p">],</span> <span class="n">pol</span><span class="o">.</span><span class="n">PromptingPolicy</span><span class="p">]</span> <span class="o">|</span> <span class="n">EllipsisType</span><span class="p">,</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="n">inner_policy_type</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">P</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Opaque</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Turn a query into an opaque space by providing a mapping from</span>
<span class="sd">        the ambient inner policy to a prompting policy.</span>

<span class="sd">        Attributes:</span>
<span class="sd">            get_policy: A function that maps the ambient inner policy to</span>
<span class="sd">                a prompting policy to use for answering the query.</span>
<span class="sd">                Alternatively, if the ellipsis value `...` is passed, the</span>
<span class="sd">                inner policy type is assumed to be `IPDict`, and</span>
<span class="sd">                prompting policies are automatically selected using tags</span>
<span class="sd">                (see `IPDict` documentation).</span>
<span class="sd">            inner_policy_type: Ambient inner policy type. This information</span>
<span class="sd">                is not used at runtime but it can be provided to help type</span>
<span class="sd">                inference when necessary.</span>

<span class="sd">        The optional `inner_policy_type` argument is ignored at runtime</span>
<span class="sd">        and can be used to help type checkers infer the type of the</span>
<span class="sd">        ambient inner policy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">get_policy</span><span class="p">,</span> <span class="n">EllipsisType</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">OpaqueSpace</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">]</span><span class="o">.</span><span class="n">from_query</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">cast</span><span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">pol</span><span class="o">.</span><span class="n">dict_subpolicy</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">OpaqueSpace</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">]</span><span class="o">.</span><span class="n">from_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">get_policy</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_toplevel</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">env</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">PolicyEnv</span><span class="p">,</span>
        <span class="n">policy</span><span class="p">:</span> <span class="n">pol</span><span class="o">.</span><span class="n">PromptingPolicy</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Stream</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Obtain a search stream of query answers, given a prompting</span>
<span class="sd">        policy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">attached</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">spawn_standalone_query</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">policy</span><span class="p">(</span><span class="n">attached</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="delphyne.Query.query_config" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">query_config</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">query_config</span><span class="p">(</span><span class="n">mode</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="AnswerMode (delphyne.core.AnswerMode)" href="../../strategies/traces/#delphyne.AnswerMode">AnswerMode</a></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="QueryConfig


  
      dataclass
   (delphyne.stdlib.queries.QueryConfig)" href="#delphyne.QueryConfig">QueryConfig</a></span> <span class="o">|</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Map modes to configurations.</p>
<p>This method inspects the <code>__config__</code> and <code>__parser__</code> class
attributes (none or either can be set but not both).</p>
<ul>
<li>If no attribute is set, the default configuration is used for
      all modes, which uses the <code>"structured"</code> parser.</li>
<li>If <code>__config__</code> is set to a <a class="autorefs autorefs-internal" title="QueryConfig


  
      dataclass
  " href="#delphyne.QueryConfig"><code>QueryConfig</code></a>, this configuration
      is used for all modes.</li>
<li>Alternatively, <code>__config__</code> can be set to a dictionary mapping
      modes to configurations.</li>
<li>If <code>__parser__</code> is set to a parser specification, the default
      configuration is used for all modes, <em>except</em> that the
      provided parser is used instead of the default one.</li>
<li>Alternatively, <code>__parser__</code> can also be set to a dictionary.</li>
</ul>
<p>In the special case where the <code>parse</code> method is overriden and
only in this case, return <code>None</code> after ensuring that
<code>__config__</code> and <code>__parser__</code> are not set.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">query_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">AnswerMode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QueryConfig</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Map modes to configurations.</span>

<span class="sd">    This method inspects the `__config__` and `__parser__` class</span>
<span class="sd">    attributes (none or either can be set but not both).</span>

<span class="sd">    - If no attribute is set, the default configuration is used for</span>
<span class="sd">          all modes, which uses the `&quot;structured&quot;` parser.</span>
<span class="sd">    - If `__config__` is set to a `QueryConfig`, this configuration</span>
<span class="sd">          is used for all modes.</span>
<span class="sd">    - Alternatively, `__config__` can be set to a dictionary mapping</span>
<span class="sd">          modes to configurations.</span>
<span class="sd">    - If `__parser__` is set to a parser specification, the default</span>
<span class="sd">          configuration is used for all modes, *except* that the</span>
<span class="sd">          provided parser is used instead of the default one.</span>
<span class="sd">    - Alternatively, `__parser__` can also be set to a dictionary.</span>

<span class="sd">    In the special case where the `parse` method is overriden and</span>
<span class="sd">    only in this case, return `None` after ensuring that</span>
<span class="sd">    `__config__` and `__parser__` are not set.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">parse_overriden</span> <span class="o">=</span> <span class="n">dpi</span><span class="o">.</span><span class="n">is_method_overridden</span><span class="p">(</span><span class="n">Query</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;parse&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">parse_overriden</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__config__</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__parser__</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__config__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parser__</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="p">(</span>
            <span class="s2">&quot;Cannot have both __config__ and __parser__ attributes.&quot;</span>
        <span class="p">)</span>
        <span class="n">config_attr</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__config__</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config_attr</span><span class="p">,</span> <span class="n">QueryConfig</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">config_attr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config_attr</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">config_attr</span><span class="p">)[</span><span class="n">mode</span><span class="p">]</span>
    <span class="k">elif</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__parser__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">parser_attr</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__parser__</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parser_attr</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">parser_attr</span><span class="p">)[</span><span class="n">mode</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">parser_attr</span>
        <span class="n">_check_valid_parser_spec</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">QueryConfig</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">QueryConfig</span><span class="p">(</span><span class="s2">&quot;structured&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.Query.parse" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">parse</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">parse</span><span class="p">(</span><span class="n">answer</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="Answer


  
      dataclass
   (delphyne.core.refs.Answer)" href="../../strategies/traces/#delphyne.Answer">Answer</a></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="delphyne.stdlib.queries.Query[T]">Query[T]</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>A more convenient method to override instead of <code>parse_answer</code>.</p>
<p>Raises <a class="autorefs autorefs-internal" title="ParseError


  
      dataclass
  " href="../../strategies/queries/#delphyne.ParseError"><code>ParseError</code></a>.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">answer</span><span class="p">:</span> <span class="n">Answer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A more convenient method to override instead of `parse_answer`.</span>

<span class="sd">    Raises `ParseError`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Decompose the specified answer type</span>
    <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_config</span><span class="p">(</span><span class="n">answer</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="n">attr</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">parser</span>
    <span class="n">ans_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decomposed_answer_type</span><span class="p">()</span>

    <span class="c1"># Compute base parsing function `parser`</span>
    <span class="n">parser</span><span class="p">:</span> <span class="n">_ParsingFunction</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="s2">&quot;structured&quot;</span><span class="p">:</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">_from_structured</span><span class="p">(</span><span class="n">ans_type</span><span class="o">.</span><span class="n">to_parse</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">attr</span> <span class="o">==</span> <span class="s2">&quot;final_tool_call&quot;</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ans_type</span><span class="o">.</span><span class="n">to_parse</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">_from_final_tool_call</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="nb">type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">ans_type</span><span class="o">.</span><span class="n">to_parse</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">callable</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">attr</span><span class="p">)</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="n">nargs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">nargs</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">nargs</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">nargs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">_from_text_parser</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">_from_generic_text_parser</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">ans_type</span><span class="o">.</span><span class="n">to_parse</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ans_type</span><span class="o">.</span><span class="n">wrap_parse_errors</span><span class="p">():</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">_wrap_parse_errors</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>

    <span class="c1"># If the answer type has form `Response[..., ...]`</span>
    <span class="k">if</span> <span class="n">ans_type</span><span class="o">.</span><span class="n">resp</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_has_final_tool_call</span><span class="p">(</span><span class="n">ans_type</span><span class="p">,</span> <span class="n">answer</span><span class="p">):</span>
            <span class="n">tcs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tcs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">_parse_tool_call</span><span class="p">(</span><span class="n">ans_type</span><span class="o">.</span><span class="n">resp</span><span class="o">.</span><span class="n">tools</span><span class="p">,</span> <span class="n">tc</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">answer</span><span class="o">.</span><span class="n">tool_calls</span>
            <span class="p">]</span>
        <span class="k">if</span> <span class="n">tcs</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">Response</span><span class="p">(</span><span class="n">answer</span><span class="p">,</span> <span class="n">ToolRequests</span><span class="p">(</span><span class="n">tcs</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">Response</span><span class="p">(</span><span class="n">answer</span><span class="p">,</span> <span class="n">FinalAnswer</span><span class="p">(</span><span class="n">parser</span><span class="p">(</span><span class="n">answer</span><span class="p">))))</span>

    <span class="k">return</span> <span class="n">parser</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.Query.query_settings" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">query_settings</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">query_settings</span><span class="p">(</span><span class="n">mode</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="AnswerMode (delphyne.core.AnswerMode)" href="../../strategies/traces/#delphyne.AnswerMode">AnswerMode</a></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="QuerySettings


  
      dataclass
   (delphyne.core.QuerySettings)" href="../../strategies/queries/#delphyne.QuerySettings">QuerySettings</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Return the settings associated with the query.</p>
<p>By default, this method uses the result of <code>query_config</code> to
determine settings if <code>parse</code> is not overriden, and the default
set of settings otherwise.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@override</span>
<span class="k">def</span><span class="w"> </span><span class="nf">query_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">AnswerMode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">QuerySettings</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the settings associated with the query.</span>

<span class="sd">    By default, this method uses the result of `query_config` to</span>
<span class="sd">    determine settings if `parse` is not overriden, and the default</span>
<span class="sd">    set of settings otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_config</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># `parse` is overriden</span>
        <span class="k">return</span> <span class="n">dp</span><span class="o">.</span><span class="n">QuerySettings</span><span class="p">(</span><span class="n">structured_output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">structured_output</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">parser</span> <span class="o">==</span> <span class="s2">&quot;structured&quot;</span><span class="p">:</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decomposed_answer_type</span><span class="p">()</span><span class="o">.</span><span class="n">final</span>
        <span class="n">structured_output</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">StructuredOutputSettings</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">tool_types</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_tools</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">parser</span><span class="p">):</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">ToolSettings</span><span class="p">(</span>
            <span class="n">tool_types</span><span class="p">,</span> <span class="n">force_tool_call</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">parser</span> <span class="o">==</span> <span class="s2">&quot;final_tool_call&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">dp</span><span class="o">.</span><span class="n">QuerySettings</span><span class="p">(</span>
        <span class="n">structured_output</span><span class="o">=</span><span class="n">structured_output</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.Query.query_prefix" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">query_prefix</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">query_prefix</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="AnswerPrefix (delphyne.core.chats.AnswerPrefix)" href="../../strategies/queries/#delphyne.AnswerPrefix">AnswerPrefix</a></span> <span class="o">|</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Return the value of the <code>prefix</code> attribute if it has type
annotation <a class="autorefs autorefs-internal" title="AnswerPrefix" href="../../strategies/queries/#delphyne.AnswerPrefix"><code>AnswerPrefix</code></a> or return <code>None</code>.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@override</span>
<span class="k">def</span><span class="w"> </span><span class="nf">query_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ct</span><span class="o">.</span><span class="n">AnswerPrefix</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the value of the `prefix` attribute if it has type</span>
<span class="sd">    annotation `AnswerPrefix` or return `None`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_special_prefix_attr</span><span class="p">():</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;prefix&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.Query.globals" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">globals</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">globals</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n"><span title="dict">dict</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="object">object</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Return global objects accessible in prompts via the <code>globals</code>
attribute.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">globals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return global objects accessible in prompts via the `globals`</span>
<span class="sd">    attribute.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.Query.using" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">using</span>


</h4>
          <div class="doc-overloads">
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">using</span><span class="p">(</span><span class="n">get_policy</span><span class="p">:</span> <span class="n"><span title="types.EllipsisType">EllipsisType</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Opaque (delphyne.stdlib.opaque.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="IPDict (delphyne.stdlib.policies.IPDict)" href="../basic/#delphyne.IPDict">IPDict</a></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.queries.Query[T]">Query[T]</span></span><span class="p">]</span>
</code></pre></div><div class="doc-signature highlight"><pre><span></span><code><span class="nf">using</span><span class="p">(</span><span class="n">get_policy</span><span class="p">:</span> <span class="n"><span title="collections.abc.Callable">Callable</span></span><span class="p">[[</span><span class="n"><span title="delphyne.stdlib.queries.Query.using[P]">using[P]</span></span><span class="p">],</span> <span class="n"><a class="autorefs autorefs-internal" title="PromptingPolicy


  
      dataclass
   (delphyne.stdlib.policies.PromptingPolicy)" href="../basic/#delphyne.PromptingPolicy">PromptingPolicy</a></span><span class="p">]</span> <span class="o">|</span> <span class="n"><span title="types.EllipsisType">EllipsisType</span></span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="n">inner_policy_type</span><span class="p">:</span> <span class="n"><span title="type">type</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.Query.using[P]">using[P]</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Opaque (delphyne.stdlib.opaque.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.Query.using[P]">using[P]</span></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.queries.Query[T]">Query[T]</span></span><span class="p">]</span>
</code></pre></div>          </div>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">using</span><span class="p">(</span><span class="n">get_policy</span><span class="p">:</span> <span class="n"><span title="collections.abc.Callable">Callable</span></span><span class="p">[[</span><span class="n"><span title="delphyne.stdlib.queries.Query.using[P]">using[P]</span></span><span class="p">],</span> <span class="n"><a class="autorefs autorefs-internal" title="PromptingPolicy


  
      dataclass
   (delphyne.stdlib.policies.PromptingPolicy)" href="../basic/#delphyne.PromptingPolicy">PromptingPolicy</a></span><span class="p">]</span> <span class="o">|</span> <span class="n"><span title="types.EllipsisType">EllipsisType</span></span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="n">inner_policy_type</span><span class="p">:</span> <span class="n"><span title="type">type</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.Query.using[P]">using[P]</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Opaque (delphyne.stdlib.opaque.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.Query.using[P]">using[P]</span></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.queries.Query[T]">Query[T]</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Turn a query into an opaque space by providing a mapping from
the ambient inner policy to a prompting policy.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.Query.using.get_policy">get_policy</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A function that maps the ambient inner policy to
a prompting policy to use for answering the query.
Alternatively, if the ellipsis value <code>...</code> is passed, the
inner policy type is assumed to be <a class="autorefs autorefs-internal" title="IPDict" href="../basic/#delphyne.IPDict"><code>IPDict</code></a>, and
prompting policies are automatically selected using tags
(see <a class="autorefs autorefs-internal" title="IPDict" href="../basic/#delphyne.IPDict"><code>IPDict</code></a> documentation).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.Query.using.inner_policy_type">inner_policy_type</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Ambient inner policy type. This information
is not used at runtime but it can be provided to help type
inference when necessary.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
        <p>The optional <code>inner_policy_type</code> argument is ignored at runtime
and can be used to help type checkers infer the type of the
ambient inner policy.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">using</span><span class="p">[</span><span class="n">P</span><span class="p">](</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">get_policy</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">P</span><span class="p">],</span> <span class="n">pol</span><span class="o">.</span><span class="n">PromptingPolicy</span><span class="p">]</span> <span class="o">|</span> <span class="n">EllipsisType</span><span class="p">,</span>
    <span class="o">/</span><span class="p">,</span>
    <span class="n">inner_policy_type</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">P</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Opaque</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Turn a query into an opaque space by providing a mapping from</span>
<span class="sd">    the ambient inner policy to a prompting policy.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        get_policy: A function that maps the ambient inner policy to</span>
<span class="sd">            a prompting policy to use for answering the query.</span>
<span class="sd">            Alternatively, if the ellipsis value `...` is passed, the</span>
<span class="sd">            inner policy type is assumed to be `IPDict`, and</span>
<span class="sd">            prompting policies are automatically selected using tags</span>
<span class="sd">            (see `IPDict` documentation).</span>
<span class="sd">        inner_policy_type: Ambient inner policy type. This information</span>
<span class="sd">            is not used at runtime but it can be provided to help type</span>
<span class="sd">            inference when necessary.</span>

<span class="sd">    The optional `inner_policy_type` argument is ignored at runtime</span>
<span class="sd">    and can be used to help type checkers infer the type of the</span>
<span class="sd">    ambient inner policy.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">get_policy</span><span class="p">,</span> <span class="n">EllipsisType</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">OpaqueSpace</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">]</span><span class="o">.</span><span class="n">from_query</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cast</span><span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">pol</span><span class="o">.</span><span class="n">dict_subpolicy</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">OpaqueSpace</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">]</span><span class="o">.</span><span class="n">from_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">get_policy</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.Query.run_toplevel" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">run_toplevel</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">run_toplevel</span><span class="p">(</span><span class="n">env</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="PolicyEnv (delphyne.core.PolicyEnv)" href="../../policies/envs/#delphyne.PolicyEnv">PolicyEnv</a></span><span class="p">,</span> <span class="n">policy</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="PromptingPolicy


  
      dataclass
   (delphyne.stdlib.policies.PromptingPolicy)" href="../basic/#delphyne.PromptingPolicy">PromptingPolicy</a></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Stream


  
      dataclass
   (delphyne.stdlib.streams.Stream)" href="../streams/#delphyne.Stream">Stream</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.Query[T]">Query[T]</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Obtain a search stream of query answers, given a prompting
policy.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">run_toplevel</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">PolicyEnv</span><span class="p">,</span>
    <span class="n">policy</span><span class="p">:</span> <span class="n">pol</span><span class="o">.</span><span class="n">PromptingPolicy</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Stream</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Obtain a search stream of query answers, given a prompting</span>
<span class="sd">    policy.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">attached</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">spawn_standalone_query</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">policy</span><span class="p">(</span><span class="n">attached</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.QueryConfig" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">QueryConfig</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">


        <p>Mode-specific query settings.</p>
<p>More settings could be added in the future.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.QueryConfig.parser">parser</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="ParserSpec (delphyne.stdlib.queries.ParserSpec)" href="#delphyne.ParserSpec">ParserSpec</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A parser specification.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">QueryConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Mode-specific query settings.</span>

<span class="sd">    More settings could be added in the future.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        parser: A parser specification.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">parser</span><span class="p">:</span> <span class="s2">&quot;ParserSpec&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="delphyne.ParserSpec" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">ParserSpec</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">ParserSpec</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="_StandardParserName (delphyne.stdlib.queries._StandardParserName)" href="#delphyne.stdlib.queries._StandardParserName">_StandardParserName</a></span> <span class="o">|</span> <span class="n"><a class="autorefs autorefs-internal" title="GenericTextParser (delphyne.stdlib.queries.GenericTextParser)" href="#delphyne.stdlib.queries.GenericTextParser">GenericTextParser</a></span> <span class="o">|</span> <span class="n"><a class="autorefs autorefs-internal" title="TextParser (delphyne.stdlib.queries.TextParser)" href="#delphyne.stdlib.queries.TextParser">TextParser</a></span><span class="p">[</span><span class="n"><span title="typing.Any">Any</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>A parser specification, which can be either:</p>
<ul>
<li><strong>"structured"</strong>: Oracles must answer with structured output, and the
      resulting JSON object is parsed using Pydantic.</li>
<li><strong>"final_tool_call"</strong>: The query answer type is presented to oracles
      as a tool, which must be called to produce the final answer. This
      provides an alternative to "structured", which additionally allows
      a chain of thoughts to precede the final answer.</li>
<li><strong>A generic text parser</strong>: See <code>GenericTextParser</code>. Oracles are then
      expected to produce a string answer, which is parsed using the
      provided function.</li>
<li><strong>A text parser</strong>: See <code>TextParser</code>. Oracles are then
      expected to produce a string answer, which is parsed using the
      provided function.</li>
</ul>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="delphyne.stdlib.queries._StandardParserName" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">_StandardParserName</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">_StandardParserName</span><span class="p">:</span> <span class="n"><span title="typing.Literal">Literal</span></span><span class="p">[</span><span class="s1">&#39;structured&#39;</span><span class="p">,</span> <span class="s1">&#39;final_tool_call&#39;</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents first">

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.queries.GenericTextParser" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">GenericTextParser</span>


</h3>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="typing.Protocol">Protocol</span></code></p>


        <p>A function that takes a type annotation along with a string as
arguments and either returns a parsed object of the specified
type or raises <a class="autorefs autorefs-internal" title="ParseError


  
      dataclass
  " href="../../strategies/queries/#delphyne.ParseError"><code>ParseError</code></a>.</p>
<p>Example: <a class="autorefs autorefs-internal" title="yaml_from_last_block" href="#delphyne.yaml_from_last_block"><code>yaml_from_last_block</code></a>.</p>







              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">GenericTextParser</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A function that takes a type annotation along with a string as</span>
<span class="sd">    arguments and either returns a parsed object of the specified</span>
<span class="sd">    type or raises `ParseError`.</span>

<span class="sd">    Example: `yaml_from_last_block`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">[</span><span class="n">T</span><span class="p">](</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="n">TypeAnnot</span><span class="p">[</span><span class="n">T</span><span class="p">],</span> <span class="n">answer</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span> <span class="o">...</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.queries.TextParser" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">TextParser</span>


</h3>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="typing.Protocol">Protocol</span></code></p>


        <p>A function that takes a string as an argument and either returns
a parsed object or raises <a class="autorefs autorefs-internal" title="ParseError


  
      dataclass
  " href="../../strategies/queries/#delphyne.ParseError"><code>ParseError</code></a>.</p>







              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TextParser</span><span class="p">[</span><span class="n">T</span><span class="p">](</span><span class="n">Protocol</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A function that takes a string as an argument and either returns</span>
<span class="sd">    a parsed object or raises `ParseError`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">answer</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span> <span class="o">...</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="delphyne.stdlib.queries.ParserSpecDict" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">ParserSpecDict</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">ParserSpecDict</span><span class="p">:</span> <span class="n"><span title="collections.abc.Mapping">Mapping</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="AnswerMode (delphyne.core.AnswerMode)" href="../../strategies/traces/#delphyne.AnswerMode">AnswerMode</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-internal" title="ParserSpec (delphyne.stdlib.queries.ParserSpec)" href="#delphyne.ParserSpec">ParserSpec</a></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>A dictionary mapping answer modes to parser specifications.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="delphyne.stdlib.queries.QueryConfigDict" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">QueryConfigDict</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">QueryConfigDict</span><span class="p">:</span> <span class="n"><span title="collections.abc.Mapping">Mapping</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="AnswerMode (delphyne.core.AnswerMode)" href="../../strategies/traces/#delphyne.AnswerMode">AnswerMode</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-internal" title="QueryConfig


  
      dataclass
   (delphyne.stdlib.queries.QueryConfig)" href="#delphyne.QueryConfig">QueryConfig</a></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>A dictionary mapping answer modes to query configurations.</p>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.queries.Response" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">Response</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">


        <p>Answer type for queries that allow follow-ups.</p>
<p><a class="autorefs autorefs-internal" title="Response


  
      dataclass
  " href="#delphyne.stdlib.queries.Response"><code>Response</code></a> values give access to both the raw LLM response (to be
passed pass in <a class="autorefs autorefs-internal" title="AnswerPrefix" href="../../strategies/queries/#delphyne.AnswerPrefix"><code>AnswerPrefix</code></a>) and to eventual tool calls.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.queries.Response.answer">answer</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Answer


  
      dataclass
   (delphyne.core.Answer)" href="../../strategies/traces/#delphyne.Answer">Answer</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The raw, unparsed LLM answer.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.queries.Response.parsed">parsed</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="FinalAnswer


  
      dataclass
   (delphyne.stdlib.queries.FinalAnswer)" href="#delphyne.stdlib.queries.FinalAnswer">FinalAnswer</a>[<span title="delphyne.stdlib.queries.Response[F]">Response[F]</span>] | <a class="autorefs autorefs-internal" title="ToolRequests


  
      dataclass
   (delphyne.stdlib.queries.ToolRequests)" href="#delphyne.stdlib.queries.ToolRequests">ToolRequests</a>[<span title="delphyne.stdlib.queries.Response[T]">Response[T]</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Either the parsed answer wrapped in <a class="autorefs autorefs-internal" title="FinalAnswer


  
      dataclass
  " href="#delphyne.stdlib.queries.FinalAnswer"><code>FinalAnswer</code></a> or
some tool call requests wrapped in <a class="autorefs autorefs-internal" title="ToolRequests


  
      dataclass
  " href="#delphyne.stdlib.queries.ToolRequests"><code>ToolRequests</code></a>.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Response</span><span class="p">[</span><span class="n">F</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="n">md</span><span class="o">.</span><span class="n">AbstractTool</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Answer type for queries that allow follow-ups.</span>

<span class="sd">    `Response` values give access to both the raw LLM response (to be</span>
<span class="sd">    passed pass in `AnswerPrefix`) and to eventual tool calls.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        answer: The raw, unparsed LLM answer.</span>
<span class="sd">        parsed: Either the parsed answer wrapped in `FinalAnswer` or</span>
<span class="sd">            some tool call requests wrapped in `ToolRequests`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">answer</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">Answer</span>
    <span class="n">parsed</span><span class="p">:</span> <span class="n">FinalAnswer</span><span class="p">[</span><span class="n">F</span><span class="p">]</span> <span class="o">|</span> <span class="n">ToolRequests</span><span class="p">[</span><span class="n">T</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.queries.FinalAnswer" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">FinalAnswer</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">


        <p>See <a class="autorefs autorefs-internal" title="Response


  
      dataclass
  " href="#delphyne.stdlib.queries.Response"><code>Response</code></a>.</p>







              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FinalAnswer</span><span class="p">[</span><span class="n">F</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    See `Response`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">final</span><span class="p">:</span> <span class="n">F</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.queries.ToolRequests" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">ToolRequests</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">


        <p>See <a class="autorefs autorefs-internal" title="Response


  
      dataclass
  " href="#delphyne.stdlib.queries.Response"><code>Response</code></a>.</p>







              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ToolRequests</span><span class="p">[</span><span class="n">T</span><span class="p">:</span> <span class="n">md</span><span class="o">.</span><span class="n">AbstractTool</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    See `Response`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tool_calls</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">T</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.queries.WrappedParseError" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">WrappedParseError</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">


        <p>A wrapped parse error that is returned to a strategy instead of
causing a failure.</p>
<p>For queries that declare a return type of the form <code>Response[... |
WrappedParseError, ...]</code>, parse errors do not result in failures but
are instead wrapped and returned, to be handled explicitly by the
surrounding strategy. For example, when building conversational
agents with <a class="autorefs autorefs-internal" title="interact" href="../algorithms/#delphyne.interact"><code>interact</code></a>, having the query include <a class="autorefs autorefs-internal" title="WrappedParseError


  
      dataclass
  " href="#delphyne.stdlib.queries.WrappedParseError"><code>WrappedParseError</code></a>
in its return type allows explicitly asking the agent to fix parse
errors instead of failing (or having the policy retry an identical
prompt).</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.queries.WrappedParseError.error">error</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="ParseError


  
      dataclass
   (delphyne.core.ParseError)" href="../../strategies/queries/#delphyne.ParseError">ParseError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The wrapped parse error.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">WrappedParseError</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A wrapped parse error that is returned to a strategy instead of</span>
<span class="sd">    causing a failure.</span>

<span class="sd">    For queries that declare a return type of the form `Response[... |</span>
<span class="sd">    WrappedParseError, ...]`, parse errors do not result in failures but</span>
<span class="sd">    are instead wrapped and returned, to be handled explicitly by the</span>
<span class="sd">    surrounding strategy. For example, when building conversational</span>
<span class="sd">    agents with `interact`, having the query include `WrappedParseError`</span>
<span class="sd">    in its return type allows explicitly asking the agent to fix parse</span>
<span class="sd">    errors instead of failing (or having the policy retry an identical</span>
<span class="sd">    prompt).</span>

<span class="sd">    Attributes:</span>
<span class="sd">        error: The wrapped parse error.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">error</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div><h2 id="standard-parsers">Standard Parsers</h2>


<div class="doc doc-object doc-function">


<h3 id="delphyne.raw_yaml" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">raw_yaml</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">raw_yaml</span><span class="p">(</span><span class="nb">type</span><span class="p">:</span> <span class="n"><span title="delphyne.utils.typing.TypeAnnot">TypeAnnot</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.raw_yaml[T]">raw_yaml[T]</span></span><span class="p">],</span> <span class="n">res</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="delphyne.stdlib.queries.raw_yaml[T]">raw_yaml[T]</span></span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Parse a text answer that consists in a single YAML object and
nothing else.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">raw_yaml</span><span class="p">[</span><span class="n">T</span><span class="p">](</span><span class="nb">type</span><span class="p">:</span> <span class="n">TypeAnnot</span><span class="p">[</span><span class="n">T</span><span class="p">],</span> <span class="n">res</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse a text answer that consists in a single YAML object and</span>
<span class="sd">    nothing else.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ty</span><span class="o">.</span><span class="n">pydantic_load</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">parsed</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="delphyne.yaml_from_last_block" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">yaml_from_last_block</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">yaml_from_last_block</span><span class="p">(</span><span class="nb">type</span><span class="p">:</span> <span class="n"><span title="delphyne.utils.typing.TypeAnnot">TypeAnnot</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.yaml_from_last_block[T]">yaml_from_last_block[T]</span></span><span class="p">],</span> <span class="n">res</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="delphyne.stdlib.queries.yaml_from_last_block[T]">yaml_from_last_block[T]</span></span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Parse the YAML object defined in the last code block of a text
answer (between triple back quotes). In particular, this parser
allows chain of thoughts.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">yaml_from_last_block</span><span class="p">[</span><span class="n">T</span><span class="p">](</span><span class="nb">type</span><span class="p">:</span> <span class="n">TypeAnnot</span><span class="p">[</span><span class="n">T</span><span class="p">],</span> <span class="n">res</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse the YAML object defined in the last code block of a text</span>
<span class="sd">    answer (between triple back quotes). In particular, this parser</span>
<span class="sd">    allows chain of thoughts.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">final</span> <span class="o">=</span> <span class="n">extract_final_block</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">final</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;No final code block found.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">raw_yaml</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">final</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="delphyne.raw_string" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">raw_string</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">raw_string</span><span class="p">(</span><span class="n">type_annot</span><span class="p">:</span> <span class="n"><span title="delphyne.utils.typing.TypeAnnot">TypeAnnot</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.raw_string[T]">raw_string[T]</span></span><span class="p">],</span> <span class="n">res</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="delphyne.stdlib.queries.raw_string[T]">raw_string[T]</span></span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Do not perform any parsing and return the answer as a raw string.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">raw_string</span><span class="p">[</span><span class="n">T</span><span class="p">](</span><span class="n">type_annot</span><span class="p">:</span> <span class="n">TypeAnnot</span><span class="p">[</span><span class="n">T</span><span class="p">],</span> <span class="n">res</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Do not perform any parsing and return the answer as a raw string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">type_annot_resolved</span> <span class="o">=</span> <span class="n">dpi</span><span class="o">.</span><span class="n">resolve_aliases_in_type</span><span class="p">(</span><span class="n">type_annot</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">type_annot_resolved</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>  <span class="c1"># if `type` is a class</span>
            <span class="k">return</span> <span class="n">type_annot_resolved</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="k">if</span> <span class="n">type_annot_resolved</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
        <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Not a string-convertible type: </span><span class="si">{</span><span class="n">type_annot</span><span class="si">}</span><span class="s2">.&quot;</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;raw_string parsed failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="delphyne.trimmed_raw_string" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">trimmed_raw_string</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">trimmed_raw_string</span><span class="p">(</span><span class="nb">type</span><span class="p">:</span> <span class="n"><span title="delphyne.utils.typing.TypeAnnot">TypeAnnot</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.trimmed_raw_string[T]">trimmed_raw_string[T]</span></span><span class="p">],</span> <span class="n">res</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="delphyne.stdlib.queries.trimmed_raw_string[T]">trimmed_raw_string[T]</span></span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Do not perform any parsing and return the answer as a raw string,
after trimming leading and trailing whitespace.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">trimmed_raw_string</span><span class="p">[</span><span class="n">T</span><span class="p">](</span><span class="nb">type</span><span class="p">:</span> <span class="n">TypeAnnot</span><span class="p">[</span><span class="n">T</span><span class="p">],</span> <span class="n">res</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Do not perform any parsing and return the answer as a raw string,</span>
<span class="sd">    after trimming leading and trailing whitespace.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">raw_string</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="delphyne.first_word" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">first_word</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">first_word</span><span class="p">(</span><span class="nb">type</span><span class="p">:</span> <span class="n"><span title="delphyne.utils.typing.TypeAnnot">TypeAnnot</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.first_word[T]">first_word[T]</span></span><span class="p">],</span> <span class="n">res</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="delphyne.stdlib.queries.first_word[T]">first_word[T]</span></span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Parse the first word of the answer and turn it into an object of
type T=Literal[s1,...,sn].</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">first_word</span><span class="p">[</span><span class="n">T</span><span class="p">](</span><span class="nb">type</span><span class="p">:</span> <span class="n">TypeAnnot</span><span class="p">[</span><span class="n">T</span><span class="p">],</span> <span class="n">res</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse the first word of the answer and turn it into an object of</span>
<span class="sd">    type T=Literal[s1,...,sn].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="n">_match_string_literal_type</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">vals</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Not recognized as a string literal type: </span><span class="si">{</span><span class="nb">type</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="k">raise</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">res</span><span class="p">,</span> <span class="s2">&quot;Cannot parse an empty string.&quot;</span>
        <span class="n">first</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">first</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">,</span> <span class="s2">&quot;Unallowed value: &quot;</span> <span class="o">+</span> <span class="n">first</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">first</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="delphyne.string_from_last_block" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">string_from_last_block</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">string_from_last_block</span><span class="p">(</span><span class="nb">type</span><span class="p">:</span> <span class="n"><span title="delphyne.utils.typing.TypeAnnot">TypeAnnot</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.string_from_last_block[T]">string_from_last_block[T]</span></span><span class="p">],</span> <span class="n">res</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="delphyne.stdlib.queries.string_from_last_block[T]">string_from_last_block[T]</span></span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Extract the string content of the last code block from the answer
(surrounded by triple back quotes).</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">string_from_last_block</span><span class="p">[</span><span class="n">T</span><span class="p">](</span><span class="nb">type</span><span class="p">:</span> <span class="n">TypeAnnot</span><span class="p">[</span><span class="n">T</span><span class="p">],</span> <span class="n">res</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract the string content of the last code block from the answer</span>
<span class="sd">    (surrounded by triple back quotes).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">final</span> <span class="o">=</span> <span class="n">extract_final_block</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">final</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;No final code block found.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">raw_string</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">final</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="delphyne.trimmed_string_from_last_block" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">trimmed_string_from_last_block</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">trimmed_string_from_last_block</span><span class="p">(</span><span class="nb">type</span><span class="p">:</span> <span class="n"><span title="delphyne.utils.typing.TypeAnnot">TypeAnnot</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.trimmed_string_from_last_block[T]">trimmed_string_from_last_block[T]</span></span><span class="p">],</span> <span class="n">res</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="delphyne.stdlib.queries.trimmed_string_from_last_block[T]">trimmed_string_from_last_block[T]</span></span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Extract the string content of the last code block from the answer
(surrounded by triple back quotes) and trim leading and trailing
whitespace.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">trimmed_string_from_last_block</span><span class="p">[</span><span class="n">T</span><span class="p">](</span><span class="nb">type</span><span class="p">:</span> <span class="n">TypeAnnot</span><span class="p">[</span><span class="n">T</span><span class="p">],</span> <span class="n">res</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract the string content of the last code block from the answer</span>
<span class="sd">    (surrounded by triple back quotes) and trim leading and trailing</span>
<span class="sd">    whitespace.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">final</span> <span class="o">=</span> <span class="n">extract_final_block</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">final</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;No final code block found.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">trimmed_raw_string</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">final</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h2 id="prompting-policies">Prompting Policies</h2>


<div class="doc doc-object doc-function">


<h3 id="delphyne.few_shot" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">few_shot</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">few_shot</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="AttachedQuery


  
      dataclass
   (delphyne.core.AttachedQuery)" href="../../strategies/trees/#delphyne.AttachedQuery">AttachedQuery</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.few_shot[T]">few_shot[T]</span></span><span class="p">],</span> <span class="n">env</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="PolicyEnv (delphyne.core.PolicyEnv)" href="../../policies/envs/#delphyne.PolicyEnv">PolicyEnv</a></span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="LLM (delphyne.stdlib.models.LLM)" href="#delphyne.stdlib.models.LLM">LLM</a></span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n"><span title="dict">dict</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="object">object</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">select_examples</span><span class="p">:</span> <span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.ExampleSelector">ExampleSelector</span></span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span> <span class="n">mode</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="AnswerMode (delphyne.core.AnswerMode)" href="../../strategies/traces/#delphyne.AnswerMode">AnswerMode</a></span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">enable_logging</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">temperature</span><span class="p">:</span> <span class="n"><span title="float">float</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">num_concurrent</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max_requests</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">no_wrap_parse_errors</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">iterative_mode</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="StreamGen (delphyne.core.StreamGen)" href="../../policies/streams/#delphyne.StreamGen">StreamGen</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.few_shot[T]">few_shot[T]</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>The standard few-shot prompting policy.</p>
<p>A prompt is formed by concatenating a system prompt, a series of
examples (each of which consists in an instance prompt followed by
an answer), and a final answer prompt. Then, answers are repeatedly
sampled and parsed, until a spending request is declined.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>query</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="AttachedQuery


  
      dataclass
   (delphyne.core.AttachedQuery)" href="../../strategies/trees/#delphyne.AttachedQuery">AttachedQuery</a>[<span title="delphyne.stdlib.queries.few_shot[T]">few_shot[T]</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The query to answer. env: The policy environment.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="LLM (delphyne.stdlib.models.LLM)" href="#delphyne.stdlib.models.LLM">LLM</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The LLM to use for answering the query</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>params</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="object">object</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Prompt hyperparameters, which are passed to prompt
templates as a <code>params</code> dictionary.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>select_examples</code>
            </td>
            <td>
                  <code><span title="collections.abc.Sequence">Sequence</span>[<span title="delphyne.stdlib.queries.ExampleSelector">ExampleSelector</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A series of filters for selecting examples, to
be applied in sequence. By default, no filter is used and so
all available examples are fetched.</p>
              </div>
            </td>
            <td>
                  <code>()</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mode</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="AnswerMode (delphyne.core.AnswerMode)" href="../../strategies/traces/#delphyne.AnswerMode">AnswerMode</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The answer mode to use for parsing the query answer.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>enable_logging</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to log raw oracle responses.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>temperature</code>
            </td>
            <td>
                  <code><span title="float">float</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The temperature parameter to use with the LLM, as a
number from 0 to 2.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_concurrent</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of completions to request for each
LLM call. Note that most LLM providers only bill input
tokens once, regardless of the number of completions.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_requests</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum number of LLM requests to perform
before the resulting seach stream terminates, if any.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>no_wrap_parse_errors</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If set to <code>True</code>, then parser results of
type <a class="autorefs autorefs-internal" title="WrappedParseError


  
      dataclass
  " href="#delphyne.stdlib.queries.WrappedParseError"><code>WrappedParseError</code></a> are unwrapped and treated as normal
parse errors.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>iterative_mode</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If set to <code>False</code> (default), answers are
repeatedly and independently sampled. If set to <code>True</code>, a
single chat conversation occurs instead: Whenever a parse
error occurs, a message is issued by rendering the
<code>&lt;QueryName&gt;.repair.jinja</code> template, asking for a new
attempt to be made (the <a class="autorefs autorefs-internal" title="ParseError


  
      dataclass
  " href="../../strategies/queries/#delphyne.ParseError"><code>ParseError</code></a> object is available as
an <code>error</code> template variable). After an answer is
successfully generated and parsed, a message is issued by
rendering the <code>&lt;QueryName&gt;.more.jinja</code> template, asking for
another different answer to be generated.</p>
<p>This special mode allows creating simple conversational
agents with very little effort, by only defining a single
query. However, it does not support tool calls, and the
demonstration language cannot be used to illustrate how
<code>repair</code> and <code>more</code> messages should be handled. For
implementing more advanced conversational agents, see
the standard <a class="autorefs autorefs-internal" title="interact" href="../algorithms/#delphyne.interact"><code>interact</code></a> strategy.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@prompting_policy</span>
<span class="k">def</span><span class="w"> </span><span class="nf">few_shot</span><span class="p">[</span><span class="n">T</span><span class="p">](</span>
    <span class="n">query</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">AttachedQuery</span><span class="p">[</span><span class="n">T</span><span class="p">],</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">PolicyEnv</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">md</span><span class="o">.</span><span class="n">LLM</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">select_examples</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ExampleSelector</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
    <span class="n">mode</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">AnswerMode</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">enable_logging</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">num_concurrent</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">max_requests</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">no_wrap_parse_errors</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">iterative_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">StreamGen</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The standard few-shot prompting policy.</span>

<span class="sd">    A prompt is formed by concatenating a system prompt, a series of</span>
<span class="sd">    examples (each of which consists in an instance prompt followed by</span>
<span class="sd">    an answer), and a final answer prompt. Then, answers are repeatedly</span>
<span class="sd">    sampled and parsed, until a spending request is declined.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        query: The query to answer. env: The policy environment.</span>
<span class="sd">        model: The LLM to use for answering the query</span>
<span class="sd">        params: Prompt hyperparameters, which are passed to prompt</span>
<span class="sd">            templates as a `params` dictionary.</span>
<span class="sd">        select_examples: A series of filters for selecting examples, to</span>
<span class="sd">            be applied in sequence. By default, no filter is used and so</span>
<span class="sd">            all available examples are fetched.</span>
<span class="sd">        mode: The answer mode to use for parsing the query answer.</span>
<span class="sd">        enable_logging: Whether to log raw oracle responses.</span>
<span class="sd">        temperature: The temperature parameter to use with the LLM, as a</span>
<span class="sd">            number from 0 to 2.</span>
<span class="sd">        num_concurrent: The number of completions to request for each</span>
<span class="sd">            LLM call. Note that most LLM providers only bill input</span>
<span class="sd">            tokens once, regardless of the number of completions.</span>
<span class="sd">        max_requests: The maximum number of LLM requests to perform</span>
<span class="sd">            before the resulting seach stream terminates, if any.</span>
<span class="sd">        no_wrap_parse_errors: If set to `True`, then parser results of</span>
<span class="sd">            type `WrappedParseError` are unwrapped and treated as normal</span>
<span class="sd">            parse errors.</span>
<span class="sd">        iterative_mode: If set to `False` (default), answers are</span>
<span class="sd">            repeatedly and independently sampled. If set to `True`, a</span>
<span class="sd">            single chat conversation occurs instead: Whenever a parse</span>
<span class="sd">            error occurs, a message is issued by rendering the</span>
<span class="sd">            `&lt;QueryName&gt;.repair.jinja` template, asking for a new</span>
<span class="sd">            attempt to be made (the `ParseError` object is available as</span>
<span class="sd">            an `error` template variable). After an answer is</span>
<span class="sd">            successfully generated and parsed, a message is issued by</span>
<span class="sd">            rendering the `&lt;QueryName&gt;.more.jinja` template, asking for</span>
<span class="sd">            another different answer to be generated.</span>

<span class="sd">            This special mode allows creating simple conversational</span>
<span class="sd">            agents with very little effort, by only defining a single</span>
<span class="sd">            query. However, it does not support tool calls, and the</span>
<span class="sd">            demonstration language cannot be used to illustrate how</span>
<span class="sd">            `repair` and `more` messages should be handled. For</span>
<span class="sd">            implementing more advanced conversational agents, see</span>
<span class="sd">            the standard `interact` strategy.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">iterative_mode</span> <span class="ow">or</span> <span class="n">num_concurrent</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">max_requests</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">max_requests</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">env</span><span class="o">.</span><span class="n">tracer</span><span class="o">.</span><span class="n">trace_query</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">ref</span><span class="p">)</span>
    <span class="n">examples</span> <span class="o">=</span> <span class="n">fetch_examples</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">examples</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">query</span><span class="p">,</span> <span class="n">select_examples</span><span class="p">)</span>
    <span class="n">mngr</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">templates</span>
    <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">prompt</span> <span class="o">=</span> <span class="n">create_prompt</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">query</span><span class="p">,</span> <span class="n">examples</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">mngr</span><span class="p">)</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">query_settings</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
    <span class="n">options</span><span class="p">:</span> <span class="n">md</span><span class="o">.</span><span class="n">RequestOptions</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">temperature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">options</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temperature</span>
    <span class="n">structured_output</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">structured_output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out_type</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">structured_output</span><span class="o">.</span><span class="n">type</span>
        <span class="n">structured_output</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">Schema</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">out_type</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">tools</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">force_tool_call</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="s2">&quot;tool_choice&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;required&quot;</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="p">[</span><span class="n">md</span><span class="o">.</span><span class="n">Schema</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">tool_types</span><span class="p">]</span>
    <span class="n">num_reqs</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">max_requests</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">num_reqs</span> <span class="o">&lt;</span> <span class="n">max_requests</span><span class="p">:</span>
        <span class="n">num_reqs</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">LLMRequest</span><span class="p">(</span>
            <span class="n">prompt</span><span class="p">,</span>
            <span class="n">num_completions</span><span class="o">=</span><span class="n">num_concurrent</span><span class="p">,</span>
            <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">structured_output</span><span class="o">=</span><span class="n">structured_output</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">_send_request</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="n">SpendingDeclined</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="n">log_oracle_response</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">resp</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">enable_logging</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s2">&quot;llm_no_output&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">elements</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">Tracked</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">|</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">answers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">Answer</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">resp</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
            <span class="n">answer</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">Answer</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">output</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">))</span>
            <span class="n">answers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>
            <span class="n">element</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">parse_answer</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">no_wrap_parse_errors</span><span class="p">:</span>
                <span class="n">element</span> <span class="o">=</span> <span class="n">_unwrap_parse_error</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
            <span class="n">env</span><span class="o">.</span><span class="n">tracer</span><span class="o">.</span><span class="n">trace_answer</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">ref</span><span class="p">,</span> <span class="n">answer</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span><span class="p">):</span>
                <span class="n">log</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s2">&quot;parse_error&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">element</span><span class="p">},</span> <span class="n">loc</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>
            <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">dp</span><span class="o">.</span><span class="n">Solution</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="c1"># In iterative mode, we want to keep the conversation going</span>
        <span class="k">if</span> <span class="n">iterative_mode</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">answers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="n">element</span> <span class="o">=</span> <span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">repair</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">generate_prompt</span><span class="p">(</span>
                        <span class="n">kind</span><span class="o">=</span><span class="n">REPAIR_PROMPT</span><span class="p">,</span>
                        <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
                        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">params</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">element</span><span class="p">},</span>
                        <span class="n">env</span><span class="o">=</span><span class="n">mngr</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="n">dp</span><span class="o">.</span><span class="n">TemplateFileMissing</span><span class="p">:</span>
                    <span class="n">repair</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;Invalid answer. Please consider the following&quot;</span>
                        <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; feedback and try again:</span><span class="se">\n\n</span><span class="si">{</span><span class="n">element</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="n">new_message</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">UserMessage</span><span class="p">(</span><span class="n">repair</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">gen_new</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">generate_prompt</span><span class="p">(</span>
                        <span class="n">kind</span><span class="o">=</span><span class="n">REQUEST_OTHER_PROMPT</span><span class="p">,</span>
                        <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
                        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">params</span><span class="p">},</span>
                        <span class="n">env</span><span class="o">=</span><span class="n">mngr</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="n">dp</span><span class="o">.</span><span class="n">TemplateFileMissing</span><span class="p">:</span>
                    <span class="n">gen_new</span> <span class="o">=</span> <span class="s2">&quot;Good! Can you generate a different answer now?&quot;</span>
                <span class="n">new_message</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">UserMessage</span><span class="p">(</span><span class="n">gen_new</span><span class="p">)</span>

            <span class="n">prompt</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">prompt</span><span class="p">,</span> <span class="n">md</span><span class="o">.</span><span class="n">AssistantMessage</span><span class="p">(</span><span class="n">answers</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">new_message</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="delphyne.classify" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">classify</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">classify</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="AttachedQuery


  
      dataclass
   (delphyne.core.AttachedQuery)" href="../../strategies/trees/#delphyne.AttachedQuery">AttachedQuery</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.classify[T]">classify[T]</span></span><span class="p">],</span> <span class="n">env</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="PolicyEnv (delphyne.core.PolicyEnv)" href="../../policies/envs/#delphyne.PolicyEnv">PolicyEnv</a></span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="LLM (delphyne.stdlib.models.LLM)" href="#delphyne.stdlib.models.LLM">LLM</a></span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n"><span title="dict">dict</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="object">object</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">select_examples</span><span class="p">:</span> <span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.ExampleSelector">ExampleSelector</span></span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span> <span class="n">mode</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="AnswerMode (delphyne.core.AnswerMode)" href="../../strategies/traces/#delphyne.AnswerMode">AnswerMode</a></span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">enable_logging</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">top_logprobs</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">temperature</span><span class="p">:</span> <span class="n"><span title="float">float</span></span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">bias</span><span class="p">:</span> <span class="n"><span title="tuple">tuple</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="float">float</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="StreamGen (delphyne.core.StreamGen)" href="../../policies/streams/#delphyne.StreamGen">StreamGen</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.queries.classify[T]">classify[T]</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Execute a classification query, attaching a probability distribution
to the attached answer.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>query</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="AttachedQuery


  
      dataclass
   (delphyne.core.AttachedQuery)" href="../../strategies/trees/#delphyne.AttachedQuery">AttachedQuery</a>[<span title="delphyne.stdlib.queries.classify[T]">classify[T]</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The query to answer.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>env</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="PolicyEnv (delphyne.core.PolicyEnv)" href="../../policies/envs/#delphyne.PolicyEnv">PolicyEnv</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The global policy environment.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="LLM (delphyne.stdlib.models.LLM)" href="#delphyne.stdlib.models.LLM">LLM</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The LLM to use for answering the query.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>params</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="object">object</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Prompt hyperparameters.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>select_examples</code>
            </td>
            <td>
                  <code><span title="collections.abc.Sequence">Sequence</span>[<span title="delphyne.stdlib.queries.ExampleSelector">ExampleSelector</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Example selector.</p>
              </div>
            </td>
            <td>
                  <code>()</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mode</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="AnswerMode (delphyne.core.AnswerMode)" href="../../strategies/traces/#delphyne.AnswerMode">AnswerMode</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The answer mode to use for parsing the query answer.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>enable_logging</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to log raw oracle responses.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>top_logprobs</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of top logprobs to request from the
LLM, putting an upper bound on the support size of the
classifier's output distributions.</p>
              </div>
            </td>
            <td>
                  <code>20</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>temperature</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A temperature to apply to the classifier's output
distribution (a temperature of 0 means that only top
elements are assigned a nonzero probability).</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bias</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span>[<span title="str">str</span>, <span title="float">float</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>When <code>bias=(e, p)</code> is provided, the final classifier
distribution <code>D</code> is transformed into <code>(1-p)*D + p*dirac(e)</code></p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>
        <p>See <a class="autorefs autorefs-internal" title="few_shot" href="#delphyne.few_shot"><code>few_shot</code></a> for details on some of the arguments above.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@prompting_policy</span>
<span class="k">def</span><span class="w"> </span><span class="nf">classify</span><span class="p">[</span><span class="n">T</span><span class="p">](</span>
    <span class="n">query</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">AttachedQuery</span><span class="p">[</span><span class="n">T</span><span class="p">],</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">PolicyEnv</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">md</span><span class="o">.</span><span class="n">LLM</span><span class="p">,</span>
    <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">select_examples</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ExampleSelector</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
    <span class="n">mode</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">AnswerMode</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">enable_logging</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">top_logprobs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
    <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">bias</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">StreamGen</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Execute a classification query, attaching a probability distribution</span>
<span class="sd">    to the attached answer.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        query: The query to answer.</span>
<span class="sd">        env: The global policy environment.</span>
<span class="sd">        model: The LLM to use for answering the query.</span>
<span class="sd">        params: Prompt hyperparameters.</span>
<span class="sd">        select_examples: Example selector.</span>
<span class="sd">        mode: The answer mode to use for parsing the query answer.</span>
<span class="sd">        enable_logging: Whether to log raw oracle responses.</span>
<span class="sd">        top_logprobs: The number of top logprobs to request from the</span>
<span class="sd">            LLM, putting an upper bound on the support size of the</span>
<span class="sd">            classifier&#39;s output distributions.</span>
<span class="sd">        temperature: A temperature to apply to the classifier&#39;s output</span>
<span class="sd">            distribution (a temperature of 0 means that only top</span>
<span class="sd">            elements are assigned a nonzero probability).</span>
<span class="sd">        bias: When `bias=(e, p)` is provided, the final classifier</span>
<span class="sd">            distribution `D` is transformed into `(1-p)*D + p*dirac(e)`</span>

<span class="sd">    See `few_shot` for details on some of the arguments above.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">env</span><span class="o">.</span><span class="n">tracer</span><span class="o">.</span><span class="n">trace_query</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">ref</span><span class="p">)</span>
    <span class="n">examples</span> <span class="o">=</span> <span class="n">fetch_examples</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">examples</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">query</span><span class="p">,</span> <span class="n">select_examples</span><span class="p">)</span>
    <span class="n">mngr</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">templates</span>
    <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">prompt</span> <span class="o">=</span> <span class="n">create_prompt</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">query</span><span class="p">,</span> <span class="n">examples</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">mngr</span><span class="p">)</span>
    <span class="n">aset</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">finite_answer_set</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">aset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="n">vals</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">aset</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="n">vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
    <span class="n">options</span><span class="p">:</span> <span class="n">md</span><span class="o">.</span><span class="n">RequestOptions</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;logprobs&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;top_logprobs&quot;</span><span class="p">:</span> <span class="n">top_logprobs</span><span class="p">,</span>
        <span class="c1"># TODO: somehow, there seems to be a problem with this, where</span>
        <span class="c1"># one can get an empty answer with &quot;finish_reason: length&quot;:</span>
        <span class="c1"># &quot;max_completion_tokens&quot;: 1,</span>
        <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">LLMRequest</span><span class="p">(</span>
        <span class="n">prompt</span><span class="p">,</span>
        <span class="n">num_completions</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">_send_request</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="n">SpendingDeclined</span><span class="p">):</span>
        <span class="k">return</span>
    <span class="n">log_oracle_response</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">resp</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">enable_logging</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">answer</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">Answer</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">output</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
    <span class="n">env</span><span class="o">.</span><span class="n">tracer</span><span class="o">.</span><span class="n">trace_answer</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">ref</span><span class="p">,</span> <span class="n">answer</span><span class="p">)</span>
    <span class="n">parse</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">_parse_or_log_and_raise</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">element</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>
        <span class="n">lpinfo</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">logprobs</span>
        <span class="k">assert</span> <span class="n">lpinfo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">ldistr</span> <span class="o">=</span> <span class="n">_compute_value_distribution</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">lpinfo</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ldistr</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="n">ldistr</span> <span class="o">=</span> <span class="p">{</span><span class="n">output</span><span class="o">.</span><span class="n">content</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>
        <span class="n">distr</span> <span class="o">=</span> <span class="n">_apply_temperature</span><span class="p">(</span><span class="n">ldistr</span><span class="p">,</span> <span class="n">temperature</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">distr</span> <span class="o">=</span> <span class="n">_apply_bias</span><span class="p">(</span><span class="n">distr</span><span class="p">,</span> <span class="n">bias</span><span class="p">)</span>
        <span class="n">distr_tup</span> <span class="o">=</span> <span class="p">[(</span><span class="n">parse</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">Answer</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">k</span><span class="p">)),</span> <span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">distr</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">ProbInfo</span><span class="p">(</span><span class="n">distr_tup</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">dp</span><span class="o">.</span><span class="n">Solution</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">meta</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParseError</span><span class="p">:</span>
        <span class="k">return</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.ProbInfo" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">ProbInfo</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="SearchMeta (delphyne.core.SearchMeta)" href="../../policies/streams/#delphyne.SearchMeta">SearchMeta</a></code></p>


        <p>Distribution probability, guaranteed to be nonempty and to sum to 1.</p>







              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/queries.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ProbInfo</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">SearchMeta</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Distribution probability, guaranteed to be nonempty and to sum to 1.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">distr</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">Tracked</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="nb">float</span><span class="p">]]</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div><h2 id="models">Models</h2>


<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.models.LLM" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">LLM</span>


</h3>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="abc.ABC">ABC</span></code></p>


        <p>Base class for an LLM.</p>







              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LLM</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for an LLM.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">estimate_budget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">LLMRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Budget</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Estimate the budget that is required to process a request.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Budget</span><span class="p">({</span><span class="n">NUM_REQUESTS</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NUM_COMPLETIONS</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">num_completions</span><span class="p">})</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_model_defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">LLMRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LLMRequest</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rewrite a request to take model-specific defaults into account.</span>

<span class="sd">        A model can carry default values for some of the request fields</span>
<span class="sd">        (e.g. the model name). Thus, requests must be processed through</span>
<span class="sd">        this function right before they are executed or cached.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_send_final_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">LLMRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LLMResponse</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Core method for processing a request.</span>

<span class="sd">        To be overriden by subclasses to implement the core</span>
<span class="sd">        functionality of `send_request`. The latter additionally handles</span>
<span class="sd">        model=specific defaults and caching.</span>

<span class="sd">        This function is allowed to raise exceptions (some</span>
<span class="sd">        provider-specific), including `LLMBusyException` for cases where</span>
<span class="sd">        retrials may be warranted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">stream_request</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">chat</span><span class="p">:</span> <span class="n">Chat</span><span class="p">,</span> <span class="n">options</span><span class="p">:</span> <span class="n">RequestOptions</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stream the text answer to a request.</span>

<span class="sd">        This is currently not used but could be leveraged by the VSCode</span>
<span class="sd">        extension in the future.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">StreamingNotImplemented</span><span class="p">()</span>

    <span class="nd">@final</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">send_request</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">LLMRequest</span><span class="p">,</span> <span class="n">cache</span><span class="p">:</span> <span class="s2">&quot;LLMCache | None&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LLMResponse</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send a request to a model and return the response.</span>

<span class="sd">        This function is allowed to raise exceptions (some</span>
<span class="sd">        provider-specific), including `LLMBusyException` for cases where</span>
<span class="sd">        retrials may be warranted.</span>

<span class="sd">        Attributes:</span>
<span class="sd">            req: The request to send.</span>
<span class="sd">            cache: An optional cache to use for the request.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span> <span class="o">=</span> <span class="n">CachedModel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache</span><span class="p">)</span>
        <span class="n">full_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_model_defaults</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_final_request</span><span class="p">(</span><span class="n">full_req</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="delphyne.stdlib.models.LLM.estimate_budget" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">estimate_budget</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">estimate_budget</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="LLMRequest


  
      dataclass
   (delphyne.stdlib.models.LLMRequest)" href="#delphyne.stdlib.models.LLMRequest">LLMRequest</a></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Budget


  
      dataclass
   (delphyne.core.streams.Budget)" href="../../policies/streams/#delphyne.Budget">Budget</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Estimate the budget that is required to process a request.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">estimate_budget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">LLMRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Budget</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Estimate the budget that is required to process a request.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Budget</span><span class="p">({</span><span class="n">NUM_REQUESTS</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NUM_COMPLETIONS</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">num_completions</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.stdlib.models.LLM.add_model_defaults" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">add_model_defaults</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">add_model_defaults</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="LLMRequest


  
      dataclass
   (delphyne.stdlib.models.LLMRequest)" href="#delphyne.stdlib.models.LLMRequest">LLMRequest</a></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="LLMRequest


  
      dataclass
   (delphyne.stdlib.models.LLMRequest)" href="#delphyne.stdlib.models.LLMRequest">LLMRequest</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Rewrite a request to take model-specific defaults into account.</p>
<p>A model can carry default values for some of the request fields
(e.g. the model name). Thus, requests must be processed through
this function right before they are executed or cached.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add_model_defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">LLMRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LLMRequest</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rewrite a request to take model-specific defaults into account.</span>

<span class="sd">    A model can carry default values for some of the request fields</span>
<span class="sd">    (e.g. the model name). Thus, requests must be processed through</span>
<span class="sd">    this function right before they are executed or cached.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.stdlib.models.LLM.stream_request" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">stream_request</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">stream_request</span><span class="p">(</span><span class="n">chat</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="Chat (delphyne.stdlib.models.Chat)" href="#delphyne.stdlib.models.Chat">Chat</a></span><span class="p">,</span> <span class="n">options</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="RequestOptions (delphyne.stdlib.models.RequestOptions)" href="#delphyne.stdlib.models.RequestOptions">RequestOptions</a></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="collections.abc.AsyncIterable">AsyncIterable</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Stream the text answer to a request.</p>
<p>This is currently not used but could be leveraged by the VSCode
extension in the future.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">stream_request</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">chat</span><span class="p">:</span> <span class="n">Chat</span><span class="p">,</span> <span class="n">options</span><span class="p">:</span> <span class="n">RequestOptions</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stream the text answer to a request.</span>

<span class="sd">    This is currently not used but could be leveraged by the VSCode</span>
<span class="sd">    extension in the future.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="n">StreamingNotImplemented</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="delphyne.stdlib.models.LLM.send_request" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">send_request</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">send_request</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="LLMRequest


  
      dataclass
   (delphyne.stdlib.models.LLMRequest)" href="#delphyne.stdlib.models.LLMRequest">LLMRequest</a></span><span class="p">,</span> <span class="n">cache</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="LLMCache


  
      dataclass
   (delphyne.stdlib.models.LLMCache)" href="#delphyne.stdlib.models.LLMCache">LLMCache</a></span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="LLMResponse


  
      dataclass
   (delphyne.stdlib.models.LLMResponse)" href="#delphyne.stdlib.models.LLMResponse">LLMResponse</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Send a request to a model and return the response.</p>
<p>This function is allowed to raise exceptions (some
provider-specific), including <a class="autorefs autorefs-internal" title="LLMBusyException


  
      dataclass
  " href="#delphyne.stdlib.models.LLMBusyException"><code>LLMBusyException</code></a> for cases where
retrials may be warranted.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.LLM.send_request.req">req</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The request to send.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.LLM.send_request.cache">cache</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An optional cache to use for the request.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@final</span>
<span class="k">def</span><span class="w"> </span><span class="nf">send_request</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">LLMRequest</span><span class="p">,</span> <span class="n">cache</span><span class="p">:</span> <span class="s2">&quot;LLMCache | None&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LLMResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Send a request to a model and return the response.</span>

<span class="sd">    This function is allowed to raise exceptions (some</span>
<span class="sd">    provider-specific), including `LLMBusyException` for cases where</span>
<span class="sd">    retrials may be warranted.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        req: The request to send.</span>
<span class="sd">        cache: An optional cache to use for the request.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="n">CachedModel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache</span><span class="p">)</span>
    <span class="n">full_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_model_defaults</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_final_request</span><span class="p">(</span><span class="n">full_req</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.models.LLMRequest" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">LLMRequest</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">


        <p>An LLM chat completion request.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.LLMRequest.chat">chat</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Chat (delphyne.stdlib.models.Chat)" href="#delphyne.stdlib.models.Chat">Chat</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The chat history.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.LLMRequest.num_completions">num_completions</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of completions to generate. Note
that most LLM providers only bill input tokens once,
regardless of the number of requested completions.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.LLMRequest.options">options</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="RequestOptions (delphyne.stdlib.models.RequestOptions)" href="#delphyne.stdlib.models.RequestOptions">RequestOptions</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Request options.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.LLMRequest.tools">tools</span></code></td>
            <td>
                  <code><span title="collections.abc.Sequence">Sequence</span>[<a class="autorefs autorefs-internal" title="Schema


  
      dataclass
   (delphyne.stdlib.models.Schema)" href="#delphyne.stdlib.models.Schema">Schema</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Available tools.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.LLMRequest.structured_output">structured_output</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Schema


  
      dataclass
   (delphyne.stdlib.models.Schema)" href="#delphyne.stdlib.models.Schema">Schema</a> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Provide a schema to enable structured output,
or <code>None</code> for disabling it.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">LLMRequest</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An LLM chat completion request.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        chat: The chat history.</span>
<span class="sd">        num_completions: The number of completions to generate. Note</span>
<span class="sd">            that most LLM providers only bill input tokens once,</span>
<span class="sd">            regardless of the number of requested completions.</span>
<span class="sd">        options: Request options.</span>
<span class="sd">        tools: Available tools.</span>
<span class="sd">        structured_output: Provide a schema to enable structured output,</span>
<span class="sd">            or `None` for disabling it.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">chat</span><span class="p">:</span> <span class="n">Chat</span>
    <span class="n">num_completions</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">options</span><span class="p">:</span> <span class="n">RequestOptions</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Schema</span><span class="p">]</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">structured_output</span><span class="p">:</span> <span class="n">Schema</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="c1"># LLMRequest needs to be hashable for `CachedModel` to work.</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">repr</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">chat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_completions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)))</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.models.LLMResponse" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">LLMResponse</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">


        <p>Response to an LLM request.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.LLMResponse.outputs">outputs</span></code></td>
            <td>
                  <code><span title="collections.abc.Sequence">Sequence</span>[<a class="autorefs autorefs-internal" title="LLMOutput


  
      dataclass
   (delphyne.stdlib.models.LLMOutput)" href="#delphyne.stdlib.models.LLMOutput">LLMOutput</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Generated completions.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.LLMResponse.budget">budget</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Budget


  
      dataclass
   (delphyne.core.streams.Budget)" href="../../policies/streams/#delphyne.Budget">Budget</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Budget consumed by the request.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.LLMResponse.log_items">log_items</span></code></td>
            <td>
                  <code><span title="list">list</span>[<a class="autorefs autorefs-internal" title="LLMResponseLogItem


  
      dataclass
   (delphyne.stdlib.models.LLMResponseLogItem)" href="#delphyne.stdlib.models.LLMResponseLogItem">LLMResponseLogItem</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Log items generated while evaluating the request.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.LLMResponse.model_name">model_name</span></code></td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the model used for the request, which is
sometimes more detailed than the model name passed in
<a class="autorefs autorefs-internal" title="RequestOptions" href="#delphyne.stdlib.models.RequestOptions"><code>RequestOptions</code></a> (e.g., <code>gpt-4.1-mini-2025-04-14</code> vs
<code>gpt-4.1-mini</code>).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.LLMResponse.usage_info">usage_info</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional usage info metadata, in a
provider-specific format.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">LLMResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Response to an LLM request.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        outputs: Generated completions.</span>
<span class="sd">        budget: Budget consumed by the request.</span>
<span class="sd">        log_items: Log items generated while evaluating the request.</span>
<span class="sd">        model_name: The name of the model used for the request, which is</span>
<span class="sd">            sometimes more detailed than the model name passed in</span>
<span class="sd">            `RequestOptions` (e.g., `gpt-4.1-mini-2025-04-14` vs</span>
<span class="sd">            `gpt-4.1-mini`).</span>
<span class="sd">        usage_info: Additional usage info metadata, in a</span>
<span class="sd">            provider-specific format.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">outputs</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">LLMOutput</span><span class="p">]</span>
    <span class="n">budget</span><span class="p">:</span> <span class="n">Budget</span>
    <span class="n">log_items</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">LLMResponseLogItem</span><span class="p">]</span>
    <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">usage_info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.models.AbstractTool" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">AbstractTool</span>


</h3>


    <div class="doc doc-contents first">


        <p>Base class for an LLM tool interface.</p>
<p>A new tool interface can be added by defining a dataclass <code>S</code> that
inherits <code>AbstractTool[T]</code>, with <code>T</code> the tool output type. Instances
of <code>S</code> correspond to tool calls, and an actual tool implementation
maps values of type <code>S</code> to values of type <code>T</code>.</p>
<p>A JSON tool specification can be extracted through the
<code>tool_name</code>, <code>tool_description</code> and <code>tool_answer_type</code> class
methods. The <code>render_result</code> method describes how to render the
output of a tool implementation, in a way that can be added back as
a message in a chat history.</p>







              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AbstractTool</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for an LLM tool interface.</span>

<span class="sd">    A new tool interface can be added by defining a dataclass `S` that</span>
<span class="sd">    inherits `AbstractTool[T]`, with `T` the tool output type. Instances</span>
<span class="sd">    of `S` correspond to tool calls, and an actual tool implementation</span>
<span class="sd">    maps values of type `S` to values of type `T`.</span>

<span class="sd">    A JSON tool specification can be extracted through the</span>
<span class="sd">    `tool_name`, `tool_description` and `tool_answer_type` class</span>
<span class="sd">    methods. The `render_result` method describes how to render the</span>
<span class="sd">    output of a tool implementation, in a way that can be added back as</span>
<span class="sd">    a message in a chat history.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">tool_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tool_name_of_class_name</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">tool_description</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">tool_answer_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypeAnnot</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">dpi</span><span class="o">.</span><span class="n">first_parameter_of_base_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">render_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Structured</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">res</span>
        <span class="n">ans_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool_answer_type</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Structured</span><span class="p">(</span><span class="n">pydantic_dump</span><span class="p">(</span><span class="n">ans_type</span><span class="p">,</span> <span class="n">res</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="delphyne.stdlib.models.Chat" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">Chat</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">Chat</span><span class="p">:</span> <span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="ChatMessage (delphyne.stdlib.models.ChatMessage)" href="#delphyne.stdlib.models.ChatMessage">ChatMessage</a></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents first">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="delphyne.stdlib.models.ChatMessage" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">ChatMessage</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">ChatMessage</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="SystemMessage


  
      dataclass
   (delphyne.stdlib.models.SystemMessage)" href="#delphyne.stdlib.models.SystemMessage">SystemMessage</a></span> <span class="o">|</span> <span class="n"><a class="autorefs autorefs-internal" title="UserMessage


  
      dataclass
   (delphyne.stdlib.models.UserMessage)" href="#delphyne.stdlib.models.UserMessage">UserMessage</a></span> <span class="o">|</span> <span class="n"><a class="autorefs autorefs-internal" title="AssistantMessage


  
      dataclass
   (delphyne.stdlib.models.AssistantMessage)" href="#delphyne.stdlib.models.AssistantMessage">AssistantMessage</a></span> <span class="o">|</span> <span class="n"><a class="autorefs autorefs-internal" title="ToolMessage


  
      dataclass
   (delphyne.stdlib.models.ToolMessage)" href="#delphyne.stdlib.models.ToolMessage">ToolMessage</a></span>
</code></pre></div>

    <div class="doc doc-contents first">

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.models.SystemMessage" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">SystemMessage</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">








              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SystemMessage</span><span class="p">:</span>
    <span class="n">role</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">]</span>  <span class="c1"># for deserialization</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># to bypass the frozen dataclass check</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;role&quot;</span><span class="p">,</span> <span class="s2">&quot;system&quot;</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.models.UserMessage" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">UserMessage</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">








              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UserMessage</span><span class="p">:</span>
    <span class="n">role</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;role&quot;</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.models.AssistantMessage" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">AssistantMessage</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">








              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">AssistantMessage</span><span class="p">:</span>
    <span class="n">role</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;assistant&quot;</span><span class="p">]</span>
    <span class="n">answer</span><span class="p">:</span> <span class="n">Answer</span>  <span class="c1"># Note: the mode does not really matter for the LLM.</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">answer</span><span class="p">:</span> <span class="n">Answer</span><span class="p">):</span>
        <span class="c1"># to bypass the frozen dataclass check</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;role&quot;</span><span class="p">,</span> <span class="s2">&quot;assistant&quot;</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;answer&quot;</span><span class="p">,</span> <span class="n">answer</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.models.ToolMessage" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">ToolMessage</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">








              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ToolMessage</span><span class="p">:</span>
    <span class="n">role</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;tool&quot;</span><span class="p">]</span>
    <span class="n">call</span><span class="p">:</span> <span class="n">ToolCall</span>
    <span class="n">result</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Structured</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">call</span><span class="p">:</span> <span class="n">ToolCall</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Structured</span><span class="p">):</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;role&quot;</span><span class="p">,</span> <span class="s2">&quot;tool&quot;</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;call&quot;</span><span class="p">,</span> <span class="n">call</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;result&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.models.RequestOptions" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">RequestOptions</span>


</h3>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="typing.TypedDict">TypedDict</span></code></p>


        <p>LLM request options, inspired from the OpenAI chat API.</p>
<p>All values are optional.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.RequestOptions.model">model</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the model to use for the request.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.RequestOptions.reasoning_effort">reasoning_effort</span></code></td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;minimal&#39;, &#39;low&#39;, &#39;medium&#39;, &#39;high&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The reasoning effort to use for the request,
when applicable (e.g., for GPT-5 or o3).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.RequestOptions.tool_choice">tool_choice</span></code></td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;auto&#39;, &#39;none&#39;, &#39;required&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How the model should select which tool (or tools)
to use when generating a response. <code>none</code> means the model
will not call any tool and instead generates a message.
<code>auto</code> means the model can pick between generating a message
or calling one or more tools. <code>required</code> means the model must
call one or more tools.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.RequestOptions.temperature">temperature</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The temperature to use for sampling, as a value
between 0 and 2.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.RequestOptions.max_completion_tokens">max_completion_tokens</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum number of tokens to generate.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.RequestOptions.logprobs">logprobs</span></code></td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to return log probabilities for the generated
tokens.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.RequestOptions.top_logprobs">top_logprobs</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of top log probabilities to return for
each generated token, as an integer between 0 and 20.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">RequestOptions</span><span class="p">(</span><span class="n">typing</span><span class="o">.</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    LLM request options, inspired from the OpenAI chat API.</span>

<span class="sd">    All values are optional.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        model: The name of the model to use for the request.</span>
<span class="sd">        reasoning_effort: The reasoning effort to use for the request,</span>
<span class="sd">            when applicable (e.g., for GPT-5 or o3).</span>
<span class="sd">        tool_choice: How the model should select which tool (or tools)</span>
<span class="sd">            to use when generating a response. `none` means the model</span>
<span class="sd">            will not call any tool and instead generates a message.</span>
<span class="sd">            `auto` means the model can pick between generating a message</span>
<span class="sd">            or calling one or more tools. `required` means the model must</span>
<span class="sd">            call one or more tools.</span>
<span class="sd">        temperature: The temperature to use for sampling, as a value</span>
<span class="sd">            between 0 and 2.</span>
<span class="sd">        max_completion_tokens: The maximum number of tokens to generate.</span>
<span class="sd">        logprobs: Whether to return log probabilities for the generated</span>
<span class="sd">            tokens.</span>
<span class="sd">        top_logprobs: The number of top log probabilities to return for</span>
<span class="sd">            each generated token, as an integer between 0 and 20.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">model</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">reasoning_effort</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;minimal&quot;</span><span class="p">,</span> <span class="s2">&quot;low&quot;</span><span class="p">,</span> <span class="s2">&quot;medium&quot;</span><span class="p">,</span> <span class="s2">&quot;high&quot;</span><span class="p">]</span>
    <span class="n">tool_choice</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;required&quot;</span><span class="p">]</span>
    <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">max_completion_tokens</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">logprobs</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">top_logprobs</span><span class="p">:</span> <span class="nb">int</span>  <span class="c1"># from 0 to 20</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.models.Schema" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">Schema</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">


        <p>The description of a schema for structured output or tool use.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.Schema.name">name</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the tool or structured output type.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.Schema.description">description</span></code></td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional description.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.Schema.schema">schema</span></code></td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The JSON schema of the tool or structured output type,
typically generated using pydantic's <code>json_schema</code> method.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Schema</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The description of a schema for structured output or tool use.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        name: Name of the tool or structured output type.</span>
<span class="sd">        description: Optional description.</span>
<span class="sd">        schema: The JSON schema of the tool or structured output type,</span>
<span class="sd">            typically generated using pydantic&#39;s `json_schema` method.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="n">schema</span><span class="p">:</span> <span class="n">Any</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">make</span><span class="p">(</span><span class="n">tool</span><span class="p">:</span> <span class="n">TypeAnnot</span><span class="p">[</span><span class="nb">object</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Schema&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build a schema from a Python class or tool interface.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
            <span class="c1"># Assert that it is a type alias</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">TypeAliasType</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tool</span><span class="p">)</span>
            <span class="n">description</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">AbstractTool</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">tool</span><span class="o">.</span><span class="n">tool_name</span><span class="p">()</span>
            <span class="n">description</span> <span class="o">=</span> <span class="n">tool</span><span class="o">.</span><span class="n">tool_description</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">tool_name_of_class_name</span><span class="p">(</span><span class="n">tool</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="n">description</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">tool</span><span class="p">))</span>
        <span class="n">adapter</span> <span class="o">=</span> <span class="n">pydantic</span><span class="o">.</span><span class="n">TypeAdapter</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">tool</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">Schema</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
            <span class="n">schema</span><span class="o">=</span><span class="n">adapter</span><span class="o">.</span><span class="n">json_schema</span><span class="p">(),</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="delphyne.stdlib.models.Schema.make" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">make</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">make</span><span class="p">(</span><span class="n">tool</span><span class="p">:</span> <span class="n"><span title="delphyne.utils.typing.TypeAnnot">TypeAnnot</span></span><span class="p">[</span><span class="n"><span title="object">object</span></span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Schema


  
      dataclass
   (delphyne.stdlib.models.Schema)" href="#delphyne.stdlib.models.Schema">Schema</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Build a schema from a Python class or tool interface.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">make</span><span class="p">(</span><span class="n">tool</span><span class="p">:</span> <span class="n">TypeAnnot</span><span class="p">[</span><span class="nb">object</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Schema&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a schema from a Python class or tool interface.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
        <span class="c1"># Assert that it is a type alias</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">TypeAliasType</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tool</span><span class="p">)</span>
        <span class="n">description</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">AbstractTool</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">tool</span><span class="o">.</span><span class="n">tool_name</span><span class="p">()</span>
        <span class="n">description</span> <span class="o">=</span> <span class="n">tool</span><span class="o">.</span><span class="n">tool_description</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">tool_name_of_class_name</span><span class="p">(</span><span class="n">tool</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">description</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">tool</span><span class="p">))</span>
    <span class="n">adapter</span> <span class="o">=</span> <span class="n">pydantic</span><span class="o">.</span><span class="n">TypeAdapter</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">tool</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">Schema</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
        <span class="n">schema</span><span class="o">=</span><span class="n">adapter</span><span class="o">.</span><span class="n">json_schema</span><span class="p">(),</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.models.LLMOutput" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">LLMOutput</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">


        <p>A single LLM chat completion.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.LLMOutput.content">content</span></code></td>
            <td>
                  <code><span title="str">str</span> | <a class="autorefs autorefs-internal" title="Structured


  
      dataclass
   (delphyne.core.refs.Structured)" href="../../strategies/traces/#delphyne.Structured">Structured</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The completion content, as a string or as a structured
object (if structured output was requested).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.LLMOutput.tool_calls">tool_calls</span></code></td>
            <td>
                  <code><span title="collections.abc.Sequence">Sequence</span>[<a class="autorefs autorefs-internal" title="ToolCall


  
      dataclass
   (delphyne.core.refs.ToolCall)" href="../../strategies/traces/#delphyne.ToolCall">ToolCall</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A sequence of tool calls made by the model, if any.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.LLMOutput.finish_reason">finish_reason</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="FinishReason (delphyne.stdlib.models.FinishReason)" href="#delphyne.stdlib.models.FinishReason">FinishReason</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The reason why the model stopped generating
content.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.LLMOutput.logprobs">logprobs</span></code></td>
            <td>
                  <code><span title="collections.abc.Sequence">Sequence</span>[<a class="autorefs autorefs-internal" title="TokenInfo


  
      dataclass
   (delphyne.stdlib.models.TokenInfo)" href="#delphyne.stdlib.models.TokenInfo">TokenInfo</a>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional sequence of token log probabilities, if
requested.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.LLMOutput.reasoning_content">reasoning_content</span></code></td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Reasoning chain of thoughts, if provided (the
DeepSeek API returns reasoning tokens, while the OpenAI API
generally does not).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">LLMOutput</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A single LLM chat completion.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        content: The completion content, as a string or as a structured</span>
<span class="sd">            object (if structured output was requested).</span>
<span class="sd">        tool_calls: A sequence of tool calls made by the model, if any.</span>
<span class="sd">        finish_reason: The reason why the model stopped generating</span>
<span class="sd">            content.</span>
<span class="sd">        logprobs: Optional sequence of token log probabilities, if</span>
<span class="sd">            requested.</span>
<span class="sd">        reasoning_content: Reasoning chain of thoughts, if provided (the</span>
<span class="sd">            DeepSeek API returns reasoning tokens, while the OpenAI API</span>
<span class="sd">            generally does not).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Structured</span>
    <span class="n">tool_calls</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ToolCall</span><span class="p">]</span>
    <span class="n">finish_reason</span><span class="p">:</span> <span class="n">FinishReason</span>
    <span class="n">logprobs</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">TokenInfo</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">reasoning_content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="delphyne.stdlib.models.FinishReason" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">FinishReason</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">FinishReason</span><span class="p">:</span> <span class="n"><span title="typing.Literal">Literal</span></span><span class="p">[</span><span class="s1">&#39;stop&#39;</span><span class="p">,</span> <span class="s1">&#39;length&#39;</span><span class="p">,</span> <span class="s1">&#39;content_filter&#39;</span><span class="p">,</span> <span class="s1">&#39;tool_calls&#39;</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Reason why the LLM stopped generating content.</p>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.models.DummyModel" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">DummyModel</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="LLM (delphyne.stdlib.models.LLM)" href="#delphyne.stdlib.models.LLM">LLM</a></code></p>


        <p>A model that always fails to generate completions.</p>
<p>Used by the <code>answer_query</code> command in particular.</p>







              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DummyModel</span><span class="p">(</span><span class="n">LLM</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A model that always fails to generate completions.</span>

<span class="sd">    Used by the `answer_query` command in particular.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_model_defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">LLMRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LLMRequest</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">req</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_send_final_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">LLMRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LLMResponse</span><span class="p">:</span>
        <span class="n">budget</span> <span class="o">=</span> <span class="n">Budget</span><span class="p">({</span><span class="n">NUM_REQUESTS</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">num_completions</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">LLMResponse</span><span class="p">(</span>
            <span class="n">outputs</span><span class="o">=</span><span class="p">[],</span> <span class="n">budget</span><span class="o">=</span><span class="n">budget</span><span class="p">,</span> <span class="n">log_items</span><span class="o">=</span><span class="p">[],</span> <span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;&lt;dummy&gt;&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.models.WithRetry" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">WithRetry</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="LLM (delphyne.stdlib.models.LLM)" href="#delphyne.stdlib.models.LLM">LLM</a></code></p>


        <p>Retrying with exponential backoff.</p>







              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">WithRetry</span><span class="p">(</span><span class="n">LLM</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrying with exponential backoff.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">model</span><span class="p">:</span> <span class="n">LLM</span>
    <span class="n">num_attempts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">base_delay_seconds</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">exponential_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span>
    <span class="n">delay_noise</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mf">0.1</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_model_defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">LLMRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LLMRequest</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_model_defaults</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">estimate_budget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">LLMRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Budget</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">estimate_budget</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">retry_delays</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">random</span>

        <span class="n">acc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_delay_seconds</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_attempts</span><span class="p">):</span>
            <span class="n">delay</span> <span class="o">=</span> <span class="n">acc</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delay_noise</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">delay</span> <span class="o">+=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delay_noise</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">delay</span>
            <span class="n">acc</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exponential_factor</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_send_final_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">LLMRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LLMResponse</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">retry_delay</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">retry_delays</span><span class="p">(),</span> <span class="kc">None</span><span class="p">]):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">send_request</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">log_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">LLMResponseLogItem</span><span class="p">(</span>
                            <span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="s2">&quot;successful_retry&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;delay&quot;</span><span class="p">:</span> <span class="n">retry_delay</span><span class="p">}</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">return</span> <span class="n">ret</span>
            <span class="k">except</span> <span class="n">LLMBusyException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">retry_delay</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">retry_delay</span><span class="p">)</span>
        <span class="k">assert</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.models.CachedModel" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">CachedModel</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="LLM (delphyne.stdlib.models.LLM)" href="#delphyne.stdlib.models.LLM">LLM</a></code></p>


        <p>Wrap a model to use a given cache.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code>LLM.send_request</code> method has a <code>cache</code> argument that can be
used as a replacement for the <a class="autorefs autorefs-internal" title="CachedModel


  
      dataclass
  " href="#delphyne.stdlib.models.CachedModel"><code>CachedModel</code></a> wrapper. In
addition, all standard prompting policies use a global request
cache (see <a class="autorefs autorefs-internal" title="PolicyEnv" href="../../policies/envs/#delphyne.PolicyEnv"><code>PolicyEnv</code></a>) when available. Thus, external users
should rarely need to manually wrap models with <a class="autorefs autorefs-internal" title="CachedModel


  
      dataclass
  " href="#delphyne.stdlib.models.CachedModel"><code>CachedModel</code></a>.</p>
</div>







              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CachedModel</span><span class="p">(</span><span class="n">LLM</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrap a model to use a given cache.</span>

<span class="sd">    !!! note</span>
<span class="sd">        The `LLM.send_request` method has a `cache` argument that can be</span>
<span class="sd">        used as a replacement for the `CachedModel` wrapper. In</span>
<span class="sd">        addition, all standard prompting policies use a global request</span>
<span class="sd">        cache (see `PolicyEnv`) when available. Thus, external users</span>
<span class="sd">        should rarely need to manually wrap models with `CachedModel`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">model</span><span class="p">:</span> <span class="n">LLM</span>
    <span class="n">cache</span><span class="p">:</span> <span class="n">LLMCache</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nd">@cache</span><span class="p">(</span>
            <span class="n">cache_spec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span>
            <span class="n">hash_arg</span><span class="o">=</span><span class="n">_CachedRequest</span><span class="o">.</span><span class="n">stable_repr</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">run_request</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">_CachedRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LLMResponse</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">request</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">send_request</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">run_request</span> <span class="o">=</span> <span class="n">run_request</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_send_final_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">LLMRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LLMResponse</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">num_seen</span><span class="p">[</span><span class="n">req</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">num_seen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">num_seen</span><span class="p">[</span><span class="n">req</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_request</span><span class="p">(</span><span class="n">_CachedRequest</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">num_seen</span><span class="p">))</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">estimate_budget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">LLMRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Budget</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">estimate_budget</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_model_defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">LLMRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LLMRequest</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_model_defaults</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.models.LLMCache" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">LLMCache</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">


        <p>A cache for LLM requests.</p>
<p>More precisely, what are cached are <code>(r, i)</code> pairs where <code>r</code> is a
request and <code>i</code> is the number of times the request has been answered
since the model was instantiated. This way, caching works even when
a policy samples multiple answers for the same request.</p>
<p>Multiple models can share the same cache.</p>







              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">LLMCache</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A cache for LLM requests.</span>

<span class="sd">    More precisely, what are cached are `(r, i)` pairs where `r` is a</span>
<span class="sd">    request and `i` is the number of times the request has been answered</span>
<span class="sd">    since the model was instantiated. This way, caching works even when</span>
<span class="sd">    a policy samples multiple answers for the same request.</span>

<span class="sd">    Multiple models can share the same cache.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">spec</span><span class="p">:</span> <span class="n">CacheSpec</span>
    <span class="n">num_seen</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">LLMRequest</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">CacheSpec</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spec</span> <span class="o">=</span> <span class="n">spec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_seen</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">LLMRequest</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.models.Token" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">Token</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">


        <p>A token produced by an LLM.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.Token.token">token</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>String representation of the token.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.models.Token.bytes">bytes</span></code></td>
            <td>
                  <code><span title="collections.abc.Sequence">Sequence</span>[<span title="int">int</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional sequence of integers representing the token's
byte encoding.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Token</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A token produced by an LLM.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        token: String representation of the token.</span>
<span class="sd">        bytes: Optional sequence of integers representing the token&#39;s</span>
<span class="sd">            byte encoding.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">token</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">bytes</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.models.TokenInfo" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">TokenInfo</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">


        <p>Logprob information for a single token.</p>







              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TokenInfo</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Logprob information for a single token.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">token</span><span class="p">:</span> <span class="n">Token</span>
    <span class="n">logprob</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">top_logprobs</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Token</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.models.ModelPricing" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">ModelPricing</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">








              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ModelPricing</span><span class="p">:</span>
    <span class="n">dollars_per_input_token</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">dollars_per_cached_input_token</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">dollars_per_output_token</span><span class="p">:</span> <span class="nb">float</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.models.LLMResponseLogItem" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">LLMResponseLogItem</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">








              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">LLMResponseLogItem</span><span class="p">:</span>
    <span class="n">severity</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="s2">&quot;warning&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">]</span>
    <span class="n">message</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.models.LLMBusyException" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">LLMBusyException</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="Exception">Exception</span></code></p>


        <p>This exception should be raised when an LLM call failed due to a
timeout or a rate limit error that warrants a retry. In particular,
it should not be raised for ill-formed requests (those assumptions
should not be caught) or when the LLM gave a bad answer (in which
case budget was consumed and should be counted, while errors are
added into <a class="autorefs autorefs-internal" title="LLMResponse


  
      dataclass
  " href="#delphyne.stdlib.models.LLMResponse"><code>LLMResponse</code></a>).</p>
<p>See <a class="autorefs autorefs-internal" title="WithRetry


  
      dataclass
  " href="#delphyne.stdlib.models.WithRetry"><code>WithRetry</code></a> for adding retrial logic to LLMs.</p>







              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">LLMBusyException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This exception should be raised when an LLM call failed due to a</span>
<span class="sd">    timeout or a rate limit error that warrants a retry. In particular,</span>
<span class="sd">    it should not be raised for ill-formed requests (those assumptions</span>
<span class="sd">    should not be caught) or when the LLM gave a bad answer (in which</span>
<span class="sd">    case budget was consumed and should be counted, while errors are</span>
<span class="sd">    added into `LLMResponse`).</span>

<span class="sd">    See `WithRetry` for adding retrial logic to LLMs.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">exn</span><span class="p">:</span> <span class="ne">Exception</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exn</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="delphyne.stdlib.models.BudgetCategory" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">BudgetCategory</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">BudgetCategory</span><span class="p">:</span> <span class="n"><span title="typing.Literal">Literal</span></span><span class="p">[</span><span class="s1">&#39;num_requests&#39;</span><span class="p">,</span> <span class="s1">&#39;num_completions&#39;</span><span class="p">,</span> <span class="s1">&#39;input_tokens&#39;</span><span class="p">,</span> <span class="s1">&#39;cached_input_tokens&#39;</span><span class="p">,</span> <span class="s1">&#39;output_tokens&#39;</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Standard metrics to measure LLM inference usage.</p>

    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="delphyne.stdlib.models.budget_entry" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">budget_entry</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">budget_entry</span><span class="p">(</span><span class="n">category</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="BudgetCategory (delphyne.stdlib.models.BudgetCategory)" href="#delphyne.stdlib.models.BudgetCategory">BudgetCategory</a></span><span class="p">,</span> <span class="n">model_class</span><span class="p">:</span> <span class="n"><span title="str">str</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="str">str</span></span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Return a string that can be used as a key in a budget dictionary.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/models.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">budget_entry</span><span class="p">(</span>
    <span class="n">category</span><span class="p">:</span> <span class="n">BudgetCategory</span><span class="p">,</span> <span class="n">model_class</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a string that can be used as a key in a budget dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">category</span>
    <span class="k">if</span> <span class="n">model_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">res</span><span class="si">}{</span><span class="n">BUDGET_ENTRY_SEPARATOR</span><span class="si">}{</span><span class="n">model_class</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">res</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="delphyne.stdlib.models.NUM_REQUESTS" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">NUM_REQUESTS</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">NUM_REQUESTS</span> <span class="o">=</span> <span class="s1">&#39;num_requests&#39;</span>
</code></pre></div>

    <div class="doc doc-contents first">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="delphyne.stdlib.models.NUM_COMPLETIONS" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">NUM_COMPLETIONS</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">NUM_COMPLETIONS</span> <span class="o">=</span> <span class="s1">&#39;num_completions&#39;</span>
</code></pre></div>

    <div class="doc doc-contents first">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="delphyne.stdlib.models.NUM_INPUT_TOKENS" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">NUM_INPUT_TOKENS</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">NUM_INPUT_TOKENS</span> <span class="o">=</span> <span class="s1">&#39;input_tokens&#39;</span>
</code></pre></div>

    <div class="doc doc-contents first">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="delphyne.stdlib.models.NUM_CACHED_INPUT_TOKENS" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">NUM_CACHED_INPUT_TOKENS</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">NUM_CACHED_INPUT_TOKENS</span> <span class="o">=</span> <span class="s1">&#39;cached_input_tokens&#39;</span>
</code></pre></div>

    <div class="doc doc-contents first">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="delphyne.stdlib.models.NUM_OUTPUT_TOKENS" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">NUM_OUTPUT_TOKENS</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">NUM_OUTPUT_TOKENS</span> <span class="o">=</span> <span class="s1">&#39;output_tokens&#39;</span>
</code></pre></div>

    <div class="doc doc-contents first">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="delphyne.stdlib.models.DOLLAR_PRICE" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">DOLLAR_PRICE</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">DOLLAR_PRICE</span> <span class="o">=</span> <span class="s1">&#39;price&#39;</span>
</code></pre></div>

    <div class="doc doc-contents first">

    </div>

</div>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["content.code.annotate", "content.code.copy", "content.tabs.link", "navigation.indexes"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.92b07e13.min.js"></script>
      
        <script src="../../../javascript/katex.js"></script>
      
        <script src="https://unpkg.com/katex@0/dist/katex.min.js"></script>
      
        <script src="https://unpkg.com/katex@0/dist/contrib/auto-render.min.js"></script>
      
    
  </body>
</html>