
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../effects/">
      
      
        <link rel="next" href="../commands/">
      
      
      <link rel="icon" href="../../../None">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.21">
    
    
      
        <title>Algorithms - Delphyne</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.2a3383ac.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="https://unpkg.com/katex@0/dist/katex.min.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#search-algorithms-and-utilities" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Delphyne" class="md-header__button md-logo" aria-label="Delphyne" data-md-component="logo">
      
  <img src="../../../assets/logos/white/mini.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Delphyne
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Algorithms
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Delphyne" class="md-nav__button md-logo" aria-label="Delphyne" data-md-component="logo">
      
  <img src="../../../assets/logos/white/mini.png" alt="logo">

    </a>
    Delphyne
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Manual
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Manual
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../manual/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../manual/strategies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Strategy Language
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../manual/policies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Policy Language
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../manual/demos/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Demonstration Language
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../manual/extension/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    VSCode Extension
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../how-to-guides/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    How-To Guides
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" >
        
          
          <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Strategy Language
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            Strategy Language
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../strategies/trees/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Trees and Spaces
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../strategies/strategies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Strategies and Reification
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../strategies/queries/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Queries and Chats
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../strategies/traces/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    References and Traces
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../strategies/misc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Miscellaneous
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Policy Language
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            Policy Language
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../policies/definitions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Definitions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../policies/streams/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Search Streams
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3" >
        
          
          <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Demonstration Language
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            Demonstration Language
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../demos/definitions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Definitions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../demos/interpreter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Interpreter
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4_4" id="__nav_4_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Standard Library
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4_4">
            <span class="md-nav__icon md-icon"></span>
            Standard Library
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../basic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Basic
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../queries/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Queries
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../streams/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Streams
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../environments/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Environments
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../effects/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Effects
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Algorithms
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Algorithms
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#strategies" class="md-nav__link">
    <span class="md-ellipsis">
      Strategies
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Strategies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.interact" class="md-nav__link">
    <span class="md-ellipsis">
      interact
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.InteractStats" class="md-nav__link">
    <span class="md-ellipsis">
      InteractStats
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#policies" class="md-nav__link">
    <span class="md-ellipsis">
      Policies
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Policies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.search.dfs.dfs" class="md-nav__link">
    <span class="md-ellipsis">
      dfs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.search.dfs.par_dfs" class="md-nav__link">
    <span class="md-ellipsis">
      par_dfs
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#combinators" class="md-nav__link">
    <span class="md-ellipsis">
      Combinators
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Combinators">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.sequence" class="md-nav__link">
    <span class="md-ellipsis">
      sequence
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.parallel" class="md-nav__link">
    <span class="md-ellipsis">
      parallel
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.or_else" class="md-nav__link">
    <span class="md-ellipsis">
      or_else
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.nofail" class="md-nav__link">
    <span class="md-ellipsis">
      nofail
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.iterate" class="md-nav__link">
    <span class="md-ellipsis">
      iterate
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#opaque-spaces-sugar" class="md-nav__link">
    <span class="md-ellipsis">
      Opaque Spaces Sugar
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Opaque Spaces Sugar">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.ambient_pp" class="md-nav__link">
    <span class="md-ellipsis">
      ambient_pp
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.ambient" class="md-nav__link">
    <span class="md-ellipsis">
      ambient
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#universal-queries" class="md-nav__link">
    <span class="md-ellipsis">
      Universal Queries
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Universal Queries">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.UniversalQuery" class="md-nav__link">
    <span class="md-ellipsis">
      UniversalQuery
    </span>
  </a>
  
    <nav class="md-nav" aria-label="UniversalQuery">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.UniversalQuery.strategy_source" class="md-nav__link">
    <span class="md-ellipsis">
      strategy_source
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.guess" class="md-nav__link">
    <span class="md-ellipsis">
      guess
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#best-first-search" class="md-nav__link">
    <span class="md-ellipsis">
      Best-First Search
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Best-First Search">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.best_first_search" class="md-nav__link">
    <span class="md-ellipsis">
      best_first_search
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#abduction" class="md-nav__link">
    <span class="md-ellipsis">
      Abduction
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Abduction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.Abduction" class="md-nav__link">
    <span class="md-ellipsis">
      Abduction
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.abduction" class="md-nav__link">
    <span class="md-ellipsis">
      abduction
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.abduct_recursively" class="md-nav__link">
    <span class="md-ellipsis">
      abduct_recursively
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.abduct_and_saturate" class="md-nav__link">
    <span class="md-ellipsis">
      abduct_and_saturate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.search.abduction.ScoringFunction" class="md-nav__link">
    <span class="md-ellipsis">
      ScoringFunction
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ScoringFunction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.search.abduction.ScoringFunction.__call__" class="md-nav__link">
    <span class="md-ellipsis">
      __call__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.search.abduction._default_scoring_function" class="md-nav__link">
    <span class="md-ellipsis">
      _default_scoring_function
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../commands/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Commands
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../experiments/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Experiments
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Delphyne CLI
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#strategies" class="md-nav__link">
    <span class="md-ellipsis">
      Strategies
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Strategies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.interact" class="md-nav__link">
    <span class="md-ellipsis">
      interact
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.InteractStats" class="md-nav__link">
    <span class="md-ellipsis">
      InteractStats
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#policies" class="md-nav__link">
    <span class="md-ellipsis">
      Policies
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Policies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.search.dfs.dfs" class="md-nav__link">
    <span class="md-ellipsis">
      dfs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.search.dfs.par_dfs" class="md-nav__link">
    <span class="md-ellipsis">
      par_dfs
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#combinators" class="md-nav__link">
    <span class="md-ellipsis">
      Combinators
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Combinators">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.sequence" class="md-nav__link">
    <span class="md-ellipsis">
      sequence
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.parallel" class="md-nav__link">
    <span class="md-ellipsis">
      parallel
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.or_else" class="md-nav__link">
    <span class="md-ellipsis">
      or_else
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.nofail" class="md-nav__link">
    <span class="md-ellipsis">
      nofail
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.iterate" class="md-nav__link">
    <span class="md-ellipsis">
      iterate
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#opaque-spaces-sugar" class="md-nav__link">
    <span class="md-ellipsis">
      Opaque Spaces Sugar
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Opaque Spaces Sugar">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.ambient_pp" class="md-nav__link">
    <span class="md-ellipsis">
      ambient_pp
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.ambient" class="md-nav__link">
    <span class="md-ellipsis">
      ambient
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#universal-queries" class="md-nav__link">
    <span class="md-ellipsis">
      Universal Queries
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Universal Queries">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.UniversalQuery" class="md-nav__link">
    <span class="md-ellipsis">
      UniversalQuery
    </span>
  </a>
  
    <nav class="md-nav" aria-label="UniversalQuery">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.UniversalQuery.strategy_source" class="md-nav__link">
    <span class="md-ellipsis">
      strategy_source
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.guess" class="md-nav__link">
    <span class="md-ellipsis">
      guess
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#best-first-search" class="md-nav__link">
    <span class="md-ellipsis">
      Best-First Search
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Best-First Search">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.best_first_search" class="md-nav__link">
    <span class="md-ellipsis">
      best_first_search
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#abduction" class="md-nav__link">
    <span class="md-ellipsis">
      Abduction
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Abduction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.Abduction" class="md-nav__link">
    <span class="md-ellipsis">
      Abduction
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.abduction" class="md-nav__link">
    <span class="md-ellipsis">
      abduction
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.abduct_recursively" class="md-nav__link">
    <span class="md-ellipsis">
      abduct_recursively
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.abduct_and_saturate" class="md-nav__link">
    <span class="md-ellipsis">
      abduct_and_saturate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.search.abduction.ScoringFunction" class="md-nav__link">
    <span class="md-ellipsis">
      ScoringFunction
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ScoringFunction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.search.abduction.ScoringFunction.__call__" class="md-nav__link">
    <span class="md-ellipsis">
      __call__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.search.abduction._default_scoring_function" class="md-nav__link">
    <span class="md-ellipsis">
      _default_scoring_function
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="search-algorithms-and-utilities">Search Algorithms and Utilities</h1>
<h2 id="strategies">Strategies</h2>


<div class="doc doc-object doc-function">


<h3 id="delphyne.interact" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">interact</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">interact</span><span class="p">(</span>
    <span class="n">step</span><span class="p">:</span> <span class="n"><span title="collections.abc.Callable">Callable</span></span><span class="p">[</span>
        <span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="AnswerPrefix (delphyne.core.AnswerPrefix)" href="../../strategies/queries/#delphyne.AnswerPrefix">AnswerPrefix</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-internal" title="InteractStats


  
      dataclass
   (delphyne.stdlib.search.interactive.InteractStats)" href="#delphyne.InteractStats">InteractStats</a></span><span class="p">],</span> <span class="n"><a class="autorefs autorefs-internal" title="Opaque (delphyne.stdlib.opaque.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.interactive.interact[P]">P</span></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-internal" title="Response


  
      dataclass
   (delphyne.stdlib.queries.Response)" href="../queries/#delphyne.Response">Response</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.interactive.interact[A]">A</span></span> <span class="o">|</span> <span class="n"><a class="autorefs autorefs-internal" title="WrappedParseError


  
      dataclass
   (delphyne.stdlib.queries.WrappedParseError)" href="../queries/#delphyne.WrappedParseError">WrappedParseError</a></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.search.interactive.interact[T]">T</span></span><span class="p">]]</span>
    <span class="p">],</span>
    <span class="n">process</span><span class="p">:</span> <span class="n"><span title="collections.abc.Callable">Callable</span></span><span class="p">[[</span><span class="n"><span title="delphyne.stdlib.search.interactive.interact[A]">A</span></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-internal" title="InteractStats


  
      dataclass
   (delphyne.stdlib.search.interactive.InteractStats)" href="#delphyne.InteractStats">InteractStats</a></span><span class="p">],</span> <span class="n"><a class="autorefs autorefs-internal" title="Opaque (delphyne.stdlib.opaque.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.interactive.interact[P]">P</span></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.search.interactive.interact[B]">B</span></span> <span class="o">|</span> <span class="n"><a class="autorefs autorefs-internal" title="Error


  
      dataclass
   (delphyne.core.Error)" href="../../strategies/misc/#delphyne.Error">Error</a></span><span class="p">]],</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n"><span title="collections.abc.Mapping">Mapping</span></span><span class="p">[</span><span class="n"><span title="type">type</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.interactive.interact[T]">T</span></span><span class="p">],</span> <span class="n"><span title="collections.abc.Callable">Callable</span></span><span class="p">[[</span><span class="n"><span title="typing.Any">Any</span></span><span class="p">],</span> <span class="n"><a class="autorefs autorefs-internal" title="Opaque (delphyne.stdlib.opaque.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.interactive.interact[P]">P</span></span><span class="p">,</span> <span class="n"><span title="typing.Any">Any</span></span><span class="p">]]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">inner_policy_type</span><span class="p">:</span> <span class="n"><span title="type">type</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.interactive.interact[P]">P</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Strategy (delphyne.core.Strategy)" href="../../strategies/strategies/#delphyne.Strategy">Strategy</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="Branch


  
      dataclass
   (delphyne.stdlib.nodes.Branch)" href="../effects/#delphyne.stdlib.nodes.Branch">Branch</a></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.search.interactive.interact[P]">P</span></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.search.interactive.interact[B]">B</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>A standard strategy for creating conversational agents.</p>
<p>A common pattern for interacting with LLMs is to have multi-message
exchanges where the full conversation history is resent repeatedly.
LLMs are also often allowed to request tool calls. This strategy
implements this pattern. It is meant to be inlined into a wrapping
strategy (since it is not decorated with <a class="autorefs autorefs-internal" title="strategy" href="../basic/#delphyne.strategy"><code>strategy</code></a>).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>step</code>
            </td>
            <td>
                  <code><span title="collections.abc.Callable">Callable</span>[[<a class="autorefs autorefs-internal" title="AnswerPrefix (delphyne.core.AnswerPrefix)" href="../../strategies/queries/#delphyne.AnswerPrefix">AnswerPrefix</a>, <a class="autorefs autorefs-internal" title="InteractStats


  
      dataclass
   (delphyne.stdlib.search.interactive.InteractStats)" href="#delphyne.InteractStats">InteractStats</a>], <a class="autorefs autorefs-internal" title="Opaque (delphyne.stdlib.opaque.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a>[<span title="delphyne.stdlib.search.interactive.interact[P]">P</span>, <a class="autorefs autorefs-internal" title="Response


  
      dataclass
   (delphyne.stdlib.queries.Response)" href="../queries/#delphyne.Response">Response</a>[<span title="delphyne.stdlib.search.interactive.interact[A]">A</span> | <a class="autorefs autorefs-internal" title="WrappedParseError


  
      dataclass
   (delphyne.stdlib.queries.WrappedParseError)" href="../queries/#delphyne.WrappedParseError">WrappedParseError</a>, <span title="delphyne.stdlib.search.interactive.interact[T]">T</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A parametric opaque space, induced by a strategy or query
that takes as an argument the current chat history (possibly
empty) along with some statistics, and returns an answer to
be processed. Oftentimes, this parametric opaque space is
induced by a query with a special <code>prefix</code> field for
receiving the chat history (see <a class="autorefs autorefs-internal" title="Query" href="../queries/#delphyne.Query"><code>Query</code></a>).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>process</code>
            </td>
            <td>
                  <code><span title="collections.abc.Callable">Callable</span>[[<span title="delphyne.stdlib.search.interactive.interact[A]">A</span>, <a class="autorefs autorefs-internal" title="InteractStats


  
      dataclass
   (delphyne.stdlib.search.interactive.InteractStats)" href="#delphyne.InteractStats">InteractStats</a>], <a class="autorefs autorefs-internal" title="Opaque (delphyne.stdlib.opaque.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a>[<span title="delphyne.stdlib.search.interactive.interact[P]">P</span>, <span title="delphyne.stdlib.search.interactive.interact[B]">B</span> | <a class="autorefs autorefs-internal" title="Error


  
      dataclass
   (delphyne.core.Error)" href="../../strategies/misc/#delphyne.Error">Error</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An opaque space induced by a query or strategy that is
called on all model responses that are not tool calls, and
which returns either a final response to be returned, or an
error to be transmitted to the model as feedback (as an
<a class="autorefs autorefs-internal" title="Error


  
      dataclass
  " href="../../strategies/misc/#delphyne.Error"><code>Error</code></a> value with an absent or serializable <code>meta</code> field).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tools</code>
            </td>
            <td>
                  <code><span title="collections.abc.Mapping">Mapping</span>[<span title="type">type</span>[<span title="delphyne.stdlib.search.interactive.interact[T]">T</span>], <span title="collections.abc.Callable">Callable</span>[[<span title="typing.Any">Any</span>], <a class="autorefs autorefs-internal" title="Opaque (delphyne.stdlib.opaque.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a>[<span title="delphyne.stdlib.search.interactive.interact[P]">P</span>, <span title="typing.Any">Any</span>]]] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A mapping from supported tool interfaces to
implementations. Tools themselves can be implemented using
arbitrary strategies or queries, allowing the integration of
horizontal and vertical LLM pipelines.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>inner_policy_type</code>
            </td>
            <td>
                  <code><span title="type">type</span>[<span title="delphyne.stdlib.search.interactive.interact[P]">P</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Ambient inner policy type. This information
is not used at runtime but it can be provided to help type
inference when necessary.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/search/interactive.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">interact</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="n">md</span><span class="o">.</span><span class="n">AbstractTool</span><span class="p">[</span><span class="n">Any</span><span class="p">]](</span>
    <span class="n">step</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
        <span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">AnswerPrefix</span><span class="p">,</span> <span class="n">InteractStats</span><span class="p">],</span>
        <span class="n">Opaque</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">dq</span><span class="o">.</span><span class="n">Response</span><span class="p">[</span><span class="n">A</span> <span class="o">|</span> <span class="n">WrappedParseError</span><span class="p">,</span> <span class="n">T</span><span class="p">]],</span>
    <span class="p">],</span>
    <span class="n">process</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">A</span><span class="p">,</span> <span class="n">InteractStats</span><span class="p">],</span> <span class="n">Opaque</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">B</span> <span class="o">|</span> <span class="n">dp</span><span class="o">.</span><span class="n">Error</span><span class="p">]],</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">T</span><span class="p">],</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Opaque</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">inner_policy_type</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">P</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">Strategy</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">B</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A standard strategy for creating conversational agents.</span>

<span class="sd">    A common pattern for interacting with LLMs is to have multi-message</span>
<span class="sd">    exchanges where the full conversation history is resent repeatedly.</span>
<span class="sd">    LLMs are also often allowed to request tool calls. This strategy</span>
<span class="sd">    implements this pattern. It is meant to be inlined into a wrapping</span>
<span class="sd">    strategy (since it is not decorated with `strategy`).</span>

<span class="sd">    Parameters:</span>
<span class="sd">        step: A parametric opaque space, induced by a strategy or query</span>
<span class="sd">            that takes as an argument the current chat history (possibly</span>
<span class="sd">            empty) along with some statistics, and returns an answer to</span>
<span class="sd">            be processed. Oftentimes, this parametric opaque space is</span>
<span class="sd">            induced by a query with a special `prefix` field for</span>
<span class="sd">            receiving the chat history (see `Query`).</span>
<span class="sd">        process: An opaque space induced by a query or strategy that is</span>
<span class="sd">            called on all model responses that are not tool calls, and</span>
<span class="sd">            which returns either a final response to be returned, or an</span>
<span class="sd">            error to be transmitted to the model as feedback (as an</span>
<span class="sd">            `Error` value with an absent or serializable `meta` field).</span>
<span class="sd">        tools: A mapping from supported tool interfaces to</span>
<span class="sd">            implementations. Tools themselves can be implemented using</span>
<span class="sd">            arbitrary strategies or queries, allowing the integration of</span>
<span class="sd">            horizontal and vertical LLM pipelines.</span>
<span class="sd">        inner_policy_type: Ambient inner policy type. This information</span>
<span class="sd">            is not used at runtime but it can be provided to help type</span>
<span class="sd">            inference when necessary.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">prefix</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">AnswerPrefix</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="n">InteractStats</span><span class="p">(</span><span class="n">num_rejected</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_tool_call_rounds</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">branch</span><span class="p">(</span><span class="n">step</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">stats</span><span class="p">))</span>
        <span class="n">prefix</span> <span class="o">+=</span> <span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">OracleMessage</span><span class="p">(</span><span class="s2">&quot;oracle&quot;</span><span class="p">,</span> <span class="n">resp</span><span class="o">.</span><span class="n">answer</span><span class="p">)]</span>
        <span class="k">match</span> <span class="n">resp</span><span class="o">.</span><span class="n">parsed</span><span class="p">:</span>
            <span class="k">case</span> <span class="n">dq</span><span class="o">.</span><span class="n">FinalAnswer</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">WrappedParseError</span><span class="p">):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">FeedbackMessage</span><span class="p">(</span>
                        <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;feedback&quot;</span><span class="p">,</span>
                        <span class="n">label</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
                        <span class="n">description</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                        <span class="n">meta</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">stats</span><span class="o">.</span><span class="n">num_rejected</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">prefix</span> <span class="o">+=</span> <span class="p">[</span><span class="n">msg</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">branch</span><span class="p">(</span><span class="n">process</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">stats</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">dp</span><span class="o">.</span><span class="n">Error</span><span class="p">):</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">FeedbackMessage</span><span class="p">(</span>
                            <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;feedback&quot;</span><span class="p">,</span>
                            <span class="n">label</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
                            <span class="n">description</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                            <span class="n">meta</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">stats</span><span class="o">.</span><span class="n">num_rejected</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">prefix</span> <span class="o">+=</span> <span class="p">[</span><span class="n">msg</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">res</span>
            <span class="k">case</span> <span class="n">dq</span><span class="o">.</span><span class="n">ToolRequests</span><span class="p">(</span><span class="n">tc</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tc</span><span class="p">):</span>
                    <span class="k">assert</span> <span class="n">tools</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="n">tres</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">branch</span><span class="p">(</span><span class="n">tools</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">t</span><span class="p">)](</span><span class="n">t</span><span class="p">))</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">ToolResult</span><span class="p">(</span>
                        <span class="s2">&quot;tool&quot;</span><span class="p">,</span>
                        <span class="n">resp</span><span class="o">.</span><span class="n">answer</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                        <span class="n">t</span><span class="o">.</span><span class="n">render_result</span><span class="p">(</span><span class="n">tres</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="n">prefix</span> <span class="o">+=</span> <span class="p">[</span><span class="n">msg</span><span class="p">]</span>
                <span class="n">stats</span><span class="o">.</span><span class="n">num_tool_call_rounds</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.InteractStats" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">InteractStats</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">


        <p>Statistics maintained by <a class="autorefs autorefs-internal" title="interact" href="#delphyne.interact"><code>interact</code></a>.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.InteractStats.num_rejected">num_rejected</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of answers that have been rejected so far,
due to either parsing or processing errors.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.InteractStats.num_tool_call_rounds">num_tool_call_rounds</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of tool call rounds that have been
reuqetsed by the LLM so far (a round consists in a single
message that can contain several tool call requests).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/search/interactive.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">InteractStats</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Statistics maintained by `interact`.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        num_rejected: Number of answers that have been rejected so far,</span>
<span class="sd">            due to either parsing or processing errors.</span>
<span class="sd">        num_tool_call_rounds: Number of tool call rounds that have been</span>
<span class="sd">            reuqetsed by the LLM so far (a round consists in a single</span>
<span class="sd">            message that can contain several tool call requests).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">num_rejected</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">num_tool_call_rounds</span><span class="p">:</span> <span class="nb">int</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div><h2 id="policies">Policies</h2>


<div class="doc doc-object doc-function">


<h3 id="delphyne.stdlib.search.dfs.dfs" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">dfs</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">dfs</span><span class="p">(</span>
    <span class="n">tree</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="Tree


  
      dataclass
   (delphyne.core.trees.Tree)" href="../../strategies/trees/#delphyne.Tree">Tree</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="Branch


  
      dataclass
   (delphyne.stdlib.nodes.Branch)" href="../effects/#delphyne.stdlib.nodes.Branch">Branch</a></span> <span class="o">|</span> <span class="n"><a class="autorefs autorefs-internal" title="Fail


  
      dataclass
   (delphyne.stdlib.nodes.Fail)" href="../effects/#delphyne.stdlib.nodes.Fail">Fail</a></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.search.dfs.dfs[P]">P</span></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.search.dfs.dfs[T]">T</span></span><span class="p">],</span>
    <span class="n">env</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="PolicyEnv (delphyne.stdlib.environments.PolicyEnv)" href="../environments/#delphyne.PolicyEnv">PolicyEnv</a></span><span class="p">,</span>
    <span class="n">policy</span><span class="p">:</span> <span class="n"><span title="delphyne.stdlib.search.dfs.dfs[P]">P</span></span><span class="p">,</span>
    <span class="n">max_depth</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_branching</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="StreamGen (delphyne.core.streams.StreamGen)" href="../../policies/streams/#delphyne.StreamGen">StreamGen</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.dfs.dfs[T]">T</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>The Standard Depth-First Search Algorithm.</p>
<p>Whenever a branching node is encountered, branching candidates are
lazily enumerated and the corresponding child recursively searched.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.search.dfs.dfs.max_depth">max_depth</span></code></td>
            <td>
                  <code><span title="optional">optional</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>maximum number of branching nodes
that can be traversed in a path to success.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.search.dfs.dfs.max_branching">max_branching</span></code></td>
            <td>
                  <code><span title="optional">optional</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>maximum number of children explored at
each branching node.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/search/dfs.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@search_policy</span>
<span class="k">def</span><span class="w"> </span><span class="nf">dfs</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">](</span>
    <span class="n">tree</span><span class="p">:</span> <span class="n">Tree</span><span class="p">[</span><span class="n">Branch</span> <span class="o">|</span> <span class="n">Fail</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">],</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">PolicyEnv</span><span class="p">,</span>
    <span class="n">policy</span><span class="p">:</span> <span class="n">P</span><span class="p">,</span>
    <span class="n">max_depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_branching</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StreamGen</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The Standard Depth-First Search Algorithm.</span>

<span class="sd">    Whenever a branching node is encountered, branching candidates are</span>
<span class="sd">    lazily enumerated and the corresponding child recursively searched.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        max_depth (optional): maximum number of branching nodes</span>
<span class="sd">            that can be traversed in a path to success.</span>
<span class="sd">        max_branching (optional): maximum number of children explored at</span>
<span class="sd">            each branching node.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">max_branching</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">max_branching</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">match</span> <span class="n">tree</span><span class="o">.</span><span class="n">node</span><span class="p">:</span>
        <span class="k">case</span> <span class="n">Success</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">Solution</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">case</span> <span class="n">Fail</span><span class="p">():</span>
            <span class="k">pass</span>
        <span class="k">case</span> <span class="n">Branch</span><span class="p">(</span><span class="n">cands</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">max_depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">max_depth</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">cands</span> <span class="o">=</span> <span class="n">cands</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">policy</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">max_branching</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cands</span> <span class="o">=</span> <span class="n">cands</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">max_branching</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">yield from</span> <span class="n">cands</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">dfs</span><span class="p">(</span>
                    <span class="n">max_depth</span><span class="o">=</span><span class="n">max_depth</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">max_depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">max_branching</span><span class="o">=</span><span class="n">max_branching</span><span class="p">,</span>
                <span class="p">)(</span><span class="n">tree</span><span class="o">.</span><span class="n">child</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">tracked</span><span class="p">),</span> <span class="n">env</span><span class="p">,</span> <span class="n">policy</span><span class="p">)</span><span class="o">.</span><span class="n">gen</span><span class="p">()</span>
            <span class="p">)</span><span class="o">.</span><span class="n">gen</span><span class="p">()</span>
        <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
            <span class="n">unsupported_node</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="delphyne.stdlib.search.dfs.par_dfs" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">par_dfs</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">par_dfs</span><span class="p">(</span><span class="n">tree</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="Tree


  
      dataclass
   (delphyne.core.trees.Tree)" href="../../strategies/trees/#delphyne.Tree">Tree</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="Branch


  
      dataclass
   (delphyne.stdlib.nodes.Branch)" href="../effects/#delphyne.stdlib.nodes.Branch">Branch</a></span> <span class="o">|</span> <span class="n"><a class="autorefs autorefs-internal" title="Fail


  
      dataclass
   (delphyne.stdlib.nodes.Fail)" href="../effects/#delphyne.stdlib.nodes.Fail">Fail</a></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.search.dfs.par_dfs[P]">P</span></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.search.dfs.par_dfs[T]">T</span></span><span class="p">],</span> <span class="n">env</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="PolicyEnv (delphyne.stdlib.environments.PolicyEnv)" href="../environments/#delphyne.PolicyEnv">PolicyEnv</a></span><span class="p">,</span> <span class="n">policy</span><span class="p">:</span> <span class="n"><span title="delphyne.stdlib.search.dfs.par_dfs[P]">P</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="StreamGen (delphyne.core.streams.StreamGen)" href="../../policies/streams/#delphyne.StreamGen">StreamGen</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.dfs.par_dfs[T]">T</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Parallel Depth-First Search.</p>
<p>Whenever a branching node is encountered, all branching candidates
are computed at once and the associated children are explored in
parallel.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/search/dfs.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@search_policy</span>
<span class="k">def</span><span class="w"> </span><span class="nf">par_dfs</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">](</span>
    <span class="n">tree</span><span class="p">:</span> <span class="n">Tree</span><span class="p">[</span><span class="n">Branch</span> <span class="o">|</span> <span class="n">Fail</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">],</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">PolicyEnv</span><span class="p">,</span>
    <span class="n">policy</span><span class="p">:</span> <span class="n">P</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StreamGen</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parallel Depth-First Search.</span>

<span class="sd">    Whenever a branching node is encountered, all branching candidates</span>
<span class="sd">    are computed at once and the associated children are explored in</span>
<span class="sd">    parallel.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">match</span> <span class="n">tree</span><span class="o">.</span><span class="n">node</span><span class="p">:</span>
        <span class="k">case</span> <span class="n">Success</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">Solution</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">case</span> <span class="n">Fail</span><span class="p">():</span>
            <span class="k">pass</span>
        <span class="k">case</span> <span class="n">Branch</span><span class="p">(</span><span class="n">cands</span><span class="p">):</span>
            <span class="n">cands</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">cands</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">policy</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="k">yield from</span> <span class="n">Stream</span><span class="o">.</span><span class="n">parallel</span><span class="p">(</span>
                <span class="p">[</span><span class="n">par_dfs</span><span class="p">()(</span><span class="n">tree</span><span class="o">.</span><span class="n">child</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">tracked</span><span class="p">),</span> <span class="n">env</span><span class="p">,</span> <span class="n">policy</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">cands</span><span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">gen</span><span class="p">()</span>
        <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
            <span class="n">unsupported_node</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h2 id="combinators">Combinators</h2>


<div class="doc doc-object doc-function">


<h3 id="delphyne.sequence" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">sequence</span>


</h3>
          <div class="doc-overloads">
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">sequence</span><span class="p">(</span>
    <span class="n">policies</span><span class="p">:</span> <span class="n"><span title="typing.Iterable">Iterable</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="PromptingPolicy


  
      dataclass
   (delphyne.stdlib.policies.PromptingPolicy)" href="../basic/#delphyne.PromptingPolicy">PromptingPolicy</a></span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">stop_on_reject</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="PromptingPolicy


  
      dataclass
   (delphyne.stdlib.policies.PromptingPolicy)" href="../basic/#delphyne.PromptingPolicy">PromptingPolicy</a></span>
</code></pre></div><div class="doc-signature highlight"><pre><span></span><code><span class="nf">sequence</span><span class="p">(</span>
    <span class="n">policies</span><span class="p">:</span> <span class="n"><span title="typing.Iterable">Iterable</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="SearchPolicy


  
      dataclass
   (delphyne.stdlib.policies.SearchPolicy)" href="../basic/#delphyne.SearchPolicy">SearchPolicy</a></span><span class="p">[</span><span class="n"><span title="N">N</span></span><span class="p">]],</span> <span class="o">*</span><span class="p">,</span> <span class="n">stop_on_reject</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="SearchPolicy


  
      dataclass
   (delphyne.stdlib.policies.SearchPolicy)" href="../basic/#delphyne.SearchPolicy">SearchPolicy</a></span><span class="p">[</span><span class="n"><span title="N">N</span></span><span class="p">]</span>
</code></pre></div><div class="doc-signature highlight"><pre><span></span><code><span class="nf">sequence</span><span class="p">(</span>
    <span class="n">policies</span><span class="p">:</span> <span class="n"><span title="typing.Iterable">Iterable</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="Policy


  
      dataclass
   (delphyne.stdlib.policies.Policy)" href="../basic/#delphyne.Policy">Policy</a></span><span class="p">[</span><span class="n"><span title="N">N</span></span><span class="p">,</span> <span class="n"><span title="P">P</span></span><span class="p">]],</span> <span class="o">*</span><span class="p">,</span> <span class="n">stop_on_reject</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Policy


  
      dataclass
   (delphyne.stdlib.policies.Policy)" href="../basic/#delphyne.Policy">Policy</a></span><span class="p">[</span><span class="n"><span title="N">N</span></span><span class="p">,</span> <span class="n"><span title="P">P</span></span><span class="p">]</span>
</code></pre></div>          </div>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">sequence</span><span class="p">(</span><span class="n">policies</span><span class="p">:</span> <span class="n"><span title="typing.Iterable">Iterable</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.misc._AnyPolicy">_AnyPolicy</span></span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">stop_on_reject</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="delphyne.stdlib.misc._AnyPolicy">_AnyPolicy</span></span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Try a list of policies, search policies, or prompting policies in
sequence.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>policies</code>
            </td>
            <td>
                  <code><span title="typing.Iterable">Iterable</span>[<span title="delphyne.stdlib.misc._AnyPolicy">_AnyPolicy</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An iterable of policies, search policies, or prompting
policies to try in sequence.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>stop_on_reject</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, stop the sequence as soon as one policy
sees all its resource requests denied. Note that this is
necessary for termination when <code>policies</code> is an infinite
iterator.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/misc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">sequence</span><span class="p">(</span>
    <span class="n">policies</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">_AnyPolicy</span><span class="p">],</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">stop_on_reject</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_AnyPolicy</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Try a list of policies, search policies, or prompting policies in</span>
<span class="sd">    sequence.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        policies: An iterable of policies, search policies, or prompting</span>
<span class="sd">            policies to try in sequence.</span>
<span class="sd">        stop_on_reject: If True, stop the sequence as soon as one policy</span>
<span class="sd">            sees all its resource requests denied. Note that this is</span>
<span class="sd">            necessary for termination when `policies` is an infinite</span>
<span class="sd">            iterator.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">policies</span><span class="p">)</span>
    <span class="n">first</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">PromptingPolicy</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">sequence_prompting_policies</span><span class="p">(</span>
            <span class="n">cast</span><span class="p">(</span><span class="n">Iterable</span><span class="p">[</span><span class="n">PromptingPolicy</span><span class="p">],</span> <span class="n">policies</span><span class="p">),</span>
            <span class="n">stop_on_reject</span><span class="o">=</span><span class="n">stop_on_reject</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">SearchPolicy</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">sequence_search_policies</span><span class="p">(</span>
            <span class="n">cast</span><span class="p">(</span><span class="n">Iterable</span><span class="p">[</span><span class="n">SearchPolicy</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">policies</span><span class="p">),</span>
            <span class="n">stop_on_reject</span><span class="o">=</span><span class="n">stop_on_reject</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">Policy</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sequence_policies</span><span class="p">(</span>
            <span class="n">cast</span><span class="p">(</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Policy</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">policies</span><span class="p">),</span>
            <span class="n">stop_on_reject</span><span class="o">=</span><span class="n">stop_on_reject</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="delphyne.parallel" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">parallel</span>


</h3>
          <div class="doc-overloads">
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">parallel</span><span class="p">(</span><span class="n">policies</span><span class="p">:</span> <span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="PromptingPolicy


  
      dataclass
   (delphyne.stdlib.policies.PromptingPolicy)" href="../basic/#delphyne.PromptingPolicy">PromptingPolicy</a></span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="PromptingPolicy


  
      dataclass
   (delphyne.stdlib.policies.PromptingPolicy)" href="../basic/#delphyne.PromptingPolicy">PromptingPolicy</a></span>
</code></pre></div><div class="doc-signature highlight"><pre><span></span><code><span class="nf">parallel</span><span class="p">(</span><span class="n">policies</span><span class="p">:</span> <span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="SearchPolicy


  
      dataclass
   (delphyne.stdlib.policies.SearchPolicy)" href="../basic/#delphyne.SearchPolicy">SearchPolicy</a></span><span class="p">[</span><span class="n"><span title="N">N</span></span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="SearchPolicy


  
      dataclass
   (delphyne.stdlib.policies.SearchPolicy)" href="../basic/#delphyne.SearchPolicy">SearchPolicy</a></span><span class="p">[</span><span class="n"><span title="N">N</span></span><span class="p">]</span>
</code></pre></div><div class="doc-signature highlight"><pre><span></span><code><span class="nf">parallel</span><span class="p">(</span><span class="n">policies</span><span class="p">:</span> <span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="Policy


  
      dataclass
   (delphyne.stdlib.policies.Policy)" href="../basic/#delphyne.Policy">Policy</a></span><span class="p">[</span><span class="n"><span title="N">N</span></span><span class="p">,</span> <span class="n"><span title="P">P</span></span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Policy


  
      dataclass
   (delphyne.stdlib.policies.Policy)" href="../basic/#delphyne.Policy">Policy</a></span><span class="p">[</span><span class="n"><span title="N">N</span></span><span class="p">,</span> <span class="n"><span title="P">P</span></span><span class="p">]</span>
</code></pre></div>          </div>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">parallel</span><span class="p">(</span><span class="n">policies</span><span class="p">:</span> <span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.misc._AnyPolicy">_AnyPolicy</span></span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n"><span title="delphyne.stdlib.misc._AnyPolicy">_AnyPolicy</span></span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Try a sequence of policies in parallel.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>policies</code>
            </td>
            <td>
                  <code><span title="collections.abc.Sequence">Sequence</span>[<span title="delphyne.stdlib.misc._AnyPolicy">_AnyPolicy</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A sequence of policies, search policies, or prompting
policies to try in parallel.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/misc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">parallel</span><span class="p">(</span>
    <span class="n">policies</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">_AnyPolicy</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_AnyPolicy</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Try a sequence of policies in parallel.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        policies: A sequence of policies, search policies, or prompting</span>
<span class="sd">            policies to try in parallel.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">policies</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot parallelize an empty sequence of policies&quot;</span><span class="p">)</span>

    <span class="n">first</span> <span class="o">=</span> <span class="n">policies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">PromptingPolicy</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">parallel_prompting_policies</span><span class="p">(</span>
            <span class="n">cast</span><span class="p">(</span><span class="n">Sequence</span><span class="p">[</span><span class="n">PromptingPolicy</span><span class="p">],</span> <span class="n">policies</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">SearchPolicy</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">parallel_search_policies</span><span class="p">(</span>
            <span class="n">cast</span><span class="p">(</span><span class="n">Sequence</span><span class="p">[</span><span class="n">SearchPolicy</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">policies</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">Policy</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">parallel_policies</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Policy</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">policies</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="delphyne.or_else" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">or_else</span>


</h3>
          <div class="doc-overloads">
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">or_else</span><span class="p">(</span><span class="n">main</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="PromptingPolicy


  
      dataclass
   (delphyne.stdlib.policies.PromptingPolicy)" href="../basic/#delphyne.PromptingPolicy">PromptingPolicy</a></span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="PromptingPolicy


  
      dataclass
   (delphyne.stdlib.policies.PromptingPolicy)" href="../basic/#delphyne.PromptingPolicy">PromptingPolicy</a></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="PromptingPolicy


  
      dataclass
   (delphyne.stdlib.policies.PromptingPolicy)" href="../basic/#delphyne.PromptingPolicy">PromptingPolicy</a></span>
</code></pre></div><div class="doc-signature highlight"><pre><span></span><code><span class="nf">or_else</span><span class="p">(</span><span class="n">main</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="SearchPolicy


  
      dataclass
   (delphyne.stdlib.policies.SearchPolicy)" href="../basic/#delphyne.SearchPolicy">SearchPolicy</a></span><span class="p">[</span><span class="n"><span title="N">N</span></span><span class="p">],</span> <span class="n">other</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="SearchPolicy


  
      dataclass
   (delphyne.stdlib.policies.SearchPolicy)" href="../basic/#delphyne.SearchPolicy">SearchPolicy</a></span><span class="p">[</span><span class="n"><span title="N">N</span></span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="SearchPolicy


  
      dataclass
   (delphyne.stdlib.policies.SearchPolicy)" href="../basic/#delphyne.SearchPolicy">SearchPolicy</a></span><span class="p">[</span><span class="n"><span title="N">N</span></span><span class="p">]</span>
</code></pre></div><div class="doc-signature highlight"><pre><span></span><code><span class="nf">or_else</span><span class="p">(</span><span class="n">main</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="Policy


  
      dataclass
   (delphyne.stdlib.policies.Policy)" href="../basic/#delphyne.Policy">Policy</a></span><span class="p">[</span><span class="n"><span title="N">N</span></span><span class="p">,</span> <span class="n"><span title="P">P</span></span><span class="p">],</span> <span class="n">other</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="Policy


  
      dataclass
   (delphyne.stdlib.policies.Policy)" href="../basic/#delphyne.Policy">Policy</a></span><span class="p">[</span><span class="n"><span title="N">N</span></span><span class="p">,</span> <span class="n"><span title="P">P</span></span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Policy


  
      dataclass
   (delphyne.stdlib.policies.Policy)" href="../basic/#delphyne.Policy">Policy</a></span><span class="p">[</span><span class="n"><span title="N">N</span></span><span class="p">,</span> <span class="n"><span title="P">P</span></span><span class="p">]</span>
</code></pre></div>          </div>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">or_else</span><span class="p">(</span><span class="n">main</span><span class="p">:</span> <span class="n"><span title="delphyne.stdlib.misc._AnyPolicy">_AnyPolicy</span></span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n"><span title="delphyne.stdlib.misc._AnyPolicy">_AnyPolicy</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="delphyne.stdlib.misc._AnyPolicy">_AnyPolicy</span></span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Take two policies, search policies, or prompting policies as
arguments. Try the first one, and then the second one only if it
fails (i.e., it does not produce any solution).</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/misc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">or_else</span><span class="p">(</span><span class="n">main</span><span class="p">:</span> <span class="n">_AnyPolicy</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">_AnyPolicy</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_AnyPolicy</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Take two policies, search policies, or prompting policies as</span>
<span class="sd">    arguments. Try the first one, and then the second one only if it</span>
<span class="sd">    fails (i.e., it does not produce any solution).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="n">PromptingPolicy</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">PromptingPolicy</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">prompting_policy_or_else</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="n">SearchPolicy</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">SearchPolicy</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">search_policy_or_else</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">policy_or_else</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="delphyne.nofail" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">nofail</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">nofail</span><span class="p">(</span><span class="n">space</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="Opaque (delphyne.core_and_base.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.misc.nofail[P]">P</span></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.misc.nofail[A]">A</span></span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n"><span title="delphyne.stdlib.misc.nofail[B]">B</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Opaque (delphyne.core_and_base.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.misc.nofail[P]">P</span></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.misc.nofail[A]">A</span></span> <span class="o">|</span> <span class="n"><span title="delphyne.stdlib.misc.nofail[B]">B</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Modify an opaque space to that branching over it can never fail.</p>
<p>If the stream associated with the opaque space gets exhausted and no
solution is produced, the provided default value is used.</p>
<p>In demonstrations, the default value can be selected by using the
<code>#no_fail_default</code> hint.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/misc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">nofail</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">](</span><span class="n">space</span><span class="p">:</span> <span class="n">Opaque</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">A</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">B</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Opaque</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">A</span> <span class="o">|</span> <span class="n">B</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Modify an opaque space to that branching over it can never fail.</span>

<span class="sd">    If the stream associated with the opaque space gets exhausted and no</span>
<span class="sd">    solution is produced, the provided default value is used.</span>

<span class="sd">    In demonstrations, the default value can be selected by using the</span>
<span class="sd">    `#no_fail_default` hint.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">try_policy</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">()</span> <span class="o">@</span> <span class="n">elim_flag</span><span class="p">(</span><span class="n">NoFailFlag</span><span class="p">,</span> <span class="s2">&quot;no_fail_try&quot;</span><span class="p">)</span>
    <span class="n">def_policy</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">()</span> <span class="o">@</span> <span class="n">elim_flag</span><span class="p">(</span><span class="n">NoFailFlag</span><span class="p">,</span> <span class="s2">&quot;no_fail_default&quot;</span><span class="p">)</span>
    <span class="n">search_policy</span> <span class="o">=</span> <span class="n">or_else</span><span class="p">(</span><span class="n">try_policy</span><span class="p">,</span> <span class="n">def_policy</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nofail_strategy</span><span class="p">(</span><span class="n">space</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">)</span><span class="o">.</span><span class="n">using</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">search_policy</span> <span class="o">&amp;</span> <span class="n">p</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="delphyne.iterate" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">iterate</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">iterate</span><span class="p">(</span>
    <span class="nb">next</span><span class="p">:</span> <span class="n"><span title="collections.abc.Callable">Callable</span></span><span class="p">[[</span><span class="n"><span title="delphyne.stdlib.search.iteration.iterate[S]">S</span></span> <span class="o">|</span> <span class="kc">None</span><span class="p">],</span> <span class="n"><a class="autorefs autorefs-internal" title="Opaque (delphyne.stdlib.opaque.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.iteration.iterate[P]">P</span></span><span class="p">,</span> <span class="n"><span title="tuple">tuple</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.iteration.iterate[T]">T</span></span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.search.iteration.iterate[S]">S</span></span><span class="p">]]],</span>
    <span class="n">transform_stream</span><span class="p">:</span> <span class="n"><span title="collections.abc.Callable">Callable</span></span><span class="p">[[</span><span class="n"><span title="delphyne.stdlib.search.iteration.iterate[P]">P</span></span><span class="p">],</span> <span class="n"><a class="autorefs autorefs-internal" title="StreamTransformer


  
      dataclass
   (delphyne.stdlib.streams.StreamTransformer)" href="../streams/#delphyne.StreamTransformer">StreamTransformer</a></span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Opaque (delphyne.stdlib.opaque.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.iteration.iterate[P]">P</span></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.search.iteration.iterate[T]">T</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Iteratively call a strategy or query, repeatedly feeding back the
last call's output state into a new call and yielding values along
the way.</p>
<p>A standard use case is to repeatedly call a query or strategy with a
blacklist of previously generated values, so as to produce diverse
success values.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>next</code>
            </td>
            <td>
                  <code><span title="collections.abc.Callable">Callable</span>[[<span title="delphyne.stdlib.search.iteration.iterate[S]">S</span> | None], <a class="autorefs autorefs-internal" title="Opaque (delphyne.stdlib.opaque.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a>[<span title="delphyne.stdlib.search.iteration.iterate[P]">P</span>, <span title="tuple">tuple</span>[<span title="delphyne.stdlib.search.iteration.iterate[T]">T</span> | None, <span title="delphyne.stdlib.search.iteration.iterate[S]">S</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A parametric opaque space, induced by a query or stratey
that takes a state as an input (or <code>None</code> initially) and
outputs a new state, along with a generated value.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>transform_stream</code>
            </td>
            <td>
                  <code><span title="collections.abc.Callable">Callable</span>[[<span title="delphyne.stdlib.search.iteration.iterate[P]">P</span>], <a class="autorefs autorefs-internal" title="StreamTransformer


  
      dataclass
   (delphyne.stdlib.streams.StreamTransformer)" href="../streams/#delphyne.StreamTransformer">StreamTransformer</a> | None] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An optional mapping from the inner policy to a
stream transformer to be applied to the resulting stream of
generated values.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="Opaque (delphyne.stdlib.opaque.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a>[<span title="delphyne.stdlib.search.iteration.iterate[P]">P</span>, <span title="delphyne.stdlib.search.iteration.iterate[T]">T</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An opaque space enumerating all generated values.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/search/iteration.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">iterate</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">T</span><span class="p">](</span>
    <span class="nb">next</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">S</span> <span class="o">|</span> <span class="kc">None</span><span class="p">],</span> <span class="n">Opaque</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">T</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">S</span><span class="p">]]],</span>
    <span class="n">transform_stream</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">P</span><span class="p">],</span> <span class="n">StreamTransformer</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Opaque</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Iteratively call a strategy or query, repeatedly feeding back the</span>
<span class="sd">    last call&#39;s output state into a new call and yielding values along</span>
<span class="sd">    the way.</span>

<span class="sd">    A standard use case is to repeatedly call a query or strategy with a</span>
<span class="sd">    blacklist of previously generated values, so as to produce diverse</span>
<span class="sd">    success values.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        next: A parametric opaque space, induced by a query or stratey</span>
<span class="sd">            that takes a state as an input (or `None` initially) and</span>
<span class="sd">            outputs a new state, along with a generated value.</span>
<span class="sd">        transform_stream: An optional mapping from the inner policy to a</span>
<span class="sd">            stream transformer to be applied to the resulting stream of</span>
<span class="sd">            generated values.</span>

<span class="sd">    Returns:</span>
<span class="sd">        An opaque space enumerating all generated values.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">iterate_policy</span><span class="p">(</span><span class="n">inner_policy</span><span class="p">:</span> <span class="n">P</span><span class="p">):</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="n">_search_iteration</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">transform_stream</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">trans</span> <span class="o">=</span> <span class="n">transform_stream</span><span class="p">(</span><span class="n">inner_policy</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">trans</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">policy</span> <span class="o">=</span> <span class="n">trans</span> <span class="o">@</span> <span class="n">policy</span>
        <span class="k">return</span> <span class="n">policy</span> <span class="o">&amp;</span> <span class="n">inner_policy</span>

    <span class="k">return</span> <span class="n">_iterate</span><span class="p">(</span><span class="nb">next</span><span class="p">)</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="n">iterate_policy</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h2 id="opaque-spaces-sugar">Opaque Spaces Sugar</h2>


<div class="doc doc-object doc-function">


<h3 id="delphyne.ambient_pp" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">ambient_pp</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">ambient_pp</span><span class="p">(</span><span class="n">policy</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="PromptingPolicy


  
      dataclass
   (delphyne.stdlib.policies.PromptingPolicy)" href="../basic/#delphyne.PromptingPolicy">PromptingPolicy</a></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="PromptingPolicy


  
      dataclass
   (delphyne.stdlib.policies.PromptingPolicy)" href="../basic/#delphyne.PromptingPolicy">PromptingPolicy</a></span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Convenience shortcut to avoid passing lambdas to the <code>get_policy</code>
argument of <code>Query.using</code>, when using the ambient inner policy as a
prompting policy.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/misc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ambient_pp</span><span class="p">(</span><span class="n">policy</span><span class="p">:</span> <span class="n">PromptingPolicy</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PromptingPolicy</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convenience shortcut to avoid passing lambdas to the `get_policy`</span>
<span class="sd">    argument of `Query.using`, when using the ambient inner policy as a</span>
<span class="sd">    prompting policy.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">policy</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="delphyne.ambient" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">ambient</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">ambient</span><span class="p">(</span><span class="n">policy</span><span class="p">:</span> <span class="n"><span title="delphyne.stdlib.misc.ambient[F]">F</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="delphyne.stdlib.misc.ambient[F]">F</span></span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Convenience shortcut to avoid passing lambdas to the <code>get_policy</code>
argument of <code>Query.using</code>, when using the ambient inner policy as a
sub-policy (or as a sub-prompting policy).</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/misc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ambient</span><span class="p">[</span><span class="n">F</span><span class="p">](</span><span class="n">policy</span><span class="p">:</span> <span class="n">F</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">F</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convenience shortcut to avoid passing lambdas to the `get_policy`</span>
<span class="sd">    argument of `Query.using`, when using the ambient inner policy as a</span>
<span class="sd">    sub-policy (or as a sub-prompting policy).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">policy</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h2 id="universal-queries">Universal Queries</h2>


<div class="doc doc-object doc-class">



<h3 id="delphyne.UniversalQuery" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">UniversalQuery</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="Query (delphyne.stdlib.queries.Query)" href="../queries/#delphyne.Query">Query</a>[<span title="object">object</span>]</code></p>


        <p>A universal query, implicitly defined by the surrounding context of
its call. See <a class="autorefs autorefs-internal" title="guess" href="#delphyne.guess"><code>guess</code></a> for more information.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.UniversalQuery.strategy">strategy</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Fully qualified name of the surrounding strategy
(e.g., <code>my_package.my_module.my_strategy</code>).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.UniversalQuery.expected_type">expected_type</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string rendition of the expected answer type.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.UniversalQuery.tags">tags</span></code></td>
            <td>
                  <code><span title="collections.abc.Sequence">Sequence</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tags associated with the space induced by the query, which
can be used to locate the exact location where the query is
issued (the default tag takes the name of the variable that
the query result is assigned to).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.UniversalQuery.locals">locals</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="object">object</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary that provides the values of a subset of
local variables or expressions (as JSON values).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
        <div class="admonition warning">
<p class="admonition-title">Experimental</p>
<p>This feature is experimental and subject to change.</p>
</div>








              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/universal_queries.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UniversalQuery</span><span class="p">(</span><span class="n">Query</span><span class="p">[</span><span class="nb">object</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A universal query, implicitly defined by the surrounding context of</span>
<span class="sd">    its call. See `guess` for more information.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        strategy: Fully qualified name of the surrounding strategy</span>
<span class="sd">            (e.g., `my_package.my_module.my_strategy`).</span>
<span class="sd">        expected_type: A string rendition of the expected answer type.</span>
<span class="sd">        tags: Tags associated with the space induced by the query, which</span>
<span class="sd">            can be used to locate the exact location where the query is</span>
<span class="sd">            issued (the default tag takes the name of the variable that</span>
<span class="sd">            the query result is assigned to).</span>
<span class="sd">        locals: A dictionary that provides the values of a subset of</span>
<span class="sd">            local variables or expressions (as JSON values).</span>

<span class="sd">    !!! warning &quot;Experimental&quot;</span>
<span class="sd">        This feature is experimental and subject to change.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># TODO: add a `context` field where we store objects whose</span>
    <span class="c1"># documentation or source should be added to the prompt.</span>

    <span class="n">strategy</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">expected_type</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">tags</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="nb">locals</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span>

    <span class="n">__parser__</span> <span class="o">=</span> <span class="n">last_code_block</span><span class="o">.</span><span class="n">yaml</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">default_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">strategy_source</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the source code of the strategy that contains this query.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">strategy_obj</span> <span class="o">=</span> <span class="n">_load_from_qualified_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">callable</span><span class="p">(</span><span class="n">strategy_obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_source_code</span><span class="p">(</span><span class="n">strategy_obj</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h4 id="delphyne.UniversalQuery.strategy_source" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">strategy_source</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">strategy_source</span><span class="p">:</span> <span class="n"><span title="str">str</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Return the source code of the strategy that contains this query.</p>

    </div>

</div>






  </div>

    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="delphyne.guess" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">guess</span>


</h3>
          <div class="doc-overloads">
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">guess</span><span class="p">(</span>
    <span class="n">annot</span><span class="p">:</span> <span class="n"><span title="type">type</span></span><span class="p">[</span><span class="n"><span title="T">T</span></span><span class="p">],</span> <span class="o">/</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">using</span><span class="p">:</span> <span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><span title="object">object</span></span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Strategy (delphyne.core.Strategy)" href="../../strategies/strategies/#delphyne.Strategy">Strategy</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="Branch


  
      dataclass
   (delphyne.stdlib.nodes.Branch)" href="../effects/#delphyne.stdlib.nodes.Branch">Branch</a></span> <span class="o">|</span> <span class="n"><a class="autorefs autorefs-internal" title="Fail


  
      dataclass
   (delphyne.stdlib.nodes.Fail)" href="../effects/#delphyne.stdlib.nodes.Fail">Fail</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-internal" title="IPDict (delphyne.stdlib.policies.IPDict)" href="../basic/#delphyne.IPDict">IPDict</a></span><span class="p">,</span> <span class="n"><span title="T">T</span></span><span class="p">]</span>
</code></pre></div><div class="doc-signature highlight"><pre><span></span><code><span class="nf">guess</span><span class="p">(</span>
    <span class="n">annot</span><span class="p">:</span> <span class="n"><span title="delphyne.utils.typing.TypeAnnot">TypeAnnot</span></span><span class="p">[</span><span class="n"><span title="typing.Any">Any</span></span><span class="p">],</span> <span class="o">/</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">using</span><span class="p">:</span> <span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><span title="object">object</span></span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Strategy (delphyne.core.Strategy)" href="../../strategies/strategies/#delphyne.Strategy">Strategy</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="Branch


  
      dataclass
   (delphyne.stdlib.nodes.Branch)" href="../effects/#delphyne.stdlib.nodes.Branch">Branch</a></span> <span class="o">|</span> <span class="n"><a class="autorefs autorefs-internal" title="Fail


  
      dataclass
   (delphyne.stdlib.nodes.Fail)" href="../effects/#delphyne.stdlib.nodes.Fail">Fail</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-internal" title="IPDict (delphyne.stdlib.policies.IPDict)" href="../basic/#delphyne.IPDict">IPDict</a></span><span class="p">,</span> <span class="n"><span title="typing.Any">Any</span></span><span class="p">]</span>
</code></pre></div>          </div>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">guess</span><span class="p">(</span>
    <span class="n">annot</span><span class="p">:</span> <span class="n"><span title="delphyne.utils.typing.TypeAnnot">TypeAnnot</span></span><span class="p">[</span><span class="n"><span title="typing.Any">Any</span></span><span class="p">],</span> <span class="o">/</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">using</span><span class="p">:</span> <span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><span title="object">object</span></span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Strategy (delphyne.core.Strategy)" href="../../strategies/strategies/#delphyne.Strategy">Strategy</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="Branch


  
      dataclass
   (delphyne.stdlib.nodes.Branch)" href="../effects/#delphyne.stdlib.nodes.Branch">Branch</a></span> <span class="o">|</span> <span class="n"><a class="autorefs autorefs-internal" title="Fail


  
      dataclass
   (delphyne.stdlib.nodes.Fail)" href="../effects/#delphyne.stdlib.nodes.Fail">Fail</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-internal" title="IPDict (delphyne.stdlib.policies.IPDict)" href="../basic/#delphyne.IPDict">IPDict</a></span><span class="p">,</span> <span class="n"><span title="typing.Any">Any</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Attempt to guess a value of a given type, using the surrounding
context of the call site along with the value of some local
variables or expressions.</p>
<p>This function inspects the call stack to determine the context in
which it is called and issues a <a class="autorefs autorefs-internal" title="UniversalQuery


  
      dataclass
  " href="#delphyne.UniversalQuery"><code>UniversalQuery</code></a>, with a tag
corresponding to the name of the assigned variable. A failure node is
issued if the oracle result cannot be parsed into the expected type.
For example:</p>
<div class="highlight"><pre><span></span><code><span class="n">res</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">guess</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">using</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">summary</span><span class="p">()])</span>
</code></pre></div>
<p>issues a <a class="autorefs autorefs-internal" title="UniversalQuery


  
      dataclass
  " href="#delphyne.UniversalQuery"><code>UniversalQuery</code></a> query tagged <code>res</code>, with attribute
<code>locals</code> a dictionary with string keys <code>"x"</code> and <code>"y.summary()"</code>.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.guess.annot">annot</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The expected type of the value to be guessed.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.guess.using">using</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A sequence of local variables or expressions whose value
should be communicated to the oracle (a label for each
expression is automatically generated using source information).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
        <div class="admonition note">
<p class="admonition-title">Note</p>
<p>Our use of an overloaded type should not be necessary anymore
when <code>TypeExpr</code> is released with Python 3.14.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Experimental</p>
<p>This feature is experimental and subject to change.</p>
</div>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/universal_queries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">guess</span><span class="p">(</span>
    <span class="n">annot</span><span class="p">:</span> <span class="n">TypeAnnot</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="o">/</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">using</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">object</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">Strategy</span><span class="p">[</span><span class="n">Branch</span> <span class="o">|</span> <span class="n">Fail</span><span class="p">,</span> <span class="n">IPDict</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Attempt to guess a value of a given type, using the surrounding</span>
<span class="sd">    context of the call site along with the value of some local</span>
<span class="sd">    variables or expressions.</span>

<span class="sd">    This function inspects the call stack to determine the context in</span>
<span class="sd">    which it is called and issues a `UniversalQuery`, with a tag</span>
<span class="sd">    corresponding to the name of the assigned variable. A failure node is</span>
<span class="sd">    issued if the oracle result cannot be parsed into the expected type.</span>
<span class="sd">    For example:</span>

<span class="sd">    ```python</span>
<span class="sd">    res = yield from guess(int, using=[x, y.summary()])</span>
<span class="sd">    ```</span>

<span class="sd">    issues a `UniversalQuery` query tagged `res`, with attribute</span>
<span class="sd">    `locals` a dictionary with string keys `&quot;x&quot;` and `&quot;y.summary()&quot;`.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        annot: The expected type of the value to be guessed.</span>
<span class="sd">        using: A sequence of local variables or expressions whose value</span>
<span class="sd">            should be communicated to the oracle (a label for each</span>
<span class="sd">            expression is automatically generated using source information).</span>

<span class="sd">    !!! note</span>
<span class="sd">        Our use of an overloaded type should not be necessary anymore</span>
<span class="sd">        when `TypeExpr` is released with Python 3.14.</span>

<span class="sd">    !!! warning &quot;Experimental&quot;</span>
<span class="sd">        This feature is experimental and subject to change.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Extracting the name of the surrounding strategy</span>
    <span class="n">strategy</span> <span class="o">=</span> <span class="n">surrounding_qualname</span><span class="p">(</span><span class="n">skip</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">strategy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="n">strategy</span> <span class="o">=</span> <span class="n">_rename_main_module_in_qualified_name</span><span class="p">(</span><span class="n">strategy</span><span class="p">)</span>

    <span class="c1"># Extracting the name of the variable being assigned</span>
    <span class="n">cur_instr_src</span> <span class="o">=</span> <span class="n">current_instruction_source</span><span class="p">(</span><span class="n">skip</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ret_val_name</span> <span class="o">=</span> <span class="n">assigned_var_name</span><span class="p">(</span><span class="n">cur_instr_src</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret_val_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

    <span class="c1"># Computing the &#39;locals&#39; dictionary</span>
    <span class="n">guess_args</span> <span class="o">=</span> <span class="n">call_argument_sources</span><span class="p">(</span><span class="n">cur_instr_src</span><span class="p">,</span> <span class="n">guess</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">guess_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="n">_args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">guess_args</span>
    <span class="n">using_args</span> <span class="o">=</span> <span class="n">_parse_list_of_ids</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;using&quot;</span><span class="p">])</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">using</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">using_args</span><span class="p">)</span>
    <span class="nb">locals</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">pydantic_dump</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">using_args</span><span class="p">,</span> <span class="n">using</span><span class="p">)}</span>

    <span class="c1"># Building the query</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">UniversalQuery</span><span class="p">(</span><span class="n">strategy</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">annot</span><span class="p">),</span> <span class="p">[</span><span class="n">ret_val_name</span><span class="p">],</span> <span class="nb">locals</span><span class="p">)</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">branch</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="o">...</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">pydantic_load</span><span class="p">(</span><span class="n">annot</span><span class="p">,</span> <span class="n">ret</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">assert_never</span><span class="p">((</span><span class="k">yield from</span> <span class="n">fail</span><span class="p">(</span><span class="s2">&quot;parse_error&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))))</span>
    <span class="k">return</span> <span class="n">parsed</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h2 id="best-first-search">Best-First Search</h2>


<div class="doc doc-object doc-function">


<h3 id="delphyne.best_first_search" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">best_first_search</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">best_first_search</span><span class="p">(</span>
    <span class="n">tree</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="Tree


  
      dataclass
   (delphyne.core.Tree)" href="../../strategies/trees/#delphyne.Tree">Tree</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="Branch


  
      dataclass
   (delphyne.stdlib.nodes.Branch)" href="../effects/#delphyne.stdlib.nodes.Branch">Branch</a></span> <span class="o">|</span> <span class="n"><a class="autorefs autorefs-internal" title="Factor


  
      dataclass
   (delphyne.stdlib.nodes.Factor)" href="../effects/#delphyne.stdlib.nodes.Factor">Factor</a></span> <span class="o">|</span> <span class="n"><a class="autorefs autorefs-internal" title="Value


  
      dataclass
   (delphyne.stdlib.nodes.Value)" href="../effects/#delphyne.stdlib.nodes.Value">Value</a></span> <span class="o">|</span> <span class="n"><a class="autorefs autorefs-internal" title="Fail


  
      dataclass
   (delphyne.stdlib.nodes.Fail)" href="../effects/#delphyne.stdlib.nodes.Fail">Fail</a></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.search.bestfs.best_first_search[P]">P</span></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.search.bestfs.best_first_search[T]">T</span></span><span class="p">],</span>
    <span class="n">env</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="PolicyEnv (delphyne.stdlib.environments.PolicyEnv)" href="../environments/#delphyne.PolicyEnv">PolicyEnv</a></span><span class="p">,</span>
    <span class="n">policy</span><span class="p">:</span> <span class="n"><span title="delphyne.stdlib.search.bestfs.best_first_search[P]">P</span></span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">child_confidence_prior</span><span class="p">:</span> <span class="n"><span title="collections.abc.Callable">Callable</span></span><span class="p">[[</span><span class="n"><span title="int">int</span></span><span class="p">,</span> <span class="n"><span title="int">int</span></span><span class="p">],</span> <span class="n"><span title="float">float</span></span><span class="p">],</span>
    <span class="n">max_depth</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="StreamGen (delphyne.core.StreamGen)" href="../../policies/streams/#delphyne.StreamGen">StreamGen</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.bestfs.best_first_search[T]">T</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Best First Search Algorithm.</p>
<p>Nodes can be branching nodes or factor nodes. Factor nodes feature a
confidence score in the [0, 1] interval. The total confidence of any
node in the tree is the product of all confidence factors found on
the path from the root to this node. The algorithm stores all
visited branching nodes in a priority queue. At every step, it picks
the node with highest confidence and spends an atomic amount of
effort trying to generate a new child. If it succeeds, the first
descendant branching node is added to the tree and the algorithm
continues.</p>
<p>Also, the total confidence of each branching node is multiplied by
an additional penalty factor that depends on how many children have
been generated already, using the <code>child_confidence_prior</code> argument.
This argument is a function that takes as its first argument the
depth of the current branching node (0 for the root, only
incrementing when meeting other branching nodes) and as its second
argument how many children have been generated so far. It returns
the additional penalty to be added.</p>
<p>The <code>max_depth</code> parameter indicates the maximum depth a branch node
can have. The root has depth 0 and and only branch nodes count
towards increasing the depth.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/search/bestfs.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@search_policy</span>
<span class="k">def</span><span class="w"> </span><span class="nf">best_first_search</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">](</span>
    <span class="n">tree</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">Tree</span><span class="p">[</span><span class="n">Branch</span> <span class="o">|</span> <span class="n">Factor</span> <span class="o">|</span> <span class="n">Value</span> <span class="o">|</span> <span class="n">Fail</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">],</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">PolicyEnv</span><span class="p">,</span>
    <span class="n">policy</span><span class="p">:</span> <span class="n">P</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">child_confidence_prior</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">max_depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">StreamGen</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Best First Search Algorithm.</span>

<span class="sd">    Nodes can be branching nodes or factor nodes. Factor nodes feature a</span>
<span class="sd">    confidence score in the [0, 1] interval. The total confidence of any</span>
<span class="sd">    node in the tree is the product of all confidence factors found on</span>
<span class="sd">    the path from the root to this node. The algorithm stores all</span>
<span class="sd">    visited branching nodes in a priority queue. At every step, it picks</span>
<span class="sd">    the node with highest confidence and spends an atomic amount of</span>
<span class="sd">    effort trying to generate a new child. If it succeeds, the first</span>
<span class="sd">    descendant branching node is added to the tree and the algorithm</span>
<span class="sd">    continues.</span>

<span class="sd">    Also, the total confidence of each branching node is multiplied by</span>
<span class="sd">    an additional penalty factor that depends on how many children have</span>
<span class="sd">    been generated already, using the `child_confidence_prior` argument.</span>
<span class="sd">    This argument is a function that takes as its first argument the</span>
<span class="sd">    depth of the current branching node (0 for the root, only</span>
<span class="sd">    incrementing when meeting other branching nodes) and as its second</span>
<span class="sd">    argument how many children have been generated so far. It returns</span>
<span class="sd">    the additional penalty to be added.</span>

<span class="sd">    The `max_depth` parameter indicates the maximum depth a branch node</span>
<span class="sd">    can have. The root has depth 0 and and only branch nodes count</span>
<span class="sd">    towards increasing the depth.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># `counter` is used to assign ids that are used to solve ties in the</span>
    <span class="c1"># priority queue (the older element gets priority).</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">pqueue</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">_PriorityItem</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># a heap</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">push_fresh_node</span><span class="p">(</span>
        <span class="n">tree</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">Tree</span><span class="p">[</span><span class="n">Branch</span> <span class="o">|</span> <span class="n">Factor</span> <span class="o">|</span> <span class="n">Value</span> <span class="o">|</span> <span class="n">Fail</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">depth</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">StreamGen</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
        <span class="k">match</span> <span class="n">tree</span><span class="o">.</span><span class="n">node</span><span class="p">:</span>
            <span class="k">case</span> <span class="n">dp</span><span class="o">.</span><span class="n">Success</span><span class="p">():</span>
                <span class="k">yield</span> <span class="n">dp</span><span class="o">.</span><span class="n">Solution</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">success</span><span class="p">)</span>
            <span class="k">case</span> <span class="n">Fail</span><span class="p">():</span>
                <span class="k">pass</span>
            <span class="k">case</span> <span class="n">Factor</span><span class="p">()</span> <span class="o">|</span> <span class="n">Value</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">Value</span><span class="p">):</span>
                    <span class="n">penalty_fun</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">penalty_fun</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">factor</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span>
                <span class="c1"># Evaluate metrics if a penalty function is provided</span>
                <span class="k">if</span> <span class="n">penalty_fun</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">eval_stream</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">eval</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">policy</span><span class="p">)</span>
                    <span class="nb">eval</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">eval_stream</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
                    <span class="c1"># If we failed to evaluate the metrics, we give up.</span>
                    <span class="k">if</span> <span class="nb">eval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">return</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">Value</span><span class="p">):</span>
                        <span class="n">confidence</span> <span class="o">=</span> <span class="n">penalty_fun</span><span class="p">(</span><span class="nb">eval</span><span class="o">.</span><span class="n">tracked</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">confidence</span> <span class="o">*=</span> <span class="n">penalty_fun</span><span class="p">(</span><span class="nb">eval</span><span class="o">.</span><span class="n">tracked</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="k">yield from</span> <span class="n">push_fresh_node</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">child</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">confidence</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
            <span class="k">case</span> <span class="n">Branch</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">max_depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">depth</span> <span class="o">&gt;</span> <span class="n">max_depth</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">_NodeState</span><span class="p">(</span>
                    <span class="n">depth</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span>
                    <span class="n">children</span><span class="o">=</span><span class="p">[],</span>
                    <span class="n">confidence</span><span class="o">=</span><span class="n">confidence</span><span class="p">,</span>
                    <span class="n">stream</span><span class="o">=</span><span class="p">[</span><span class="n">tree</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">cands</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">policy</span><span class="p">)],</span>
                    <span class="n">node</span><span class="o">=</span><span class="n">tree</span><span class="o">.</span><span class="n">node</span><span class="p">,</span>
                    <span class="n">tree</span><span class="o">=</span><span class="n">tree</span><span class="p">,</span>
                    <span class="n">next_actions</span><span class="o">=</span><span class="p">[],</span>
                <span class="p">)</span>
                <span class="k">nonlocal</span> <span class="n">counter</span>
                <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">prior</span> <span class="o">=</span> <span class="n">child_confidence_prior</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">item_confidence</span> <span class="o">=</span> <span class="n">confidence</span> <span class="o">*</span> <span class="n">prior</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">_PriorityItem</span><span class="p">(</span><span class="o">-</span><span class="n">item_confidence</span><span class="p">,</span> <span class="n">counter</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
                <span class="n">heapq</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="n">pqueue</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
                <span class="n">unsupported_node</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reinsert_node</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">_NodeState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">nonlocal</span> <span class="n">counter</span>
        <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">prior</span> <span class="o">=</span> <span class="n">child_confidence_prior</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">children</span><span class="p">))</span>
        <span class="n">item_confidence</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">confidence</span> <span class="o">*</span> <span class="n">prior</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">_PriorityItem</span><span class="p">(</span><span class="o">-</span><span class="n">item_confidence</span><span class="p">,</span> <span class="n">counter</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="n">heapq</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="n">pqueue</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>

    <span class="c1"># Put the root into the queue.</span>
    <span class="k">yield from</span> <span class="n">push_fresh_node</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">pqueue</span><span class="p">:</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">heapq</span><span class="o">.</span><span class="n">heappop</span><span class="p">(</span><span class="n">pqueue</span><span class="p">)</span><span class="o">.</span><span class="n">node_state</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="o">.</span><span class="n">next_actions</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="o">.</span><span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="c1"># No more actions to take, we do not put the node back.</span>
                <span class="k">continue</span>
            <span class="n">generated</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="nb">next</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">state</span><span class="o">.</span><span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="n">state</span><span class="o">.</span><span class="n">next_actions</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">tracked</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">generated</span><span class="p">])</span>
            <span class="n">state</span><span class="o">.</span><span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">next</span>
        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">next_actions</span><span class="p">:</span>
            <span class="n">cand</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">next_actions</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">child</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">child</span><span class="p">(</span><span class="n">cand</span><span class="p">)</span>
            <span class="n">state</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">ref</span><span class="p">)</span>
            <span class="k">yield from</span> <span class="n">push_fresh_node</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># We put the node back into the queue</span>
        <span class="n">reinsert_node</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h2 id="abduction">Abduction</h2>


<div class="doc doc-object doc-class">



<h3 id="delphyne.Abduction" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">Abduction</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="Node (delphyne.core.Node)" href="../../strategies/trees/#delphyne.Node">Node</a></code></p>


        <p>Node for the singleton tree produced by <a class="autorefs autorefs-internal" title="abduction" href="#delphyne.abduction"><code>abduction</code></a>.
See <a class="autorefs autorefs-internal" title="abduction" href="#delphyne.abduction"><code>abduction</code></a> for details.</p>
<p>An action is a successful proof of the main goal.</p>








              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/search/abduction.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span>
<span class="normal">98</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Abduction</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">Node</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Node for the singleton tree produced by `abduction`.</span>
<span class="sd">    See `abduction` for details.</span>

<span class="sd">    An action is a successful proof of the main goal.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">prove</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
        <span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">_TrackedFact</span><span class="p">,</span> <span class="n">_TrackedProof</span><span class="p">]],</span> <span class="n">_TrackedEFact</span><span class="p">],</span>
        <span class="n">OpaqueSpace</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">_Status</span><span class="p">],</span>
    <span class="p">]</span>
    <span class="n">suggest</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
        <span class="p">[</span><span class="n">_TrackedFeedback</span><span class="p">],</span>
        <span class="n">OpaqueSpace</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">_Fact</span><span class="p">]],</span>
    <span class="p">]</span>
    <span class="n">search_equivalent</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
        <span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">_TrackedFact</span><span class="p">],</span> <span class="n">_TrackedFact</span><span class="p">],</span>
        <span class="n">OpaqueSpace</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">_Fact</span> <span class="o">|</span> <span class="kc">None</span><span class="p">],</span>
    <span class="p">]</span>
    <span class="n">redundant</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
        <span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">_TrackedFact</span><span class="p">],</span> <span class="n">_TrackedFact</span><span class="p">],</span>
        <span class="n">OpaqueSpace</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">bool</span><span class="p">],</span>
    <span class="p">]</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">navigate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">Navigation</span><span class="p">:</span>
        <span class="n">proved</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">_TrackedEFact</span><span class="p">,</span> <span class="n">_TrackedProof</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">aux</span><span class="p">(</span><span class="n">fact</span><span class="p">:</span> <span class="n">_TrackedEFact</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">NavigationContext</span><span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
            <span class="c1"># If `fact` is already proved, do nothing</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">drop_refs</span><span class="p">(</span><span class="n">fact</span><span class="p">)</span> <span class="o">==</span> <span class="n">drop_refs</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">proved</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="c1"># We use `cast` because we know `proved` does not contain `None`.</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">prove</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">proved</span><span class="p">),</span> <span class="n">fact</span><span class="p">)</span>
            <span class="n">status</span><span class="p">,</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">status</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;proved&quot;</span><span class="p">:</span>
                <span class="n">proved</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">fact</span><span class="p">,</span> <span class="n">payload</span><span class="p">))</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">status</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;disproved&quot;</span><span class="p">:</span>
                <span class="c1"># It is ok if a subgoal is disproved, as long as the</span>
                <span class="c1"># main goal is proved in the end.</span>
                <span class="k">return</span>
            <span class="k">assert</span> <span class="n">status</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;feedback&quot;</span>
            <span class="c1"># Obtain suggestions and try to prove them all recursively</span>
            <span class="n">feedback</span> <span class="o">=</span> <span class="n">payload</span>
            <span class="n">suggestions</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">suggest</span><span class="p">(</span><span class="n">feedback</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">suggestions</span><span class="p">:</span>
                <span class="k">yield from</span> <span class="n">aux</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="c1"># Check again if `fact` is now proved</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">drop_refs</span><span class="p">(</span><span class="n">fact</span><span class="p">)</span> <span class="o">==</span> <span class="n">drop_refs</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">proved</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="c1"># If not, try and prove it again with the suggestions</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">prove</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">proved</span><span class="p">),</span> <span class="n">fact</span><span class="p">)</span>
            <span class="n">status</span><span class="p">,</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">status</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="s2">&quot;proved&quot;</span><span class="p">:</span>
                <span class="c1"># It is ok if a subgoal is not proved, as long as the</span>
                <span class="c1"># main goal is proved in the end. Indeed, suggestions</span>
                <span class="c1"># can be repair proposals instead of auxiliary facts.</span>
                <span class="k">return</span>
            <span class="n">proved</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">fact</span><span class="p">,</span> <span class="n">payload</span><span class="p">))</span>

        <span class="k">yield from</span> <span class="n">aux</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">proved</span> <span class="ow">or</span> <span class="n">proved</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">dp</span><span class="o">.</span><span class="n">NavigationError</span><span class="p">(</span><span class="s2">&quot;Main goal was not proved&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">proved</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="delphyne.abduction" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">abduction</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">abduction</span><span class="p">(</span>
    <span class="n">prove</span><span class="p">:</span> <span class="n"><span title="collections.abc.Callable">Callable</span></span><span class="p">[</span>
        <span class="p">[</span><span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><span title="tuple">tuple</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.abduction.abduction[Fact]">Fact</span></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.search.abduction.abduction[Proof]">Proof</span></span><span class="p">]],</span> <span class="n"><span title="delphyne.stdlib.search.abduction.abduction[Fact]">Fact</span></span> <span class="o">|</span> <span class="kc">None</span><span class="p">],</span>
        <span class="n"><a class="autorefs autorefs-internal" title="Opaque (delphyne.stdlib.opaque.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.abduction.abduction[P]">P</span></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.search.abduction.AbductionStatus">AbductionStatus</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.abduction.abduction[Feedback]">Feedback</span></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.search.abduction.abduction[Proof]">Proof</span></span><span class="p">]],</span>
    <span class="p">],</span>
    <span class="n">suggest</span><span class="p">:</span> <span class="n"><span title="collections.abc.Callable">Callable</span></span><span class="p">[[</span><span class="n"><span title="delphyne.stdlib.search.abduction.abduction[Feedback]">Feedback</span></span><span class="p">],</span> <span class="n"><a class="autorefs autorefs-internal" title="Opaque (delphyne.stdlib.opaque.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.abduction.abduction[P]">P</span></span><span class="p">,</span> <span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.abduction.abduction[Fact]">Fact</span></span><span class="p">]]],</span>
    <span class="n">search_equivalent</span><span class="p">:</span> <span class="n"><span title="collections.abc.Callable">Callable</span></span><span class="p">[[</span><span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.abduction.abduction[Fact]">Fact</span></span><span class="p">],</span> <span class="n"><span title="delphyne.stdlib.search.abduction.abduction[Fact]">Fact</span></span><span class="p">],</span> <span class="n"><a class="autorefs autorefs-internal" title="Opaque (delphyne.stdlib.opaque.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.abduction.abduction[P]">P</span></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.search.abduction.abduction[Fact]">Fact</span></span> <span class="o">|</span> <span class="kc">None</span><span class="p">]],</span>
    <span class="n">redundant</span><span class="p">:</span> <span class="n"><span title="collections.abc.Callable">Callable</span></span><span class="p">[[</span><span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.abduction.abduction[Fact]">Fact</span></span><span class="p">],</span> <span class="n"><span title="delphyne.stdlib.search.abduction.abduction[Fact]">Fact</span></span><span class="p">],</span> <span class="n"><a class="autorefs autorefs-internal" title="Opaque (delphyne.stdlib.opaque.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.abduction.abduction[P]">P</span></span><span class="p">,</span> <span class="n"><span title="bool">bool</span></span><span class="p">]],</span>
    <span class="n">inner_policy_type</span><span class="p">:</span> <span class="n"><span title="type">type</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.abduction.abduction[P]">P</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Strategy (delphyne.core.Strategy)" href="../../strategies/strategies/#delphyne.Strategy">Strategy</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="Abduction


  
      dataclass
   (delphyne.stdlib.search.abduction.Abduction)" href="#delphyne.Abduction">Abduction</a></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.search.abduction.abduction[P]">P</span></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.search.abduction.abduction[Proof]">Proof</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Higher-order strategy for proving a fact via recursive abduction.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>prove</code>
            </td>
            <td>
                  <code><span title="collections.abc.Callable">Callable</span>[[<span title="collections.abc.Sequence">Sequence</span>[<span title="tuple">tuple</span>[<span title="delphyne.stdlib.search.abduction.abduction[Fact]">Fact</span>, <span title="delphyne.stdlib.search.abduction.abduction[Proof]">Proof</span>]], <span title="delphyne.stdlib.search.abduction.abduction[Fact]">Fact</span> | None], <a class="autorefs autorefs-internal" title="Opaque (delphyne.stdlib.opaque.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a>[<span title="delphyne.stdlib.search.abduction.abduction[P]">P</span>, <span title="delphyne.stdlib.search.abduction.AbductionStatus">AbductionStatus</span>[<span title="delphyne.stdlib.search.abduction.abduction[Feedback]">Feedback</span>, <span title="delphyne.stdlib.search.abduction.abduction[Proof]">Proof</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>take a sequence of already established facts as an
argument along with a new fact, and attempt to prove this new
fact. Three outcomes are possible: the fact is proved,
disproved, or a list of suggestions are made that might be
helpful to prove first. <code>None</code> denotes the top-level goal to be
proved.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>suggest</code>
            </td>
            <td>
                  <code><span title="collections.abc.Callable">Callable</span>[[<span title="delphyne.stdlib.search.abduction.abduction[Feedback]">Feedback</span>], <a class="autorefs autorefs-internal" title="Opaque (delphyne.stdlib.opaque.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a>[<span title="delphyne.stdlib.search.abduction.abduction[P]">P</span>, <span title="collections.abc.Sequence">Sequence</span>[<span title="delphyne.stdlib.search.abduction.abduction[Fact]">Fact</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>take some feedback from the <code>prove</code> function and return a
sequence of fact candidates that may be useful to prove before
reattempting the original proof.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>search_equivalent</code>
            </td>
            <td>
                  <code><span title="collections.abc.Callable">Callable</span>[[<span title="collections.abc.Sequence">Sequence</span>[<span title="delphyne.stdlib.search.abduction.abduction[Fact]">Fact</span>], <span title="delphyne.stdlib.search.abduction.abduction[Fact]">Fact</span>], <a class="autorefs autorefs-internal" title="Opaque (delphyne.stdlib.opaque.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a>[<span title="delphyne.stdlib.search.abduction.abduction[P]">P</span>, <span title="delphyne.stdlib.search.abduction.abduction[Fact]">Fact</span> | None]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>take a collection of facts along with a new
one, and return either the first fact of the list equivalent to
the new fact or <code>None</code>. This is used to avoid spending search in
proving equivalent facts.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>redundant</code>
            </td>
            <td>
                  <code><span title="collections.abc.Callable">Callable</span>[[<span title="collections.abc.Sequence">Sequence</span>[<span title="delphyne.stdlib.search.abduction.abduction[Fact]">Fact</span>], <span title="delphyne.stdlib.search.abduction.abduction[Fact]">Fact</span>], <a class="autorefs autorefs-internal" title="Opaque (delphyne.stdlib.opaque.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a>[<span title="delphyne.stdlib.search.abduction.abduction[P]">P</span>, <span title="bool">bool</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>take a collection of established facts and decide
whether they imply a new fact candidate. This is useful to avoid
trying to prove and accumulating redundant facts.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="Strategy (delphyne.core.Strategy)" href="../../strategies/strategies/#delphyne.Strategy">Strategy</a>[<a class="autorefs autorefs-internal" title="Abduction


  
      dataclass
   (delphyne.stdlib.search.abduction.Abduction)" href="#delphyne.Abduction">Abduction</a>, <span title="delphyne.stdlib.search.abduction.abduction[P]">P</span>, <span title="delphyne.stdlib.search.abduction.abduction[Proof]">Proof</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>a proof of the top-level goal.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/search/abduction.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">abduction</span><span class="p">[</span><span class="n">Fact</span><span class="p">,</span> <span class="n">Feedback</span><span class="p">,</span> <span class="n">Proof</span><span class="p">,</span> <span class="n">P</span><span class="p">](</span>
    <span class="n">prove</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
        <span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Fact</span><span class="p">,</span> <span class="n">Proof</span><span class="p">]],</span> <span class="n">Fact</span> <span class="o">|</span> <span class="kc">None</span><span class="p">],</span>
        <span class="n">Opaque</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">AbductionStatus</span><span class="p">[</span><span class="n">Feedback</span><span class="p">,</span> <span class="n">Proof</span><span class="p">]],</span>
    <span class="p">],</span>
    <span class="n">suggest</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
        <span class="p">[</span><span class="n">Feedback</span><span class="p">],</span>
        <span class="n">Opaque</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Fact</span><span class="p">]],</span>
    <span class="p">],</span>
    <span class="n">search_equivalent</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
        <span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Fact</span><span class="p">],</span> <span class="n">Fact</span><span class="p">],</span> <span class="n">Opaque</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">Fact</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span>
    <span class="p">],</span>
    <span class="n">redundant</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Fact</span><span class="p">],</span> <span class="n">Fact</span><span class="p">],</span> <span class="n">Opaque</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]],</span>
    <span class="n">inner_policy_type</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">P</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">Strategy</span><span class="p">[</span><span class="n">Abduction</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">Proof</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Higher-order strategy for proving a fact via recursive abduction.</span>

<span class="sd">    Arguments:</span>
<span class="sd">      prove: take a sequence of already established facts as an</span>
<span class="sd">        argument along with a new fact, and attempt to prove this new</span>
<span class="sd">        fact. Three outcomes are possible: the fact is proved,</span>
<span class="sd">        disproved, or a list of suggestions are made that might be</span>
<span class="sd">        helpful to prove first. `None` denotes the top-level goal to be</span>
<span class="sd">        proved.</span>

<span class="sd">      suggest: take some feedback from the `prove` function and return a</span>
<span class="sd">        sequence of fact candidates that may be useful to prove before</span>
<span class="sd">        reattempting the original proof.</span>

<span class="sd">      search_equivalent: take a collection of facts along with a new</span>
<span class="sd">        one, and return either the first fact of the list equivalent to</span>
<span class="sd">        the new fact or `None`. This is used to avoid spending search in</span>
<span class="sd">        proving equivalent facts.</span>

<span class="sd">      redundant: take a collection of established facts and decide</span>
<span class="sd">        whether they imply a new fact candidate. This is useful to avoid</span>
<span class="sd">        trying to prove and accumulating redundant facts.</span>

<span class="sd">    Returns:</span>
<span class="sd">      a proof of the top-level goal.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">spawn_node</span><span class="p">(</span>
        <span class="n">Abduction</span><span class="p">,</span>
        <span class="n">prove</span><span class="o">=</span><span class="n">prove</span><span class="p">,</span>
        <span class="n">suggest</span><span class="o">=</span><span class="n">suggest</span><span class="p">,</span>
        <span class="n">search_equivalent</span><span class="o">=</span><span class="n">search_equivalent</span><span class="p">,</span>
        <span class="n">redundant</span><span class="o">=</span><span class="n">redundant</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">Proof</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="delphyne.abduct_recursively" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">abduct_recursively</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">abduct_recursively</span><span class="p">(</span>
    <span class="n">tree</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="Tree


  
      dataclass
   (delphyne.core.Tree)" href="../../strategies/trees/#delphyne.Tree">Tree</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="Abduction


  
      dataclass
   (delphyne.stdlib.search.abduction.Abduction)" href="#delphyne.Abduction">Abduction</a></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.search.abduction.abduct_recursively[P]">P</span></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.search.abduction.abduct_recursively[Proof]">Proof</span></span><span class="p">],</span>
    <span class="n">env</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="PolicyEnv (delphyne.stdlib.environments.PolicyEnv)" href="../environments/#delphyne.PolicyEnv">PolicyEnv</a></span><span class="p">,</span>
    <span class="n">policy</span><span class="p">:</span> <span class="n"><span title="delphyne.stdlib.search.abduction.abduct_recursively[P]">P</span></span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">max_depth</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">max_suggestions</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="StreamGen (delphyne.core.StreamGen)" href="../../policies/streams/#delphyne.StreamGen">StreamGen</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.abduction.abduct_recursively[Proof]">Proof</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>A simple policy for <a class="autorefs autorefs-internal" title="Abduction


  
      dataclass
  " href="#delphyne.Abduction"><code>Abduction</code></a> nodes that mimics the behavior of
the associated navigation function.</p>
<p>This policy does not use <code>search_equivalent</code> and <code>is_redundant</code>.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>max_depth</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum recursive depth at which proof attempts
are performed. If equal to 0, <code>suggest</code> is never called and
the policy succeeds only if the top-level goal can be
proved straight away. If equal to 1, suggestions can be made
but they must all be provable straight away.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_suggestions</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum of suggestions to consider.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/search/abduction.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@search_policy</span>
<span class="k">def</span><span class="w"> </span><span class="nf">abduct_recursively</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">Proof</span><span class="p">](</span>
    <span class="n">tree</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">Tree</span><span class="p">[</span><span class="n">Abduction</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">Proof</span><span class="p">],</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">PolicyEnv</span><span class="p">,</span>
    <span class="n">policy</span><span class="p">:</span> <span class="n">P</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">max_depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">max_suggestions</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">StreamGen</span><span class="p">[</span><span class="n">Proof</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A simple policy for `Abduction` nodes that mimics the behavior of</span>
<span class="sd">    the associated navigation function.</span>

<span class="sd">    This policy does not use `search_equivalent` and `is_redundant`.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        max_depth: The maximum recursive depth at which proof attempts</span>
<span class="sd">            are performed. If equal to 0, `suggest` is never called and</span>
<span class="sd">            the policy succeeds only if the top-level goal can be</span>
<span class="sd">            proved straight away. If equal to 1, suggestions can be made</span>
<span class="sd">            but they must all be provable straight away.</span>
<span class="sd">        max_suggestions: The maximum of suggestions to consider.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">proved</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">_TrackedEFact</span><span class="p">,</span> <span class="n">_TrackedProof</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">Abduction</span><span class="p">)</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">node</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">prove</span><span class="p">(</span>
        <span class="n">fact</span><span class="p">:</span> <span class="n">_TrackedEFact</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">StreamContext</span><span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">Tracked</span><span class="p">[</span><span class="n">AbductionStatus</span><span class="p">[</span><span class="n">_Feedback</span><span class="p">,</span> <span class="n">_Proof</span><span class="p">]]]:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">(</span>
            <span class="k">yield from</span> <span class="n">node</span><span class="o">.</span><span class="n">prove</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">proved</span><span class="p">),</span> <span class="n">fact</span><span class="p">)</span>
            <span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">policy</span><span class="p">)</span>
            <span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">_Abort</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">tracked</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">suggest</span><span class="p">(</span>
        <span class="n">feedback</span><span class="p">:</span> <span class="n">_TrackedFeedback</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">StreamContext</span><span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">Tracked</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">_Fact</span><span class="p">]]]:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">node</span><span class="o">.</span><span class="n">suggest</span><span class="p">(</span><span class="n">feedback</span><span class="p">)</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">policy</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">_Abort</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">tracked</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">aux</span><span class="p">(</span><span class="n">fact</span><span class="p">:</span> <span class="n">_TrackedEFact</span><span class="p">,</span> <span class="n">depth</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">StreamContext</span><span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;</span> <span class="n">max_depth</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># If `fact` is already proved, do nothing</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">drop_refs</span><span class="p">(</span><span class="n">fact</span><span class="p">)</span> <span class="o">==</span> <span class="n">drop_refs</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">proved</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">prove</span><span class="p">(</span><span class="n">fact</span><span class="p">)</span>
        <span class="n">status</span><span class="p">,</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">status</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;proved&quot;</span><span class="p">:</span>
            <span class="n">proved</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">fact</span><span class="p">,</span> <span class="n">payload</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">status</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;disproved&quot;</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">assert</span> <span class="n">status</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;feedback&quot;</span>
        <span class="c1"># Obtain suggestions and try to prove them all recursively</span>
        <span class="n">feedback</span> <span class="o">=</span> <span class="n">payload</span>
        <span class="n">suggestions</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="p">(</span><span class="k">yield from</span> <span class="n">suggest</span><span class="p">(</span><span class="n">feedback</span><span class="p">))]</span>
        <span class="k">if</span> <span class="n">max_suggestions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">suggestions</span> <span class="o">=</span> <span class="n">suggestions</span><span class="p">[:</span><span class="n">max_suggestions</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">suggestions</span><span class="p">:</span>
            <span class="k">yield from</span> <span class="n">aux</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Check again if `fact` is now proved</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">drop_refs</span><span class="p">(</span><span class="n">fact</span><span class="p">)</span> <span class="o">==</span> <span class="n">drop_refs</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">proved</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="c1"># If not, try and prove it again with the suggestions</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">prove</span><span class="p">(</span><span class="n">fact</span><span class="p">)</span>
        <span class="n">status</span><span class="p">,</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">status</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="s2">&quot;proved&quot;</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">proved</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">fact</span><span class="p">,</span> <span class="n">payload</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield from</span> <span class="n">aux</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">_Abort</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">proved</span> <span class="ow">and</span> <span class="n">proved</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">proof</span> <span class="o">=</span> <span class="n">proved</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">child</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">child</span><span class="p">(</span><span class="n">proof</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">dp</span><span class="o">.</span><span class="n">Success</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">dp</span><span class="o">.</span><span class="n">Solution</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">success</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="delphyne.abduct_and_saturate" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">abduct_and_saturate</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">abduct_and_saturate</span><span class="p">(</span>
    <span class="n">tree</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="Tree


  
      dataclass
   (delphyne.core.Tree)" href="../../strategies/trees/#delphyne.Tree">Tree</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="Abduction


  
      dataclass
   (delphyne.stdlib.search.abduction.Abduction)" href="#delphyne.Abduction">Abduction</a></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.search.abduction.abduct_and_saturate[P]">P</span></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.search.abduction.abduct_and_saturate[Proof]">Proof</span></span><span class="p">],</span>
    <span class="n">env</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="PolicyEnv (delphyne.stdlib.environments.PolicyEnv)" href="../environments/#delphyne.PolicyEnv">PolicyEnv</a></span><span class="p">,</span>
    <span class="n">policy</span><span class="p">:</span> <span class="n"><span title="delphyne.stdlib.search.abduction.abduct_and_saturate[P]">P</span></span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">max_rollout_depth</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">scoring_function</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="ScoringFunction (delphyne.stdlib.search.abduction.ScoringFunction)" href="#delphyne.stdlib.search.abduction.ScoringFunction">ScoringFunction</a></span> <span class="o">=</span> <span class="n"><a class="autorefs autorefs-internal" title="_default_scoring_function (delphyne.stdlib.search.abduction._default_scoring_function)" href="#delphyne.stdlib.search.abduction._default_scoring_function">_default_scoring_function</a></span><span class="p">,</span>
    <span class="n">log_steps</span><span class="p">:</span> <span class="n"><span title="delphyne.core.LogLevel">LogLevel</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_raw_suggestions_per_step</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_reattempted_candidates_per_propagation_step</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_consecutive_propagation_steps</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_proved</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_candidates</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">remember_disproved</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="StreamGen (delphyne.core.StreamGen)" href="../../policies/streams/#delphyne.StreamGen">StreamGen</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.abduction.abduct_and_saturate[Proof]">Proof</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>A saturation-based, sequential policy for abduction trees.</p>
<p>This policy proceeds by saturation: it repeatedly grows a set of
proved facts until the main goal is proved or some limit is reached.</p>
<p>It does so by repeatedly performing <em>rollouts</em>. Each rollout starts
with the toplevel goal as a target, and attempts to prove this target
assuming all facts in <code>proved</code>. If the target cannot be proved,
suggestions for auxiliary facts to prove first are requested before
another attempt is made. If still unsuccessful, one of the unproved
suggestions is set as the new target and the rollout proceeds (up to
some depth specified by <code>max_rollout_depth</code>).</p>
<p>The algorithm maintains four, disjoint global sets of facts:</p>
<ul>
<li><code>proved</code>: facts that have been successfully proved</li>
<li><code>disproved</code>: facts that have been disproved</li>
<li><code>redundant</code>: facts that are implied by the conjunction of all
  facts from <code>proved</code>.</li>
<li><code>candidates</code>: facts that have been suggested but do not belong to
  any of the three sets above.</li>
</ul>
<p>Each step of a rollout proceeds as follows:</p>
<ul>
<li>The current target is assumed to be a fact from the <code>candidates</code>
  set. Suggestions for new rollout targets are determined as follows
  (<code>get_suggestions</code>):<ul>
<li>The <code>suggest</code> node function returns a list of candidates.</li>
<li>All suggestions are normalized using the <code>search_equivalent</code>
  node function (one call per suggestion).</li>
<li>Each normalized suggestion is added (<code>add_candidate</code>) to one
  of the <code>proved</code>, <code>disproved</code>, <code>redundant</code>, or <code>candidates</code>
  sets. At most one call to the <code>prove</code> and <code>is_redundant</code> node
  functions is made per suggestion.</li>
<li>Assuming the previous step results in at least one new fact
  being proved, all candidates from the <code>candidates</code> set are
  re-examined until saturation (<code>saturate</code>).</li>
<li>Remaining suggestions that are in <code>candidates</code> are potential
  taregts for the next rollout step.</li>
</ul>
</li>
<li>Assuming the current target is still not proved, the next rollout
  target is picked using the <code>scoring_function</code> parameter.</li>
</ul>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>max_rollout_depth</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum depth of a rollout, as the
maximal number of consecutive target goals that can be set
(the first goal being the toplevel goal).</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>scoring_function</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="ScoringFunction (delphyne.stdlib.search.abduction.ScoringFunction)" href="#delphyne.stdlib.search.abduction.ScoringFunction">ScoringFunction</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Scoring function for choosing the next target
goal at the end of each rollout step.</p>
              </div>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="_default_scoring_function (delphyne.stdlib.search.abduction._default_scoring_function)" href="#delphyne.stdlib.search.abduction._default_scoring_function">_default_scoring_function</a></code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>log_steps</code>
            </td>
            <td>
                  <code><span title="delphyne.core.LogLevel">LogLevel</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If not <code>None</code>, log main steps of the algorithm at the
provided severity level.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_raw_suggestions_per_step</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of suggestions from
the <code>suggest</code> node function to consider at each rollout
step. If more suggestions are available, the most frequent
(for naive, syntacic equality) ones are chosen.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_reattempted_candidates_per_propagation_step</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number
of candidates that are reattempted at each propagation step.
Candidates that have been proposed more frequently are
selected in priority.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_consecutive_propagation_steps</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of propagation
steps that are performed during a rollout step, or <code>None</code> if
there is no limit.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_proved</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum number of proved facts that can be
accumulated. Search fails if this number is exceeded without
the top-level goal being proved. In particular, setting such
a limit is useful for bounding the complexity of <code>prove</code>,
<code>search_equivalent</code> and <code>is_redundant</code>.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_candidates</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum number of unproved fact candidates
that can be memorized. Once this number is met, new
suggestions are not memorized if they cannot be proved
straight away. In particular, setting such a limit is useful
for bounding the complexity of <code>search_equivalent</code>.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>remember_disproved</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether or not to remember disproved facts
so that one does not attempt to prove them again. In
particular, not remembering disproved facts is useful for
bounding the complexity of <code>search_equivalent</code>.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>
        <div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Facts must be hashable.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>By design, this policy tries and makes as few calls to <code>suggest</code>
as possible, since those typically involve LLM calls. However,
by default, it can make a very large number of calls to <code>prove</code>,
<code>is_redundant</code> and <code>search_equivalent</code>. This number can explode
as the number of candidates increases (in particular, it can be
quadratic in the number of candidates at each rollout step, due
to saturation). Thus, we recommend setting proper limits using
the hyperparameters whose name start with <code>max_</code>.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Possible suggestions are auxiliary facts, but also repair
suggestions. For example, suppose the goal is to prove <code>x &gt; 0</code>,
which is false. Then, one might suggest a repair such as <code>n &gt; 0
-&gt; x &gt; 0</code>.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>No fact is attempted to be proved if it is redundant with
already-proved facts. However, in the current implementation,
the set of proved facts can still contain redundancy. For
example, if <code>x &gt; 0</code> is established before the stronger <code>x &gt;= 0</code>
is, the former won't be deleted.</p>
</div>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/search/abduction.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@search_policy</span>
<span class="k">def</span><span class="w"> </span><span class="nf">abduct_and_saturate</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">Proof</span><span class="p">](</span>
    <span class="n">tree</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">Tree</span><span class="p">[</span><span class="n">Abduction</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">Proof</span><span class="p">],</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">PolicyEnv</span><span class="p">,</span>
    <span class="n">policy</span><span class="p">:</span> <span class="n">P</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">max_rollout_depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">scoring_function</span><span class="p">:</span> <span class="n">ScoringFunction</span> <span class="o">=</span> <span class="n">_default_scoring_function</span><span class="p">,</span>
    <span class="n">log_steps</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">LogLevel</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_raw_suggestions_per_step</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_reattempted_candidates_per_propagation_step</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_consecutive_propagation_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_proved</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_candidates</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">remember_disproved</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">StreamGen</span><span class="p">[</span><span class="n">Proof</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A saturation-based, sequential policy for abduction trees.</span>

<span class="sd">    This policy proceeds by saturation: it repeatedly grows a set of</span>
<span class="sd">    proved facts until the main goal is proved or some limit is reached.</span>

<span class="sd">    It does so by repeatedly performing _rollouts_. Each rollout starts</span>
<span class="sd">    with the toplevel goal as a target, and attempts to prove this target</span>
<span class="sd">    assuming all facts in `proved`. If the target cannot be proved,</span>
<span class="sd">    suggestions for auxiliary facts to prove first are requested before</span>
<span class="sd">    another attempt is made. If still unsuccessful, one of the unproved</span>
<span class="sd">    suggestions is set as the new target and the rollout proceeds (up to</span>
<span class="sd">    some depth specified by `max_rollout_depth`).</span>

<span class="sd">    The algorithm maintains four, disjoint global sets of facts:</span>

<span class="sd">    - `proved`: facts that have been successfully proved</span>
<span class="sd">    - `disproved`: facts that have been disproved</span>
<span class="sd">    - `redundant`: facts that are implied by the conjunction of all</span>
<span class="sd">      facts from `proved`.</span>
<span class="sd">    - `candidates`: facts that have been suggested but do not belong to</span>
<span class="sd">      any of the three sets above.</span>

<span class="sd">    Each step of a rollout proceeds as follows:</span>

<span class="sd">    - The current target is assumed to be a fact from the `candidates`</span>
<span class="sd">      set. Suggestions for new rollout targets are determined as follows</span>
<span class="sd">      (`get_suggestions`):</span>
<span class="sd">        - The `suggest` node function returns a list of candidates.</span>
<span class="sd">        - All suggestions are normalized using the `search_equivalent`</span>
<span class="sd">          node function (one call per suggestion).</span>
<span class="sd">        - Each normalized suggestion is added (`add_candidate`) to one</span>
<span class="sd">          of the `proved`, `disproved`, `redundant`, or `candidates`</span>
<span class="sd">          sets. At most one call to the `prove` and `is_redundant` node</span>
<span class="sd">          functions is made per suggestion.</span>
<span class="sd">        - Assuming the previous step results in at least one new fact</span>
<span class="sd">          being proved, all candidates from the `candidates` set are</span>
<span class="sd">          re-examined until saturation (`saturate`).</span>
<span class="sd">        - Remaining suggestions that are in `candidates` are potential</span>
<span class="sd">          taregts for the next rollout step.</span>
<span class="sd">    - Assuming the current target is still not proved, the next rollout</span>
<span class="sd">      target is picked using the `scoring_function` parameter.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        max_rollout_depth: The maximum depth of a rollout, as the</span>
<span class="sd">            maximal number of consecutive target goals that can be set</span>
<span class="sd">            (the first goal being the toplevel goal).</span>
<span class="sd">        scoring_function: Scoring function for choosing the next target</span>
<span class="sd">            goal at the end of each rollout step.</span>
<span class="sd">        log_steps: If not `None`, log main steps of the algorithm at the</span>
<span class="sd">            provided severity level.</span>
<span class="sd">        max_raw_suggestions_per_step: Maximum number of suggestions from</span>
<span class="sd">            the `suggest` node function to consider at each rollout</span>
<span class="sd">            step. If more suggestions are available, the most frequent</span>
<span class="sd">            (for naive, syntacic equality) ones are chosen.</span>
<span class="sd">        max_reattempted_candidates_per_propagation_step: Maximum number</span>
<span class="sd">            of candidates that are reattempted at each propagation step.</span>
<span class="sd">            Candidates that have been proposed more frequently are</span>
<span class="sd">            selected in priority.</span>
<span class="sd">        max_consecutive_propagation_steps: Maximum number of propagation</span>
<span class="sd">            steps that are performed during a rollout step, or `None` if</span>
<span class="sd">            there is no limit.</span>
<span class="sd">        max_proved: The maximum number of proved facts that can be</span>
<span class="sd">            accumulated. Search fails if this number is exceeded without</span>
<span class="sd">            the top-level goal being proved. In particular, setting such</span>
<span class="sd">            a limit is useful for bounding the complexity of `prove`,</span>
<span class="sd">            `search_equivalent` and `is_redundant`.</span>
<span class="sd">        max_candidates: The maximum number of unproved fact candidates</span>
<span class="sd">            that can be memorized. Once this number is met, new</span>
<span class="sd">            suggestions are not memorized if they cannot be proved</span>
<span class="sd">            straight away. In particular, setting such a limit is useful</span>
<span class="sd">            for bounding the complexity of `search_equivalent`.</span>
<span class="sd">        remember_disproved: Whether or not to remember disproved facts</span>
<span class="sd">            so that one does not attempt to prove them again. In</span>
<span class="sd">            particular, not remembering disproved facts is useful for</span>
<span class="sd">            bounding the complexity of `search_equivalent`.</span>

<span class="sd">    !!! warning</span>
<span class="sd">        Facts must be hashable.</span>

<span class="sd">    !!! warning</span>
<span class="sd">        By design, this policy tries and makes as few calls to `suggest`</span>
<span class="sd">        as possible, since those typically involve LLM calls. However,</span>
<span class="sd">        by default, it can make a very large number of calls to `prove`,</span>
<span class="sd">        `is_redundant` and `search_equivalent`. This number can explode</span>
<span class="sd">        as the number of candidates increases (in particular, it can be</span>
<span class="sd">        quadratic in the number of candidates at each rollout step, due</span>
<span class="sd">        to saturation). Thus, we recommend setting proper limits using</span>
<span class="sd">        the hyperparameters whose name start with `max_`.</span>

<span class="sd">    !!! tip</span>
<span class="sd">        Possible suggestions are auxiliary facts, but also repair</span>
<span class="sd">        suggestions. For example, suppose the goal is to prove `x &gt; 0`,</span>
<span class="sd">        which is false. Then, one might suggest a repair such as `n &gt; 0</span>
<span class="sd">        -&gt; x &gt; 0`.</span>

<span class="sd">    !!! note</span>
<span class="sd">        No fact is attempted to be proved if it is redundant with</span>
<span class="sd">        already-proved facts. However, in the current implementation,</span>
<span class="sd">        the set of proved facts can still contain redundancy. For</span>
<span class="sd">        example, if `x &gt; 0` is established before the stronger `x &gt;= 0`</span>
<span class="sd">        is, the former won&#39;t be deleted.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># TODO: stop the rollout if the current goal is proved.</span>

    <span class="c1"># Initialize tool statistics tracking</span>
    <span class="n">call_stats</span> <span class="o">=</span> <span class="n">_CallStats</span><span class="p">()</span>

    <span class="c1"># Invariant: `candidates`, `proved`, `disproved` and `redundant` are</span>
    <span class="c1"># disjoint. Together, they form the set of &quot;canonical facts&quot;.</span>
    <span class="n">candidates</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">_EFact</span><span class="p">,</span> <span class="n">_CandInfo</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">proved</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">_EFact</span><span class="p">,</span> <span class="n">_TrackedProof</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">disproved</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">_EFact</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="c1"># Facts that are implied by the conjunction of all proved facts.</span>
    <span class="n">redundant</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">_EFact</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="c1"># It is easier to manipulate untracked facts and so we keep the</span>
    <span class="c1"># correspondence with tracked facts here.</span>
    <span class="c1"># Invariant: all canonical facts are included in `tracked`.</span>
    <span class="n">tracked</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">_EFact</span><span class="p">,</span> <span class="n">_TrackedEFact</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="kc">None</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

    <span class="c1"># The `equivalent` dict maps a fact to its canonical equivalent</span>
    <span class="c1"># representative that is somewhere in `candidates`, `proved`,</span>
    <span class="c1"># `disproved` or `redundant`.</span>
    <span class="n">equivalent</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">_EFact</span><span class="p">,</span> <span class="n">_EFact</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">assert</span> <span class="n">max_rollout_depth</span> <span class="o">&gt;=</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">Abduction</span><span class="p">)</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">node</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">tracked_f</span><span class="p">(</span><span class="n">fact</span><span class="p">:</span> <span class="n">_Fact</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_TrackedFact</span><span class="p">:</span>
        <span class="c1"># Access `tracked` but ensure that `None` is not returned</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">tracked</span><span class="p">[</span><span class="n">fact</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_fact_stats</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">_FactStats</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_FactStats</span><span class="p">(</span>
            <span class="n">num_candidates</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">),</span>
            <span class="n">num_proved</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">proved</span><span class="p">),</span>
            <span class="n">num_disproved</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">disproved</span><span class="p">),</span>
            <span class="n">num_redundant</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">redundant</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dbg</span><span class="p">(</span><span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">log_steps</span><span class="p">:</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;facts_stats&quot;</span><span class="p">:</span> <span class="n">compute_fact_stats</span><span class="p">(),</span>
                <span class="s2">&quot;call_stats&quot;</span><span class="p">:</span> <span class="n">call_stats</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">env</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">log_steps</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">stats</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">log_call_stats</span><span class="p">():</span>
        <span class="n">env</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;abduct_and_saturate_call_stats&quot;</span><span class="p">,</span> <span class="n">call_stats</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">all_canonical</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">_EFact</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span><span class="o">*</span><span class="n">candidates</span><span class="p">,</span> <span class="o">*</span><span class="n">proved</span><span class="p">,</span> <span class="o">*</span><span class="n">disproved</span><span class="p">,</span> <span class="o">*</span><span class="n">redundant</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_redundant</span><span class="p">(</span><span class="n">f</span><span class="p">:</span> <span class="n">_EFact</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">StreamContext</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">call_stats</span><span class="o">.</span><span class="n">is_redundant_calls</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">respace</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">redundant</span><span class="p">([</span><span class="n">tracked_f</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">proved</span><span class="p">],</span> <span class="n">tracked_f</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">respace</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">policy</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="n">call_stats</span><span class="o">.</span><span class="n">is_redundant_time_in_seconds</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">_Abort</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">tracked</span><span class="o">.</span><span class="n">value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_candidate</span><span class="p">(</span><span class="n">c</span><span class="p">:</span> <span class="n">_EFact</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">StreamContext</span><span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
        <span class="c1"># Take a new fact and put it into either `proved`, `disproved`,</span>
        <span class="c1"># `candidates` or `redundant`. If a canonical fact is passed,</span>
        <span class="c1"># nothing is done.</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">all_canonical</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="c1"># We first make a redundancy check</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">yield from</span> <span class="n">is_redundant</span><span class="p">(</span><span class="n">c</span><span class="p">)):</span>
            <span class="n">dbg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Redundant: </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">redundant</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># If not redundant, we try and prove it</span>
        <span class="n">call_stats</span><span class="o">.</span><span class="n">prove_calls</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">facts_list</span> <span class="o">=</span> <span class="p">[(</span><span class="n">tracked_f</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">proved</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="n">pstream</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">prove</span><span class="p">(</span><span class="n">facts_list</span><span class="p">,</span> <span class="n">tracked</span><span class="p">[</span><span class="n">c</span><span class="p">])</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">policy</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">pstream</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="n">call_stats</span><span class="o">.</span><span class="n">prove_time_in_seconds</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">_Abort</span><span class="p">()</span>
        <span class="n">status</span><span class="p">,</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">tracked</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">res</span><span class="o">.</span><span class="n">tracked</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">status</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;disproved&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">remember_disproved</span><span class="p">:</span>
                <span class="n">disproved</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="n">dbg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Disproved: </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">_Abort</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">status</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;proved&quot;</span><span class="p">:</span>
            <span class="n">proved</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">payload</span>
            <span class="n">dbg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Proved: </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">_ProofFound</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">max_proved</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">proved</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_proved</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">_Abort</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">max_candidates</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">max_candidates</span><span class="p">:</span>
            <span class="n">candidates</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">_CandInfo</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">propagate</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">StreamContext</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;updated&quot;</span><span class="p">,</span> <span class="s2">&quot;not_updated&quot;</span><span class="p">]]:</span>
        <span class="c1"># Go through each candidate and see if it is now provable</span>
        <span class="c1"># assuming all established facts.</span>
        <span class="n">dbg</span><span class="p">(</span><span class="s2">&quot;Propagating...&quot;</span><span class="p">)</span>
        <span class="n">old_candidates</span> <span class="o">=</span> <span class="n">candidates</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># Determining which candidates to reattempt</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">max_reattempted_candidates_per_propagation_step</span>
        <span class="k">if</span> <span class="n">M</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">to_reattempt</span> <span class="o">=</span> <span class="n">old_candidates</span>
            <span class="n">candidates</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">to_reattempt_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">old_candidates</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="n">to_reattempt_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">num_proposed</span><span class="p">)</span>
            <span class="n">to_reattempt</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">to_reattempt_list</span><span class="p">[:</span><span class="n">M</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">to_reattempt</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">candidates</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">to_reattempt</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">yield from</span> <span class="n">add_candidate</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
                <span class="c1"># Restore the counters if `c` is still a candidate</span>
                <span class="n">candidates</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">num_proposed</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">num_proposed</span>
                <span class="n">candidates</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">num_visited</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">num_visited</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="s2">&quot;updated&quot;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_candidates</span><span class="p">)</span>
            <span class="k">else</span> <span class="s2">&quot;not_updated&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">saturate</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">StreamContext</span><span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
        <span class="c1"># Propagate facts until saturation</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">max_consecutive_propagation_steps</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">m</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="k">yield from</span> <span class="n">propagate</span><span class="p">())</span> <span class="o">==</span> <span class="s2">&quot;updated&quot;</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_canonical</span><span class="p">(</span><span class="n">f</span><span class="p">:</span> <span class="n">_EFact</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">StreamContext</span><span class="p">[</span><span class="n">_EFact</span><span class="p">]:</span>
        <span class="c1"># The result is guaranteed to be in `tracked`</span>
        <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">proved</span> <span class="ow">or</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">disproved</span> <span class="ow">or</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
            <span class="c1"># Case where f is a canonical fact</span>
            <span class="k">return</span> <span class="n">f</span>
        <span class="k">assert</span> <span class="n">f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">equivalent</span><span class="p">:</span>
            <span class="c1"># Case where an equivalent canonical fact is known already</span>
            <span class="n">nf</span> <span class="o">=</span> <span class="n">equivalent</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">nf</span> <span class="ow">in</span> <span class="n">all_canonical</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">equivalent</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
        <span class="c1"># New fact whose equivalence must be tested</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="p">[</span><span class="n">tracked_f</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">all_canonical</span><span class="p">()</span> <span class="k">if</span> <span class="n">o</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">prev</span><span class="p">:</span>
            <span class="c1"># First fact: no need to make equivalence call</span>
            <span class="k">return</span> <span class="n">f</span>
        <span class="n">call_stats</span><span class="o">.</span><span class="n">search_equivalent_calls</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">eqspace</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">search_equivalent</span><span class="p">(</span><span class="n">prev</span><span class="p">,</span> <span class="n">tracked_f</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">eqspace</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">policy</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="n">call_stats</span><span class="o">.</span><span class="n">search_equivalent_time_in_seconds</span> <span class="o">+=</span> <span class="p">(</span>
            <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">_Abort</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">tracked</span>
        <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span>
        <span class="k">elif</span> <span class="n">res</span><span class="o">.</span><span class="n">value</span> <span class="ow">in</span> <span class="n">all_canonical</span><span class="p">():</span>
            <span class="n">equivalent</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">value</span>
            <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">env</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;invalid_equivalent_call&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">f</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_raw_suggestions</span><span class="p">(</span><span class="n">c</span><span class="p">:</span> <span class="n">_EFact</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">StreamContext</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">_EFact</span><span class="p">]]:</span>
        <span class="k">assert</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">candidates</span>
        <span class="n">sstream</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">suggest</span><span class="p">(</span><span class="n">candidates</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">feedback</span><span class="p">)</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">policy</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">sstream</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">:</span>
            <span class="c1"># If no suggestions are returned, we are out of budget and</span>
            <span class="c1"># abort so as to not call this again in a loop.</span>
            <span class="k">raise</span> <span class="n">_Abort</span><span class="p">()</span>
        <span class="n">tracked_suggs</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">tracked</span><span class="p">]</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">max_raw_suggestions_per_step</span>
        <span class="k">if</span> <span class="n">M</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tracked_suggs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">M</span><span class="p">:</span>
            <span class="n">counts</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">_Fact</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">tracked_suggs</span><span class="p">:</span>
                <span class="n">counts</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tracked_suggs</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">counts</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">tracked_suggs</span> <span class="o">=</span> <span class="n">tracked_suggs</span><span class="p">[:</span><span class="n">M</span><span class="p">]</span>
        <span class="c1"># Populate the `tracked` cache (this is the only place where new</span>
        <span class="c1"># facts can be created and so the only place where `tracked`</span>
        <span class="c1"># must be updated).</span>
        <span class="n">suggs</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">tracked_suggs</span><span class="p">]</span>
        <span class="n">dbg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Suggestions: </span><span class="si">{</span><span class="n">suggs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">ts</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">suggs</span><span class="p">,</span> <span class="n">tracked_suggs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tracked</span><span class="p">:</span>
                <span class="n">tracked</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts</span>
        <span class="k">return</span> <span class="n">suggs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_suggestions</span><span class="p">(</span><span class="n">c</span><span class="p">:</span> <span class="n">_EFact</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">StreamContext</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="n">_EFact</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
        <span class="c1"># Return a dict representing a multiset of suggestions</span>
        <span class="k">assert</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">candidates</span>
        <span class="n">raw_suggs</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">get_raw_suggestions</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">suggs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">_EFact</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">raw_suggs</span><span class="p">:</span>
            <span class="n">suggs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="k">yield from</span> <span class="n">get_canonical</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
        <span class="n">len_proved_old</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">proved</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">suggs</span><span class="p">:</span>
            <span class="k">yield from</span> <span class="n">add_candidate</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">len_proved_old</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">proved</span><span class="p">):</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">proved</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">len_proved_old</span>
            <span class="k">yield from</span> <span class="n">saturate</span><span class="p">()</span>
        <span class="n">suggs</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">suggs</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">]</span>
        <span class="n">suggs_multiset</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">_EFact</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">suggs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">suggs_multiset</span><span class="p">:</span>
                <span class="n">suggs_multiset</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">suggs_multiset</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">dbg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filtered: </span><span class="si">{</span><span class="n">suggs_multiset</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">suggs_multiset</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield from</span> <span class="n">add_candidate</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">cur</span><span class="p">:</span> <span class="n">_EFact</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_rollout_depth</span><span class="p">):</span>
                <span class="n">dbg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Explore fact: </span><span class="si">{</span><span class="n">cur</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">suggs</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">get_suggestions</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">suggs</span> <span class="ow">or</span> <span class="n">cur</span> <span class="ow">in</span> <span class="n">proved</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">n</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">suggs</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">suggs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">candidates</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">num_proposed</span> <span class="o">+=</span> <span class="n">k</span> <span class="o">/</span> <span class="n">n</span>
                <span class="n">infos</span> <span class="o">=</span> <span class="p">[</span><span class="n">candidates</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">suggs</span><span class="p">]</span>
                <span class="n">best</span> <span class="o">=</span> <span class="n">_argmax</span><span class="p">(</span>
                    <span class="n">scoring_function</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">num_proposed</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">num_visited</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">infos</span>
                <span class="p">)</span>
                <span class="n">cur</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">suggs</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">best</span><span class="p">]</span>
                <span class="n">candidates</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span><span class="o">.</span><span class="n">num_visited</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">except</span> <span class="n">_Abort</span><span class="p">:</span>
        <span class="n">log_call_stats</span><span class="p">()</span>
        <span class="k">return</span>
    <span class="k">except</span> <span class="n">_ProofFound</span><span class="p">:</span>
        <span class="n">log_call_stats</span><span class="p">()</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">proved</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span>
        <span class="n">child</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">child</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">dp</span><span class="o">.</span><span class="n">Success</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">dp</span><span class="o">.</span><span class="n">Solution</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">success</span><span class="p">)</span>
        <span class="k">return</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="delphyne.stdlib.search.abduction.ScoringFunction" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">ScoringFunction</span>


</h3>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="typing.Protocol">Protocol</span></code></p>


        <p>A function for assigning a score to candidate facts to prove, so
that the fact with the highest score is chosen next.</p>








              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/search/abduction.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ScoringFunction</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A function for assigning a score to candidate facts to prove, so</span>
<span class="sd">    that the fact with the highest score is chosen next.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_proposed</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">num_visited</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Arguments:</span>
<span class="sd">            num_proposed: Normalized number of times the fact was</span>
<span class="sd">                proposed by the `suggest` function. When the latter</span>
<span class="sd">                returns `n` suggestions, each suggestion&#39;s count is</span>
<span class="sd">                increased by `1/n`.</span>
<span class="sd">            num_visited: Number of times the fact was chosen as target</span>
<span class="sd">                in one step of a rollout.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="delphyne.stdlib.search.abduction.ScoringFunction.__call__" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">__call__</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">__call__</span><span class="p">(</span><span class="n">num_proposed</span><span class="p">:</span> <span class="n"><span title="float">float</span></span><span class="p">,</span> <span class="n">num_visited</span><span class="p">:</span> <span class="n"><span title="float">float</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="float">float</span></span>
</code></pre></div>

    <div class="doc doc-contents ">



<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>num_proposed</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Normalized number of times the fact was
proposed by the <code>suggest</code> function. When the latter
returns <code>n</code> suggestions, each suggestion's count is
increased by <code>1/n</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_visited</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of times the fact was chosen as target
in one step of a rollout.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/search/abduction.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_proposed</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">num_visited</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Arguments:</span>
<span class="sd">        num_proposed: Normalized number of times the fact was</span>
<span class="sd">            proposed by the `suggest` function. When the latter</span>
<span class="sd">            returns `n` suggestions, each suggestion&#39;s count is</span>
<span class="sd">            increased by `1/n`.</span>
<span class="sd">        num_visited: Number of times the fact was chosen as target</span>
<span class="sd">            in one step of a rollout.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="o">...</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="delphyne.stdlib.search.abduction._default_scoring_function" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">_default_scoring_function</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">_default_scoring_function</span><span class="p">(</span><span class="n">num_proposed</span><span class="p">:</span> <span class="n"><span title="float">float</span></span><span class="p">,</span> <span class="n">num_visited</span><span class="p">:</span> <span class="n"><span title="float">float</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="float">float</span></span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>The default scoring function for fact candidates.</p>
<p>See <code>ScoringFunction</code> for details.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/search/abduction.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_default_scoring_function</span><span class="p">(</span>
    <span class="n">num_proposed</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">num_visited</span><span class="p">:</span> <span class="nb">float</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The default scoring function for fact candidates.</span>

<span class="sd">    See `ScoringFunction` for details.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">num_visited</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">num_proposed</span><span class="p">)))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["content.code.annotate", "content.code.copy", "content.tabs.link", "navigation.indexes"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="../../../javascript/katex.js"></script>
      
        <script src="https://unpkg.com/katex@0/dist/katex.min.js"></script>
      
        <script src="https://unpkg.com/katex@0/dist/contrib/auto-render.min.js"></script>
      
    
  </body>
</html>