
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../effects/">
      
      
        <link rel="next" href="../commands/">
      
      
      <link rel="icon" href="../../../None">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.18">
    
    
      
        <title>Algorithms - Delphyne</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="https://unpkg.com/katex@0/dist/katex.min.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#search-algorithms-and-utilities" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Delphyne" class="md-header__button md-logo" aria-label="Delphyne" data-md-component="logo">
      
  <img src="../../../assets/logos/white/mini.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Delphyne
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Algorithms
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Delphyne" class="md-nav__button md-logo" aria-label="Delphyne" data-md-component="logo">
      
  <img src="../../../assets/logos/white/mini.png" alt="logo">

    </a>
    Delphyne
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Manual
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Manual
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../manual/strategies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Strategies and Trees
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../manual/policies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Policies
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../manual/demos/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Demonstrations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../manual/extension/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    VSCode Extension
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../how-to-guides/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    How-To Guides
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" >
        
          
          <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Strategy Language
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            Strategy Language
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../strategies/trees/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Trees and Spaces
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../strategies/strategies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Strategies and Reification
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../strategies/queries/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Queries and Chats
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../strategies/traces/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    References and Traces
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../strategies/misc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Miscellaneous
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Policy Language
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            Policy Language
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../policies/definitions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Definitions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../policies/streams/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Search Streams
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3" >
        
          
          <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Demonstration Language
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            Demonstration Language
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../demos/definitions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Definitions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../demos/interpreter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Interpreter
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4_4" id="__nav_4_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Standard Library
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4_4">
            <span class="md-nav__icon md-icon"></span>
            Standard Library
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../basic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Basic
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../queries/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Queries
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../streams/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Streams
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../environments/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Environments
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../effects/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Effects
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Algorithms
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Algorithms
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#strategies" class="md-nav__link">
    <span class="md-ellipsis">
      Strategies
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Strategies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.interact" class="md-nav__link">
    <span class="md-ellipsis">
      interact
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#policies" class="md-nav__link">
    <span class="md-ellipsis">
      Policies
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Policies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.search.dfs.dfs" class="md-nav__link">
    <span class="md-ellipsis">
      dfs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.search.dfs.par_dfs" class="md-nav__link">
    <span class="md-ellipsis">
      par_dfs
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#combinators" class="md-nav__link">
    <span class="md-ellipsis">
      Combinators
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Combinators">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.sequence" class="md-nav__link">
    <span class="md-ellipsis">
      sequence
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.or_else" class="md-nav__link">
    <span class="md-ellipsis">
      or_else
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.nofail" class="md-nav__link">
    <span class="md-ellipsis">
      nofail
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.iterate" class="md-nav__link">
    <span class="md-ellipsis">
      iterate
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#opaque-spaces-sugar" class="md-nav__link">
    <span class="md-ellipsis">
      Opaque Spaces Sugar
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Opaque Spaces Sugar">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.just_dfs" class="md-nav__link">
    <span class="md-ellipsis">
      just_dfs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.just_compute" class="md-nav__link">
    <span class="md-ellipsis">
      just_compute
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.ambient_pp" class="md-nav__link">
    <span class="md-ellipsis">
      ambient_pp
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.ambient" class="md-nav__link">
    <span class="md-ellipsis">
      ambient
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#abduction" class="md-nav__link">
    <span class="md-ellipsis">
      Abduction
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Abduction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.Abduction" class="md-nav__link">
    <span class="md-ellipsis">
      Abduction
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.abduction" class="md-nav__link">
    <span class="md-ellipsis">
      abduction
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.abduct_and_saturate" class="md-nav__link">
    <span class="md-ellipsis">
      abduct_and_saturate
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../commands/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Commands
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../experiments/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Experiments
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Delphyne CLI
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#strategies" class="md-nav__link">
    <span class="md-ellipsis">
      Strategies
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Strategies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.interact" class="md-nav__link">
    <span class="md-ellipsis">
      interact
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#policies" class="md-nav__link">
    <span class="md-ellipsis">
      Policies
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Policies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.search.dfs.dfs" class="md-nav__link">
    <span class="md-ellipsis">
      dfs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.stdlib.search.dfs.par_dfs" class="md-nav__link">
    <span class="md-ellipsis">
      par_dfs
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#combinators" class="md-nav__link">
    <span class="md-ellipsis">
      Combinators
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Combinators">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.sequence" class="md-nav__link">
    <span class="md-ellipsis">
      sequence
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.or_else" class="md-nav__link">
    <span class="md-ellipsis">
      or_else
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.nofail" class="md-nav__link">
    <span class="md-ellipsis">
      nofail
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.iterate" class="md-nav__link">
    <span class="md-ellipsis">
      iterate
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#opaque-spaces-sugar" class="md-nav__link">
    <span class="md-ellipsis">
      Opaque Spaces Sugar
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Opaque Spaces Sugar">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.just_dfs" class="md-nav__link">
    <span class="md-ellipsis">
      just_dfs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.just_compute" class="md-nav__link">
    <span class="md-ellipsis">
      just_compute
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.ambient_pp" class="md-nav__link">
    <span class="md-ellipsis">
      ambient_pp
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.ambient" class="md-nav__link">
    <span class="md-ellipsis">
      ambient
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#abduction" class="md-nav__link">
    <span class="md-ellipsis">
      Abduction
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Abduction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delphyne.Abduction" class="md-nav__link">
    <span class="md-ellipsis">
      Abduction
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.abduction" class="md-nav__link">
    <span class="md-ellipsis">
      abduction
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delphyne.abduct_and_saturate" class="md-nav__link">
    <span class="md-ellipsis">
      abduct_and_saturate
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="search-algorithms-and-utilities">Search Algorithms and Utilities</h1>
<h2 id="strategies">Strategies</h2>


<div class="doc doc-object doc-function">


<h3 id="delphyne.interact" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">interact</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">interact</span><span class="p">(</span><span class="n">step</span><span class="p">:</span> <span class="n"><span title="collections.abc.Callable">Callable</span></span><span class="p">[[</span><span class="n"><a class="autorefs autorefs-internal" title="AnswerPrefix (delphyne.core.AnswerPrefix)" href="../../strategies/queries/#delphyne.AnswerPrefix">AnswerPrefix</a></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.search.interactive.InteractStats">InteractStats</span></span><span class="p">],</span> <span class="n"><a class="autorefs autorefs-internal" title="Opaque (delphyne.stdlib.opaque.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.interactive.interact[P]">interact[P]</span></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-internal" title="Response


  
      dataclass
   (delphyne.stdlib.queries.Response)" href="../queries/#delphyne.Response">Response</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.interactive.interact[A]">interact[A]</span></span> <span class="o">|</span> <span class="n"><a class="autorefs autorefs-internal" title="WrappedParseError


  
      dataclass
   (delphyne.stdlib.queries.WrappedParseError)" href="../queries/#delphyne.WrappedParseError">WrappedParseError</a></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.search.interactive.interact[T]">interact[T]</span></span><span class="p">]]],</span> <span class="n">process</span><span class="p">:</span> <span class="n"><span title="collections.abc.Callable">Callable</span></span><span class="p">[[</span><span class="n"><span title="delphyne.stdlib.search.interactive.interact[A]">interact[A]</span></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.search.interactive.InteractStats">InteractStats</span></span><span class="p">],</span> <span class="n"><a class="autorefs autorefs-internal" title="Opaque (delphyne.stdlib.opaque.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.interactive.interact[P]">interact[P]</span></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.search.interactive.interact[B]">interact[B]</span></span> <span class="o">|</span> <span class="n"><a class="autorefs autorefs-internal" title="Error


  
      dataclass
   (delphyne.core.Error)" href="../../strategies/misc/#delphyne.Error">Error</a></span><span class="p">]],</span> <span class="n">tools</span><span class="p">:</span> <span class="n"><span title="collections.abc.Mapping">Mapping</span></span><span class="p">[</span><span class="n"><span title="type">type</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.interactive.interact[T]">interact[T]</span></span><span class="p">],</span> <span class="n"><span title="collections.abc.Callable">Callable</span></span><span class="p">[[</span><span class="n"><span title="typing.Any">Any</span></span><span class="p">],</span> <span class="n"><a class="autorefs autorefs-internal" title="Opaque (delphyne.stdlib.opaque.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.interactive.interact[P]">interact[P]</span></span><span class="p">,</span> <span class="n"><span title="typing.Any">Any</span></span><span class="p">]]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">inner_policy_type</span><span class="p">:</span> <span class="n"><span title="type">type</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.interactive.interact[P]">interact[P]</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Strategy (delphyne.core.Strategy)" href="../../strategies/strategies/#delphyne.Strategy">Strategy</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="Branch


  
      dataclass
   (delphyne.stdlib.nodes.Branch)" href="../effects/#delphyne.stdlib.nodes.Branch">Branch</a></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.search.interactive.interact[P]">interact[P]</span></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.search.interactive.interact[B]">interact[B]</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>A standard strategy for creating conversational agents.</p>
<p>A common pattern for interacting with LLMs is to have multi-message
exchanges where the full conversation history is resent repeatedly.
LLMs are also often allowed to request tool call. This strategy
implements this pattern. It is meant to be inlined into a wrapping
strategy (since it is not decorated with <a class="autorefs autorefs-internal" title="strategy" href="../basic/#delphyne.strategy"><code>strategy</code></a>).</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.interact.step">step</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>a parametric opaque space, induced by a strategy or query
that takes as an argument the current chat history (possibly
empty) along with some statistics, and returns an answer to
be processed. Oftentimes, this parametric opaque space is
induced by a query with a special <code>prefix</code> field for
receiving the chat history (see <a class="autorefs autorefs-internal" title="Query" href="../queries/#delphyne.Query"><code>Query</code></a>).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.interact.process">process</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>an opaque space induced by a query or strategy that is
called on all model responses that are not tool calls, and
which returns either a final response to be returned, or an
error to be transmitted to the model as feedback (as an
<a class="autorefs autorefs-internal" title="Error


  
      dataclass
  " href="../../strategies/misc/#delphyne.Error"><code>Error</code></a> value with an absent or serializable <code>meta</code> field).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.interact.tools">tools</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>a mapping from supported tool interfaces to
implementations. Tools themselves can be implemented using
arbitrary strategies or queries, allowing the integration of
horizontal and vertical LLM pipelines.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.interact.inner_policy_type">inner_policy_type</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Ambient inner policy type. This information
is not used at runtime but it can be provided to help type
inference when necessary.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/search/interactive.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">interact</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="n">md</span><span class="o">.</span><span class="n">AbstractTool</span><span class="p">[</span><span class="n">Any</span><span class="p">]](</span>
    <span class="n">step</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
        <span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">AnswerPrefix</span><span class="p">,</span> <span class="n">InteractStats</span><span class="p">],</span>
        <span class="n">Opaque</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">dq</span><span class="o">.</span><span class="n">Response</span><span class="p">[</span><span class="n">A</span> <span class="o">|</span> <span class="n">WrappedParseError</span><span class="p">,</span> <span class="n">T</span><span class="p">]],</span>
    <span class="p">],</span>
    <span class="n">process</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">A</span><span class="p">,</span> <span class="n">InteractStats</span><span class="p">],</span> <span class="n">Opaque</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">B</span> <span class="o">|</span> <span class="n">dp</span><span class="o">.</span><span class="n">Error</span><span class="p">]],</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">T</span><span class="p">],</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Opaque</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">inner_policy_type</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">P</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">Strategy</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">B</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A standard strategy for creating conversational agents.</span>

<span class="sd">    A common pattern for interacting with LLMs is to have multi-message</span>
<span class="sd">    exchanges where the full conversation history is resent repeatedly.</span>
<span class="sd">    LLMs are also often allowed to request tool call. This strategy</span>
<span class="sd">    implements this pattern. It is meant to be inlined into a wrapping</span>
<span class="sd">    strategy (since it is not decorated with `strategy`).</span>

<span class="sd">    Attributes:</span>
<span class="sd">        step: a parametric opaque space, induced by a strategy or query</span>
<span class="sd">            that takes as an argument the current chat history (possibly</span>
<span class="sd">            empty) along with some statistics, and returns an answer to</span>
<span class="sd">            be processed. Oftentimes, this parametric opaque space is</span>
<span class="sd">            induced by a query with a special `prefix` field for</span>
<span class="sd">            receiving the chat history (see `Query`).</span>
<span class="sd">        process: an opaque space induced by a query or strategy that is</span>
<span class="sd">            called on all model responses that are not tool calls, and</span>
<span class="sd">            which returns either a final response to be returned, or an</span>
<span class="sd">            error to be transmitted to the model as feedback (as an</span>
<span class="sd">            `Error` value with an absent or serializable `meta` field).</span>
<span class="sd">        tools: a mapping from supported tool interfaces to</span>
<span class="sd">            implementations. Tools themselves can be implemented using</span>
<span class="sd">            arbitrary strategies or queries, allowing the integration of</span>
<span class="sd">            horizontal and vertical LLM pipelines.</span>
<span class="sd">        inner_policy_type: Ambient inner policy type. This information</span>
<span class="sd">            is not used at runtime but it can be provided to help type</span>
<span class="sd">            inference when necessary.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">prefix</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">AnswerPrefix</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="n">InteractStats</span><span class="p">(</span><span class="n">num_rejected</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_tool_call_rounds</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">branch</span><span class="p">(</span><span class="n">step</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">stats</span><span class="p">))</span>
        <span class="n">prefix</span> <span class="o">+=</span> <span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">OracleMessage</span><span class="p">(</span><span class="s2">&quot;oracle&quot;</span><span class="p">,</span> <span class="n">resp</span><span class="o">.</span><span class="n">answer</span><span class="p">)]</span>
        <span class="k">match</span> <span class="n">resp</span><span class="o">.</span><span class="n">parsed</span><span class="p">:</span>
            <span class="k">case</span> <span class="n">dq</span><span class="o">.</span><span class="n">FinalAnswer</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">WrappedParseError</span><span class="p">):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">FeedbackMessage</span><span class="p">(</span>
                        <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;feedback&quot;</span><span class="p">,</span>
                        <span class="n">label</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
                        <span class="n">description</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                        <span class="n">meta</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">stats</span><span class="o">.</span><span class="n">num_rejected</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">prefix</span> <span class="o">+=</span> <span class="p">[</span><span class="n">msg</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">branch</span><span class="p">(</span><span class="n">process</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">stats</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">dp</span><span class="o">.</span><span class="n">Error</span><span class="p">):</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">FeedbackMessage</span><span class="p">(</span>
                            <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;feedback&quot;</span><span class="p">,</span>
                            <span class="n">label</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
                            <span class="n">description</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                            <span class="n">meta</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">stats</span><span class="o">.</span><span class="n">num_rejected</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">prefix</span> <span class="o">+=</span> <span class="p">[</span><span class="n">msg</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">res</span>
            <span class="k">case</span> <span class="n">dq</span><span class="o">.</span><span class="n">ToolRequests</span><span class="p">(</span><span class="n">tc</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tc</span><span class="p">):</span>
                    <span class="k">assert</span> <span class="n">tools</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="n">tres</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">branch</span><span class="p">(</span><span class="n">tools</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">t</span><span class="p">)](</span><span class="n">t</span><span class="p">))</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">ToolResult</span><span class="p">(</span>
                        <span class="s2">&quot;tool&quot;</span><span class="p">,</span>
                        <span class="n">resp</span><span class="o">.</span><span class="n">answer</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                        <span class="n">t</span><span class="o">.</span><span class="n">render_result</span><span class="p">(</span><span class="n">tres</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="n">prefix</span> <span class="o">+=</span> <span class="p">[</span><span class="n">msg</span><span class="p">]</span>
                <span class="n">stats</span><span class="o">.</span><span class="n">num_tool_call_rounds</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h2 id="policies">Policies</h2>


<div class="doc doc-object doc-function">


<h3 id="delphyne.stdlib.search.dfs.dfs" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">dfs</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">dfs</span><span class="p">(</span><span class="n">tree</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="Tree


  
      dataclass
   (delphyne.core.trees.Tree)" href="../../strategies/trees/#delphyne.Tree">Tree</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="Branch


  
      dataclass
   (delphyne.stdlib.nodes.Branch)" href="../effects/#delphyne.stdlib.nodes.Branch">Branch</a></span> <span class="o">|</span> <span class="n"><a class="autorefs autorefs-internal" title="Fail


  
      dataclass
   (delphyne.stdlib.nodes.Fail)" href="../effects/#delphyne.stdlib.nodes.Fail">Fail</a></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.search.dfs.dfs[P]">dfs[P]</span></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.search.dfs.dfs[T]">dfs[T]</span></span><span class="p">],</span> <span class="n">env</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="PolicyEnv (delphyne.stdlib.environments.PolicyEnv)" href="../environments/#delphyne.PolicyEnv">PolicyEnv</a></span><span class="p">,</span> <span class="n">policy</span><span class="p">:</span> <span class="n"><span title="delphyne.stdlib.search.dfs.dfs[P]">dfs[P]</span></span><span class="p">,</span> <span class="n">max_depth</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">max_branching</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="StreamGen (delphyne.core.streams.StreamGen)" href="../../policies/streams/#delphyne.StreamGen">StreamGen</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.dfs.dfs[T]">dfs[T]</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>The Standard Depth-First Search Algorithm.</p>
<p>Whenever a branching node is encountered, branching candidates are
lazily enumerated and the corresponding child recursively searched.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.search.dfs.dfs.max_depth">max_depth</span></code></td>
            <td>
                  <code><span title="optional">optional</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>maximum number of branching nodes
that can be traversed in a path to success.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="delphyne.stdlib.search.dfs.dfs.max_branching">max_branching</span></code></td>
            <td>
                  <code><span title="optional">optional</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>maximum number of children explored at
each branching node.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/search/dfs.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@search_policy</span>
<span class="k">def</span><span class="w"> </span><span class="nf">dfs</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">](</span>
    <span class="n">tree</span><span class="p">:</span> <span class="n">Tree</span><span class="p">[</span><span class="n">Branch</span> <span class="o">|</span> <span class="n">Fail</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">],</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">PolicyEnv</span><span class="p">,</span>
    <span class="n">policy</span><span class="p">:</span> <span class="n">P</span><span class="p">,</span>
    <span class="n">max_depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_branching</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StreamGen</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The Standard Depth-First Search Algorithm.</span>

<span class="sd">    Whenever a branching node is encountered, branching candidates are</span>
<span class="sd">    lazily enumerated and the corresponding child recursively searched.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        max_depth (optional): maximum number of branching nodes</span>
<span class="sd">            that can be traversed in a path to success.</span>
<span class="sd">        max_branching (optional): maximum number of children explored at</span>
<span class="sd">            each branching node.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">max_branching</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">max_branching</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">match</span> <span class="n">tree</span><span class="o">.</span><span class="n">node</span><span class="p">:</span>
        <span class="k">case</span> <span class="n">Success</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">Solution</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">case</span> <span class="n">Fail</span><span class="p">():</span>
            <span class="k">pass</span>
        <span class="k">case</span> <span class="n">Branch</span><span class="p">(</span><span class="n">cands</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">max_depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">max_depth</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">cands</span> <span class="o">=</span> <span class="n">cands</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">policy</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">max_branching</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cands</span> <span class="o">=</span> <span class="n">cands</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">max_branching</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">yield from</span> <span class="n">cands</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">dfs</span><span class="p">(</span>
                    <span class="n">max_depth</span><span class="o">=</span><span class="n">max_depth</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">max_depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">max_branching</span><span class="o">=</span><span class="n">max_branching</span><span class="p">,</span>
                <span class="p">)(</span><span class="n">tree</span><span class="o">.</span><span class="n">child</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">tracked</span><span class="p">),</span> <span class="n">env</span><span class="p">,</span> <span class="n">policy</span><span class="p">)</span><span class="o">.</span><span class="n">gen</span><span class="p">()</span>
            <span class="p">)</span><span class="o">.</span><span class="n">gen</span><span class="p">()</span>
        <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
            <span class="n">unsupported_node</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="delphyne.stdlib.search.dfs.par_dfs" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">par_dfs</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">par_dfs</span><span class="p">(</span><span class="n">tree</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="Tree


  
      dataclass
   (delphyne.core.trees.Tree)" href="../../strategies/trees/#delphyne.Tree">Tree</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="Branch


  
      dataclass
   (delphyne.stdlib.nodes.Branch)" href="../effects/#delphyne.stdlib.nodes.Branch">Branch</a></span> <span class="o">|</span> <span class="n"><a class="autorefs autorefs-internal" title="Fail


  
      dataclass
   (delphyne.stdlib.nodes.Fail)" href="../effects/#delphyne.stdlib.nodes.Fail">Fail</a></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.search.dfs.par_dfs[P]">par_dfs[P]</span></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.search.dfs.par_dfs[T]">par_dfs[T]</span></span><span class="p">],</span> <span class="n">env</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="PolicyEnv (delphyne.stdlib.environments.PolicyEnv)" href="../environments/#delphyne.PolicyEnv">PolicyEnv</a></span><span class="p">,</span> <span class="n">policy</span><span class="p">:</span> <span class="n"><span title="delphyne.stdlib.search.dfs.par_dfs[P]">par_dfs[P]</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="StreamGen (delphyne.core.streams.StreamGen)" href="../../policies/streams/#delphyne.StreamGen">StreamGen</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.dfs.par_dfs[T]">par_dfs[T]</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Parallel Depth-First Search.</p>
<p>Whenever a branching node is encountered, all branching candidates
are computed at once and the associated children are explored in
parallel.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/search/dfs.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@search_policy</span>
<span class="k">def</span><span class="w"> </span><span class="nf">par_dfs</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">](</span>
    <span class="n">tree</span><span class="p">:</span> <span class="n">Tree</span><span class="p">[</span><span class="n">Branch</span> <span class="o">|</span> <span class="n">Fail</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">],</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">PolicyEnv</span><span class="p">,</span>
    <span class="n">policy</span><span class="p">:</span> <span class="n">P</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StreamGen</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parallel Depth-First Search.</span>

<span class="sd">    Whenever a branching node is encountered, all branching candidates</span>
<span class="sd">    are computed at once and the associated children are explored in</span>
<span class="sd">    parallel.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">match</span> <span class="n">tree</span><span class="o">.</span><span class="n">node</span><span class="p">:</span>
        <span class="k">case</span> <span class="n">Success</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">Solution</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">case</span> <span class="n">Fail</span><span class="p">():</span>
            <span class="k">pass</span>
        <span class="k">case</span> <span class="n">Branch</span><span class="p">(</span><span class="n">cands</span><span class="p">):</span>
            <span class="n">cands</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">cands</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">policy</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="k">yield from</span> <span class="n">Stream</span><span class="o">.</span><span class="n">parallel</span><span class="p">(</span>
                <span class="p">[</span><span class="n">par_dfs</span><span class="p">()(</span><span class="n">tree</span><span class="o">.</span><span class="n">child</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">tracked</span><span class="p">),</span> <span class="n">env</span><span class="p">,</span> <span class="n">policy</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">cands</span><span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">gen</span><span class="p">()</span>
        <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
            <span class="n">unsupported_node</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h2 id="combinators">Combinators</h2>


<div class="doc doc-object doc-function">


<h3 id="delphyne.sequence" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">sequence</span>


</h3>
          <div class="doc-overloads">
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">sequence</span><span class="p">(</span><span class="n">policies</span><span class="p">:</span> <span class="n"><span title="typing.Iterable">Iterable</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="PromptingPolicy


  
      dataclass
   (delphyne.stdlib.policies.PromptingPolicy)" href="../basic/#delphyne.PromptingPolicy">PromptingPolicy</a></span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">stop_on_reject</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="PromptingPolicy


  
      dataclass
   (delphyne.stdlib.policies.PromptingPolicy)" href="../basic/#delphyne.PromptingPolicy">PromptingPolicy</a></span>
</code></pre></div><div class="doc-signature highlight"><pre><span></span><code><span class="nf">sequence</span><span class="p">(</span><span class="n">policies</span><span class="p">:</span> <span class="n"><span title="typing.Iterable">Iterable</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="SearchPolicy


  
      dataclass
   (delphyne.stdlib.policies.SearchPolicy)" href="../basic/#delphyne.SearchPolicy">SearchPolicy</a></span><span class="p">[</span><span class="n"><span title="N">N</span></span><span class="p">]],</span> <span class="o">*</span><span class="p">,</span> <span class="n">stop_on_reject</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="SearchPolicy


  
      dataclass
   (delphyne.stdlib.policies.SearchPolicy)" href="../basic/#delphyne.SearchPolicy">SearchPolicy</a></span><span class="p">[</span><span class="n"><span title="N">N</span></span><span class="p">]</span>
</code></pre></div><div class="doc-signature highlight"><pre><span></span><code><span class="nf">sequence</span><span class="p">(</span><span class="n">policies</span><span class="p">:</span> <span class="n"><span title="typing.Iterable">Iterable</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="Policy


  
      dataclass
   (delphyne.stdlib.policies.Policy)" href="../basic/#delphyne.Policy">Policy</a></span><span class="p">[</span><span class="n"><span title="N">N</span></span><span class="p">,</span> <span class="n"><span title="P">P</span></span><span class="p">]],</span> <span class="o">*</span><span class="p">,</span> <span class="n">stop_on_reject</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Policy


  
      dataclass
   (delphyne.stdlib.policies.Policy)" href="../basic/#delphyne.Policy">Policy</a></span><span class="p">[</span><span class="n"><span title="N">N</span></span><span class="p">,</span> <span class="n"><span title="P">P</span></span><span class="p">]</span>
</code></pre></div>          </div>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">sequence</span><span class="p">(</span><span class="n">policies</span><span class="p">:</span> <span class="n"><span title="typing.Iterable">Iterable</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.misc._AnyPolicy">_AnyPolicy</span></span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">stop_on_reject</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="delphyne.stdlib.misc._AnyPolicy">_AnyPolicy</span></span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Try a list of policies, search policies, or prompting policies in
sequence.</p>
        <ul>
<li>policies: An iterable of policies, search policies, or prompting
      policies to try in sequence.</li>
<li>stop_on_reject: If True, stop the sequence as soon as one policy
      sees all its resource requests denied. Note that this is
      necessary for termination when <code>policies</code> is an infinite
      iterator.</li>
</ul>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/misc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">sequence</span><span class="p">(</span>
    <span class="n">policies</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">_AnyPolicy</span><span class="p">],</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">stop_on_reject</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_AnyPolicy</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Try a list of policies, search policies, or prompting policies in</span>
<span class="sd">    sequence.</span>

<span class="sd">    Attributes:</span>
<span class="sd">    - policies: An iterable of policies, search policies, or prompting</span>
<span class="sd">          policies to try in sequence.</span>
<span class="sd">    - stop_on_reject: If True, stop the sequence as soon as one policy</span>
<span class="sd">          sees all its resource requests denied. Note that this is</span>
<span class="sd">          necessary for termination when `policies` is an infinite</span>
<span class="sd">          iterator.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">policies</span><span class="p">)</span>
    <span class="n">first</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">PromptingPolicy</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">sequence_prompting_policies</span><span class="p">(</span>
            <span class="n">cast</span><span class="p">(</span><span class="n">Iterable</span><span class="p">[</span><span class="n">PromptingPolicy</span><span class="p">],</span> <span class="n">policies</span><span class="p">),</span>
            <span class="n">stop_on_reject</span><span class="o">=</span><span class="n">stop_on_reject</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">SearchPolicy</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">sequence_search_policies</span><span class="p">(</span>
            <span class="n">cast</span><span class="p">(</span><span class="n">Iterable</span><span class="p">[</span><span class="n">SearchPolicy</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">policies</span><span class="p">),</span>
            <span class="n">stop_on_reject</span><span class="o">=</span><span class="n">stop_on_reject</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">Policy</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sequence_policies</span><span class="p">(</span>
            <span class="n">cast</span><span class="p">(</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Policy</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">policies</span><span class="p">),</span>
            <span class="n">stop_on_reject</span><span class="o">=</span><span class="n">stop_on_reject</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="delphyne.or_else" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">or_else</span>


</h3>
          <div class="doc-overloads">
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">or_else</span><span class="p">(</span><span class="n">main</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="PromptingPolicy


  
      dataclass
   (delphyne.stdlib.policies.PromptingPolicy)" href="../basic/#delphyne.PromptingPolicy">PromptingPolicy</a></span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="PromptingPolicy


  
      dataclass
   (delphyne.stdlib.policies.PromptingPolicy)" href="../basic/#delphyne.PromptingPolicy">PromptingPolicy</a></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="PromptingPolicy


  
      dataclass
   (delphyne.stdlib.policies.PromptingPolicy)" href="../basic/#delphyne.PromptingPolicy">PromptingPolicy</a></span>
</code></pre></div><div class="doc-signature highlight"><pre><span></span><code><span class="nf">or_else</span><span class="p">(</span><span class="n">main</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="SearchPolicy


  
      dataclass
   (delphyne.stdlib.policies.SearchPolicy)" href="../basic/#delphyne.SearchPolicy">SearchPolicy</a></span><span class="p">[</span><span class="n"><span title="N">N</span></span><span class="p">],</span> <span class="n">other</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="SearchPolicy


  
      dataclass
   (delphyne.stdlib.policies.SearchPolicy)" href="../basic/#delphyne.SearchPolicy">SearchPolicy</a></span><span class="p">[</span><span class="n"><span title="N">N</span></span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="SearchPolicy


  
      dataclass
   (delphyne.stdlib.policies.SearchPolicy)" href="../basic/#delphyne.SearchPolicy">SearchPolicy</a></span><span class="p">[</span><span class="n"><span title="N">N</span></span><span class="p">]</span>
</code></pre></div><div class="doc-signature highlight"><pre><span></span><code><span class="nf">or_else</span><span class="p">(</span><span class="n">main</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="Policy


  
      dataclass
   (delphyne.stdlib.policies.Policy)" href="../basic/#delphyne.Policy">Policy</a></span><span class="p">[</span><span class="n"><span title="N">N</span></span><span class="p">,</span> <span class="n"><span title="P">P</span></span><span class="p">],</span> <span class="n">other</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="Policy


  
      dataclass
   (delphyne.stdlib.policies.Policy)" href="../basic/#delphyne.Policy">Policy</a></span><span class="p">[</span><span class="n"><span title="N">N</span></span><span class="p">,</span> <span class="n"><span title="P">P</span></span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Policy


  
      dataclass
   (delphyne.stdlib.policies.Policy)" href="../basic/#delphyne.Policy">Policy</a></span><span class="p">[</span><span class="n"><span title="N">N</span></span><span class="p">,</span> <span class="n"><span title="P">P</span></span><span class="p">]</span>
</code></pre></div>          </div>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">or_else</span><span class="p">(</span><span class="n">main</span><span class="p">:</span> <span class="n"><span title="delphyne.stdlib.misc._AnyPolicy">_AnyPolicy</span></span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n"><span title="delphyne.stdlib.misc._AnyPolicy">_AnyPolicy</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="delphyne.stdlib.misc._AnyPolicy">_AnyPolicy</span></span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Take two policies, search policies, or prompting policies as
arguments. Try the first one, and then the second one only if it
fails (i.e., it does not produce any solution).</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/misc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">or_else</span><span class="p">(</span><span class="n">main</span><span class="p">:</span> <span class="n">_AnyPolicy</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">_AnyPolicy</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_AnyPolicy</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Take two policies, search policies, or prompting policies as</span>
<span class="sd">    arguments. Try the first one, and then the second one only if it</span>
<span class="sd">    fails (i.e., it does not produce any solution).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="n">PromptingPolicy</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">PromptingPolicy</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">prompting_policy_or_else</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="n">SearchPolicy</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">SearchPolicy</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">search_policy_or_else</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">policy_or_else</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="delphyne.nofail" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">nofail</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">nofail</span><span class="p">(</span><span class="n">space</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="Opaque (delphyne.stdlib.opaque.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.misc.nofail[P]">nofail[P]</span></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.misc.nofail[A]">nofail[A]</span></span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n"><span title="delphyne.stdlib.misc.nofail[B]">nofail[B]</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Opaque (delphyne.stdlib.opaque.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.misc.nofail[P]">nofail[P]</span></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.misc.nofail[A]">nofail[A]</span></span> <span class="o">|</span> <span class="n"><span title="delphyne.stdlib.misc.nofail[B]">nofail[B]</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Modify an opaque space to that branching over it can never fail.</p>
<p>If the stream associated with the opaque space gets exhausted and no
solution is produced, the provided default value is used.</p>
<p>In demonstrations, the default value can be selected by using the
<code>#no_fail_default</code> hint.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/misc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">nofail</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">](</span><span class="n">space</span><span class="p">:</span> <span class="n">Opaque</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">A</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">B</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Opaque</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">A</span> <span class="o">|</span> <span class="n">B</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Modify an opaque space to that branching over it can never fail.</span>

<span class="sd">    If the stream associated with the opaque space gets exhausted and no</span>
<span class="sd">    solution is produced, the provided default value is used.</span>

<span class="sd">    In demonstrations, the default value can be selected by using the</span>
<span class="sd">    `#no_fail_default` hint.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">try_policy</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">()</span> <span class="o">@</span> <span class="n">elim_flag</span><span class="p">(</span><span class="n">NoFailFlag</span><span class="p">,</span> <span class="s2">&quot;no_fail_try&quot;</span><span class="p">)</span>
    <span class="n">def_policy</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">()</span> <span class="o">@</span> <span class="n">elim_flag</span><span class="p">(</span><span class="n">NoFailFlag</span><span class="p">,</span> <span class="s2">&quot;no_fail_default&quot;</span><span class="p">)</span>
    <span class="n">search_policy</span> <span class="o">=</span> <span class="n">or_else</span><span class="p">(</span><span class="n">try_policy</span><span class="p">,</span> <span class="n">def_policy</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nofail_strategy</span><span class="p">(</span><span class="n">space</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">)</span><span class="o">.</span><span class="n">using</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">search_policy</span> <span class="o">&amp;</span> <span class="n">p</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="delphyne.iterate" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">iterate</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">iterate</span><span class="p">(</span><span class="nb">next</span><span class="p">:</span> <span class="n"><span title="collections.abc.Callable">Callable</span></span><span class="p">[[</span><span class="n"><span title="delphyne.stdlib.search.iteration.iterate[S]">iterate[S]</span></span> <span class="o">|</span> <span class="kc">None</span><span class="p">],</span> <span class="n"><a class="autorefs autorefs-internal" title="Opaque (delphyne.stdlib.opaque.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.iteration.iterate[P]">iterate[P]</span></span><span class="p">,</span> <span class="n"><span title="tuple">tuple</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.iteration.iterate[T]">iterate[T]</span></span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.search.iteration.iterate[S]">iterate[S]</span></span><span class="p">]]],</span> <span class="n">transform_stream</span><span class="p">:</span> <span class="n"><span title="collections.abc.Callable">Callable</span></span><span class="p">[[</span><span class="n"><span title="delphyne.stdlib.search.iteration.iterate[P]">iterate[P]</span></span><span class="p">],</span> <span class="n"><a class="autorefs autorefs-internal" title="StreamTransformer


  
      dataclass
   (delphyne.stdlib.streams.StreamTransformer)" href="../streams/#delphyne.StreamTransformer">StreamTransformer</a></span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Opaque (delphyne.stdlib.opaque.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.iteration.iterate[P]">iterate[P]</span></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.search.iteration.iterate[T]">iterate[T]</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Iteratively call a strategy or query, repeatedly feeding back the
last call's output state into a new call and yielding values along
the way.</p>
<p>A standard use case is to repeatedly call a query or strategy with a
blacklist of previously generated values, so as to produce diverse
success values.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>next</code>
            </td>
            <td>
                  <code><span title="collections.abc.Callable">Callable</span>[[<span title="delphyne.stdlib.search.iteration.iterate[S]">iterate[S]</span> | None], <a class="autorefs autorefs-internal" title="Opaque (delphyne.stdlib.opaque.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a>[<span title="delphyne.stdlib.search.iteration.iterate[P]">iterate[P]</span>, <span title="tuple">tuple</span>[<span title="delphyne.stdlib.search.iteration.iterate[T]">iterate[T]</span> | None, <span title="delphyne.stdlib.search.iteration.iterate[S]">iterate[S]</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A parametric opaque space, induced by a query or stratey
that takes a state as an input (or <code>None</code> initially) and
outputs a new state, along with a generated value.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>transform_stream</code>
            </td>
            <td>
                  <code><span title="collections.abc.Callable">Callable</span>[[<span title="delphyne.stdlib.search.iteration.iterate[P]">iterate[P]</span>], <a class="autorefs autorefs-internal" title="StreamTransformer


  
      dataclass
   (delphyne.stdlib.streams.StreamTransformer)" href="../streams/#delphyne.StreamTransformer">StreamTransformer</a> | None] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An optional mapping from the inner policy to a
stream transformer to be applied to the resulting stream of
generated values.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="Opaque (delphyne.stdlib.opaque.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a>[<span title="delphyne.stdlib.search.iteration.iterate[P]">iterate[P]</span>, <span title="delphyne.stdlib.search.iteration.iterate[T]">iterate[T]</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An opaque space enumerating all generated values.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/search/iteration.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">iterate</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">T</span><span class="p">](</span>
    <span class="nb">next</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">S</span> <span class="o">|</span> <span class="kc">None</span><span class="p">],</span> <span class="n">Opaque</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">T</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">S</span><span class="p">]]],</span>
    <span class="n">transform_stream</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">P</span><span class="p">],</span> <span class="n">StreamTransformer</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Opaque</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Iteratively call a strategy or query, repeatedly feeding back the</span>
<span class="sd">    last call&#39;s output state into a new call and yielding values along</span>
<span class="sd">    the way.</span>

<span class="sd">    A standard use case is to repeatedly call a query or strategy with a</span>
<span class="sd">    blacklist of previously generated values, so as to produce diverse</span>
<span class="sd">    success values.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        next: A parametric opaque space, induced by a query or stratey</span>
<span class="sd">            that takes a state as an input (or `None` initially) and</span>
<span class="sd">            outputs a new state, along with a generated value.</span>
<span class="sd">        transform_stream: An optional mapping from the inner policy to a</span>
<span class="sd">            stream transformer to be applied to the resulting stream of</span>
<span class="sd">            generated values.</span>

<span class="sd">    Returns:</span>
<span class="sd">        An opaque space enumerating all generated values.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">iterate_policy</span><span class="p">(</span><span class="n">inner_policy</span><span class="p">:</span> <span class="n">P</span><span class="p">):</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="n">_search_iteration</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">transform_stream</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">trans</span> <span class="o">=</span> <span class="n">transform_stream</span><span class="p">(</span><span class="n">inner_policy</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">trans</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">policy</span> <span class="o">=</span> <span class="n">trans</span> <span class="o">@</span> <span class="n">policy</span>
        <span class="k">return</span> <span class="n">policy</span> <span class="o">&amp;</span> <span class="n">inner_policy</span>

    <span class="k">return</span> <span class="n">_iterate</span><span class="p">(</span><span class="nb">next</span><span class="p">)</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="n">iterate_policy</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h2 id="opaque-spaces-sugar">Opaque Spaces Sugar</h2>


<div class="doc doc-object doc-function">


<h3 id="delphyne.just_dfs" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">just_dfs</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">just_dfs</span><span class="p">(</span><span class="n">policy</span><span class="p">:</span> <span class="n"><span title="delphyne.stdlib.misc.just_dfs[P]">just_dfs[P]</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Policy


  
      dataclass
   (delphyne.stdlib.policies.Policy)" href="../basic/#delphyne.Policy">Policy</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="Branch


  
      dataclass
   (delphyne.stdlib.nodes.Branch)" href="../effects/#delphyne.stdlib.nodes.Branch">Branch</a></span> <span class="o">|</span> <span class="n"><a class="autorefs autorefs-internal" title="Fail


  
      dataclass
   (delphyne.stdlib.nodes.Fail)" href="../effects/#delphyne.stdlib.nodes.Fail">Fail</a></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.misc.just_dfs[P]">just_dfs[P]</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Convenience shortcut to avoid passing lambdas to the <code>get_policy</code>
argument of <code>using</code>, when using DFS in combination with the ambient
inner policy.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/misc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">just_dfs</span><span class="p">[</span><span class="n">P</span><span class="p">](</span><span class="n">policy</span><span class="p">:</span> <span class="n">P</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Policy</span><span class="p">[</span><span class="n">Branch</span> <span class="o">|</span> <span class="n">Fail</span><span class="p">,</span> <span class="n">P</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convenience shortcut to avoid passing lambdas to the `get_policy`</span>
<span class="sd">    argument of `using`, when using DFS in combination with the ambient</span>
<span class="sd">    inner policy.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">dfs</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">policy</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="delphyne.just_compute" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">just_compute</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">just_compute</span><span class="p">(</span><span class="n">policy</span><span class="p">:</span> <span class="n"><span title="delphyne.stdlib.misc.just_compute[P]">just_compute[P]</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Policy


  
      dataclass
   (delphyne.stdlib.policies.Policy)" href="../basic/#delphyne.Policy">Policy</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="Compute


  
      dataclass
   (delphyne.stdlib.computations.Compute)" href="../effects/#delphyne.stdlib.computations.Compute">Compute</a></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.misc.just_compute[P]">just_compute[P]</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Convenience shortcut to avoid passing lambdas to the <code>get_policy</code>
argument of <code>using</code>, in the case of sub-strategies that only feature
the <a class="autorefs autorefs-internal" title="Compute


  
      dataclass
  " href="../effects/#delphyne.stdlib.computations.Compute"><code>Compute</code></a> effect.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/misc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">just_compute</span><span class="p">[</span><span class="n">P</span><span class="p">](</span><span class="n">policy</span><span class="p">:</span> <span class="n">P</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Policy</span><span class="p">[</span><span class="n">Compute</span><span class="p">,</span> <span class="n">P</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convenience shortcut to avoid passing lambdas to the `get_policy`</span>
<span class="sd">    argument of `using`, in the case of sub-strategies that only feature</span>
<span class="sd">    the `Compute` effect.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">dfs</span><span class="p">()</span> <span class="o">@</span> <span class="n">elim_compute</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">policy</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="delphyne.ambient_pp" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">ambient_pp</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">ambient_pp</span><span class="p">(</span><span class="n">policy</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="PromptingPolicy


  
      dataclass
   (delphyne.stdlib.policies.PromptingPolicy)" href="../basic/#delphyne.PromptingPolicy">PromptingPolicy</a></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="PromptingPolicy


  
      dataclass
   (delphyne.stdlib.policies.PromptingPolicy)" href="../basic/#delphyne.PromptingPolicy">PromptingPolicy</a></span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Convenience shortcut to avoid passing lambdas to the <code>get_policy</code>
argument of <code>Query.using</code>, when using the ambient inner policy as a
prompting policy.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/misc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ambient_pp</span><span class="p">(</span><span class="n">policy</span><span class="p">:</span> <span class="n">PromptingPolicy</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PromptingPolicy</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convenience shortcut to avoid passing lambdas to the `get_policy`</span>
<span class="sd">    argument of `Query.using`, when using the ambient inner policy as a</span>
<span class="sd">    prompting policy.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">policy</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="delphyne.ambient" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">ambient</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">ambient</span><span class="p">(</span><span class="n">policy</span><span class="p">:</span> <span class="n"><span title="delphyne.stdlib.misc.ambient[F]">ambient[F]</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="delphyne.stdlib.misc.ambient[F]">ambient[F]</span></span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Convenience shortcut to avoid passing lambdas to the <code>get_policy</code>
argument of <code>Query.using</code>, when using the ambient inner policy as a
sub-policy (or as a sub- prompting policy).</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/misc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ambient</span><span class="p">[</span><span class="n">F</span><span class="p">](</span><span class="n">policy</span><span class="p">:</span> <span class="n">F</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">F</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convenience shortcut to avoid passing lambdas to the `get_policy`</span>
<span class="sd">    argument of `Query.using`, when using the ambient inner policy as a</span>
<span class="sd">    sub-policy (or as a sub- prompting policy).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">policy</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h2 id="abduction">Abduction</h2>


<div class="doc doc-object doc-class">



<h3 id="delphyne.Abduction" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">Abduction</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="Node (delphyne.core.Node)" href="../../strategies/trees/#delphyne.Node">Node</a></code></p>


        <p>Node for the singleton tree produced by <a class="autorefs autorefs-internal" title="abduction" href="#delphyne.abduction"><code>abduction</code></a>.
See <a class="autorefs autorefs-internal" title="abduction" href="#delphyne.abduction"><code>abduction</code></a> for details.</p>
<p>An action is a successful proof of the main goal.</p>







              <details class="quote">
                <summary>Source code in <code>src/delphyne/stdlib/search/abduction.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Abduction</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">Node</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Node for the singleton tree produced by `abduction`.</span>
<span class="sd">    See `abduction` for details.</span>

<span class="sd">    An action is a successful proof of the main goal.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">prove</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
        <span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">_Fact</span><span class="p">,</span> <span class="n">_Proof</span><span class="p">]],</span> <span class="n">_Fact</span> <span class="o">|</span> <span class="kc">None</span><span class="p">],</span>
        <span class="n">OpaqueSpace</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">_Status</span><span class="p">],</span>
    <span class="p">]</span>
    <span class="n">suggest</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
        <span class="p">[</span><span class="n">_Feedback</span><span class="p">],</span>
        <span class="n">OpaqueSpace</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">_Fact</span><span class="p">]],</span>
    <span class="p">]</span>
    <span class="n">search_equivalent</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
        <span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">_Fact</span><span class="p">],</span> <span class="n">_Fact</span><span class="p">],</span>
        <span class="n">OpaqueSpace</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">_Fact</span> <span class="o">|</span> <span class="kc">None</span><span class="p">],</span>
    <span class="p">]</span>
    <span class="n">redundant</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
        <span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">_Fact</span><span class="p">],</span> <span class="n">_Fact</span><span class="p">],</span>
        <span class="n">OpaqueSpace</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">bool</span><span class="p">],</span>
    <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">navigate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">Navigation</span><span class="p">:</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">aux</span><span class="p">(</span><span class="n">fact</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">Tracked</span><span class="p">[</span><span class="n">_Fact</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">Navigation</span><span class="p">:</span>
            <span class="c1"># Take a fact as an argument and return a list of</span>
            <span class="c1"># (proved_fact, proof) pairs.</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">prove</span><span class="p">([],</span> <span class="n">fact</span><span class="p">)</span>
            <span class="n">status</span><span class="p">,</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">status</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;proved&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[(</span><span class="n">fact</span><span class="p">,</span> <span class="n">payload</span><span class="p">)]</span>
            <span class="k">elif</span> <span class="n">status</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;disproved&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">status</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;feedback&quot;</span>
                <span class="n">feedback</span> <span class="o">=</span> <span class="n">payload</span>
                <span class="n">suggestions</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">suggest</span><span class="p">(</span><span class="n">feedback</span><span class="p">)</span>
                <span class="n">proved</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">suggestions</span><span class="p">:</span>
                    <span class="n">extra</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">aux</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                    <span class="n">proved</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">extra</span><span class="p">)</span>
                <span class="n">res</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">prove</span><span class="p">(</span><span class="n">proved</span><span class="p">,</span> <span class="n">fact</span><span class="p">)</span>
                <span class="n">status</span><span class="p">,</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">status</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;proved&quot;</span><span class="p">:</span>
                    <span class="n">proved</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">fact</span><span class="p">,</span> <span class="n">payload</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">_remove_duplicates</span><span class="p">(</span><span class="n">proved</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">drop_refs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="n">proved</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">aux</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">main_proof</span> <span class="o">=</span> <span class="n">_find_assoc</span><span class="p">(</span><span class="n">proved</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">main_proof</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">dp</span><span class="o">.</span><span class="n">NavigationError</span><span class="p">(</span>
                <span class="s2">&quot;No proof for the main goal was produced.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">main_proof</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="delphyne.abduction" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">abduction</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">abduction</span><span class="p">(</span><span class="n">prove</span><span class="p">:</span> <span class="n"><span title="collections.abc.Callable">Callable</span></span><span class="p">[[</span><span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><span title="tuple">tuple</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.abduction.abduction[Fact]">abduction[Fact]</span></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.search.abduction.abduction[Proof]">abduction[Proof]</span></span><span class="p">]],</span> <span class="n"><span title="delphyne.stdlib.search.abduction.abduction[Fact]">abduction[Fact]</span></span> <span class="o">|</span> <span class="kc">None</span><span class="p">],</span> <span class="n"><a class="autorefs autorefs-internal" title="Opaque (delphyne.stdlib.opaque.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.abduction.abduction[P]">abduction[P]</span></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.search.abduction.AbductionStatus">AbductionStatus</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.abduction.abduction[Feedback]">abduction[Feedback]</span></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.search.abduction.abduction[Proof]">abduction[Proof]</span></span><span class="p">]]],</span> <span class="n">suggest</span><span class="p">:</span> <span class="n"><span title="collections.abc.Callable">Callable</span></span><span class="p">[[</span><span class="n"><span title="delphyne.stdlib.search.abduction.abduction[Feedback]">abduction[Feedback]</span></span><span class="p">],</span> <span class="n"><a class="autorefs autorefs-internal" title="Opaque (delphyne.stdlib.opaque.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.abduction.abduction[P]">abduction[P]</span></span><span class="p">,</span> <span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.abduction.abduction[Fact]">abduction[Fact]</span></span><span class="p">]]],</span> <span class="n">search_equivalent</span><span class="p">:</span> <span class="n"><span title="collections.abc.Callable">Callable</span></span><span class="p">[[</span><span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.abduction.abduction[Fact]">abduction[Fact]</span></span><span class="p">],</span> <span class="n"><span title="delphyne.stdlib.search.abduction.abduction[Fact]">abduction[Fact]</span></span><span class="p">],</span> <span class="n"><a class="autorefs autorefs-internal" title="Opaque (delphyne.stdlib.opaque.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.abduction.abduction[P]">abduction[P]</span></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.search.abduction.abduction[Fact]">abduction[Fact]</span></span> <span class="o">|</span> <span class="kc">None</span><span class="p">]],</span> <span class="n">redundant</span><span class="p">:</span> <span class="n"><span title="collections.abc.Callable">Callable</span></span><span class="p">[[</span><span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.abduction.abduction[Fact]">abduction[Fact]</span></span><span class="p">],</span> <span class="n"><span title="delphyne.stdlib.search.abduction.abduction[Fact]">abduction[Fact]</span></span><span class="p">],</span> <span class="n"><a class="autorefs autorefs-internal" title="Opaque (delphyne.stdlib.opaque.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.abduction.abduction[P]">abduction[P]</span></span><span class="p">,</span> <span class="n"><span title="bool">bool</span></span><span class="p">]],</span> <span class="n">inner_policy_type</span><span class="p">:</span> <span class="n"><span title="type">type</span></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.abduction.abduction[P]">abduction[P]</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Strategy (delphyne.core.Strategy)" href="../../strategies/strategies/#delphyne.Strategy">Strategy</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="Abduction


  
      dataclass
   (delphyne.stdlib.search.abduction.Abduction)" href="#delphyne.Abduction">Abduction</a></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.search.abduction.abduction[P]">abduction[P]</span></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.search.abduction.abduction[Proof]">abduction[Proof]</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>Higher-order strategy for proving a fact via recursive abduction.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>prove</code>
            </td>
            <td>
                  <code><span title="collections.abc.Callable">Callable</span>[[<span title="collections.abc.Sequence">Sequence</span>[<span title="tuple">tuple</span>[<span title="delphyne.stdlib.search.abduction.abduction[Fact]">abduction[Fact]</span>, <span title="delphyne.stdlib.search.abduction.abduction[Proof]">abduction[Proof]</span>]], <span title="delphyne.stdlib.search.abduction.abduction[Fact]">abduction[Fact]</span> | None], <a class="autorefs autorefs-internal" title="Opaque (delphyne.stdlib.opaque.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a>[<span title="delphyne.stdlib.search.abduction.abduction[P]">abduction[P]</span>, <span title="delphyne.stdlib.search.abduction.AbductionStatus">AbductionStatus</span>[<span title="delphyne.stdlib.search.abduction.abduction[Feedback]">abduction[Feedback]</span>, <span title="delphyne.stdlib.search.abduction.abduction[Proof]">abduction[Proof]</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>take a sequence of already established facts as an
argument along with a new fact, and attempt to prove this new
fact. Three outcomes are possible: the fact is proved,
disproved, or a list of suggestions are made that might be
helpful to prove first. <code>None</code> denotes the top-level goal to be
proved.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>suggest</code>
            </td>
            <td>
                  <code><span title="collections.abc.Callable">Callable</span>[[<span title="delphyne.stdlib.search.abduction.abduction[Feedback]">abduction[Feedback]</span>], <a class="autorefs autorefs-internal" title="Opaque (delphyne.stdlib.opaque.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a>[<span title="delphyne.stdlib.search.abduction.abduction[P]">abduction[P]</span>, <span title="collections.abc.Sequence">Sequence</span>[<span title="delphyne.stdlib.search.abduction.abduction[Fact]">abduction[Fact]</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>take some feedback from the <code>prove</code> function and return a
sequence of fact candidates that may be useful to prove before
reattempting the original proof.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>search_equivalent</code>
            </td>
            <td>
                  <code><span title="collections.abc.Callable">Callable</span>[[<span title="collections.abc.Sequence">Sequence</span>[<span title="delphyne.stdlib.search.abduction.abduction[Fact]">abduction[Fact]</span>], <span title="delphyne.stdlib.search.abduction.abduction[Fact]">abduction[Fact]</span>], <a class="autorefs autorefs-internal" title="Opaque (delphyne.stdlib.opaque.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a>[<span title="delphyne.stdlib.search.abduction.abduction[P]">abduction[P]</span>, <span title="delphyne.stdlib.search.abduction.abduction[Fact]">abduction[Fact]</span> | None]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>take a collection of facts along with a new
one, and return either the first fact of the list equivalent to
the new fact or <code>None</code>. This is used to avoid spending search in
proving equivalent facts.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>redundant</code>
            </td>
            <td>
                  <code><span title="collections.abc.Callable">Callable</span>[[<span title="collections.abc.Sequence">Sequence</span>[<span title="delphyne.stdlib.search.abduction.abduction[Fact]">abduction[Fact]</span>], <span title="delphyne.stdlib.search.abduction.abduction[Fact]">abduction[Fact]</span>], <a class="autorefs autorefs-internal" title="Opaque (delphyne.stdlib.opaque.Opaque)" href="../basic/#delphyne.Opaque">Opaque</a>[<span title="delphyne.stdlib.search.abduction.abduction[P]">abduction[P]</span>, <span title="bool">bool</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>take a collection of established facts and decide
whether they imply a new fact candidate. This is useful to avoid
trying to prove and accumulating redundant facts.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="Strategy (delphyne.core.Strategy)" href="../../strategies/strategies/#delphyne.Strategy">Strategy</a>[<a class="autorefs autorefs-internal" title="Abduction


  
      dataclass
   (delphyne.stdlib.search.abduction.Abduction)" href="#delphyne.Abduction">Abduction</a>, <span title="delphyne.stdlib.search.abduction.abduction[P]">abduction[P]</span>, <span title="delphyne.stdlib.search.abduction.abduction[Proof]">abduction[Proof]</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>a proof of the top-level goal.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/search/abduction.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">abduction</span><span class="p">[</span><span class="n">Fact</span><span class="p">,</span> <span class="n">Feedback</span><span class="p">,</span> <span class="n">Proof</span><span class="p">,</span> <span class="n">P</span><span class="p">](</span>
    <span class="n">prove</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
        <span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Fact</span><span class="p">,</span> <span class="n">Proof</span><span class="p">]],</span> <span class="n">Fact</span> <span class="o">|</span> <span class="kc">None</span><span class="p">],</span>
        <span class="n">Opaque</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">AbductionStatus</span><span class="p">[</span><span class="n">Feedback</span><span class="p">,</span> <span class="n">Proof</span><span class="p">]],</span>
    <span class="p">],</span>
    <span class="n">suggest</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
        <span class="p">[</span><span class="n">Feedback</span><span class="p">],</span>
        <span class="n">Opaque</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Fact</span><span class="p">]],</span>
    <span class="p">],</span>
    <span class="n">search_equivalent</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
        <span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Fact</span><span class="p">],</span> <span class="n">Fact</span><span class="p">],</span> <span class="n">Opaque</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">Fact</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span>
    <span class="p">],</span>
    <span class="n">redundant</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Fact</span><span class="p">],</span> <span class="n">Fact</span><span class="p">],</span> <span class="n">Opaque</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]],</span>
    <span class="n">inner_policy_type</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">P</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">Strategy</span><span class="p">[</span><span class="n">Abduction</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">Proof</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Higher-order strategy for proving a fact via recursive abduction.</span>

<span class="sd">    Arguments:</span>
<span class="sd">      prove: take a sequence of already established facts as an</span>
<span class="sd">        argument along with a new fact, and attempt to prove this new</span>
<span class="sd">        fact. Three outcomes are possible: the fact is proved,</span>
<span class="sd">        disproved, or a list of suggestions are made that might be</span>
<span class="sd">        helpful to prove first. `None` denotes the top-level goal to be</span>
<span class="sd">        proved.</span>

<span class="sd">      suggest: take some feedback from the `prove` function and return a</span>
<span class="sd">        sequence of fact candidates that may be useful to prove before</span>
<span class="sd">        reattempting the original proof.</span>

<span class="sd">      search_equivalent: take a collection of facts along with a new</span>
<span class="sd">        one, and return either the first fact of the list equivalent to</span>
<span class="sd">        the new fact or `None`. This is used to avoid spending search in</span>
<span class="sd">        proving equivalent facts.</span>

<span class="sd">      redundant: take a collection of established facts and decide</span>
<span class="sd">        whether they imply a new fact candidate. This is useful to avoid</span>
<span class="sd">        trying to prove and accumulating redundant facts.</span>

<span class="sd">    Returns:</span>
<span class="sd">      a proof of the top-level goal.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">spawn_node</span><span class="p">(</span>
        <span class="n">Abduction</span><span class="p">,</span>
        <span class="n">prove</span><span class="o">=</span><span class="n">prove</span><span class="p">,</span>
        <span class="n">suggest</span><span class="o">=</span><span class="n">suggest</span><span class="p">,</span>
        <span class="n">search_equivalent</span><span class="o">=</span><span class="n">search_equivalent</span><span class="p">,</span>
        <span class="n">redundant</span><span class="o">=</span><span class="n">redundant</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">Proof</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="delphyne.abduct_and_saturate" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">abduct_and_saturate</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">abduct_and_saturate</span><span class="p">(</span><span class="n">tree</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="Tree


  
      dataclass
   (delphyne.core.Tree)" href="../../strategies/trees/#delphyne.Tree">Tree</a></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="Abduction


  
      dataclass
   (delphyne.stdlib.search.abduction.Abduction)" href="#delphyne.Abduction">Abduction</a></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.search.abduction.abduct_and_saturate[P]">abduct_and_saturate[P]</span></span><span class="p">,</span> <span class="n"><span title="delphyne.stdlib.search.abduction.abduct_and_saturate[Proof]">abduct_and_saturate[Proof]</span></span><span class="p">],</span> <span class="n">env</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="PolicyEnv (delphyne.stdlib.environments.PolicyEnv)" href="../environments/#delphyne.PolicyEnv">PolicyEnv</a></span><span class="p">,</span> <span class="n">policy</span><span class="p">:</span> <span class="n"><span title="delphyne.stdlib.search.abduction.abduct_and_saturate[P]">abduct_and_saturate[P]</span></span><span class="p">,</span> <span class="n">max_rollout_depth</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">scoring_function</span><span class="p">:</span> <span class="n"><span title="delphyne.stdlib.search.abduction.ScoringFunction">ScoringFunction</span></span> <span class="o">=</span> <span class="n"><span title="delphyne.stdlib.search.abduction._default_scoring_function">_default_scoring_function</span></span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="StreamGen (delphyne.core.StreamGen)" href="../../policies/streams/#delphyne.StreamGen">StreamGen</a></span><span class="p">[</span><span class="n"><span title="delphyne.stdlib.search.abduction.abduct_and_saturate[Proof]">abduct_and_saturate[Proof]</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents first">

        <p>A standard, sequential policy to process abduction nodes.</p>
<p>Note: facts must be hashable.</p>


            <details class="quote">
              <summary>Source code in <code>src/delphyne/stdlib/search/abduction.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@search_policy</span>
<span class="k">def</span><span class="w"> </span><span class="nf">abduct_and_saturate</span><span class="p">[</span><span class="n">P</span><span class="p">,</span> <span class="n">Proof</span><span class="p">](</span>
    <span class="n">tree</span><span class="p">:</span> <span class="n">dp</span><span class="o">.</span><span class="n">Tree</span><span class="p">[</span><span class="n">Abduction</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">Proof</span><span class="p">],</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">PolicyEnv</span><span class="p">,</span>
    <span class="n">policy</span><span class="p">:</span> <span class="n">P</span><span class="p">,</span>
    <span class="n">max_rollout_depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">scoring_function</span><span class="p">:</span> <span class="n">ScoringFunction</span> <span class="o">=</span> <span class="n">_default_scoring_function</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">StreamGen</span><span class="p">[</span><span class="n">Proof</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A standard, sequential policy to process abduction nodes.</span>

<span class="sd">    Note: facts must be hashable.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># TODO: we are currently allowing redundant facts in `proved` since</span>
    <span class="c1"># we never clean up `proved`. For example, if `x &gt; 0` is established</span>
    <span class="c1"># before the stronger `x &gt;= 0`, the former won&#39;t be deleted from</span>
    <span class="c1"># `proved`.</span>

    <span class="c1"># Invariant: `candidates`, `proved`, `disproved` and `redundant` are</span>
    <span class="c1"># disjoint. Together, they form the set of &quot;canonical facts&quot;.</span>
    <span class="n">candidates</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">_EFact</span><span class="p">,</span> <span class="n">_CandInfo</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">proved</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">_EFact</span><span class="p">,</span> <span class="n">_Proof</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">disproved</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">_EFact</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="c1"># Facts that are implied by the conjunction of all proved facts.</span>
    <span class="n">redundant</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">_EFact</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="c1"># It is easier to manipulate untracked facts and so we keep the</span>
    <span class="c1"># correspondence with tracked facts here.</span>
    <span class="c1"># Invariant: all canonical facts are included in `tracked`.</span>
    <span class="n">tracked</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">_EFact</span><span class="p">,</span> <span class="n">_Tracked_EFact</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="kc">None</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

    <span class="c1"># The `equivalent` dict maps a fact to its canonical equivalent</span>
    <span class="c1"># representative that is somewhere in `candidates`, `proved`,</span>
    <span class="c1"># `disproved` or `redundant`.</span>
    <span class="n">equivalent</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">_EFact</span><span class="p">,</span> <span class="n">_EFact</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Can a new fact make a candidate redundant? YES. So we should also</span>
    <span class="c1"># do this in `propagate`</span>

    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">Abduction</span><span class="p">)</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">node</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dbg</span><span class="p">(</span><span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">all_canonical</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">_EFact</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span><span class="o">*</span><span class="n">candidates</span><span class="p">,</span> <span class="o">*</span><span class="n">proved</span><span class="p">,</span> <span class="o">*</span><span class="n">disproved</span><span class="p">,</span> <span class="o">*</span><span class="n">redundant</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_redundant</span><span class="p">(</span><span class="n">f</span><span class="p">:</span> <span class="n">_EFact</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">StreamContext</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">respace</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">redundant</span><span class="p">([</span><span class="n">tracked</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">proved</span><span class="p">],</span> <span class="n">tracked</span><span class="p">[</span><span class="n">f</span><span class="p">])</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">respace</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">policy</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">_Abort</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">tracked</span><span class="o">.</span><span class="n">value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_candidate</span><span class="p">(</span><span class="n">c</span><span class="p">:</span> <span class="n">_EFact</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">StreamContext</span><span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
        <span class="c1"># Take a new fact and put it into either `proved`, `disproved`,</span>
        <span class="c1"># `candidates` or `redundant`. If a canonical fact is passed,</span>
        <span class="c1"># nothing is done.</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">all_canonical</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="c1"># We first make a redundancy check</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">yield from</span> <span class="n">is_redundant</span><span class="p">(</span><span class="n">c</span><span class="p">)):</span>
            <span class="n">dbg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Redundant: </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">redundant</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># If not redundant, we try and prove it</span>
        <span class="n">facts_list</span> <span class="o">=</span> <span class="p">[(</span><span class="n">tracked</span><span class="p">[</span><span class="n">f</span><span class="p">],</span> <span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">proved</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="n">pstream</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">prove</span><span class="p">(</span><span class="n">facts_list</span><span class="p">,</span> <span class="n">tracked</span><span class="p">[</span><span class="n">c</span><span class="p">])</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">policy</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">pstream</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">_Abort</span><span class="p">()</span>
        <span class="n">status</span><span class="p">,</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">tracked</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">res</span><span class="o">.</span><span class="n">tracked</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">status</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;disproved&quot;</span><span class="p">:</span>
            <span class="n">disproved</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="n">dbg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Disproved: </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">_Abort</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">status</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;proved&quot;</span><span class="p">:</span>
            <span class="n">proved</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">payload</span>
            <span class="n">dbg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Proved: </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">_ProofFound</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">candidates</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">_CandInfo</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">propagate</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">StreamContext</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;updated&quot;</span><span class="p">,</span> <span class="s2">&quot;not_updated&quot;</span><span class="p">]]:</span>
        <span class="c1"># Go through each candidate and see if it is now provable</span>
        <span class="c1"># assuming all established facts.</span>
        <span class="n">old_candidates</span> <span class="o">=</span> <span class="n">candidates</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">candidates</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">old_candidates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">yield from</span> <span class="n">add_candidate</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
                <span class="c1"># Restore the counters if `c` is still a candidate</span>
                <span class="n">candidates</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">num_proposed</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">num_proposed</span>
                <span class="n">candidates</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">num_visited</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">num_visited</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="s2">&quot;updated&quot;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_candidates</span><span class="p">)</span>
            <span class="k">else</span> <span class="s2">&quot;not_updated&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">saturate</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">StreamContext</span><span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
        <span class="c1"># Propagate facts until saturation</span>
        <span class="k">while</span> <span class="p">(</span><span class="k">yield from</span> <span class="n">propagate</span><span class="p">())</span> <span class="o">==</span> <span class="s2">&quot;updated&quot;</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_canonical</span><span class="p">(</span><span class="n">f</span><span class="p">:</span> <span class="n">_EFact</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">StreamContext</span><span class="p">[</span><span class="n">_EFact</span><span class="p">]:</span>
        <span class="c1"># The result is guaranteed to be in `tracked`</span>
        <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">proved</span> <span class="ow">or</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">disproved</span> <span class="ow">or</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
            <span class="c1"># Case where f is a canonical fact</span>
            <span class="k">return</span> <span class="n">f</span>
        <span class="k">assert</span> <span class="n">f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">equivalent</span><span class="p">:</span>
            <span class="c1"># Case where an equivalent canonical fact is known already</span>
            <span class="n">nf</span> <span class="o">=</span> <span class="n">equivalent</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">nf</span> <span class="ow">in</span> <span class="n">all_canonical</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">equivalent</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
        <span class="c1"># New fact whose equivalence must be tested</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="p">[</span><span class="n">tracked</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">all_canonical</span><span class="p">()</span> <span class="k">if</span> <span class="n">o</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">prev</span><span class="p">:</span>
            <span class="c1"># First fact: no need to make equivalence call</span>
            <span class="k">return</span> <span class="n">f</span>
        <span class="n">eqspace</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">search_equivalent</span><span class="p">(</span><span class="n">prev</span><span class="p">,</span> <span class="n">tracked</span><span class="p">[</span><span class="n">f</span><span class="p">])</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">eqspace</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">policy</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">_Abort</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">tracked</span>
        <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span>
        <span class="k">elif</span> <span class="n">res</span><span class="o">.</span><span class="n">value</span> <span class="ow">in</span> <span class="n">all_canonical</span><span class="p">():</span>
            <span class="n">equivalent</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">value</span>
            <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s2">&quot;invalid_equivalent_call&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">f</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_raw_suggestions</span><span class="p">(</span><span class="n">c</span><span class="p">:</span> <span class="n">_EFact</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">StreamContext</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">_EFact</span><span class="p">]]:</span>
        <span class="k">assert</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">candidates</span>
        <span class="n">sstream</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">suggest</span><span class="p">(</span><span class="n">candidates</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">feedback</span><span class="p">)</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">policy</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">sstream</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">:</span>
            <span class="c1"># If no suggestions are returned, we are out of budget and</span>
            <span class="c1"># abort so as to not call this again in a loop.</span>
            <span class="k">raise</span> <span class="n">_Abort</span><span class="p">()</span>
        <span class="n">tracked_suggs</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">tracked</span><span class="p">]</span>
        <span class="c1"># Populate the `tracked` cache (this is the only place where new</span>
        <span class="c1"># facts can be created and so the only place where `tracked`</span>
        <span class="c1"># must be updated).</span>
        <span class="n">suggs</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">tracked_suggs</span><span class="p">]</span>
        <span class="n">dbg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Suggestions: </span><span class="si">{</span><span class="n">suggs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">ts</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">suggs</span><span class="p">,</span> <span class="n">tracked_suggs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tracked</span><span class="p">:</span>
                <span class="n">tracked</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts</span>
        <span class="k">return</span> <span class="n">suggs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_suggestions</span><span class="p">(</span><span class="n">c</span><span class="p">:</span> <span class="n">_EFact</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dp</span><span class="o">.</span><span class="n">StreamContext</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="n">_EFact</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
        <span class="c1"># Return a dict representing a multiset of suggestions</span>
        <span class="k">assert</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">candidates</span>
        <span class="n">raw_suggs</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">get_raw_suggestions</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">suggs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">_EFact</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">raw_suggs</span><span class="p">:</span>
            <span class="n">suggs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="k">yield from</span> <span class="n">get_canonical</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
        <span class="n">len_proved_old</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">proved</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">suggs</span><span class="p">:</span>
            <span class="k">yield from</span> <span class="n">add_candidate</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">len_proved_old</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">proved</span><span class="p">):</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">proved</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">len_proved_old</span>
            <span class="k">yield from</span> <span class="n">saturate</span><span class="p">()</span>
        <span class="n">suggs</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">suggs</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">]</span>
        <span class="n">suggs_multiset</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">_EFact</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">suggs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">suggs_multiset</span><span class="p">:</span>
                <span class="n">suggs_multiset</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">suggs_multiset</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">dbg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filtered: </span><span class="si">{</span><span class="n">suggs_multiset</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">suggs_multiset</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield from</span> <span class="n">add_candidate</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">cur</span><span class="p">:</span> <span class="n">_EFact</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_rollout_depth</span><span class="p">):</span>
                <span class="n">dbg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Explore fact: </span><span class="si">{</span><span class="n">cur</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">suggs</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">get_suggestions</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">suggs</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">n</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">suggs</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">suggs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">candidates</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">num_proposed</span> <span class="o">+=</span> <span class="n">k</span> <span class="o">/</span> <span class="n">n</span>
                <span class="n">infos</span> <span class="o">=</span> <span class="p">[</span><span class="n">candidates</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">suggs</span><span class="p">]</span>
                <span class="n">best</span> <span class="o">=</span> <span class="n">_argmax</span><span class="p">(</span>
                    <span class="n">scoring_function</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">num_proposed</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">num_visited</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">infos</span>
                <span class="p">)</span>
                <span class="n">cur</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">suggs</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">best</span><span class="p">]</span>
                <span class="n">candidates</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span><span class="o">.</span><span class="n">num_visited</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">except</span> <span class="n">_Abort</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">except</span> <span class="n">_ProofFound</span><span class="p">:</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">proved</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span>
        <span class="n">child</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">child</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">dp</span><span class="o">.</span><span class="n">Success</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">dp</span><span class="o">.</span><span class="n">Solution</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">success</span><span class="p">)</span>
        <span class="k">return</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["content.code.annotate", "content.code.copy", "content.tabs.link", "navigation.indexes"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.92b07e13.min.js"></script>
      
        <script src="../../../javascript/katex.js"></script>
      
        <script src="https://unpkg.com/katex@0/dist/katex.min.js"></script>
      
        <script src="https://unpkg.com/katex@0/dist/contrib/auto-render.min.js"></script>
      
    
  </body>
</html>